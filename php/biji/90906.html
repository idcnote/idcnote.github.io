<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <title>使用PHP如何实现高效安全的ftp服务器(二)_PHP教程_IDC笔记</title>
    <meta name="keywords" content="PHP,PHP笔记,PHP教程" />
    <meta name="description" content="在上篇文章给大家介绍了使用PHP如何实现高效安全的ftp服务器(一)，感兴趣的朋友可以点击了解详情。接下来通过本篇文章给大家介绍使用PHP如何实现高效安全的ftp服务器(二)，具体" />
    <meta content="Responsive admin theme build on top of Bootstrap 4" name="description" />
    <meta content="idcnote.com" name="author" />
    <link rel="shortcut icon" href="/skin1/images/favicon.ico">
    <!--Morris Chart CSS -->
    <link rel="stylesheet" href="/skin1/css/morris.css">
    <link href="/skin1/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/metismenu.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/icons.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/style.css" rel="stylesheet" type="text/css">
<link href="/SyntaxHighlighter/shCoreDefault.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">
 SyntaxHighlighter.all();
</script>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
</head>
<body>
<!-- Begin page -->
		<div id="wrapper">
			<!-- Top Bar Start -->
			<div class="topbar">
				<!-- LOGO -->
				<div class="topbar-left">
					<a href="/" class="logo">
						<span class="logo-light">
                            <i class="mdi mdi-camera-control"></i>IDC笔记
                        </span>
						<span class="logo-sm">
                            <i class="mdi mdi-camera-control"></i>
                        </span>
					</a>
				</div>
				<nav class="navbar-custom">
					<ul class="navbar-right list-inline float-right mb-0">
						<!--<li class="dropdown notification-list list-inline-item d-none d-md-inline-block">
							<a class="nav-link waves-effect" href="#" id="btn-fullscreen">
								<i class="mdi mdi-arrow-expand-all noti-icon"></i>
							</a>
						</li>
						<li class="dropdown notification-list list-inline-item">
							<div class="dropdown notification-list nav-pro-img">
								<a class="dropdown-toggle nav-link arrow-none nav-user" data-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
									<img src="/skin1/picture/user-4.jpg" alt="user" class="rounded-circle">
								</a>
								<div class="dropdown-menu dropdown-menu-right profile-dropdown ">
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-account-circle"></i> Profile</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-wallet"></i> Wallet</a>
									<a class="dropdown-item d-block" href="#">
										<span class="badge badge-success float-right">11</span>
										<i class="mdi mdi-settings"></i> Settings</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-lock-open-outline"></i> Lock screen</a>
									<div class="dropdown-divider"></div>
									<a class="dropdown-item text-danger" href="#">
										<i class="mdi mdi-power text-danger"></i> Logout</a>
								</div>
							</div>
						</li>
						-->
					</ul>
					<ul class="list-inline menu-left mb-0">
						<li class="float-left">
							<button class="button-menu-mobile open-left waves-effect">
                            <i class="mdi mdi-menu"></i>
                        </button>
						</li>
						<li class="d-none d-md-inline-block">
							<form role="search" class="app-search">
								<div class="form-group mb-0">
									<input type="text" class="form-control" placeholder="Search..">
									<button type="submit"><i class="fa fa-search"></i></button>
								</div>
							</form>
						</li>
					</ul>
				</nav>
			</div>
<!-- ========== Left Sidebar Start ========== -->
<div class="left side-menu">
    <div class="slimscroll-menu" id="remove-scroll">
    <!--- Sidemenu -->
    <div id="sidebar-menu">
    <!-- Left Menu Start -->
    <ul class="metismenu" id="side-menu">
			<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP简介			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/jianjie/1.html">PHP简介</a></li><li><a href="/php/jianjie/2.html">PHP用途</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP基本语法			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yufa/3.html">分离HTML</a></li><li><a href="/php/yufa/4.html">指令分隔符</a></li><li><a href="/php/yufa/5.html">PHP注释</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP类型			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpleixing/6.html">PHP类型简介</a></li><li><a href="/php/phpleixing/7.html">PHP类型之布尔类型</a></li><li><a href="/php/phpleixing/8.html">PHP类型之整型</a></li><li><a href="/php/phpleixing/9.html">PHP类型之浮点型</a></li><li><a href="/php/phpleixing/10.html">PHP类型之字符串</a></li><li><a href="/php/phpleixing/11.html">PHP类型之数组</a></li><li><a href="/php/phpleixing/12.html">PHP类型之对象</a></li><li><a href="/php/phpleixing/13.html">PHP类型之资源类型</a></li><li><a href="/php/phpleixing/14.html">PHP类型之NULL</a></li><li><a href="/php/phpleixing/15.html">PHP类型之伪类型</a></li><li><a href="/php/phpleixing/16.html">PHP类型之类型判别</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP变量			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpbianliang/17.html">PHP变量之基础</a></li><li><a href="/php/phpbianliang/18.html">PHP变量之预定义变量</a></li><li><a href="/php/phpbianliang/19.html">PHP变量之变量范围</a></li><li><a href="/php/phpbianliang/20.html">PHP变量之可变变量</a></li><li><a href="/php/phpbianliang/21.html">PHP变量之外部变量</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP运算符			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yunsuanfu/22.html">PHP运算符优先级</a></li><li><a href="/php/yunsuanfu/23.html">算术运算符</a></li><li><a href="/php/yunsuanfu/24.html">赋值运算符</a></li><li><a href="/php/yunsuanfu/25.html">位运算符</a></li><li><a href="/php/yunsuanfu/26.html">比较运算符</a></li><li><a href="/php/yunsuanfu/27.html">错误控制运算符</a></li><li><a href="/php/yunsuanfu/28.html">执行运算符</a></li><li><a href="/php/yunsuanfu/29.html">递增/递减运算符</a></li><li><a href="/php/yunsuanfu/30.html">逻辑运算符</a></li><li><a href="/php/yunsuanfu/31.html">字符串运算符</a></li><li><a href="/php/yunsuanfu/32.html">数组运算符</a></li><li><a href="/php/yunsuanfu/33.html">类型运算符</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP控制结构			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/jiegou/34.html">PHP控制结构之if</a></li><li><a href="/php/jiegou/35.html">PHP控制结构之else</a></li><li><a href="/php/jiegou/36.html">PHP控制结构之elseif/else if</a></li><li><a href="/php/jiegou/37.html">PHP控制结构之替代语法</a></li><li><a href="/php/jiegou/38.html">PHP控制结构之while</a></li><li><a href="/php/jiegou/39.html">PHP控制结构之do-while</a></li><li><a href="/php/jiegou/40.html">PHP控制结构之for</a></li><li><a href="/php/jiegou/41.html">PHP控制结构之foreach</a></li><li><a href="/php/jiegou/42.html">PHP控制结构之break</a></li><li><a href="/php/jiegou/43.html">PHP控制结构之continue</a></li><li><a href="/php/jiegou/44.html">PHP控制结构之switch</a></li><li><a href="/php/jiegou/45.html">PHP控制结构之declare</a></li><li><a href="/php/jiegou/46.html">PHP控制结构之return</a></li><li><a href="/php/jiegou/47.html">PHP控制结构之require</a></li><li><a href="/php/jiegou/48.html">PHP控制结构之include</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP函数			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/hanshu/52.html">用户自定义函数</a></li><li><a href="/php/hanshu/53.html">函数的参数</a></li><li><a href="/php/hanshu/54.html">返回值</a></li><li><a href="/php/hanshu/55.html">可变函数</a></li><li><a href="/php/hanshu/56.html">内部（内置）函数</a></li><li><a href="/php/hanshu/57.html">匿名函数</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP类与对象			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpduixiang/58.html">类与对象前言</a></li><li><a href="/php/phpduixiang/59.html">基本概念</a></li><li><a href="/php/phpduixiang/60.html">属性</a></li><li><a href="/php/phpduixiang/61.html">类常量</a></li><li><a href="/php/phpduixiang/62.html">自动加载对象</a></li><li><a href="/php/phpduixiang/63.html">构造函数和析构函数</a></li><li><a href="/php/phpduixiang/64.html">访问控制</a></li><li><a href="/php/phpduixiang/65.html">对象继承</a></li><li><a href="/php/phpduixiang/66.html">Static关键字</a></li><li><a href="/php/phpduixiang/67.html">抽象类</a></li><li><a href="/php/phpduixiang/68.html">接口</a></li><li><a href="/php/phpduixiang/69.html">Traits</a></li><li><a href="/php/phpduixiang/70.html">重载</a></li><li><a href="/php/phpduixiang/71.html">对象迭代</a></li><li><a href="/php/phpduixiang/72.html">设计模式</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP异常处理			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yichang/81.html">异常处理</a></li><li><a href="/php/yichang/82.html">扩展PHP内置的异常处理类</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP函数库按分类			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpku/83.html">数组</a></li><li><a href="/php/phpku/84.html">Classes/Objects</a></li><li><a href="/php/phpku/85.html">Date/Time</a></li><li><a href="/php/phpku/86.html">Directories</a></li><li><a href="/php/phpku/87.html">错误处理</a></li><li><a href="/php/phpku/88.html">Program execution</a></li><li><a href="/php/phpku/89.html">Filesystem</a></li><li><a href="/php/phpku/90.html">Filter</a></li><li><a href="/php/phpku/91.html">Function Handling</a></li><li><a href="/php/phpku/92.html">PHP 选项/信息</a></li><li><a href="/php/phpku/93.html">Mail</a></li><li><a href="/php/phpku/94.html">Math</a></li><li><a href="/php/phpku/95.html">Misc.</a></li><li><a href="/php/phpku/96.html">Network</a></li><li><a href="/php/phpku/97.html">输出控制</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> php基础			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpbiji/108377.html"></a></li><li><a href="/php/phpbiji/108376.html"></a></li><li><a href="/php/phpbiji/108380.html"></a></li><li><a href="/php/phpbiji/108379.html"></a></li><li><a href="/php/phpbiji/108378.html"></a></li><li><a href="/php/phpbiji/108381.html"></a></li><li><a href="/php/phpbiji/108382.html"></a></li><li><a href="/php/phpbiji/108384.html"></a></li><li><a href="/php/phpbiji/108383.html"></a></li><li><a href="/php/phpbiji/108385.html"></a></li><li><a href="/php/phpbiji/108386.html"></a></li><li><a href="/php/phpbiji/108388.html"></a></li><li><a href="/php/phpbiji/108387.html"></a></li><li><a href="/php/phpbiji/108389.html"></a></li><li><a href="/php/phpbiji/108391.html"></a></li>		</ul>
	</li>
		<li>
	    <a href="/php/biji/" class="waves-effect">
		    <i class="icon-share"></i>
		    <span>PHP笔记
		       	<span class="float-right menu-arrow">
		       	<i class="mdi mdi-chevron-right"></i>
		       	</span>
		    </span>
	    </a>
	</li>
	</ul>
</div>
<!-- Sidebar -->
<div class="clearfix"></div>
</div>
<!-- Sidebar -left -->
</div>
<!-- Left Sidebar End -->
<!-- Start right Content here -->
<div class="content-page">
	<div class="content">
		<div class="container-fluid">
			<div class="page-title-box">
				<div class="row align-items-center">
					<div class="col-sm-6">
						<h1 class="page-title">使用PHP如何实现高效安全的ftp服务器(二)</h1>
					</div>
				</div>
				<!-- end row -->
			</div>
			<!-- end page-title -->
			<!-- START ROW -->
			<div class="panel panel-forbid">
				<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>内容摘要</div>
			    <div class="panel-content">
			    <span>在上篇文章给大家介绍了使用PHP如何实现高效安全的ftp服务器(一)，感兴趣的朋友可以点击了解详情。接下来通过本篇文章给大家介绍使用PHP如何实现高效安全的ftp服务器(二)，具体</span>                                     
		    	</div>
			    <div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>文章正文</div>
			    <div class="panel-content">
			    <span><p>在上篇文章给大家介绍了使用PHP如何实现高效安全的ftp服务器(一)，感兴趣的朋友可以点击了解详情。接下来通过本篇文章给大家介绍使用PHP如何实现高效安全的ftp服务器(二)，具体内容如下所示：</p>
<p><span style="color: #0000ff"><strong>1.实现用户类CUser。</strong></span><strong><br />
</strong></p>
<p>　　用户的存储采用文本形式，将用户数组进行json编码。　　<br />
</p>
<p>用户文件格式：<br />
</p>
<div class="phpstudycode">
<pre class="brush:php;">
* array(
* 'user1' =&gt; array(
* 'pass'=&gt;'',
* 'group'=&gt;'',
* 'home'=&gt;'/home/ftp/', //ftp主目录
* 'active'=&gt;true,
* 'expired=&gt;'2015-12-12',
* 'description'=&gt;'',
* 'email' =&gt; '',
* 'folder'=&gt;array(
* //可以列出主目录下的文件和目录，但不能创建和删除，也不能进入主目录下的目录
* //前1-5位是文件权限，6-9是文件夹权限,10是否继承(inherit)
* array('path'=&gt;'/home/ftp/','access'=&gt;'RWANDLCNDI'),
* //可以列出/home/ftp/a/下的文件和目录,可以创建和删除，可以进入/home/ftp/a/下的子目录，可以创建和删除。
* array('path'=&gt;'/home/ftp/a/','access'=&gt;'RWAND-----'),
* ),
* 'ip'=&gt;array(
* 'allow'=&gt;array(ip1,ip2,...),//支持*通配符: 192.168.0.*
* 'deny'=&gt;array(ip1,ip2,...)
* )
* ) 
* )
* 
* 组文件格式：
* array(
* 'group1'=&gt;array(
* 'home'=&gt;'/home/ftp/dept1/',
* 'folder'=&gt;array(
* 
* ),
* 'ip'=&gt;array(
* 'allow'=&gt;array(ip1,ip2,...),
* 'deny'=&gt;array(ip1,ip2,...)
* )
* )
* ) </pre>
</div>
<p>　　<strong>文件夹和文件的权限说明：</strong></p>
<p>* 文件权限 <br />
* R读 : 允许用户读取（即下载）文件。该权限不允许用户列出目录内容，执行该操作需要列表权限。 <br />
* W写: 允许用户写入（即上传）文件。该权限不允许用户修改现有的文件，执行该操作需要追加权限。<br />
* A追加: 允许用户向现有文件中追加数据。该权限通常用于使用户能够对部分上传的文件进行续传。 <br />
* N重命名: 允许用户重命名现有的文件。<br />
* D删除: 允许用户删除文件。 <br />
* <br />
* 目录权限 <br />
* L列表: 允许用户列出目录中包含的文件。<br />
* C创建: 允许用户在目录中新建子目录。 <br />
* N重命名: 允许用户在目录中重命名现有子目录。<br />
* D删除: 允许用户在目录中删除现有子目录。注意： 如果目录包含文件，用户要删除目录还需要具有删除文件权限。<br />
* <br />
* 子目录权限<br />
* I继承: 允许所有子目录继承其父目录具有的相同权限。继承权限适用于大多数情况，但是如果访问必须受限于子文件夹，例如实施强制访问控制（Mandatory Access Control）时，则取消继承并为文件夹逐一授予权限。<br />
* <br />
</p>
<p>　　实现代码如下：　　<br />
</p>
<p></p>
<div class="phpstudycode">
<pre class="brush:php;">
class User{
const I = 1; // inherit
const FD = 2; // folder delete
const FN = 4; // folder rename
const FC = 8; // folder create
const FL = 16; // folder list
const D = 32; // file delete
const N = 64; // file rename
const A = 128; // file append
const W = 256; // file write (upload)
const R = 512; // file read (download) 
private $hash_salt = '';
private $user_file;
private $group_file;
private $users = array();
private $groups = array();
private $file_hash = ''; 
public function __construct(){
$this-&gt;user_file = BASE_PATH.'/conf/users';
$this-&gt;group_file = BASE_PATH.'/conf/groups';
$this-&gt;reload();
}
/**
* 返回权限表达式
* @param int $access
* @return string
*/
public static function AC($access){
$str = '';
$char = array('R','W','A','N','D','L','C','N','D','I');
for($i = 0; $i &lt; 10; $i++){
if($access & pow(2,9-$i))$str.= $char[$i];else $str.= '-';
}
return $str;
}
/**
* 加载用户数据
*/
public function reload(){
$user_file_hash = md5_file($this-&gt;user_file);
$group_file_hash = md5_file($this-&gt;group_file); 
if($this-&gt;file_hash != md5($user_file_hash.$group_file_hash)){
if(($user = file_get_contents($this-&gt;user_file)) !== false){
$this-&gt;users = json_decode($user,true);
if($this-&gt;users){
//folder排序
foreach ($this-&gt;users as $user=&gt;$profile){
if(isset($profile['folder'])){
$this-&gt;users[$user]['folder'] = $this-&gt;sortFolder($profile['folder']);
}
}
}
}
if(($group = file_get_contents($this-&gt;group_file)) !== false){
$this-&gt;groups = json_decode($group,true);
if($this-&gt;groups){
//folder排序
foreach ($this-&gt;groups as $group=&gt;$profile){ 
if(isset($profile['folder'])){ 
$this-&gt;groups[$group]['folder'] = $this-&gt;sortFolder($profile['folder']);
}
}
}
}
$this-&gt;file_hash = md5($user_file_hash.$group_file_hash); 
}
}
/**
* 对folder进行排序
* @return array
*/
private function sortFolder($folder){
uasort($folder, function($a,$b){
return strnatcmp($a['path'], $b['path']);
}); 
$result = array();
foreach ($folder as $v){
$result[] = $v;
} 
return $result;
}
/**
* 保存用户数据
*/
public function save(){
file_put_contents($this-&gt;user_file, json_encode($this-&gt;users),LOCK_EX);
file_put_contents($this-&gt;group_file, json_encode($this-&gt;groups),LOCK_EX);
}
/**
* 添加用户
* @param string $user
* @param string $pass
* @param string $home
* @param string $expired
* @param boolean $active
* @param string $group
* @param string $description
* @param string $email
* @return boolean
*/
public function addUser($user,$pass,$home,$expired,$active=true,$group='',$description='',$email = ''){
$user = strtolower($user);
if(isset($this-&gt;users[$user]) || empty($user)){
return false;
} 
$this-&gt;users[$user] = array(
'pass' =&gt; md5($user.$this-&gt;hash_salt.$pass),
'home' =&gt; $home,
'expired' =&gt; $expired,
'active' =&gt; $active,
'group' =&gt; $group,
'description' =&gt; $description,
'email' =&gt; $email,
);
return true;
}
/**
* 设置用户资料
* @param string $user
* @param array $profile
* @return boolean
*/
public function setUserProfile($user,$profile){
$user = strtolower($user);
if(is_array($profile) && isset($this-&gt;users[$user])){
if(isset($profile['pass'])){
$profile['pass'] = md5($user.$this-&gt;hash_salt.$profile['pass']);
}
if(isset($profile['active'])){
if(!is_bool($profile['active'])){
$profile['active'] = $profile['active'] == 'true' &#63; true : false;
}
} 
$this-&gt;users[$user] = array_merge($this-&gt;users[$user],$profile);
return true;
}
return false;
}
/**
* 获取用户资料
* @param string $user
* @return multitype:|boolean
*/
public function getUserProfile($user){
$user = strtolower($user);
if(isset($this-&gt;users[$user])){
return $this-&gt;users[$user];
}
return false;
}
/**
* 删除用户
* @param string $user
* @return boolean
*/
public function delUser($user){
$user = strtolower($user);
if(isset($this-&gt;users[$user])){
unset($this-&gt;users[$user]);
return true;
}
return false;
}
/**
* 获取用户列表
* @return array
*/
public function getUserList(){
$list = array();
if($this-&gt;users){
foreach ($this-&gt;users as $user=&gt;$profile){
$list[] = $user;
}
}
sort($list);
return $list;
}
/**
* 添加组
* @param string $group
* @param string $home
* @return boolean
*/
public function addGroup($group,$home){
$group = strtolower($group);
if(isset($this-&gt;groups[$group])){
return false;
}
$this-&gt;groups[$group] = array(
'home' =&gt; $home
);
return true;
}
/**
* 设置组资料
* @param string $group
* @param array $profile
* @return boolean
*/
public function setGroupProfile($group,$profile){
$group = strtolower($group);
if(is_array($profile) && isset($this-&gt;groups[$group])){
$this-&gt;groups[$group] = array_merge($this-&gt;groups[$group],$profile);
return true;
}
return false;
}
/**
* 获取组资料
* @param string $group
* @return multitype:|boolean
*/
public function getGroupProfile($group){
$group = strtolower($group);
if(isset($this-&gt;groups[$group])){
return $this-&gt;groups[$group];
}
return false;
}
/**
* 删除组
* @param string $group
* @return boolean
*/
public function delGroup($group){
$group = strtolower($group);
if(isset($this-&gt;groups[$group])){
unset($this-&gt;groups[$group]);
foreach ($this-&gt;users as $user =&gt; $profile){
if($profile['group'] == $group)
$this-&gt;users[$user]['group'] = '';
}
return true;
}
return false;
}
/**
* 获取组列表
* @return array
*/
public function getGroupList(){
$list = array();
if($this-&gt;groups){
foreach ($this-&gt;groups as $group=&gt;$profile){
$list[] = $group;
}
}
sort($list);
return $list;
}
/**
* 获取组用户列表
* @param string $group
* @return array
*/
public function getUserListOfGroup($group){
$list = array();
if(isset($this-&gt;groups[$group]) && $this-&gt;users){
foreach ($this-&gt;users as $user=&gt;$profile){
if(isset($profile['group']) && $profile['group'] == $group){
$list[] = $user;
}
}
}
sort($list);
return $list;
}
/**
* 用户验证
* @param string $user
* @param string $pass
* @param string $ip
* @return boolean
*/
public function checkUser($user,$pass,$ip = ''){
$this-&gt;reload();
$user = strtolower($user);
if(isset($this-&gt;users[$user])){
if($this-&gt;users[$user]['active'] && time() &lt;= strtotime($this-&gt;users[$user]['expired'])
&& $this-&gt;users[$user]['pass'] == md5($user.$this-&gt;hash_salt.$pass)){
if(empty($ip)){
return true;
}else{
//ip验证
return $this-&gt;checkIP($user, $ip);
}
}else{
return false;
} 
}
return false;
}
/**
* basic auth 
* @param string $base64 
*/
public function checkUserBasicAuth($base64){
$base64 = trim(str_replace('Basic ', '', $base64));
$str = base64_decode($base64);
if($str !== false){
list($user,$pass) = explode(':', $str,2);
$this-&gt;reload();
$user = strtolower($user);
if(isset($this-&gt;users[$user])){
$group = $this-&gt;users[$user]['group'];
if($group == 'admin' && $this-&gt;users[$user]['active'] && time() &lt;= strtotime($this-&gt;users[$user]['expired'])
&& $this-&gt;users[$user]['pass'] == md5($user.$this-&gt;hash_salt.$pass)){ 
return true;
}else{
return false;
}
}
}
return false;
}
/**
* 用户登录ip验证
* @param string $user
* @param string $ip
* 
* 用户的ip权限继承组的IP权限。
* 匹配规则：
* 1.进行组允许列表匹配；
* 2.如同通过，进行组拒绝列表匹配；
* 3.进行用户允许匹配
* 4.如果通过，进行用户拒绝匹配
* 
*/
public function checkIP($user,$ip){
$pass = false;
//先进行组验证 
$group = $this-&gt;users[$user]['group'];
//组允许匹配
if(isset($this-&gt;groups[$group]['ip']['allow'])){
foreach ($this-&gt;groups[$group]['ip']['allow'] as $addr){
$pattern = '/'.str_replace('*','\d+',str_replace('.', '\.', $addr)).'/';
if(preg_match($pattern, $ip) && !empty($addr)){
$pass = true;
break;
}
}
}
//如果允许通过，进行拒绝匹配
if($pass){
if(isset($this-&gt;groups[$group]['ip']['deny'])){
foreach ($this-&gt;groups[$group]['ip']['deny'] as $addr){
$pattern = '/'.str_replace('*','\d+',str_replace('.', '\.', $addr)).'/';
if(preg_match($pattern, $ip) && !empty($addr)){
$pass = false;
break;
}
}
}
}
if(isset($this-&gt;users[$user]['ip']['allow'])){ 
foreach ($this-&gt;users[$user]['ip']['allow'] as $addr){
$pattern = '/'.str_replace('*','\d+',str_replace('.', '\.', $addr)).'/';
if(preg_match($pattern, $ip) && !empty($addr)){
$pass = true;
break;
}
}
}
if($pass){
if(isset($this-&gt;users[$user]['ip']['deny'])){
foreach ($this-&gt;users[$user]['ip']['deny'] as $addr){
$pattern = '/'.str_replace('*','\d+',str_replace('.', '\.', $addr)).'/';
if(preg_match($pattern, $ip) && !empty($addr)){
$pass = false;
break;
}
}
}
}
echo date('Y-m-d H:i:s')." [debug]\tIP ACCESS:".' '.($pass&#63;'true':'false')."\n";
return $pass;
}
/**
* 获取用户主目录
* @param string $user
* @return string
*/
public function getHomeDir($user){
$user = strtolower($user);
$group = $this-&gt;users[$user]['group'];
$dir = '';
if($group){
if(isset($this-&gt;groups[$group]['home']))$dir = $this-&gt;groups[$group]['home'];
}
$dir = !empty($this-&gt;users[$user]['home'])&#63;$this-&gt;users[$user]['home']:$dir;
return $dir;
}
//文件权限判断
public function isReadable($user,$path){ 
$result = $this-&gt;getPathAccess($user, $path);
if($result['isExactMatch']){
return $result['access'][0] == 'R';
}else{
return $result['access'][0] == 'R' && $result['access'][9] == 'I';
}
} 
public function isWritable($user,$path){ 
$result = $this-&gt;getPathAccess($user, $path); 
if($result['isExactMatch']){
return $result['access'][1] == 'W';
}else{
return $result['access'][1] == 'W' && $result['access'][9] == 'I';
}
}
public function isAppendable($user,$path){
$result = $this-&gt;getPathAccess($user, $path);
if($result['isExactMatch']){
return $result['access'][2] == 'A';
}else{
return $result['access'][2] == 'A' && $result['access'][9] == 'I';
}
} 
public function isRenamable($user,$path){
$result = $this-&gt;getPathAccess($user, $path);
if($result['isExactMatch']){
return $result['access'][3] == 'N';
}else{
return $result['access'][3] == 'N' && $result['access'][9] == 'I';
}
}
public function isDeletable($user,$path){ 
$result = $this-&gt;getPathAccess($user, $path);
if($result['isExactMatch']){
return $result['access'][4] == 'D';
}else{
return $result['access'][4] == 'D' && $result['access'][9] == 'I';
}
}
//目录权限判断
public function isFolderListable($user,$path){
$result = $this-&gt;getPathAccess($user, $path);
if($result['isExactMatch']){
return $result['access'][5] == 'L';
}else{
return $result['access'][5] == 'L' && $result['access'][9] == 'I';
}
}
public function isFolderCreatable($user,$path){
$result = $this-&gt;getPathAccess($user, $path);
if($result['isExactMatch']){
return $result['access'][6] == 'C';
}else{
return $result['access'][6] == 'C' && $result['access'][9] == 'I';
}
}
public function isFolderRenamable($user,$path){
$result = $this-&gt;getPathAccess($user, $path);
if($result['isExactMatch']){
return $result['access'][7] == 'N';
}else{
return $result['access'][7] == 'N' && $result['access'][9] == 'I';
}
}
public function isFolderDeletable($user,$path){
$result = $this-&gt;getPathAccess($user, $path);
if($result['isExactMatch']){
return $result['access'][8] == 'D';
}else{
return $result['access'][8] == 'D' && $result['access'][9] == 'I';
}
}
/**
* 获取目录权限
* @param string $user
* @param string $path
* @return array
* 进行最长路径匹配
* 
* 返回：
* array(
* 'access'=&gt;目前权限 
* ,'isExactMatch'=&gt;是否精确匹配
* 
* );
* 
* 如果精确匹配，则忽略inherit.
* 否则应判断是否继承父目录的权限，
* 权限位表：
* +---+---+---+---+---+---+---+---+---+---+
* | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 |
* +---+---+---+---+---+---+---+---+---+---+
* | R | W | A | N | D | L | C | N | D | I |
* +---+---+---+---+---+---+---+---+---+---+
* | FILE | FOLDER |
* +-------------------+-------------------+
*/
public function getPathAccess($user,$path){
$this-&gt;reload();
$user = strtolower($user);
$group = $this-&gt;users[$user]['group']; 
//去除文件名称
$path = str_replace(substr(strrchr($path, '/'),1),'',$path);
$access = self::AC(0); 
$isExactMatch = false;
if($group){
if(isset($this-&gt;groups[$group]['folder'])){ 
foreach ($this-&gt;groups[$group]['folder'] as $f){
//中文处理
$t_path = iconv('UTF-8','GB18030',$f['path']); 
if(strpos($path, $t_path) === 0){
$access = $f['access']; 
$isExactMatch = ($path == $t_path&#63;true:false);
} 
}
}
}
if(isset($this-&gt;users[$user]['folder'])){
foreach ($this-&gt;users[$user]['folder'] as $f){
//中文处理
$t_path = iconv('UTF-8','GB18030',$f['path']);
if(strpos($path, $t_path) === 0){
$access = $f['access']; 
$isExactMatch = ($path == $t_path&#63;true:false);
}
}
}
echo date('Y-m-d H:i:s')." [debug]\tACCESS:$access ".' '.($isExactMatch&#63;'1':'0')." $path\n";
return array('access'=&gt;$access,'isExactMatch'=&gt;$isExactMatch);
} 
/**
* 添加在线用户
* @param ShareMemory $shm
* @param swoole_server $serv
* @param unknown $user
* @param unknown $fd
* @param unknown $ip
* @return Ambigous &lt;multitype:, boolean, mixed, multitype:unknown number multitype:Ambigous &lt;unknown, number&gt; &gt;
*/
public function addOnline(ShareMemory $shm ,$serv,$user,$fd,$ip){
$shm_data = $shm-&gt;read();
if($shm_data !== false){
$shm_data['online'][$user.'-'.$fd] = array('ip'=&gt;$ip,'time'=&gt;time());
$shm_data['last_login'][] = array('user' =&gt; $user,'ip'=&gt;$ip,'time'=&gt;time());
//清除旧数据
if(count($shm_data['last_login'])&gt;30)array_shift($shm_data['last_login']);
$list = array();
foreach ($shm_data['online'] as $k =&gt;$v){
$arr = explode('-', $k);
if($serv-&gt;connection_info($arr[1]) !== false){
$list[$k] = $v;
}
}
$shm_data['online'] = $list;
$shm-&gt;write($shm_data);
}
return $shm_data;
}
/**
* 添加登陆失败记录
* @param ShareMemory $shm
* @param unknown $user
* @param unknown $ip
* @return Ambigous &lt;number, multitype:, boolean, mixed&gt;
*/
public function addAttempt(ShareMemory $shm ,$user,$ip){
$shm_data = $shm-&gt;read();
if($shm_data !== false){
if(isset($shm_data['login_attempt'][$ip.'||'.$user]['count'])){
$shm_data['login_attempt'][$ip.'||'.$user]['count'] += 1;
}else{
$shm_data['login_attempt'][$ip.'||'.$user]['count'] = 1;
}
$shm_data['login_attempt'][$ip.'||'.$user]['time'] = time();
//清除旧数据
if(count($shm_data['login_attempt'])&gt;30)array_shift($shm_data['login_attempt']);
$shm-&gt;write($shm_data);
}
return $shm_data;
}
/**
* 密码错误上限
* @param unknown $shm
* @param unknown $user
* @param unknown $ip
* @return boolean
*/
public function isAttemptLimit(ShareMemory $shm,$user,$ip){
$shm_data = $shm-&gt;read();
if($shm_data !== false){
if(isset($shm_data['login_attempt'][$ip.'||'.$user]['count'])){
if($shm_data['login_attempt'][$ip.'||'.$user]['count'] &gt; 10 &&
time() - $shm_data['login_attempt'][$ip.'||'.$user]['time'] &lt; 600){ 
return true;
}
}
}
return false;
}
/**
* 生成随机密钥
* @param int $len
* @return Ambigous &lt;NULL, string&gt;
*/
public static function genPassword($len){
$str = null;
$strPol = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz@!#$%*+-";
$max = strlen($strPol)-1;
for($i=0;$i&lt;$len;$i++){
$str.=$strPol[rand(0,$max)];//rand($min,$max)生成介于min和max两个数之间的一个随机整数
}
return $str;
} 
} </pre>
</div>
<p><span style="color: #0000ff"><strong>2.共享内存操作类</strong></span><br />
</p>
<p>　　这个相对简单，使用php的shmop扩展即可。<br />
</p>
<div class="phpstudycode">
<pre class="brush:php;">
class ShareMemory{
private $mode = 0644;
private $shm_key;
private $shm_size;
/**
* 构造函数 
*/
public function __construct(){
$key = 'F';
$size = 1024*1024;
$this-&gt;shm_key = ftok(__FILE__,$key);
$this-&gt;shm_size = $size + 1;
}
/**
* 读取内存数组
* @return array|boolean
*/
public function read(){
if(($shm_id = shmop_open($this-&gt;shm_key,'c',$this-&gt;mode,$this-&gt;shm_size)) !== false){
$str = shmop_read($shm_id,1,$this-&gt;shm_size-1);
shmop_close($shm_id);
if(($i = strpos($str,"\0")) !== false)$str = substr($str,0,$i);
if($str){
return json_decode($str,true);
}else{
return array();
}
}
return false;
}
/**
* 写入数组到内存
* @param array $arr
* @return int|boolean
*/
public function write($arr){
if(!is_array($arr))return false;
$str = json_encode($arr)."\0";
if(strlen($str) &gt; $this-&gt;shm_size) return false;
if(($shm_id = shmop_open($this-&gt;shm_key,'c',$this-&gt;mode,$this-&gt;shm_size)) !== false){ 
$count = shmop_write($shm_id,$str,1);
shmop_close($shm_id);
return $count;
}
return false;
}
/**
* 删除内存块，下次使用时将重新开辟内存块
* @return boolean
*/
public function delete(){
if(($shm_id = shmop_open($this-&gt;shm_key,'c',$this-&gt;mode,$this-&gt;shm_size)) !== false){
$result = shmop_delete($shm_id);
shmop_close($shm_id);
return $result;
}
return false;
}
} </pre>
</div>
<p><span style="color: #0000ff"><strong>3.内置的web服务器类</strong></span><br />
</p>
<p>　　这个主要是嵌入在ftp的http服务器类，功能不是很完善，进行ftp的管理还是可行的。不过需要注意的是，这个实现与apache等其他http服务器运行的方式可能有所不同。代码是驻留内存的。<br />
</p>
<p></p>
<div class="phpstudycode">
<pre class="brush:php;">
class CWebServer{
protected $buffer_header = array();
protected $buffer_maxlen = 65535; //最大POST尺寸
const DATE_FORMAT_HTTP = 'D, d-M-Y H:i:s T';
const HTTP_EOF = "\r\n\r\n";
const HTTP_HEAD_MAXLEN = 8192; //http头最大长度不得超过2k
const HTTP_POST_MAXLEN = 1048576;//1m
const ST_FINISH = 1; //完成，进入处理流程
const ST_WAIT = 2; //等待数据
const ST_ERROR = 3; //错误，丢弃此包
private $requsts = array();
private $config = array();
public function log($msg,$level = 'debug'){
echo date('Y-m-d H:i:s').' ['.$level."]\t" .$msg."\n";
}
public function __construct($config = array()){
$this-&gt;config = array(
'wwwroot' =&gt; __DIR__.'/wwwroot/',
'index' =&gt; 'index.php',
'path_deny' =&gt; array('/protected/'), 
); 
}
public function onReceive($serv,$fd,$data){ 
$ret = $this-&gt;checkData($fd, $data);
switch ($ret){
case self::ST_ERROR:
$serv-&gt;close($fd);
$this-&gt;cleanBuffer($fd);
$this-&gt;log('Recevie error.');
break;
case self::ST_WAIT: 
$this-&gt;log('Recevie wait.');
return;
default:
break;
}
//开始完整的请求
$request = $this-&gt;requsts[$fd];
$info = $serv-&gt;connection_info($fd); 
$request = $this-&gt;parseRequest($request);
$request['remote_ip'] = $info['remote_ip'];
$response = $this-&gt;onRequest($request);
$output = $this-&gt;parseResponse($request,$response);
$serv-&gt;send($fd,$output);
if(isset($request['head']['Connection']) && strtolower($request['head']['Connection']) == 'close'){
$serv-&gt;close($fd);
}
unset($this-&gt;requsts[$fd]);
$_REQUEST = $_SESSION = $_COOKIE = $_FILES = $_POST = $_SERVER = $_GET = array();
}
/**
* 处理请求
* @param array $request
* @return array $response
* 
* $request=array(
* 'time'=&gt;
* 'head'=&gt;array(
* 'method'=&gt;
* 'path'=&gt;
* 'protocol'=&gt;
* 'uri'=&gt;
* //other http header
* '..'=&gt;value
* )
* 'body'=&gt;
* 'get'=&gt;(if appropriate)
* 'post'=&gt;(if appropriate)
* 'cookie'=&gt;(if appropriate)
* 
* 
* )
*/
public function onRequest($request){ 
if($request['head']['path'][strlen($request['head']['path']) - 1] == '/'){
$request['head']['path'] .= $this-&gt;config['index'];
}
$response = $this-&gt;process($request);
return $response;
} 
/**
* 清除数据
* @param unknown $fd
*/
public function cleanBuffer($fd){
unset($this-&gt;requsts[$fd]);
unset($this-&gt;buffer_header[$fd]);
}
/**
* 检查数据
* @param unknown $fd
* @param unknown $data
* @return string
*/
public function checkData($fd,$data){
if(isset($this-&gt;buffer_header[$fd])){
$data = $this-&gt;buffer_header[$fd].$data;
}
$request = $this-&gt;checkHeader($fd, $data);
//请求头错误
if($request === false){
$this-&gt;buffer_header[$fd] = $data;
if(strlen($data) &gt; self::HTTP_HEAD_MAXLEN){
return self::ST_ERROR;
}else{
return self::ST_WAIT;
}
}
//post请求检查
if($request['head']['method'] == 'POST'){
return $this-&gt;checkPost($request);
}else{
return self::ST_FINISH;
} 
}
/**
* 检查请求头
* @param unknown $fd
* @param unknown $data
* @return boolean|array
*/
public function checkHeader($fd, $data){
//新的请求
if(!isset($this-&gt;requsts[$fd])){
//http头结束符
$ret = strpos($data,self::HTTP_EOF);
if($ret === false){
return false;
}else{
$this-&gt;buffer_header[$fd] = '';
$request = array();
list($header,$request['body']) = explode(self::HTTP_EOF, $data,2); 
$request['head'] = $this-&gt;parseHeader($header); 
$this-&gt;requsts[$fd] = $request;
if($request['head'] == false){
return false;
}
}
}else{
//post 数据合并
$request = $this-&gt;requsts[$fd];
$request['body'] .= $data;
}
return $request;
}
/**
* 解析请求头
* @param string $header
* @return array
* array(
* 'method'=&gt;,
* 'uri'=&gt;
* 'protocol'=&gt;
* 'name'=&gt;value,...
* 
* 
* 
* }
*/
public function parseHeader($header){
$request = array();
$headlines = explode("\r\n", $header);
list($request['method'],$request['uri'],$request['protocol']) = explode(' ', $headlines[0],3); 
foreach ($headlines as $k=&gt;$line){
$line = trim($line); 
if($k && !empty($line) && strpos($line,':') !== false){
list($name,$value) = explode(':', $line,2);
$request[trim($name)] = trim($value);
}
} 
return $request;
}
/**
* 检查post数据是否完整
* @param unknown $request
* @return string
*/
public function checkPost($request){
if(isset($request['head']['Content-Length'])){
if(intval($request['head']['Content-Length']) &gt; self::HTTP_POST_MAXLEN){
return self::ST_ERROR;
}
if(intval($request['head']['Content-Length']) &gt; strlen($request['body'])){
return self::ST_WAIT;
}else{
return self::ST_FINISH;
}
}
return self::ST_ERROR;
}
/**
* 解析请求
* @param unknown $request
* @return Ambigous &lt;unknown, mixed, multitype:string &gt;
*/
public function parseRequest($request){
$request['time'] = time();
$url_info = parse_url($request['head']['uri']);
$request['head']['path'] = $url_info['path'];
if(isset($url_info['fragment']))$request['head']['fragment'] = $url_info['fragment'];
if(isset($url_info['query'])){
parse_str($url_info['query'],$request['get']);
}
//parse post body
if($request['head']['method'] == 'POST'){
//目前只处理表单提交 
if (isset($request['head']['Content-Type']) && substr($request['head']['Content-Type'], 0, 33) == 'application/x-www-form-urlencoded'
|| isset($request['head']['X-Request-With']) && $request['head']['X-Request-With'] == 'XMLHttpRequest'){
parse_str($request['body'],$request['post']);
}
}
//parse cookies
if(!empty($request['head']['Cookie'])){
$params = array();
$blocks = explode(";", $request['head']['Cookie']);
foreach ($blocks as $b){
$_r = explode("=", $b, 2);
if(count($_r)==2){
list ($key, $value) = $_r;
$params[trim($key)] = trim($value, "\r\n \t\"");
}else{
$params[$_r[0]] = '';
}
}
$request['cookie'] = $params;
}
return $request;
}
public function parseResponse($request,$response){
if(!isset($response['head']['Date'])){
$response['head']['Date'] = gmdate("D, d M Y H:i:s T");
}
if(!isset($response['head']['Content-Type'])){
$response['head']['Content-Type'] = 'text/html;charset=utf-8';
}
if(!isset($response['head']['Content-Length'])){
$response['head']['Content-Length'] = strlen($response['body']);
}
if(!isset($response['head']['Connection'])){
if(isset($request['head']['Connection']) && strtolower($request['head']['Connection']) == 'keep-alive'){
$response['head']['Connection'] = 'keep-alive';
}else{
$response['head']['Connection'] = 'close';
} 
}
$response['head']['Server'] = CFtpServer::$software.'/'.CFtpServer::VERSION; 
$out = '';
if(isset($response['head']['Status'])){
$out .= 'HTTP/1.1 '.$response['head']['Status']."\r\n";
unset($response['head']['Status']);
}else{
$out .= "HTTP/1.1 200 OK\r\n";
}
//headers
foreach($response['head'] as $k=&gt;$v){
$out .= $k.': '.$v."\r\n";
}
//cookies
if($_COOKIE){ 
$arr = array();
foreach ($_COOKIE as $k =&gt; $v){
$arr[] = $k.'='.$v; 
}
$out .= 'Set-Cookie: '.implode(';', $arr)."\r\n";
}
//End
$out .= "\r\n";
$out .= $response['body'];
return $out;
}
/**
* 处理请求
* @param unknown $request
* @return array
*/
public function process($request){
$path = $request['head']['path'];
$isDeny = false;
foreach ($this-&gt;config['path_deny'] as $p){
if(strpos($path, $p) === 0){
$isDeny = true;
break;
}
}
if($isDeny){
return $this-&gt;httpError(403, '服务器拒绝访问:路径错误'); 
}
if(!in_array($request['head']['method'],array('GET','POST'))){
return $this-&gt;httpError(500, '服务器拒绝访问:错误的请求方法');
}
$file_ext = strtolower(trim(substr(strrchr($path, '.'), 1)));
$path = realpath(rtrim($this-&gt;config['wwwroot'],'/'). '/' . ltrim($path,'/'));
$this-&gt;log('WEB:['.$request['head']['method'].'] '.$request['head']['uri'] .' '.json_encode(isset($request['post'])&#63;$request['post']:array()));
$response = array();
if($file_ext == 'php'){
if(is_file($path)){
//设置全局变量 
if(isset($request['get']))$_GET = $request['get'];
if(isset($request['post']))$_POST = $request['post'];
if(isset($request['cookie']))$_COOKIE = $request['cookie'];
$_REQUEST = array_merge($_GET,$_POST, $_COOKIE); 
foreach ($request['head'] as $key =&gt; $value){
$_key = 'HTTP_'.strtoupper(str_replace('-', '_', $key));
$_SERVER[$_key] = $value;
}
$_SERVER['REMOTE_ADDR'] = $request['remote_ip'];
$_SERVER['REQUEST_URI'] = $request['head']['uri']; 
//进行http auth
if(isset($_GET['c']) && strtolower($_GET['c']) != 'site'){
if(isset($request['head']['Authorization'])){
$user = new User();
if($user-&gt;checkUserBasicAuth($request['head']['Authorization'])){
$response['head']['Status'] = self::$HTTP_HEADERS[200];
goto process;
}
}
$response['head']['Status'] = self::$HTTP_HEADERS[401];
$response['head']['WWW-Authenticate'] = 'Basic realm="Real-Data-FTP"'; 
$_GET['c'] = 'Site';
$_GET['a'] = 'Unauthorized'; 
}
process: 
ob_start(); 
try{
include $path; 
$response['body'] = ob_get_contents();
$response['head']['Content-Type'] = APP::$content_type; 
}catch (Exception $e){
$response = $this-&gt;httpError(500, $e-&gt;getMessage());
}
ob_end_clean();
}else{
$response = $this-&gt;httpError(404, '页面不存在');
}
}else{
//处理静态文件
if(is_file($path)){
$response['head']['Content-Type'] = isset(self::$MIME_TYPES[$file_ext]) &#63; self::$MIME_TYPES[$file_ext]:"application/octet-stream";
//使用缓存
if(!isset($request['head']['If-Modified-Since'])){
$fstat = stat($path);
$expire = 2592000;//30 days
$response['head']['Status'] = self::$HTTP_HEADERS[200];
$response['head']['Cache-Control'] = "max-age={$expire}";
$response['head']['Pragma'] = "max-age={$expire}";
$response['head']['Last-Modified'] = date(self::DATE_FORMAT_HTTP, $fstat['mtime']);
$response['head']['Expires'] = "max-age={$expire}";
$response['body'] = file_get_contents($path);
}else{
$response['head']['Status'] = self::$HTTP_HEADERS[304];
$response['body'] = '';
} 
}else{
$response = $this-&gt;httpError(404, '页面不存在');
} 
}
return $response;
}
public function httpError($code, $content){
$response = array();
$version = CFtpServer::$software.'/'.CFtpServer::VERSION; 
$response['head']['Content-Type'] = 'text/html;charset=utf-8';
$response['head']['Status'] = self::$HTTP_HEADERS[$code];
$response['body'] = &lt;&lt;&lt;html
&lt;!DOCTYPE html&gt;
&lt;html lang="zh-CN"&gt;
&lt;head&gt;
&lt;meta charset="utf-8"&gt; 
&lt;title&gt;FTP后台管理 &lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;p&gt;{$content}&lt;/p&gt;
&lt;div style="text-align:center"&gt;
&lt;hr&gt;
{$version} Copyright &copy; 2015 by &lt;a target='_new' href='http://www.realdatamed.com'&gt;Real Data&lt;/a&gt; All Rights Reserved.
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
html;
return $response;
}
static $HTTP_HEADERS = array(
100 =&gt; "100 Continue",
101 =&gt; "101 Switching Protocols",
200 =&gt; "200 OK",
201 =&gt; "201 Created",
204 =&gt; "204 No Content",
206 =&gt; "206 Partial Content",
300 =&gt; "300 Multiple Choices",
301 =&gt; "301 Moved Permanently",
302 =&gt; "302 Found",
303 =&gt; "303 See Other",
304 =&gt; "304 Not Modified",
307 =&gt; "307 Temporary Redirect",
400 =&gt; "400 Bad Request",
401 =&gt; "401 Unauthorized",
403 =&gt; "403 Forbidden",
404 =&gt; "404 Not Found",
405 =&gt; "405 Method Not Allowed",
406 =&gt; "406 Not Acceptable",
408 =&gt; "408 Request Timeout",
410 =&gt; "410 Gone",
413 =&gt; "413 Request Entity Too Large",
414 =&gt; "414 Request URI Too Long",
415 =&gt; "415 Unsupported Media Type",
416 =&gt; "416 Requested Range Not Satisfiable",
417 =&gt; "417 Expectation Failed",
500 =&gt; "500 Internal Server Error",
501 =&gt; "501 Method Not Implemented",
503 =&gt; "503 Service Unavailable",
506 =&gt; "506 Variant Also Negotiates",
);
static $MIME_TYPES = array( 
'jpg' =&gt; 'image/jpeg',
'bmp' =&gt; 'image/bmp',
'ico' =&gt; 'image/x-icon',
'gif' =&gt; 'image/gif',
'png' =&gt; 'image/png' ,
'bin' =&gt; 'application/octet-stream',
'js' =&gt; 'application/javascript',
'css' =&gt; 'text/css' ,
'html' =&gt; 'text/html' ,
'xml' =&gt; 'text/xml',
'tar' =&gt; 'application/x-tar' ,
'ppt' =&gt; 'application/vnd.ms-powerpoint',
'pdf' =&gt; 'application/pdf' ,
'svg' =&gt; ' image/svg+xml',
'woff' =&gt; 'application/x-font-woff',
'woff2' =&gt; 'application/x-font-woff', 
); 
} </pre>
</div>
<p><span style="color: #0000ff"><strong>4.FTP主类<br />
</strong></span></p>
<p>　　有了前面类，就可以在ftp进行引用了。使用ssl时，请注意进行防火墙passive 端口范围的nat配置。　<br />
</p>
<div class="phpstudycode">
<pre class="brush:php;">
defined('DEBUG_ON') or define('DEBUG_ON', false);
//主目录
defined('BASE_PATH') or define('BASE_PATH', __DIR__);
require_once BASE_PATH.'/inc/User.php';
require_once BASE_PATH.'/inc/ShareMemory.php';
require_once BASE_PATH.'/web/CWebServer.php';
require_once BASE_PATH.'/inc/CSmtp.php';
class CFtpServer{
//软件版本
const VERSION = '2.0'; 
const EOF = "\r\n"; 
public static $software "FTP-Server";
private static $server_mode = SWOOLE_PROCESS; 
private static $pid_file;
private static $log_file; 
//待写入文件的日志队列（缓冲区）
private $queue = array();
private $pasv_port_range = array(55000,60000);
public $host = '0.0.0.0';
public $port = 21;
public $setting = array();
//最大连接数
public $max_connection = 50; 
//web管理端口
public $manager_port = 8080;
//tls
public $ftps_port = 990;
/**
* @var swoole_server
*/
protected $server;
protected $connection = array();
protected $session = array();
protected $user;//用户类，复制验证与权限
//共享内存类
protected $shm;//ShareMemory
/**
* 
* @var embedded http server
*/
protected $webserver;
/*+++++++++++++++++++++++++++++++++++++++++++++++++++++++++
+ 静态方法
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/
public static function setPidFile($pid_file){
self::$pid_file = $pid_file;
}
/**
* 服务启动控制方法
*/
public static function start($startFunc){
if(empty(self::$pid_file)){
exit("Require pid file.\n"); 
}
if(!extension_loaded('posix')){ 
exit("Require extension `posix`.\n"); 
}
if(!extension_loaded('swoole')){ 
exit("Require extension `swoole`.\n"); 
}
if(!extension_loaded('shmop')){
exit("Require extension `shmop`.\n");
}
if(!extension_loaded('openssl')){
exit("Require extension `openssl`.\n");
}
$pid_file = self::$pid_file;
$server_pid = 0;
if(is_file($pid_file)){
$server_pid = file_get_contents($pid_file);
}
global $argv;
if(empty($argv[1])){
goto usage;
}elseif($argv[1] == 'reload'){
if (empty($server_pid)){
exit("FtpServer is not running\n");
}
posix_kill($server_pid, SIGUSR1);
exit;
}elseif ($argv[1] == 'stop'){
if (empty($server_pid)){
exit("FtpServer is not running\n");
}
posix_kill($server_pid, SIGTERM);
exit;
}elseif ($argv[1] == 'start'){
//已存在ServerPID，并且进程存在
if (!empty($server_pid) and posix_kill($server_pid,(int) 0)){
exit("FtpServer is already running.\n");
}
//启动服务器
$startFunc(); 
}else{
usage:
exit("Usage: php {$argv[0]} start|stop|reload\n");
}
}
/*+++++++++++++++++++++++++++++++++++++++++++++++++++++++++
+ 方法
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/
public function __construct($host,$port){
$this-&gt;user = new User();
$this-&gt;shm = new ShareMemory();
$this-&gt;shm-&gt;write(array());
$flag = SWOOLE_SOCK_TCP;
$this-&gt;server = new swoole_server($host,$port,self::$server_mode,$flag);
$this-&gt;host = $host;
$this-&gt;port = $port;
$this-&gt;setting = array(
'backlog' =&gt; 128, 
'dispatch_mode' =&gt; 2,
); 
}
public function daemonize(){
$this-&gt;setting['daemonize'] = 1; 
}
public function getConnectionInfo($fd){
return $this-&gt;server-&gt;connection_info($fd); 
}
/**
* 启动服务进程
* @param array $setting
* @throws Exception
*/ 
public function run($setting = array()){
$this-&gt;setting = array_merge($this-&gt;setting,$setting); 
//不使用swoole的默认日志
if(isset($this-&gt;setting['log_file'])){
self::$log_file = $this-&gt;setting['log_file'];
unset($this-&gt;setting['log_file']);
} 
if(isset($this-&gt;setting['max_connection'])){
$this-&gt;max_connection = $this-&gt;setting['max_connection'];
unset($this-&gt;setting['max_connection']);
}
if(isset($this-&gt;setting['manager_port'])){
$this-&gt;manager_port = $this-&gt;setting['manager_port'];
unset($this-&gt;setting['manager_port']);
}
if(isset($this-&gt;setting['ftps_port'])){
$this-&gt;ftps_port = $this-&gt;setting['ftps_port'];
unset($this-&gt;setting['ftps_port']);
}
if(isset($this-&gt;setting['passive_port_range'])){
$this-&gt;pasv_port_range = $this-&gt;setting['passive_port_range'];
unset($this-&gt;setting['passive_port_range']);
} 
$this-&gt;server-&gt;set($this-&gt;setting);
$version = explode('.', SWOOLE_VERSION);
if($version[0] == 1 && $version[1] &lt; 7 && $version[2] &lt;20){
throw new Exception('Swoole version require 1.7.20 +.');
}
//事件绑定
$this-&gt;server-&gt;on('start',array($this,'onMasterStart'));
$this-&gt;server-&gt;on('shutdown',array($this,'onMasterStop'));
$this-&gt;server-&gt;on('ManagerStart',array($this,'onManagerStart'));
$this-&gt;server-&gt;on('ManagerStop',array($this,'onManagerStop'));
$this-&gt;server-&gt;on('WorkerStart',array($this,'onWorkerStart'));
$this-&gt;server-&gt;on('WorkerStop',array($this,'onWorkerStop'));
$this-&gt;server-&gt;on('WorkerError',array($this,'onWorkerError'));
$this-&gt;server-&gt;on('Connect',array($this,'onConnect'));
$this-&gt;server-&gt;on('Receive',array($this,'onReceive'));
$this-&gt;server-&gt;on('Close',array($this,'onClose'));
//管理端口
$this-&gt;server-&gt;addlistener($this-&gt;host,$this-&gt;manager_port,SWOOLE_SOCK_TCP);
//tls
$this-&gt;server-&gt;addlistener($this-&gt;host,$this-&gt;ftps_port,SWOOLE_SOCK_TCP | SWOOLE_SSL);
$this-&gt;server-&gt;start();
}
public function log($msg,$level = 'debug',$flush = false){ 
if(DEBUG_ON){
$log = date('Y-m-d H:i:s').' ['.$level."]\t" .$msg."\n";
if(!empty(self::$log_file)){
$debug_file = dirname(self::$log_file).'/debug.log'; 
file_put_contents($debug_file, $log,FILE_APPEND);
if(filesize($debug_file) &gt; 10485760){//10M
unlink($debug_file);
}
}
echo $log; 
}
if($level != 'debug'){
//日志记录 
$this-&gt;queue[] = date('Y-m-d H:i:s')."\t[".$level."]\t".$msg; 
} 
if(count($this-&gt;queue)&gt;10 && !empty(self::$log_file) || $flush){
if (filesize(self::$log_file) &gt; 209715200){ //200M 
rename(self::$log_file,self::$log_file.'.'.date('His'));
}
$logs = '';
foreach ($this-&gt;queue as $q){
$logs .= $q."\n";
}
file_put_contents(self::$log_file, $logs,FILE_APPEND);
$this-&gt;queue = array();
} 
}
public function shutdown(){
return $this-&gt;server-&gt;shutdown();
}
public function close($fd){
return $this-&gt;server-&gt;close($fd);
}
public function send($fd,$data){
$data = strtr($data,array("\n" =&gt; "", "\0" =&gt; "", "\r" =&gt; ""));
$this-&gt;log("[--&gt;]\t" . $data);
return $this-&gt;server-&gt;send($fd,$data.self::EOF);
}
/*+++++++++++++++++++++++++++++++++++++++++++++++++++++++++
+ 事件回调
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/
public function onMasterStart($serv){
global $argv;
swoole_set_process_name('php '.$argv[0].': master -host='.$this-&gt;host.' -port='.$this-&gt;port.'/'.$this-&gt;manager_port);
if(!empty($this-&gt;setting['pid_file'])){
file_put_contents(self::$pid_file, $serv-&gt;master_pid);
}
$this-&gt;log('Master started.');
}
public function onMasterStop($serv){
if (!empty($this-&gt;setting['pid_file'])){
unlink(self::$pid_file);
}
$this-&gt;shm-&gt;delete();
$this-&gt;log('Master stop.');
}
public function onManagerStart($serv){
global $argv;
swoole_set_process_name('php '.$argv[0].': manager');
$this-&gt;log('Manager started.');
}
public function onManagerStop($serv){
$this-&gt;log('Manager stop.');
}
public function onWorkerStart($serv,$worker_id){
global $argv;
if($worker_id &gt;= $serv-&gt;setting['worker_num']) {
swoole_set_process_name("php {$argv[0]}: worker [task]");
} else {
swoole_set_process_name("php {$argv[0]}: worker [{$worker_id}]");
}
$this-&gt;log("Worker {$worker_id} started.");
}
public function onWorkerStop($serv,$worker_id){
$this-&gt;log("Worker {$worker_id} stop.");
}
public function onWorkerError($serv,$worker_id,$worker_pid,$exit_code){
$this-&gt;log("Worker {$worker_id} error:{$exit_code}.");
}
public function onConnect($serv,$fd,$from_id){
$info = $this-&gt;getConnectionInfo($fd);
if($info['server_port'] == $this-&gt;manager_port){
//web请求
$this-&gt;webserver = new CWebServer();
}else{
$this-&gt;send($fd, "220---------- Welcome to " . self::$software . " ----------");
$this-&gt;send($fd, "220-Local time is now " . date("H:i"));
$this-&gt;send($fd, "220 This is a private system - No anonymous login");
if(count($this-&gt;server-&gt;connections) &lt;= $this-&gt;max_connection){
if($info['server_port'] == $this-&gt;port && isset($this-&gt;setting['force_ssl']) && $this-&gt;setting['force_ssl']){
//如果启用强制ssl 
$this-&gt;send($fd, "421 Require implicit FTP over tls, closing control connection.");
$this-&gt;close($fd);
return ;
}
$this-&gt;connection[$fd] = array();
$this-&gt;session = array();
$this-&gt;queue = array(); 
}else{ 
$this-&gt;send($fd, "421 Too many connections, closing control connection.");
$this-&gt;close($fd);
}
}
}
public function onReceive($serv,$fd,$from_id,$recv_data){
$info = $this-&gt;getConnectionInfo($fd);
if($info['server_port'] == $this-&gt;manager_port){
//web请求
$this-&gt;webserver-&gt;onReceive($this-&gt;server, $fd, $recv_data);
}else{
$read = trim($recv_data);
$this-&gt;log("[&lt;--]\t" . $read);
$cmd = explode(" ", $read); 
$func = 'cmd_'.strtoupper($cmd[0]);
$data = trim(str_replace($cmd[0], '', $read));
if (!method_exists($this, $func)){
$this-&gt;send($fd, "500 Unknown Command");
return;
}
if (empty($this-&gt;connection[$fd]['login'])){
switch($cmd[0]){
case 'TYPE':
case 'USER':
case 'PASS':
case 'QUIT':
case 'AUTH':
case 'PBSZ':
break;
default:
$this-&gt;send($fd,"530 You aren't logged in");
return;
}
}
$this-&gt;$func($fd,$data);
}
} 
public function onClose($serv,$fd,$from_id){
//在线用户 
$shm_data = $this-&gt;shm-&gt;read();
if($shm_data !== false){
if(isset($shm_data['online'])){
$list = array();
foreach($shm_data['online'] as $u =&gt; $info){ 
if(!preg_match('/\.*-'.$fd.'$/',$u,$m))
$list[$u] = $info;
}
$shm_data['online'] = $list;
$this-&gt;shm-&gt;write($shm_data); 
} 
}
$this-&gt;log('Socket '.$fd.' close. Flush the logs.','debug',true);
}
/*+++++++++++++++++++++++++++++++++++++++++++++++++++++++++
+ 工具函数
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/ 
/**
* 获取用户名
* @param $fd
*/
public function getUser($fd){
return isset($this-&gt;connection[$fd]['user'])&#63;$this-&gt;connection[$fd]['user']:'';
}
/**
* 获取文件全路径
* @param $user
* @param $file
* @return string|boolean
*/
public function getFile($user, $file){
$file = $this-&gt;fillDirName($user, $file); 
if (is_file($file)){
return realpath($file);
}else{
return false;
}
}
/**
* 遍历目录
* @param $rdir
* @param $showHidden
* @param $format list/mlsd
* @return string
* 
* list 使用local时间
* mlsd 使用gmt时间
*/
public function getFileList($user, $rdir, $showHidden = false, $format = 'list'){
$filelist = '';
if($format == 'mlsd'){
$stats = stat($rdir);
$filelist.= 'Type=cdir;Modify='.gmdate('YmdHis',$stats['mtime']).';UNIX.mode=d'.$this-&gt;mode2char($stats['mode']).'; '.$this-&gt;getUserDir($user)."\r\n";
}
if ($handle = opendir($rdir)){
$isListable = $this-&gt;user-&gt;isFolderListable($user, $rdir);
while (false !== ($file = readdir($handle))){
if ($file == '.' or $file == '..'){
continue;
}
if ($file{0} == "." and !$showHidden){
continue;
}
//如果当前目录$rdir不允许列出，则判断当前目录下的目录是否配置为可以列出 
if(!$isListable){ 
$dir = $rdir . $file;
if(is_dir($dir)){
$dir = $this-&gt;joinPath($dir, '/');
if($this-&gt;user-&gt;isFolderListable($user, $dir)){ 
goto listFolder;
}
}
continue;
} 
listFolder: 
$stats = stat($rdir . $file);
if (is_dir($rdir . "/" . $file)) $mode = "d"; else $mode = "-";
$mode .= $this-&gt;mode2char($stats['mode']);
if($format == 'mlsd'){
if($mode[0] == 'd'){
$filelist.= 'Type=dir;Modify='.gmdate('YmdHis',$stats['mtime']).';UNIX.mode='.$mode.'; '.$file."\r\n";
}else{
$filelist.= 'Type=file;Size='.$stats['size'].';Modify='.gmdate('YmdHis',$stats['mtime']).';UNIX.mode='.$mode.'; '.$file."\r\n";
}
}else{
$uidfill = "";
for ($i = strlen($stats['uid']); $i &lt; 5; $i++) $uidfill .= " ";
$gidfill = "";
for ($i = strlen($stats['gid']); $i &lt; 5; $i++) $gidfill .= " ";
$sizefill = "";
for ($i = strlen($stats['size']); $i &lt; 11; $i++) $sizefill .= " ";
$nlinkfill = "";
for ($i = strlen($stats['nlink']); $i &lt; 5; $i++) $nlinkfill .= " ";
$mtime = date("M d H:i", $stats['mtime']);
$filelist .= $mode . $nlinkfill . $stats['nlink'] . " " . $stats['uid'] . $uidfill . $stats['gid'] . $gidfill . $sizefill . $stats['size'] . " " . $mtime . " " . $file . "\r\n";
}
}
closedir($handle);
}
return $filelist;
}
/**
* 将文件的全新从数字转换为字符串
* @param int $int
*/
public function mode2char($int){
$mode = '';
$moded = sprintf("%o", ($int & 000777));
$mode1 = substr($moded, 0, 1);
$mode2 = substr($moded, 1, 1);
$mode3 = substr($moded, 2, 1);
switch ($mode1) {
case "0":
$mode .= "---";
break;
case "1":
$mode .= "--x";
break;
case "2":
$mode .= "-w-";
break;
case "3":
$mode .= "-wx";
break;
case "4":
$mode .= "r--";
break;
case "5":
$mode .= "r-x";
break;
case "6":
$mode .= "rw-";
break;
case "7":
$mode .= "rwx";
break;
}
switch ($mode2) {
case "0":
$mode .= "---";
break;
case "1":
$mode .= "--x";
break;
case "2":
$mode .= "-w-";
break;
case "3":
$mode .= "-wx";
break;
case "4":
$mode .= "r--";
break;
case "5":
$mode .= "r-x";
break;
case "6":
$mode .= "rw-";
break;
case "7":
$mode .= "rwx";
break;
}
switch ($mode3) {
case "0":
$mode .= "---";
break;
case "1":
$mode .= "--x";
break;
case "2":
$mode .= "-w-";
break;
case "3":
$mode .= "-wx";
break;
case "4":
$mode .= "r--";
break;
case "5":
$mode .= "r-x";
break;
case "6":
$mode .= "rw-";
break;
case "7":
$mode .= "rwx";
break;
}
return $mode;
}
/**
* 设置用户当前的路径 
* @param $user
* @param $pwd
*/
public function setUserDir($user, $cdir){
$old_dir = $this-&gt;session[$user]['pwd'];
if ($old_dir == $cdir){
return $cdir;
} 
if($cdir[0] != '/')
$cdir = $this-&gt;joinPath($old_dir,$cdir); 
$this-&gt;session[$user]['pwd'] = $cdir;
$abs_dir = realpath($this-&gt;getAbsDir($user));
if (!$abs_dir){
$this-&gt;session[$user]['pwd'] = $old_dir;
return false;
}
$this-&gt;session[$user]['pwd'] = $this-&gt;joinPath('/',substr($abs_dir, strlen($this-&gt;session[$user]['home'])));
$this-&gt;session[$user]['pwd'] = $this-&gt;joinPath($this-&gt;session[$user]['pwd'],'/');
$this-&gt;log("CHDIR: $old_dir -&gt; $cdir");
return $this-&gt;session[$user]['pwd'];
}
/**
* 获取全路径
* @param $user
* @param $file
* @return string
*/
public function fillDirName($user, $file){ 
if (substr($file, 0, 1) != "/"){
$file = '/'.$file;
$file = $this-&gt;joinPath($this-&gt;getUserDir( $user), $file);
} 
$file = $this-&gt;joinPath($this-&gt;session[$user]['home'],$file);
return $file;
}
/**
* 获取用户路径
* @param unknown $user
*/
public function getUserDir($user){
return $this-&gt;session[$user]['pwd'];
}
/**
* 获取用户的当前文件系统绝对路径，非chroot路径
* @param $user
* @return string
*/
public function getAbsDir($user){
$rdir = $this-&gt;joinPath($this-&gt;session[$user]['home'],$this-&gt;session[$user]['pwd']);
return $rdir;
}
/**
* 路径连接
* @param string $path1
* @param string $path2
* @return string
*/
public function joinPath($path1,$path2){ 
$path1 = rtrim($path1,'/');
$path2 = trim($path2,'/');
return $path1.'/'.$path2;
}
/**
* IP判断
* @param string $ip
* @return boolean
*/
public function isIPAddress($ip){
if (!is_numeric($ip[0]) || $ip[0] &lt; 1 || $ip[0] &gt; 254) {
return false;
} elseif (!is_numeric($ip[1]) || $ip[1] &lt; 0 || $ip[1] &gt; 254) {
return false;
} elseif (!is_numeric($ip[2]) || $ip[2] &lt; 0 || $ip[2] &gt; 254) {
return false;
} elseif (!is_numeric($ip[3]) || $ip[3] &lt; 1 || $ip[3] &gt; 254) {
return false;
} elseif (!is_numeric($ip[4]) || $ip[4] &lt; 1 || $ip[4] &gt; 500) {
return false;
} elseif (!is_numeric($ip[5]) || $ip[5] &lt; 1 || $ip[5] &gt; 500) {
return false;
} else {
return true;
}
}
/**
* 获取pasv端口
* @return number
*/
public function getPasvPort(){
$min = is_int($this-&gt;pasv_port_range[0])&#63;$this-&gt;pasv_port_range[0]:55000;
$max = is_int($this-&gt;pasv_port_range[1])&#63;$this-&gt;pasv_port_range[1]:60000;
$max = $max &lt;= 65535 &#63; $max : 65535;
$loop = 0;
$port = 0;
while($loop &lt; 10){
$port = mt_rand($min, $max);
if($this-&gt;isAvailablePasvPort($port)){ 
break;
}
$loop++;
} 
return $port;
}
public function pushPasvPort($port){
$shm_data = $this-&gt;shm-&gt;read();
if($shm_data !== false){
if(isset($shm_data['pasv_port'])){
array_push($shm_data['pasv_port'], $port);
}else{
$shm_data['pasv_port'] = array($port);
}
$this-&gt;shm-&gt;write($shm_data);
$this-&gt;log('Push pasv port: '.implode(',', $shm_data['pasv_port']));
return true;
}
return false;
}
public function popPasvPort($port){
$shm_data = $this-&gt;shm-&gt;read();
if($shm_data !== false){
if(isset($shm_data['pasv_port'])){
$tmp = array();
foreach ($shm_data['pasv_port'] as $p){
if($p != $port){
$tmp[] = $p;
}
}
$shm_data['pasv_port'] = $tmp;
}
$this-&gt;shm-&gt;write($shm_data);
$this-&gt;log('Pop pasv port: '.implode(',', $shm_data['pasv_port']));
return true;
}
return false;
}
public function isAvailablePasvPort($port){
$shm_data = $this-&gt;shm-&gt;read();
if($shm_data !== false){
if(isset($shm_data['pasv_port'])){
return !in_array($port, $shm_data['pasv_port']);
}
return true;
}
return false;
}
/**
* 获取当前数据链接tcp个数
*/
public function getDataConnections(){
$shm_data = $this-&gt;shm-&gt;read();
if($shm_data !== false){
if(isset($shm_data['pasv_port'])){
return count($shm_data['pasv_port']);
} 
}
return 0;
} 
/**
* 关闭数据传输socket
* @param $user
* @return bool
*/
public function closeUserSock($user){
$peer = stream_socket_get_name($this-&gt;session[$user]['sock'], false);
list($ip,$port) = explode(':', $peer);
//释放端口占用
$this-&gt;popPasvPort($port);
fclose($this-&gt;session[$user]['sock']);
$this-&gt;session[$user]['sock'] = 0;
return true;
}
/**
* @param $user
* @return resource
*/
public function getUserSock($user){
//被动模式
if ($this-&gt;session[$user]['pasv'] == true){
if (empty($this-&gt;session[$user]['sock'])){
$addr = stream_socket_get_name($this-&gt;session[$user]['serv_sock'], false);
list($ip, $port) = explode(':', $addr);
$sock = stream_socket_accept($this-&gt;session[$user]['serv_sock'], 5);
if ($sock){
$peer = stream_socket_get_name($sock, true);
$this-&gt;log("Accept: success client is $peer.");
$this-&gt;session[$user]['sock'] = $sock;
//关闭server socket
fclose($this-&gt;session[$user]['serv_sock']);
}else{
$this-&gt;log("Accept: failed.");
//释放端口
$this-&gt;popPasvPort($port);
return false;
}
}
}
return $this-&gt;session[$user]['sock'];
}
/*+++++++++++++++++++++++++++++++++++++++++++++++++++++++++
+ FTP Command
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/
//==================
//RFC959
//==================
/**
* 登录用户名
* @param $fd
* @param $data
*/
public function cmd_USER($fd, $data){
if (preg_match("/^([a-z0-9.@]+)$/", $data)){
$user = strtolower($data);
$this-&gt;connection[$fd]['user'] = $user; 
$this-&gt;send($fd, "331 User $user OK. Password required");
}else{
$this-&gt;send($fd, "530 Login authentication failed");
}
}
/**
* 登录密码
* @param $fd
* @param $data
*/
public function cmd_PASS($fd, $data){
$user = $this-&gt;connection[$fd]['user'];
$pass = $data;
$info = $this-&gt;getConnectionInfo($fd);
$ip = $info['remote_ip'];
//判断登陆失败次数
if($this-&gt;user-&gt;isAttemptLimit($this-&gt;shm, $user, $ip)){
$this-&gt;send($fd, "530 Login authentication failed: Too many login attempts. Blocked in 10 minutes.");
return;
} 
if ($this-&gt;user-&gt;checkUser($user, $pass, $ip)){
$dir = "/";
$this-&gt;session[$user]['pwd'] = $dir;
//ftp根目录 
$this-&gt;session[$user]['home'] = $this-&gt;user-&gt;getHomeDir($user);
if(empty($this-&gt;session[$user]['home']) || !is_dir($this-&gt;session[$user]['home'])){
$this-&gt;send($fd, "530 Login authentication failed: `home` path error.");
}else{
$this-&gt;connection[$fd]['login'] = true;
//在线用户
$shm_data = $this-&gt;user-&gt;addOnline($this-&gt;shm, $this-&gt;server, $user, $fd, $ip);
$this-&gt;log('SHM: '.json_encode($shm_data) );
$this-&gt;send($fd, "230 OK. Current restricted directory is " . $dir); 
$this-&gt;log('User '.$user .' has login successfully! IP: '.$ip,'warn');
}
}else{
$this-&gt;user-&gt;addAttempt($this-&gt;shm, $user, $ip);
$this-&gt;log('User '.$user .' login fail! IP: '.$ip,'warn');
$this-&gt;send($fd, "530 Login authentication failed: check your pass or ip allow rules.");
}
}
/**
* 更改当前目录
* @param $fd
* @param $data
*/
public function cmd_CWD($fd, $data){
$user = $this-&gt;getUser($fd);
if (($dir = $this-&gt;setUserDir($user, $data)) != false){
$this-&gt;send($fd, "250 OK. Current directory is " . $dir);
}else{
$this-&gt;send($fd, "550 Can't change directory to " . $data . ": No such file or directory");
}
}
/**
* 返回上级目录
* @param $fd
* @param $data
*/
public function cmd_CDUP($fd, $data){
$data = '..';
$this-&gt;cmd_CWD($fd, $data);
}
/**
* 退出服务器
* @param $fd
* @param $data
*/
public function cmd_QUIT($fd, $data){
$this-&gt;send($fd,"221 Goodbye.");
unset($this-&gt;connection[$fd]);
}
/**
* 获取当前目录
* @param $fd
* @param $data
*/
public function cmd_PWD($fd, $data){
$user = $this-&gt;getUser($fd);
$this-&gt;send($fd, "257 \"" . $this-&gt;getUserDir($user) . "\" is your current location");
}
/**
* 下载文件
* @param $fd
* @param $data
*/
public function cmd_RETR($fd, $data){
$user = $this-&gt;getUser($fd);
$ftpsock = $this-&gt;getUserSock($user);
if (!$ftpsock){
$this-&gt;send($fd, "425 Connection Error");
return;
}
if (($file = $this-&gt;getFile($user, $data)) != false){
if($this-&gt;user-&gt;isReadable($user, $file)){
$this-&gt;send($fd, "150 Connecting to client");
if ($fp = fopen($file, "rb")){
//断点续传
if(isset($this-&gt;session[$user]['rest_offset'])){
if(!fseek($fp, $this-&gt;session[$user]['rest_offset'])){
$this-&gt;log("RETR at offset ".ftell($fp));
}else{
$this-&gt;log("RETR at offset ".ftell($fp).' fail.');
}
unset($this-&gt;session[$user]['rest_offset']);
} 
while (!feof($fp)){ 
$cont = fread($fp, 8192); 
if (!fwrite($ftpsock, $cont)) break; 
}
if (fclose($fp) and $this-&gt;closeUserSock($user)){
$this-&gt;send($fd, "226 File successfully transferred");
$this-&gt;log($user."\tGET:".$file,'info');
}else{
$this-&gt;send($fd, "550 Error during file-transfer");
}
}else{
$this-&gt;send($fd, "550 Can't open " . $data . ": Permission denied");
}
}else{
$this-&gt;send($fd, "550 You're unauthorized: Permission denied");
}
}else{
$this-&gt;send($fd, "550 Can't open " . $data . ": No such file or directory");
}
}
/**
* 上传文件
* @param $fd
* @param $data
*/
public function cmd_STOR($fd, $data){
$user = $this-&gt;getUser($fd);
$ftpsock = $this-&gt;getUserSock($user);
if (!$ftpsock){
$this-&gt;send($fd, "425 Connection Error");
return;
}
$file = $this-&gt;fillDirName($user, $data);
$isExist = false;
if(file_exists($file))$isExist = true;
if((!$isExist && $this-&gt;user-&gt;isWritable($user, $file)) ||
($isExist && $this-&gt;user-&gt;isAppendable($user, $file))){
if($isExist){
$fp = fopen($file, "rb+");
$this-&gt;log("OPEN for STOR.");
}else{
$fp = fopen($file, 'wb');
$this-&gt;log("CREATE for STOR.");
}
if (!$fp){
$this-&gt;send($fd, "553 Can't open that file: Permission denied");
}else{
//断点续传，需要Append权限
if(isset($this-&gt;session[$user]['rest_offset'])){
if(!fseek($fp, $this-&gt;session[$user]['rest_offset'])){
$this-&gt;log("STOR at offset ".ftell($fp));
}else{
$this-&gt;log("STOR at offset ".ftell($fp).' fail.');
}
unset($this-&gt;session[$user]['rest_offset']);
}
$this-&gt;send($fd, "150 Connecting to client");
while (!feof($ftpsock)){
$cont = fread($ftpsock, 8192);
if (!$cont) break;
if (!fwrite($fp, $cont)) break;
}
touch($file);//设定文件的访问和修改时间
if (fclose($fp) and $this-&gt;closeUserSock($user)){
$this-&gt;send($fd, "226 File successfully transferred");
$this-&gt;log($user."\tPUT: $file",'info');
}else{
$this-&gt;send($fd, "550 Error during file-transfer");
}
}
}else{
$this-&gt;send($fd, "550 You're unauthorized: Permission denied");
$this-&gt;closeUserSock($user);
}
}
/**
* 文件追加
* @param $fd
* @param $data
*/
public function cmd_APPE($fd,$data){
$user = $this-&gt;getUser($fd);
$ftpsock = $this-&gt;getUserSock($user);
if (!$ftpsock){
$this-&gt;send($fd, "425 Connection Error");
return;
}
$file = $this-&gt;fillDirName($user, $data);
$isExist = false;
if(file_exists($file))$isExist = true;
if((!$isExist && $this-&gt;user-&gt;isWritable($user, $file)) ||
($isExist && $this-&gt;user-&gt;isAppendable($user, $file))){
$fp = fopen($file, "rb+");
if (!$fp){
$this-&gt;send($fd, "553 Can't open that file: Permission denied");
}else{
//断点续传，需要Append权限
if(isset($this-&gt;session[$user]['rest_offset'])){
if(!fseek($fp, $this-&gt;session[$user]['rest_offset'])){
$this-&gt;log("APPE at offset ".ftell($fp));
}else{
$this-&gt;log("APPE at offset ".ftell($fp).' fail.');
}
unset($this-&gt;session[$user]['rest_offset']);
}
$this-&gt;send($fd, "150 Connecting to client");
while (!feof($ftpsock)){
$cont = fread($ftpsock, 8192);
if (!$cont) break;
if (!fwrite($fp, $cont)) break;
}
touch($file);//设定文件的访问和修改时间
if (fclose($fp) and $this-&gt;closeUserSock($user)){
$this-&gt;send($fd, "226 File successfully transferred");
$this-&gt;log($user."\tAPPE: $file",'info');
}else{
$this-&gt;send($fd, "550 Error during file-transfer");
}
}
}else{
$this-&gt;send($fd, "550 You're unauthorized: Permission denied");
$this-&gt;closeUserSock($user);
}
}
/**
* 文件重命名,源文件
* @param $fd
* @param $data
*/
public function cmd_RNFR($fd, $data){
$user = $this-&gt;getUser($fd);
$file = $this-&gt;fillDirName($user, $data);
if (file_exists($file) || is_dir($file)){
$this-&gt;session[$user]['rename'] = $file;
$this-&gt;send($fd, "350 RNFR accepted - file exists, ready for destination"); 
}else{
$this-&gt;send($fd, "550 Sorry, but that '$data' doesn't exist");
}
}
/**
* 文件重命名,目标文件
* @param $fd
* @param $data
*/
public function cmd_RNTO($fd, $data){
$user = $this-&gt;getUser($fd);
$old_file = $this-&gt;session[$user]['rename'];
$new_file = $this-&gt;fillDirName($user, $data);
$isDir = false;
if(is_dir($old_file)){
$isDir = true;
$old_file = $this-&gt;joinPath($old_file, '/');
}
if((!$isDir && $this-&gt;user-&gt;isRenamable($user, $old_file)) || 
($isDir && $this-&gt;user-&gt;isFolderRenamable($user, $old_file))){
if (empty($old_file) or !is_dir(dirname($new_file))){
$this-&gt;send($fd, "451 Rename/move failure: No such file or directory");
}elseif (rename($old_file, $new_file)){
$this-&gt;send($fd, "250 File successfully renamed or moved");
$this-&gt;log($user."\tRENAME: $old_file to $new_file",'warn');
}else{
$this-&gt;send($fd, "451 Rename/move failure: Operation not permitted");
}
}else{
$this-&gt;send($fd, "550 You're unauthorized: Permission denied");
}
unset($this-&gt;session[$user]['rename']);
}
/**
* 删除文件
* @param $fd
* @param $data
*/
public function cmd_DELE($fd, $data){
$user = $this-&gt;getUser($fd);
$file = $this-&gt;fillDirName($user, $data);
if($this-&gt;user-&gt;isDeletable($user, $file)){
if (!file_exists($file)){
$this-&gt;send($fd, "550 Could not delete " . $data . ": No such file or directory");
}
elseif (unlink($file)){
$this-&gt;send($fd, "250 Deleted " . $data);
$this-&gt;log($user."\tDEL: $file",'warn');
}else{
$this-&gt;send($fd, "550 Could not delete " . $data . ": Permission denied");
}
}else{
$this-&gt;send($fd, "550 You're unauthorized: Permission denied");
}
}
/**
* 创建目录
* @param $fd
* @param $data
*/
public function cmd_MKD($fd, $data){
$user = $this-&gt;getUser($fd);
$path = '';
if($data[0] == '/'){
$path = $this-&gt;joinPath($this-&gt;session[$user]['home'],$data);
}else{
$path = $this-&gt;joinPath($this-&gt;getAbsDir($user),$data);
}
$path = $this-&gt;joinPath($path, '/'); 
if($this-&gt;user-&gt;isFolderCreatable($user, $path)){
if (!is_dir(dirname($path))){
$this-&gt;send($fd, "550 Can't create directory: No such file or directory");
}elseif(file_exists($path)){
$this-&gt;send($fd, "550 Can't create directory: File exists");
}else{
if (mkdir($path)){
$this-&gt;send($fd, "257 \"" . $data . "\" : The directory was successfully created");
$this-&gt;log($user."\tMKDIR: $path",'info');
}else{
$this-&gt;send($fd, "550 Can't create directory: Permission denied");
}
}
}else{
$this-&gt;send($fd, "550 You're unauthorized: Permission denied");
}
}
/**
* 删除目录
* @param $fd
* @param $data
*/
public function cmd_RMD($fd, $data){
$user = $this-&gt;getUser($fd);
$dir = '';
if($data[0] == '/'){
$dir = $this-&gt;joinPath($this-&gt;session[$user]['home'], $data);
}else{
$dir = $this-&gt;fillDirName($user, $data);
}
$dir = $this-&gt;joinPath($dir, '/');
if($this-&gt;user-&gt;isFolderDeletable($user, $dir)){
if (is_dir(dirname($dir)) and is_dir($dir)){
if (count(glob($dir . "/*"))){
$this-&gt;send($fd, "550 Can't remove directory: Directory not empty");
}elseif (rmdir($dir)){
$this-&gt;send($fd, "250 The directory was successfully removed");
$this-&gt;log($user."\tRMDIR: $dir",'warn');
}else{
$this-&gt;send($fd, "550 Can't remove directory: Operation not permitted");
}
}elseif (is_dir(dirname($dir)) and file_exists($dir)){
$this-&gt;send($fd, "550 Can't remove directory: Not a directory");
}else{
$this-&gt;send($fd, "550 Can't create directory: No such file or directory");
}
}else{
$this-&gt;send($fd, "550 You're unauthorized: Permission denied");
}
}
/**
* 得到服务器类型
* @param $fd
* @param $data
*/
public function cmd_SYST($fd, $data){
$this-&gt;send($fd, "215 UNIX Type: L8");
}
/**
* 权限控制
* @param $fd
* @param $data
*/
public function cmd_SITE($fd, $data){
if (substr($data, 0, 6) == "CHMOD "){
$user = $this-&gt;getUser($fd);
$chmod = explode(" ", $data, 3);
$file = $this-&gt;fillDirName($user, $chmod[2]);
if($this-&gt;user-&gt;isWritable($user, $file)){
if (chmod($file, octdec($chmod[1]))){
$this-&gt;send($fd, "200 Permissions changed on {$chmod[2]}");
$this-&gt;log($user."\tCHMOD: $file to {$chmod[1]}",'info');
}else{
$this-&gt;send($fd, "550 Could not change perms on " . $chmod[2] . ": Permission denied");
}
}else{
$this-&gt;send($fd, "550 You're unauthorized: Permission denied");
}
}else{
$this-&gt;send($fd, "500 Unknown Command");
}
} 
/**
* 更改传输类型
* @param $fd
* @param $data
*/
public function cmd_TYPE($fd, $data){
switch ($data){
case "A":
$type = "ASCII";
break;
case "I":
$type = "8-bit binary";
break;
}
$this-&gt;send($fd, "200 TYPE is now " . $type);
}
/**
* 遍历目录
* @param $fd
* @param $data
*/
public function cmd_LIST($fd, $data){
$user = $this-&gt;getUser($fd);
$ftpsock = $this-&gt;getUserSock($user);
if (!$ftpsock){
$this-&gt;send($fd, "425 Connection Error");
return;
} 
$path = $this-&gt;joinPath($this-&gt;getAbsDir($user),'/');
$this-&gt;send($fd, "150 Opening ASCII mode data connection for file list");
$filelist = $this-&gt;getFileList($user, $path, true);
fwrite($ftpsock, $filelist); 
$this-&gt;send($fd, "226 Transfer complete."); 
$this-&gt;closeUserSock($user);
}
/**
* 建立数据传输通
* @param $fd
* @param $data
*/
// 不使用主动模式 
// public function cmd_PORT($fd, $data){
// $user = $this-&gt;getUser($fd);
// $port = explode(",", $data);
// if (count($port) != 6){
// $this-&gt;send($fd, "501 Syntax error in IP address");
// }else{
// if (!$this-&gt;isIPAddress($port)){
// $this-&gt;send($fd, "501 Syntax error in IP address");
// return;
// }
// $ip = $port[0] . "." . $port[1] . "." . $port[2] . "." . $port[3];
// $port = hexdec(dechex($port[4]) . dechex($port[5]));
// if ($port &lt; 1024){
// $this-&gt;send($fd, "501 Sorry, but I won't connect to ports &lt; 1024");
// }elseif ($port &gt; 65000){
// $this-&gt;send($fd, "501 Sorry, but I won't connect to ports &gt; 65000");
// }else{ 
// $ftpsock = fsockopen($ip, $port); 
// if ($ftpsock){
// $this-&gt;session[$user]['sock'] = $ftpsock;
// $this-&gt;session[$user]['pasv'] = false; 
// $this-&gt;send($fd, "200 PORT command successful"); 
// }else{
// $this-&gt;send($fd, "501 Connection failed");
// }
// }
// }
// }
/**
* 被动模式 
* @param unknown $fd
* @param unknown $data
*/
public function cmd_PASV($fd, $data){
$user = $th

 <hr></span>                                     
		    	</div>
		    	<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>代码注释</div>
			    <div class="panel-content">
			    <span></span>                                     
		    	</div>

			</div>

			<!-- END ROW -->
			<div class="newsPage">
				<div class="newsPageTurn">
				    <span><a>上一篇</a><a href='/php/biji/90905.html'>jsp导出excel并支持分sheet导出的方法</a><a>下一篇</a><a href='/php/biji/90907.html'>php判断一个数组是否为有序的方法</a></span>
				</div>
			</div>
		</div>


<div id="author-box">
    <h3>作者：喵哥笔记</h3>
        <div class="author-info">
            <div class="author-avatar">
                <img src="/skin1/picture/01.jpg" alt="IDC笔记" class="avatar" width="64" height="64">
            </div>
        <div class="author-description">
            <p>学的不仅是技术，更是梦想！</p>
            <ul class="author-social follows nb">
            	<li>
                    <a target="_blank" href="/" title="IDC笔记">IDC笔记</a>
                </li>
            </ul>
        </div>
        <div class="clear"></div>
    </div>
</div>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
<!-- container-fluid -->
	</div>
<!-- content -->
	<footer class="footer">
	© 2020 IDC笔记 <i class="mdi mdi-heart text-danger"></i>. | 备案号：<a href="https://beian.miit.gov.cn/">辽ICP备18000516号</a>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?674585fbbd2294d3faf910f668ea91b4";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

	</footer>
</div>

</div>
<!-- END wrapper -->
<!-- jQuery  -->
<script src="/skin1/js/jquery.min.js"></script>
<script src="/skin1/js/bootstrap.bundle.min.js"></script>
<script src="/skin1/js/metismenu.min.js"></script>
<script src="/skin1/js/jquery.slimscroll.js"></script>
<script src="/skin1/js/waves.min.js"></script>
<!--Morris Chart-->
<script src="/skin1/js/morris.min.js"></script>
<script src="/skin1/js/raphael.min.js"></script>
<script src="/skin1/js/dashboard.init.js"></script>
<script src="/skin1/js/app.js"></script>
<script src="/foot.js"></script>
</body>
</html>