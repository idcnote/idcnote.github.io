<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <title>通过C#实现自动售货机接口_PHP教程_IDC笔记</title>
    <meta name="keywords" content="PHP,PHP笔记,PHP教程" />
    <meta name="description" content="下面分几部分介绍C#实现自动售货机接口的方法，代码写的非常详细，不懂的地方有注释可以参考下。<br />
MachineJP类：<br />
第1部分：串口初始化，串口数据读写<br />
<br />
<br />
using System;<br />
using System.Co" />
    <meta content="Responsive admin theme build on top of Bootstrap 4" name="description" />
    <meta content="idcnote.com" name="author" />
    <link rel="shortcut icon" href="/skin1/images/favicon.ico">
    <!--Morris Chart CSS -->
    <link rel="stylesheet" href="/skin1/css/morris.css">
    <link href="/skin1/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/metismenu.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/icons.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/style.css" rel="stylesheet" type="text/css">
<link href="/SyntaxHighlighter/shCoreDefault.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">
 SyntaxHighlighter.all();
</script>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
</head>
<body>
<!-- Begin page -->
		<div id="wrapper">
			<!-- Top Bar Start -->
			<div class="topbar">
				<!-- LOGO -->
				<div class="topbar-left">
					<a href="/" class="logo">
						<span class="logo-light">
                            <i class="mdi mdi-camera-control"></i>IDC笔记
                        </span>
						<span class="logo-sm">
                            <i class="mdi mdi-camera-control"></i>
                        </span>
					</a>
				</div>
				<nav class="navbar-custom">
					<ul class="navbar-right list-inline float-right mb-0">
						<!--<li class="dropdown notification-list list-inline-item d-none d-md-inline-block">
							<a class="nav-link waves-effect" href="#" id="btn-fullscreen">
								<i class="mdi mdi-arrow-expand-all noti-icon"></i>
							</a>
						</li>
						<li class="dropdown notification-list list-inline-item">
							<div class="dropdown notification-list nav-pro-img">
								<a class="dropdown-toggle nav-link arrow-none nav-user" data-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
									<img src="/skin1/picture/user-4.jpg" alt="user" class="rounded-circle">
								</a>
								<div class="dropdown-menu dropdown-menu-right profile-dropdown ">
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-account-circle"></i> Profile</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-wallet"></i> Wallet</a>
									<a class="dropdown-item d-block" href="#">
										<span class="badge badge-success float-right">11</span>
										<i class="mdi mdi-settings"></i> Settings</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-lock-open-outline"></i> Lock screen</a>
									<div class="dropdown-divider"></div>
									<a class="dropdown-item text-danger" href="#">
										<i class="mdi mdi-power text-danger"></i> Logout</a>
								</div>
							</div>
						</li>
						-->
					</ul>
					<ul class="list-inline menu-left mb-0">
						<li class="float-left">
							<button class="button-menu-mobile open-left waves-effect">
                            <i class="mdi mdi-menu"></i>
                        </button>
						</li>
						<li class="d-none d-md-inline-block">
							<form role="search" class="app-search">
								<div class="form-group mb-0">
									<input type="text" class="form-control" placeholder="Search..">
									<button type="submit"><i class="fa fa-search"></i></button>
								</div>
							</form>
						</li>
					</ul>
				</nav>
			</div>
<!-- ========== Left Sidebar Start ========== -->
<div class="left side-menu">
    <div class="slimscroll-menu" id="remove-scroll">
    <!--- Sidemenu -->
    <div id="sidebar-menu">
    <!-- Left Menu Start -->
    <ul class="metismenu" id="side-menu">
			<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP简介			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/jianjie/1.html">PHP简介</a></li><li><a href="/php/jianjie/2.html">PHP用途</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP基本语法			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yufa/3.html">分离HTML</a></li><li><a href="/php/yufa/4.html">指令分隔符</a></li><li><a href="/php/yufa/5.html">PHP注释</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP类型			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpleixing/6.html">PHP类型简介</a></li><li><a href="/php/phpleixing/7.html">PHP类型之布尔类型</a></li><li><a href="/php/phpleixing/8.html">PHP类型之整型</a></li><li><a href="/php/phpleixing/9.html">PHP类型之浮点型</a></li><li><a href="/php/phpleixing/10.html">PHP类型之字符串</a></li><li><a href="/php/phpleixing/11.html">PHP类型之数组</a></li><li><a href="/php/phpleixing/12.html">PHP类型之对象</a></li><li><a href="/php/phpleixing/13.html">PHP类型之资源类型</a></li><li><a href="/php/phpleixing/14.html">PHP类型之NULL</a></li><li><a href="/php/phpleixing/15.html">PHP类型之伪类型</a></li><li><a href="/php/phpleixing/16.html">PHP类型之类型判别</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP变量			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpbianliang/17.html">PHP变量之基础</a></li><li><a href="/php/phpbianliang/18.html">PHP变量之预定义变量</a></li><li><a href="/php/phpbianliang/19.html">PHP变量之变量范围</a></li><li><a href="/php/phpbianliang/20.html">PHP变量之可变变量</a></li><li><a href="/php/phpbianliang/21.html">PHP变量之外部变量</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP运算符			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yunsuanfu/22.html">PHP运算符优先级</a></li><li><a href="/php/yunsuanfu/23.html">算术运算符</a></li><li><a href="/php/yunsuanfu/24.html">赋值运算符</a></li><li><a href="/php/yunsuanfu/25.html">位运算符</a></li><li><a href="/php/yunsuanfu/26.html">比较运算符</a></li><li><a href="/php/yunsuanfu/27.html">错误控制运算符</a></li><li><a href="/php/yunsuanfu/28.html">执行运算符</a></li><li><a href="/php/yunsuanfu/29.html">递增/递减运算符</a></li><li><a href="/php/yunsuanfu/30.html">逻辑运算符</a></li><li><a href="/php/yunsuanfu/31.html">字符串运算符</a></li><li><a href="/php/yunsuanfu/32.html">数组运算符</a></li><li><a href="/php/yunsuanfu/33.html">类型运算符</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP控制结构			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/jiegou/34.html">PHP控制结构之if</a></li><li><a href="/php/jiegou/35.html">PHP控制结构之else</a></li><li><a href="/php/jiegou/36.html">PHP控制结构之elseif/else if</a></li><li><a href="/php/jiegou/37.html">PHP控制结构之替代语法</a></li><li><a href="/php/jiegou/38.html">PHP控制结构之while</a></li><li><a href="/php/jiegou/39.html">PHP控制结构之do-while</a></li><li><a href="/php/jiegou/40.html">PHP控制结构之for</a></li><li><a href="/php/jiegou/41.html">PHP控制结构之foreach</a></li><li><a href="/php/jiegou/42.html">PHP控制结构之break</a></li><li><a href="/php/jiegou/43.html">PHP控制结构之continue</a></li><li><a href="/php/jiegou/44.html">PHP控制结构之switch</a></li><li><a href="/php/jiegou/45.html">PHP控制结构之declare</a></li><li><a href="/php/jiegou/46.html">PHP控制结构之return</a></li><li><a href="/php/jiegou/47.html">PHP控制结构之require</a></li><li><a href="/php/jiegou/48.html">PHP控制结构之include</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP函数			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/hanshu/52.html">用户自定义函数</a></li><li><a href="/php/hanshu/53.html">函数的参数</a></li><li><a href="/php/hanshu/54.html">返回值</a></li><li><a href="/php/hanshu/55.html">可变函数</a></li><li><a href="/php/hanshu/56.html">内部（内置）函数</a></li><li><a href="/php/hanshu/57.html">匿名函数</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP类与对象			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpduixiang/58.html">类与对象前言</a></li><li><a href="/php/phpduixiang/59.html">基本概念</a></li><li><a href="/php/phpduixiang/60.html">属性</a></li><li><a href="/php/phpduixiang/61.html">类常量</a></li><li><a href="/php/phpduixiang/62.html">自动加载对象</a></li><li><a href="/php/phpduixiang/63.html">构造函数和析构函数</a></li><li><a href="/php/phpduixiang/64.html">访问控制</a></li><li><a href="/php/phpduixiang/65.html">对象继承</a></li><li><a href="/php/phpduixiang/66.html">Static关键字</a></li><li><a href="/php/phpduixiang/67.html">抽象类</a></li><li><a href="/php/phpduixiang/68.html">接口</a></li><li><a href="/php/phpduixiang/69.html">Traits</a></li><li><a href="/php/phpduixiang/70.html">重载</a></li><li><a href="/php/phpduixiang/71.html">对象迭代</a></li><li><a href="/php/phpduixiang/72.html">设计模式</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP异常处理			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yichang/81.html">异常处理</a></li><li><a href="/php/yichang/82.html">扩展PHP内置的异常处理类</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP函数库按分类			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpku/83.html">数组</a></li><li><a href="/php/phpku/84.html">Classes/Objects</a></li><li><a href="/php/phpku/85.html">Date/Time</a></li><li><a href="/php/phpku/86.html">Directories</a></li><li><a href="/php/phpku/87.html">错误处理</a></li><li><a href="/php/phpku/88.html">Program execution</a></li><li><a href="/php/phpku/89.html">Filesystem</a></li><li><a href="/php/phpku/90.html">Filter</a></li><li><a href="/php/phpku/91.html">Function Handling</a></li><li><a href="/php/phpku/92.html">PHP 选项/信息</a></li><li><a href="/php/phpku/93.html">Mail</a></li><li><a href="/php/phpku/94.html">Math</a></li><li><a href="/php/phpku/95.html">Misc.</a></li><li><a href="/php/phpku/96.html">Network</a></li><li><a href="/php/phpku/97.html">输出控制</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> php基础			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpbiji/108377.html"></a></li><li><a href="/php/phpbiji/108376.html"></a></li><li><a href="/php/phpbiji/108380.html"></a></li><li><a href="/php/phpbiji/108379.html"></a></li><li><a href="/php/phpbiji/108378.html"></a></li><li><a href="/php/phpbiji/108381.html"></a></li><li><a href="/php/phpbiji/108382.html"></a></li><li><a href="/php/phpbiji/108384.html"></a></li><li><a href="/php/phpbiji/108383.html"></a></li><li><a href="/php/phpbiji/108385.html"></a></li><li><a href="/php/phpbiji/108386.html"></a></li><li><a href="/php/phpbiji/108388.html"></a></li><li><a href="/php/phpbiji/108387.html"></a></li><li><a href="/php/phpbiji/108389.html"></a></li><li><a href="/php/phpbiji/108391.html"></a></li>		</ul>
	</li>
		<li>
	    <a href="/php/biji/" class="waves-effect">
		    <i class="icon-share"></i>
		    <span>PHP笔记
		       	<span class="float-right menu-arrow">
		       	<i class="mdi mdi-chevron-right"></i>
		       	</span>
		    </span>
	    </a>
	</li>
	</ul>
</div>
<!-- Sidebar -->
<div class="clearfix"></div>
</div>
<!-- Sidebar -left -->
</div>
<!-- Left Sidebar End -->
<!-- Start right Content here -->
<div class="content-page">
	<div class="content">
		<div class="container-fluid">
			<div class="page-title-box">
				<div class="row align-items-center">
					<div class="col-sm-6">
						<h1 class="page-title">通过C#实现自动售货机接口</h1>
					</div>
				</div>
				<!-- end row -->
			</div>
			<!-- end page-title -->
			<!-- START ROW -->
			<div class="panel panel-forbid">
				<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>内容摘要</div>
			    <div class="panel-content">
			    <span>下面分几部分介绍C#实现自动售货机接口的方法，代码写的非常详细，不懂的地方有注释可以参考下。<br />
MachineJP类：<br />
第1部分：串口初始化，串口数据读写<br />
<br />
<br />
using System;<br />
using System.Co</span>                                     
		    	</div>
			    <div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>文章正文</div>
			    <div class="panel-content">
			    <span><p>下面分几部分介绍C#实现自动售货机接口的方法，代码写的非常详细，不懂的地方有注释可以参考下。</p>
<p><strong>MachineJP类：</strong></p>
<p><strong>第1部分：串口初始化，串口数据读写</strong></p>
<div class="phpstudycode">
<pre class="brush:csharp;">
using System;
using System.Collections.Generic;
using System.IO.Ports;
using System.Linq;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using System.Windows.Forms;
using MachineJPDll.Models;
using MachineJPDll.Utils;

namespace MachineJPDll
{
  /// &lt;summary&gt;
  /// 售货机接口(接口)
  /// &lt;/summary&gt;
  public partial class MachineJP
  {
    #region 变量
    /// &lt;summary&gt;
    /// 串口资源
    /// &lt;/summary&gt;
    private SerialPort m_SerialPort = null;
    /// &lt;summary&gt;
    /// 待发送给串口的命令列表
    /// &lt;/summary&gt;
    private List&lt;Cmd&gt; m_CommandList = new List&lt;Cmd&gt;();
    /// &lt;summary&gt;
    /// 等待ACK_RPT或NAK_RPT的PC端向VMC端发送的消息列表
    /// &lt;/summary&gt;
    private List&lt;MT&gt; m_WaitResultMTList = new List&lt;MT&gt;();
    /// &lt;summary&gt;
    /// 从串口接收的数据集合(数据已通过验证)
    /// &lt;/summary&gt;
    private ReceiveDataCollection m_ReceiveDataCollection = new ReceiveDataCollection();
    #endregion

    #region 构造函数与析构函数
    /// &lt;summary&gt;
    /// 售货机接口(接口)
    /// &lt;/summary&gt;
    public MachineJP()
    {

    }

    ~MachineJP()
    {
      if (m_SerialPort != null)
      {
        m_SerialPort.Close();
        m_SerialPort.Dispose();
        m_SerialPort = null;
      }
    }
    #endregion

    #region 读取串口数据
    /// &lt;summary&gt;
    /// 读取串口数据
    /// &lt;/summary&gt;
    /// &lt;returns&gt;从串口读取的数据&lt;/returns&gt;
    private byte[] ReadPort()
    {
      //读取串口数据
      DateTime dt = DateTime.Now;
      while (m_SerialPort.BytesToRead &lt; 2)
      {
        Thread.Sleep(1);

        if (DateTime.Now.Subtract(dt).TotalMilliseconds &gt; 1500) //超时
        {
          return new byte[0];
        }
      }
      List&lt;byte&gt; recList = new List&lt;byte&gt;();
      byte[] recData = new byte[m_SerialPort.BytesToRead];
      m_SerialPort.Read(recData, 0, recData.Length);
      recList.AddRange(recData);
      int length = recData[1] + 2; //报文数据总长度
      while (recList.Count &lt; length)
      {
        if (m_SerialPort.BytesToRead &gt; 0)
        {
          recData = new byte[m_SerialPort.BytesToRead];
          m_SerialPort.Read(recData, 0, recData.Length);
          recList.AddRange(recData);
        }
        Thread.Sleep(1);
      }

      return recList.ToArray();
    }
    #endregion

    #region 向串口发送数据
    /// &lt;summary&gt;
    /// 向串口发送数据
    /// &lt;/summary&gt;
    /// &lt;param name="cmd"&gt;待发送的命令&lt;/param&gt;
    /// &lt;param name="SN"&gt;序列号&lt;/param&gt;
    private void WritePort(Cmd cmd, byte SN)
    {
      //发送数据
      List&lt;byte&gt; sendData = cmd.Data;
      sendData[1] = (byte)sendData.Count;
      sendData[2] = SN;
      byte[] checkCode = CommonUtil.CalCheckCode(sendData, sendData.Count);
      sendData.AddRange(checkCode);
      if (cmd.Mt != null)
      {
        m_WaitResultMTList.Add(cmd.Mt);
      }
      m_SerialPort.Write(sendData.ToArray(), 0, sendData.Count);
      LogHelper.Log(LogMsgType.Info, true, sendData.ToArray());
    }
    #endregion

    #region 发送ACK消息
    /// &lt;summary&gt;
    /// 发送ACK消息
    /// &lt;/summary&gt;
    /// &lt;param name="SN"&gt;序列号&lt;/param&gt;
    private void SendACK(byte SN)
    {
      List&lt;byte&gt; sendData = new List&lt;byte&gt;() { 0xE5, 0x00, 0x00, 0x40, 0x80 };
      WritePort(new Cmd(sendData), SN);
    }
    #endregion

    #region Init 初始化
    /// &lt;summary&gt;
    /// 初始化
    /// &lt;/summary&gt;
    /// &lt;param name="com"&gt;串口号(例：COM1)&lt;/param&gt;
    public void Init(string com)
    {
      if (m_SerialPort == null)
      {
        m_SerialPort = new SerialPort(com, 9600, Parity.None, 8, StopBits.One);
        m_SerialPort.ReadBufferSize = 1024;
        m_SerialPort.WriteBufferSize = 1024;
        m_SerialPort.DataReceived += new SerialDataReceivedEventHandler(serialPort_DataReceived);
      }

      if (!m_SerialPort.IsOpen)
      {
        m_SerialPort.Open();
      }

      GET_SETUP();
      CONTROL_IND(0x13, new byte[] { 0x00 }); //初始化完成标志
      GET_STATUS();

      SetDecimalPlaces(2); //设置小数点位数
    }
    #endregion

    #region Close 关闭连接
    /// &lt;summary&gt;
    /// 关闭连接
    /// &lt;/summary&gt;
    public void Close()
    {
      m_SerialPort.Close();
    }
    #endregion

    #region 接收串口数据
    /// &lt;summary&gt;
    /// 接收串口数据
    /// &lt;/summary&gt;
    /// &lt;param name="type"&gt;消息类型&lt;/param&gt;
    /// &lt;param name="subtype"&gt;消息子类型&lt;/param&gt;
    public byte[] Receive(byte type, byte subtype)
    {
      return m_ReceiveDataCollection.Get(type, subtype);
    }

    /// &lt;summary&gt;
    /// 接收串口数据
    /// &lt;/summary&gt;
    /// &lt;param name="type"&gt;消息类型&lt;/param&gt;
    /// &lt;param name="subtype"&gt;消息子类型&lt;/param&gt;
    public byte[] WaitReceive(byte type, byte subtype)
    {
      DateTime time = DateTime.Now;
      while (true)
      {
        byte[] receiveData = m_ReceiveDataCollection.Get(type, subtype);
        if (receiveData != null) return receiveData;

        if (DateTime.Now.Subtract(time).TotalMinutes &gt; 3) return null;

        Thread.Sleep(50);
      }
    }

    /// &lt;summary&gt;
    /// 接收串口数据
    /// &lt;/summary&gt;
    /// &lt;param name="type"&gt;消息类型&lt;/param&gt;
    public byte[] WaitReceive(byte type)
    {
      DateTime time = DateTime.Now;
      while (true)
      {
        byte[] receiveData = m_ReceiveDataCollection.Get(type);
        if (receiveData != null) return receiveData;

        if (DateTime.Now.Subtract(time).TotalMinutes &gt; 3) return null;

        Thread.Sleep(50);
      }
    }
    #endregion

    #region 判断消息是否发送成功
    /// &lt;summary&gt;
    /// 判断消息是否发送成功
    /// &lt;/summary&gt;
    public bool SendSuccess(byte type, byte subtype)
    {
      DateTime time = DateTime.Now;
      while (true)
      {
        if (DateTime.Now.Subtract(time).TotalMinutes &gt; 3)
        {
          return false;
        }
        byte[] ack = m_ReceiveDataCollection.Get(type, subtype);
        byte[] nak = m_ReceiveDataCollection.Get(type, subtype);
        if (ack != null) return true;
        if (nak != null) return false;

        Thread.Sleep(1);
      }
    }
    #endregion

  }
}</pre>
</div>
<p><strong>第2部分：接收串口数据，并响应货机，向货机发送数据&nbsp;</strong></p>
<p>&nbsp;</p>
<div class="phpstudycode">
<pre class="brush:csharp;">
using System;
using System.Collections.Generic;
using System.IO.Ports;
using System.Linq;
using System.Text;
using MachineJPDll.Models;
using MachineJPDll.Utils;

/*
 * VMC-&gt;PC数据的接收,货机事件的分发
 */

namespace MachineJPDll
{
  partial class MachineJP
  {
    #region serialPort_DataReceived
    /// &lt;summary&gt;
    /// 数据接收事件的方法
    /// &lt;/summary&gt;
    public void serialPort_DataReceived(object obj, SerialDataReceivedEventArgs args)
    {
      byte[] receiveData = ReadPort();

      if (CommonUtil.ValidReceiveData(receiveData)) //只处理验证正确的数据，不正确的数据抛弃不处理
      {
        LogHelper.Log(LogMsgType.Info, false, receiveData);
        byte SN = CommonUtil.GetSN(receiveData);
        MT mt = new MT(receiveData);

        #region 轮询(POLL)
        if (mt.Type == 0x03)
        {
          if (m_CommandList.Count &gt; 0)
          {
            WritePort(m_CommandList[0], SN);
            m_CommandList.RemoveAt(0);
          }
          else
          {
            //发送ACK消息
            SendACK(SN);
          }
        }
        #endregion

        #region 发送ACK消息
        if (CommonUtil.NeedACK(receiveData))
        {
          SendACK(SN); //发送ACK消息
        }
        #endregion

        #region VMC系统参数
        if (mt.Type == 0x05)
        {
          m_ReceiveDataCollection.Add(mt.Type, mt.Subtype, receiveData);
        }
        #endregion

        #region ACK_RPT或NAK_RPT
        if (mt.Type == 0x01 //ACK_RPT
          || mt.Type == 0x02) //NAK_RPT
        {
          if (m_WaitResultMTList.Count &gt; 0)
          {
            m_ReceiveDataCollection.Add(m_WaitResultMTList[0].Type, m_WaitResultMTList[0].Subtype, receiveData);
            m_WaitResultMTList.RemoveAt(0);
          }
        }
        #endregion

        #region INFO_RPT 数据报告
        if (mt.Type == 0x11)
        {
          #region 纸币器信息
          if (mt.Subtype == 16)
          {
            m_ReceiveDataCollection.Add(mt.Type, mt.Subtype, receiveData);
          }
          #endregion

          #region 硬币器信息
          if (mt.Subtype == 17)
          {
            m_ReceiveDataCollection.Add(mt.Type, mt.Subtype, receiveData);
          }
          #endregion

          #region 用户投币余额
          if (mt.Subtype == 3)
          {
            m_ReceiveDataCollection.Add(mt.Type, mt.Subtype, receiveData);
          }
          #endregion
        }
        #endregion

        #region VENDOUT_RPT 出货报告
        if (mt.Type == 0x08)
        {
          m_ReceiveDataCollection.Add(mt.Type, mt.Subtype, receiveData);
        }
        #endregion

        #region STATUS_RPT VMC整机状态报告
        if (mt.Type == 0x0D)
        {
          m_ReceiveDataCollection.Add(mt.Type, mt.Subtype, receiveData);
        }
        #endregion

        #region SALEPRICE_IND 设置当前商品售价
        if (mt.Type == 0x8E)
        {
          m_ReceiveDataCollection.Add(mt.Type, mt.Subtype, receiveData);
        }
        #endregion

        #region PAYIN_RPT VMC发送现金投币报告给PC
        if (mt.Type == 0x06)
        {
          m_ReceiveDataCollection.Add(mt.Type, mt.Subtype, receiveData);
        }
        #endregion

        #region PAYOUT_RPT 出币报告
        if (mt.Type == 0x07)
        {
          m_ReceiveDataCollection.Add(mt.Type, mt.Subtype, receiveData);
        }
        #endregion

        #region COST_RPT VMC扣款报告
        if (mt.Type == 0x10)
        {
          m_ReceiveDataCollection.Add(mt.Type, mt.Subtype, receiveData);
        }
        #endregion

        #region ACTION_RPT 售货机行为报告
        if (mt.Type == 0x0B)
        {
          m_ReceiveDataCollection.Add(mt.Type, mt.Subtype, receiveData);
        }
        #endregion

        #region HUODAO_RPT VMC货道报告
        if (mt.Type == 0x0E)
        {
          m_ReceiveDataCollection.Add(mt.Type, mt.Subtype, receiveData);
        }
        #endregion
      }
      else //接收到的数据没有验证通过
      {
        LogHelper.LogException(LogMsgType.Error, false, "数据异常", receiveData);
      }
    }
    #endregion

  }
}</pre>
</div>
<p><strong>&nbsp;第3部分：货机状态、投币、出货等接口</strong></p>
<div class="phpstudycode">
<pre class="brush:csharp;">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading;
using MachineJPDll.Enums;
using MachineJPDll.Models;
using MachineJPDll.Utils;

/*
 * PC-&gt;VMC数据的发送(并非直接发送,只是添加到发送列表)
 */

namespace MachineJPDll
{
  partial class MachineJP
  {
    #region GET_SETUP
    /// &lt;summary&gt;
    /// PC通知VMC发送VMC_SETUP
    /// &lt;/summary&gt;
    public VmcSetup GET_SETUP()
    {
      List&lt;byte&gt; sendData = new List&lt;byte&gt;() { 0xE5, 0x00, 0x00, 0x40, 0x90 };
      m_CommandList.Add(new Cmd(sendData));

      byte[] receiveData = WaitReceive(0x05);
      if (receiveData != null)
      {
        return new VmcSetup(receiveData);
      }
      return null;
    }
    #endregion

    #region CONTROL_IND PC控制售货机完成对应的动作
    /// &lt;summary&gt;
    /// PC控制VMC
    /// &lt;/summary&gt;
    public bool CONTROL_IND(byte subtype, byte[] value)
    {
      List&lt;byte&gt; sendData = new List&lt;byte&gt;() { 0xE5, 0x00, 0x00, 0x41, 0x85 };
      sendData.Add(subtype);
      if (value != null && value.Length &gt; 0)
      {
        sendData.AddRange(value);
      }
      m_CommandList.Add(new Cmd(sendData, new MT(sendData)));

      return SendSuccess(0x85, subtype);
    }
    #endregion

    #region 设置小数点位数
    /// &lt;summary&gt;
    /// 设置小数点位数
    /// 用于PC 通知VMC，双方的金额数据比例系数关系，PC 每次启动时，都会给
    /// VMC 下发一次type=18 的消息，VMC 需要自己永久保存该数据，直到被PC 再
    /// 次更新。
    /// 取值范围：0、1、2 分别表示以 元、 角 、分 为单位
    /// &lt;/summary&gt;
    public bool SetDecimalPlaces(int data)
    {
      return CONTROL_IND(18, new byte[] { (byte)data });
    }
    #endregion

    #region GET_STATUS PC通知VMC发送STATUS_RPT
    /// &lt;summary&gt;
    /// PC通知VMC发送STATUS_RPT
    /// &lt;/summary&gt;
    public StatusRpt GET_STATUS()
    {
      List&lt;byte&gt; sendData = new List&lt;byte&gt;() { 0xE5, 0x00, 0x00, 0x40, 0x86 };
      m_CommandList.Add(new Cmd(sendData));

      byte[] receiveData = WaitReceive(0x0D);
      if (receiveData != null)
      {
        return new StatusRpt(receiveData);
      }
      return null;
    }
    #endregion

    #region GET_INFO PC通知VMC发送INFO_RPT
    /// &lt;summary&gt;
    /// PC通知VMC发送INFO_RPT
    /// &lt;/summary&gt;
    public byte[] GET_INFO(byte subtype)
    {
      List&lt;byte&gt; sendData = new List&lt;byte&gt;() { 0xE5, 0x00, 0x00, 0x40, 0x8C };
      sendData.Add(subtype);
      m_CommandList.Add(new Cmd(sendData));

      return WaitReceive(0x11);
    }
    #endregion

    #region VENDOUT_IND 出货
    /// &lt;summary&gt;
    /// PC出货指示
    /// &lt;/summary&gt;
    /// &lt;param name="device"&gt;售货机的箱体号 例如柜1 为 0x01 以此类推&lt;/param&gt;
    /// &lt;param name="method"&gt;method =1：VMC 通过商品ID 指示出货，如果商品ID 不存在，回复NAK_RPT method =2：VMC 通过货道ID 指示VMC 出货，如果货道ID 不存在，回复NAK_RPT&lt;/param&gt;
    /// &lt;param name="sp_id_hd_id"&gt;sp_id：通过商品ID 指示VMC 出货 hd_id：通过货道ID 指示VMC 出货&lt;/param&gt;
    /// &lt;param name="type"&gt;如果type=0，cost 代表本次出货扣款金额 如果TYPE 不为0，则COST 必须为0&lt;/param&gt;
    /// &lt;param name="cost"&gt;cost 代表本次出货扣款金额&lt;/param&gt;
    public VendoutRpt VENDOUT_IND(byte device, byte method, byte sp_id_hd_id, byte type, int cost)
    {
      List&lt;byte&gt; sendData = new List&lt;byte&gt;() { 0xE5, 0x00, 0x00, 0x41, 0x83 };
      sendData.AddRange(new byte[] { device, method, sp_id_hd_id, type });
      sendData.AddRange(CommonUtil.Int2ByteArray(cost, 2));
      m_CommandList.Add(new Cmd(sendData, new MT(sendData)));

      if (SendSuccess(0x83, 0x00))
      {
        byte[] receiveData = WaitReceive(0x08);
        if (receiveData != null)
        {
          return new VendoutRpt(receiveData);
        }
      }
      return null;
    }
    #endregion

    #region HUODAO_SET_IND 设置货道商品数量
    /// &lt;summary&gt;
    /// PC通知VMC，当前货道对应商品的数量等信息
    /// &lt;/summary&gt;
    /// &lt;param name="device"&gt;表示箱柜号&lt;/param&gt;
    /// &lt;param name="huodao"&gt;zyxxxxxx “z”固定填0 “y”固定填0 “xxxxxx”，表示商品余量，如果商品余量大于63，则统一为63&lt;/param&gt;
    public bool HUODAO_SET_IND(byte device, List&lt;int&gt; huodao)
    {
      List&lt;byte&gt; sendData = new List&lt;byte&gt;() { 0xE5, 0x00, 0x00, 0x41, 0x8F };
      sendData.Add(device);
      for (int i = 0; i &lt; huodao.Count; i++)
      {
        if (huodao[i] &gt; 63)
        {
          huodao[i] = 63;
        }
      }
      sendData.AddRange(huodao.ConvertAll&lt;byte&gt;(a =&gt; (byte)a));
      m_CommandList.Add(new Cmd(sendData, new MT(sendData)));

      return SendSuccess(0x8F, 0x00);
    }
    #endregion

    #region SALEPRICE_IND 设置当前商品售价
    /// &lt;summary&gt;
    /// PC通知VMC，当前商品售价
    /// &lt;/summary&gt;
    /// &lt;param name="device"&gt;表示箱柜号&lt;/param&gt;
    /// &lt;param name="type"&gt;表示设置单价的方式；Type = 0：为按商品ID 发送单价，可以变长发送，商品种类最大不超过80 个；Type = 1: 为按货道号发送，固定发送80 个货道的单价信息&lt;/param&gt;
    /// &lt;param name="sp_price"&gt;商品售价&lt;/param&gt;
    public bool SALEPRICE_IND(byte device, byte type, List&lt;int&gt; sp_price)
    {
      List&lt;byte&gt; sendData = new List&lt;byte&gt;() { 0xE5, 0x00, 0x00, 0x41, 0x8E };
      sendData.Add(device);
      sendData.Add(type);
      sendData.AddRange(sp_price.ConvertAll&lt;byte&gt;(a =&gt; (byte)a));
      m_CommandList.Add(new Cmd(sendData, new MT(sendData)));

      return SendSuccess(0x8E, 0x00);
    }
    #endregion

    #region PAYOUT_IND PC指示VMC出币
    /// &lt;summary&gt;
    /// PC指示VMC出币
    /// &lt;/summary&gt;
    /// &lt;param name="device"&gt;出币设备&lt;/param&gt;
    /// &lt;param name="value"&gt;本次出币总金额&lt;/param&gt;
    /// &lt;param name="type"&gt;出币类型 无需理解type 的含义，只需要在出币完成后的PAYOUT_RPT 中将该type 值回传给PC 即可&lt;/param&gt;
    public PayoutRpt PAYOUT_IND(PayoutType device, int value, byte type)
    {
      List&lt;byte&gt; sendData = new List&lt;byte&gt;() { 0xE5, 0x00, 0x00, 0x41, 0x89 };
      sendData.Add((byte)device);
      sendData.AddRange(CommonUtil.Int2ByteArray(value, 2));
      sendData.Add(type);
      m_CommandList.Add(new Cmd(sendData, new MT(sendData)));

      if (SendSuccess(0x89, 0x00))
      {
        byte[] receiveData = WaitReceive(0x07);
        if (receiveData != null)
        {
          return new PayoutRpt(receiveData);
        }
      }
      return null;
    }
    #endregion

    #region COST_IND PC扣款指示
    /// &lt;summary&gt;
    /// PC扣款指示
    /// &lt;/summary&gt;
    /// &lt;param name="device"&gt;device=0，从用户投币总额中扣款；优先从用户非暂存金额中扣除（纸币尽量滞后压钞），参见《现金扣款顺序》&lt;/param&gt;
    /// &lt;param name="value"&gt;扣款金额&lt;/param&gt;
    /// &lt;param name="type"&gt;VMC 不用理解type 的含义，只需上报对应的COST_RPT 时回传即可&lt;/param&gt;
    public CostRpt COST_IND(byte device, int value, byte type)
    {
      List&lt;byte&gt; sendData = new List&lt;byte&gt;() { 0xE5, 0x00, 0x00, 0x41, 0x8B };
      sendData.Add(device);
      sendData.AddRange(CommonUtil.Int2ByteArray(value, 2));
      sendData.Add(type);
      m_CommandList.Add(new Cmd(sendData, new MT(sendData)));

      if (SendSuccess(0x8B, 0x00))
      {
        byte[] receiveData = WaitReceive(0x10);
        if (receiveData != null)
        {
          return new CostRpt(receiveData);
        }
      }
      return null;
    }
    #endregion

    #region GET_HUODAO PC通知VMC上报HUODAO_RPT
    /// &lt;summary&gt;
    /// PC通知VMC上报HUODAO_RPT
    /// &lt;/summary&gt;
    /// &lt;param name="device"&gt;箱柜号&lt;/param&gt;
    public HuoDaoRpt GET_HUODAO(byte device)
    {
      List&lt;byte&gt; sendData = new List&lt;byte&gt;() { 0xE5, 0x00, 0x00, 0x40, 0x8A };
      sendData.Add(device);
      m_CommandList.Add(new Cmd(sendData));

      byte[] receiveData = WaitReceive(0x0E);
      if (receiveData != null)
      {
        return new HuoDaoRpt(receiveData);
      }
      return null;
    }
    #endregion

    #region SET_HUODAO PC发送配置货道信息
    /// &lt;summary&gt;
    /// PC发送配置货道信息
    /// &lt;/summary&gt;
    /// &lt;param name="Cabinet"&gt;箱柜号&lt;/param&gt;
    /// &lt;param name="hd_no"&gt;货道逻辑编号，十进制&lt;/param&gt;
    /// &lt;param name="Hd_id"&gt;商品ID号&lt;/param&gt;
    /// &lt;param name="Hd_count"&gt;货道剩余量&lt;/param&gt;
    /// &lt;param name="Hd_price"&gt;货道单价&lt;/param&gt;
    /// &lt;param name="Reserved"&gt;保留字段VMC忽略此字段，PC最好将此字段置为0&lt;/param&gt;
    public bool SET_HUODAO(byte Cabinet, int hd_no, int Hd_id, int Hd_count, int Hd_price, int Reserved = 0)
    {
      List&lt;byte&gt; sendData = new List&lt;byte&gt;() { 0xE5, 0x00, 0x00, 0x41, 0x93 };
      sendData.Add(Cabinet);
      sendData.Add((byte)hd_no);
      sendData.Add((byte)Hd_id);
      sendData.Add((byte)Hd_count);
      sendData.AddRange(CommonUtil.Int2ByteArray(Hd_price, 2));
      sendData.AddRange(CommonUtil.Int2ByteArray(Reserved, 2));
      m_CommandList.Add(new Cmd(sendData, new MT(sendData)));

      return SendSuccess(0x93, 0x00);
    }
    #endregion

    #region 开启纸硬币器
    /// &lt;summary&gt;
    /// 现金收银模组（纸币器、硬币器）开关
    /// &lt;/summary&gt;
    /// &lt;param name="open"&gt;true:开,false:关&lt;/param&gt;
    public bool CtrlCoinPaper(bool open)
    {
      if (open)
      {
        return CONTROL_IND(2, new byte[] { 1 });
      }
      else
      {
        return CONTROL_IND(2, new byte[] { 0 });
      }
    }
    #endregion

    #region 找零
    /// &lt;summary&gt;
    /// 找零
    /// 与手工拨弄物理找零开关相同
    /// &lt;/summary&gt;
    public bool MakeChange()
    {
      return CONTROL_IND(6, new byte[] { 0 });
    }
    #endregion

    #region 获取硬币器信息
    /// &lt;summary&gt;
    /// 获取硬币器信息
    /// &lt;/summary&gt;
    public InfoRpt_17 GetCoinInfo()
    {
      return new InfoRpt_17(GET_INFO(17));
    }
    #endregion

    #region 获取纸币器信息
    /// &lt;summary&gt;
    /// 获取纸币器信息
    /// &lt;/summary&gt;
    public InfoRpt_16 GetPaperInfo()
    {
      return new InfoRpt_16(GET_INFO(16));
    }
    #endregion

    #region 获取现金投币报告
    /// &lt;summary&gt;
    /// 获取现金投币报告
    /// &lt;/summary&gt;
    public PayinRpt GetPayinRpt()
    {
      byte[] receiveData = Receive(0x06, 0x00);
      if (receiveData != null)
      {
        return new PayinRpt(receiveData);
      }
      return null;
    }
    #endregion

    #region 获取用户投币余额
    /// &lt;summary&gt;
    /// 获取用户投币余额
    /// &lt;/summary&gt;
    public InfoRpt_3 GetRemaiderAmount()
    {
      byte[] receiveData = WaitReceive(0x11, 0x003);
      if (receiveData != null)
      {
        return new InfoRpt_3(receiveData);
      }
      return null;
    }
    #endregion

  }
}</pre>
</div>
<p><strong>ReceiveDataCollection类和ReceiveData类：&nbsp;</strong></p>
<p>&nbsp;</p>
<div class="phpstudycode">
<pre class="brush:csharp;">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;

namespace MachineJPDll.Models
{
  /// &lt;summary&gt;
  /// 从串口接收到的数据(数据已通过验证)
  /// &lt;/summary&gt;
  public class ReceiveData
  {
    /// &lt;summary&gt;
    /// 从串口接收到的数据(数据已通过验证)
    /// &lt;/summary&gt;
    public byte[] Data { get; set; }
    /// &lt;summary&gt;
    /// 添加到集合ReceiveDataCollection的时间
    /// &lt;/summary&gt;
    public DateTime AddTime { get; set; }
    /// &lt;summary&gt;
    /// 消息类型
    /// &lt;/summary&gt;
    public byte Type { get; set; }
    /// &lt;summary&gt;
    /// 消息子类型
    /// &lt;/summary&gt;
    public byte Subtype { get; set; }

    /// &lt;summary&gt;
    /// 从串口接收到的数据(数据已通过验证)
    /// &lt;/summary&gt;
    /// &lt;param name="type"&gt;消息类型&lt;/param&gt;
    /// &lt;param name="subtype"&gt;消息子类型&lt;/param&gt;
    /// &lt;param name="data"&gt;从串口接收到的数据(数据已通过验证)&lt;/param&gt;
    /// &lt;param name="addTime"&gt;添加到集合ReceiveDataCollection的时间&lt;/param&gt;
    public ReceiveData(byte type, byte subtype, byte[] data, DateTime addTime)
    {
      this.Type = type;
      this.Subtype = subtype;
      this.Data = data;
      this.AddTime = addTime;
    }
  }
}</pre>
</div>
<div class="phpstudycode">
<pre class="brush:csharp;">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;

namespace MachineJPDll.Models
{
  /// &lt;summary&gt;
  /// 从串口接收到的数据集合(数据已通过验证)
  /// &lt;/summary&gt;
  public class ReceiveDataCollection
  {
    /// &lt;summary&gt;
    /// 从串口接收到的数据集合(数据已通过验证)
    /// &lt;/summary&gt;
    private List&lt;ReceiveData&gt; m_ReceiveDataList = new List&lt;ReceiveData&gt;();
    /// &lt;summary&gt;
    /// 数据过期时间
    /// &lt;/summary&gt;
    private int m_Timeout = 3;
    private static object _lock = new object();

    /// &lt;summary&gt;
    /// 添加到集合
    /// &lt;/summary&gt;
    /// &lt;param name="type"&gt;消息类型&lt;/param&gt;
    /// &lt;param name="subtype"&gt;消息子类型&lt;/param&gt;
    /// &lt;param name="data"&gt;从串口接收到的数据(数据已通过验证)&lt;/param&gt;
    public void Add(byte type, byte subtype, byte[] data)
    {
      lock (_lock)
      {
        ReceiveData receiveData = new ReceiveData(type, subtype, data, DateTime.Now);
        m_ReceiveDataList.Add(receiveData);
        for (int i = m_ReceiveDataList.Count - 1; i &gt;= 0; i--)
        {
          if (DateTime.Now.Subtract(m_ReceiveDataList[i].AddTime).TotalMinutes &gt; m_Timeout)
          {
            m_ReceiveDataList.RemoveAt(i);
          }
        }
      }
    }

    /// &lt;summary&gt;
    /// 从集合中获取串口接收到的数据(数据已通过验证)
    /// &lt;/summary&gt;
    /// &lt;param name="type"&gt;消息类型&lt;/param&gt;
    /// &lt;param name="subtype"&gt;消息子类型&lt;/param&gt;
    /// &lt;returns&gt;从串口接收到的数据(数据已通过验证)&lt;/returns&gt;
    public byte[] Get(byte type, byte subtype)
    {
      lock (_lock)
      {
        ReceiveData receiveData = null;
        for (int i = 0; i &lt; m_ReceiveDataList.Count; i++)
        {
          if (m_ReceiveDataList[i].Type == type && m_ReceiveDataList[i].Subtype == subtype)
          {
            receiveData = m_ReceiveDataList[i];
            m_ReceiveDataList.RemoveAt(i);
            return receiveData.Data;
          }
        }
        return null;
      }
    }

    /// &lt;summary&gt;
    /// 从集合中获取串口接收到的数据(数据已通过验证)
    /// &lt;/summary&gt;
    /// &lt;param name="type"&gt;消息类型&lt;/param&gt;
    /// &lt;returns&gt;从串口接收到的数据(数据已通过验证)&lt;/returns&gt;
    public byte[] Get(byte type)
    {
      lock (_lock)
      {
        ReceiveData receiveData = null;
        for (int i = 0; i &lt; m_ReceiveDataList.Count; i++)
        {
          if (m_ReceiveDataList[i].Type == type)
          {
            receiveData = m_ReceiveDataList[i];
            m_ReceiveDataList.RemoveAt(i);
            return receiveData.Data;
          }
        }
        return null;
      }
    }
  }
}
</pre>
</div>
<p><strong>Models：</strong></p>
<p><strong>StatusRpt类：</strong></p>
<div class="phpstudycode">
<pre class="brush:csharp;">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using MachineJPDll;
using MachineJPDll.Enums;
using MachineJPDll.Utils;

namespace MachineJPDll.Models
{
  /// &lt;summary&gt;
  /// VMC状态报告
  /// &lt;/summary&gt;
  public class StatusRpt
  {
    /// &lt;summary&gt;
    /// 从串口读取的通过验证的数据
    /// &lt;/summary&gt;
    private byte[] m_data;

    /// &lt;summary&gt;
    /// VMC状态报告
    /// &lt;/summary&gt;
    /// &lt;param name="data"&gt;从串口读取的通过验证的数据&lt;/param&gt;
    public StatusRpt(byte[] data)
    {
      m_data = data;
    }

    public override string ToString()
    {
      StringBuilder sb = new StringBuilder();
      sb.AppendFormat("出货检测设备状态：{0}\r\n", check_st.ToString());
      sb.AppendFormat("纸币器状态：{0}\r\n", bv_st.ToString());
      sb.AppendFormat("硬币器状态：{0}\r\n", cc_st.ToString());
      sb.AppendFormat("VMC状态：{0}\r\n", vmc_st.ToString());
      sb.AppendFormat("展示位状态：{0} {1} {2} {3}\r\n", pos_st[0].ToString(), pos_st[1].ToString(), pos_st[2].ToString(), pos_st[3].ToString());
      sb.AppendFormat("机器中可用的找零量总金额(包括硬币和纸币)：{0}\r\n", change.ToString());
      sb.AppendFormat("货仓1货仓2货仓3货仓4温度：{0} {1} {2} {3}\r\n", tem1.ToString(), tem2.ToString(), tem3.ToString(), tem4.ToString());
      sb.AppendFormat("货仓状态设置值：{0} {1} {2} {3}\r\n", tem_st[0].ToString(), tem_st[1].ToString(), tem_st[2].ToString(), tem_st[3].ToString());
      if (this.自动退币 == 255)
      {
        sb.AppendFormat("自动退币时间：永不自动退币\r\n");
      }
      else
      {
        sb.AppendFormat("自动退币时间：{0}\r\n", 自动退币.ToString());
      }
      sb.AppendFormat("找零余量(1#--6#)：{0} {1} {2} {3} {4} {5}\r\n", this.找零余量1, this.找零余量2, this.找零余量3, this.找零余量4, this.找零余量5, this.找零余量6);

      return sb.ToString();
    }

    /// &lt;summary&gt;
    /// 出货检测设备状态
    /// &lt;/summary&gt;
    public CheckSt check_st
    {
      get
      {
        byte val = m_data[5];
        return (CheckSt)CommonUtil.GetFromByte(val, 0, 2);
      }
    }

    /// &lt;summary&gt;
    /// 纸币器状态
    /// &lt;/summary&gt;
    public DeviceSt bv_st
    {
      get
      {
        byte val = m_data[5];
        return (DeviceSt)CommonUtil.GetFromByte(val, 2, 2);
      }
    }

    /// &lt;summary&gt;
    /// 硬币器状态
    /// &lt;/summary&gt;
    public DeviceSt cc_st
    {
      get
      {
        byte val = m_data[5];
        return (DeviceSt)CommonUtil.GetFromByte(val, 4, 2);
      }
    }

    /// &lt;summary&gt;
    /// VMC状态
    /// &lt;/summary&gt;
    public VmcSt vmc_st
    {
      get
      {
        byte val = m_data[5];
        return (VmcSt)CommonUtil.GetFromByte(val, 6, 2);
      }
    }

    /// &lt;summary&gt;
    /// 展示位状态
    /// &lt;/summary&gt;
    public List&lt;DeviceSt&gt; pos_st
    {
      get
      {
        List&lt;DeviceSt&gt; deviceStList = new List&lt;DeviceSt&gt;();

        byte val = m_data[6];
        for (int i = 0; i &lt; 4; i++)
        {
          DeviceSt deviceSt = (DeviceSt)CommonUtil.GetFromByte(val, i * 2, 2);
          deviceStList.Add(deviceSt);
        }

        return deviceStList;
      }
    }

    /// &lt;summary&gt;
    /// 机器中，可用的找零量总金额（包括硬币和纸币）
    /// &lt;/summary&gt;
    public int change
    {
      get
      {
        return CommonUtil.ByteArray2Int(m_data, 7, 2);
      }
    }

    /// &lt;summary&gt;
    /// 货仓1 温度，8 位有符号数，该温度通过货仓内传感器获取，单位：℃
    /// &lt;/summary&gt;
    public TemSub tem1
    {
      get
      {
        return new TemSub(m_data[9]);
      }
    }

    /// &lt;summary&gt;
    /// 货仓2 温度，8 位有符号数，该温度通过货仓内传感器获取，单位：℃
    /// &lt;/summary&gt;
    public TemSub tem2
    {
      get
      {
        return new TemSub(m_data[10]);
      }
    }

    /// &lt;summary&gt;
    /// 货仓3 温度，8 位有符号数，该温度通过货仓内传感器获取，单位：℃
    /// &lt;/summary&gt;
    public TemSub tem3
    {
      get
      {
        return new TemSub(m_data[11]);
      }
    }

    /// &lt;summary&gt;
    /// 货仓4 温度，8 位有符号数，该温度通过货仓内传感器获取，单位：℃
    /// &lt;/summary&gt;
    public TemSub tem4
    {
      get
      {
        return new TemSub(m_data[12]);
      }
    }

    /// &lt;summary&gt;
    /// 货仓状态设置值，共支持4 个货仓
    /// &lt;/summary&gt;
    public List&lt;TemSt&gt; tem_st
    {
      get
      {
        List&lt;TemSt&gt; temStList = new List&lt;TemSt&gt;();
        for (int i = 0; i &lt; 4; i++)
        {
          TemSt temSt = (TemSt)CommonUtil.GetFromByte(m_data[13], i * 2, 2);
          temStList.Add(temSt);
        }
        return temStList;
      }
    }

    /// &lt;summary&gt;
    /// 自动退币时间。
    /// 0：表示商品出货后，立即自动退币
    /// 255：表示永不自动退币
    /// 1-254：表示商品出货后，自动退币时间（单位：秒）
    /// &lt;/summary&gt;
    public int 自动退币
    {
      get
      {
        return m_data[14];
      }
    }

    /// &lt;summary&gt;
    /// 找零余量“找零量1#”…“找零量6#”，分别对应硬币器信息INFO_RPT.type=17 的“找零
    /// 1#”…“找零6#”中每种钱币的找零数量；
    /// * 找零量最大为255，超过255 时上报为255；
    /// * 找零量单位为“个”，代表可找零硬币的个数。
    /// &lt;/summary&gt;
    public int 找零余量1
    {
      get
      {
        return m_data[15];
      }
    }

    /// &lt;summary&gt;
    /// 找零余量“找零量1#”…“找零量6#”，分别对应硬币器信息INFO_RPT.type=17 的“找零
    /// 1#”…“找零6#”中每种钱币的找零数量；
    /// * 找零量最大为255，超过255 时上报为255；
    /// * 找零量单位为“个”，代表可找零硬币的个数。
    /// &lt;/summary&gt;
    public int 找零余量2
    {
      get
      {
        return m_data[16];
      }
    }

    /// &lt;summary&gt;
    /// 找零余量“找零量1#”…“找零量6#”，分别对应硬币器信息INFO_RPT.type=17 的“找零
    /// 1#”…“找零6#”中每种钱币的找零数量；
    /// * 找零量最大为255，超过255 时上报为255；
    /// * 找零量单位为“个”，代表可找零硬币的个数。
    /// &lt;/summary&gt;
    public int 找零余量3
    {
      get
      {
        return m_data[17];
      }
    }

    /// &lt;summary&gt;
    /// 找零余量“找零量1#”…“找零量6#”，分别对应硬币器信息INFO_RPT.type=17 的“找零
    /// 1#”…“找零6#”中每种钱币的找零数量；
    /// * 找零量最大为255，超过255 时上报为255；
    /// * 找零量单位为“个”，代表可找零硬币的个数。
    /// &lt;/summary&gt;
    public int 找零余量4
    {
      get
      {
        return m_data[18];
      }
    }

    /// &lt;summary&gt;
    /// 找零余量“找零量1#”…“找零量6#”，分别对应硬币器信息INFO_RPT.type=17 的“找零
    /// 1#”…“找零6#”中每种钱币的找零数量；
    /// * 找零量最大为255，超过255 时上报为255；
    /// * 找零量单位为“个”，代表可找零硬币的个数。
    /// &lt;/summary&gt;
    public int 找零余量5
    {
      get
      {
        return m_data[19];
      }
    }

    /// &lt;summary&gt;
    /// 找零余量“找零量1#”…“找零量6#”，分别对应硬币器信息INFO_RPT.type=17 的“找零
    /// 1#”…“找零6#”中每种钱币的找零数量；
    /// * 找零量最大为255，超过255 时上报为255；
    /// * 找零量单位为“个”，代表可找零硬币的个数。
    /// &lt;/summary&gt;
    public int 找零余量6
    {
      get
      {
        return m_data[20];
      }
    }

  }
}</pre>
</div>
<p>以上就是C#实现自动售货机接口的代码，需要的朋友可以来学习。</p>
<hr></span>                                     
		    	</div>
		    	<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>代码注释</div>
			    <div class="panel-content">
			    <span></span>                                     
		    	</div>

			</div>

			<!-- END ROW -->
			<div class="newsPage">
				<div class="newsPageTurn">
				    <span><a>上一篇</a><a href='/php/biji/106272.html'>Android App实现应用内部自动更新的最基本方法示例</a><a>下一篇</a><a href='/php/biji/106274.html'>详解Android中Intent对象与Intent Filter过滤匹配过程</a></span>
				</div>
			</div>
		</div>


<div id="author-box">
    <h3>作者：喵哥笔记</h3>
        <div class="author-info">
            <div class="author-avatar">
                <img src="/skin1/picture/01.jpg" alt="IDC笔记" class="avatar" width="64" height="64">
            </div>
        <div class="author-description">
            <p>学的不仅是技术，更是梦想！</p>
            <ul class="author-social follows nb">
            	<li>
                    <a target="_blank" href="/" title="IDC笔记">IDC笔记</a>
                </li>
            </ul>
        </div>
        <div class="clear"></div>
    </div>
</div>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
<!-- container-fluid -->
	</div>
<!-- content -->
	<footer class="footer">
	© 2020 IDC笔记 <i class="mdi mdi-heart text-danger"></i>. | 备案号：<a href="https://beian.miit.gov.cn/">辽ICP备18000516号</a>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?674585fbbd2294d3faf910f668ea91b4";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

	</footer>
</div>

</div>
<!-- END wrapper -->
<!-- jQuery  -->
<script src="/skin1/js/jquery.min.js"></script>
<script src="/skin1/js/bootstrap.bundle.min.js"></script>
<script src="/skin1/js/metismenu.min.js"></script>
<script src="/skin1/js/jquery.slimscroll.js"></script>
<script src="/skin1/js/waves.min.js"></script>
<!--Morris Chart-->
<script src="/skin1/js/morris.min.js"></script>
<script src="/skin1/js/raphael.min.js"></script>
<script src="/skin1/js/dashboard.init.js"></script>
<script src="/skin1/js/app.js"></script>
<script src="/foot.js"></script>
</body>
</html>