<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <title>PHP使用Face++接口开发微信公众平台人脸识别系统的方法_PHP教程_IDC笔记</title>
    <meta name="keywords" content="PHP,PHP笔记,PHP教程" />
    <meta name="description" content="本文实例讲述了PHP使用Face++接口开发微信公众平台人脸识别系统的方法。分享给大家供大家参考。具体如下：<br />
效果图如下：<br />
<br />
<br />
具体步骤如下：<br />
首先，先登录Face++的官网注册账号：官网链" />
    <meta content="Responsive admin theme build on top of Bootstrap 4" name="description" />
    <meta content="idcnote.com" name="author" />
    <link rel="shortcut icon" href="/skin1/images/favicon.ico">
    <!--Morris Chart CSS -->
    <link rel="stylesheet" href="/skin1/css/morris.css">
    <link href="/skin1/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/metismenu.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/icons.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/style.css" rel="stylesheet" type="text/css">
<link href="/SyntaxHighlighter/shCoreDefault.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">
 SyntaxHighlighter.all();
</script>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
</head>
<body>
<!-- Begin page -->
		<div id="wrapper">
			<!-- Top Bar Start -->
			<div class="topbar">
				<!-- LOGO -->
				<div class="topbar-left">
					<a href="/" class="logo">
						<span class="logo-light">
                            <i class="mdi mdi-camera-control"></i>IDC笔记
                        </span>
						<span class="logo-sm">
                            <i class="mdi mdi-camera-control"></i>
                        </span>
					</a>
				</div>
				<nav class="navbar-custom">
					<ul class="navbar-right list-inline float-right mb-0">
						<!--<li class="dropdown notification-list list-inline-item d-none d-md-inline-block">
							<a class="nav-link waves-effect" href="#" id="btn-fullscreen">
								<i class="mdi mdi-arrow-expand-all noti-icon"></i>
							</a>
						</li>
						<li class="dropdown notification-list list-inline-item">
							<div class="dropdown notification-list nav-pro-img">
								<a class="dropdown-toggle nav-link arrow-none nav-user" data-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
									<img src="/skin1/picture/user-4.jpg" alt="user" class="rounded-circle">
								</a>
								<div class="dropdown-menu dropdown-menu-right profile-dropdown ">
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-account-circle"></i> Profile</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-wallet"></i> Wallet</a>
									<a class="dropdown-item d-block" href="#">
										<span class="badge badge-success float-right">11</span>
										<i class="mdi mdi-settings"></i> Settings</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-lock-open-outline"></i> Lock screen</a>
									<div class="dropdown-divider"></div>
									<a class="dropdown-item text-danger" href="#">
										<i class="mdi mdi-power text-danger"></i> Logout</a>
								</div>
							</div>
						</li>
						-->
					</ul>
					<ul class="list-inline menu-left mb-0">
						<li class="float-left">
							<button class="button-menu-mobile open-left waves-effect">
                            <i class="mdi mdi-menu"></i>
                        </button>
						</li>
						<li class="d-none d-md-inline-block">
							<form role="search" class="app-search">
								<div class="form-group mb-0">
									<input type="text" class="form-control" placeholder="Search..">
									<button type="submit"><i class="fa fa-search"></i></button>
								</div>
							</form>
						</li>
					</ul>
				</nav>
			</div>
<!-- ========== Left Sidebar Start ========== -->
<div class="left side-menu">
    <div class="slimscroll-menu" id="remove-scroll">
    <!--- Sidemenu -->
    <div id="sidebar-menu">
    <!-- Left Menu Start -->
    <ul class="metismenu" id="side-menu">
			<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP简介			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/jianjie/1.html">PHP简介</a></li><li><a href="/php/jianjie/2.html">PHP用途</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP基本语法			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yufa/3.html">分离HTML</a></li><li><a href="/php/yufa/4.html">指令分隔符</a></li><li><a href="/php/yufa/5.html">PHP注释</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP类型			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpleixing/6.html">PHP类型简介</a></li><li><a href="/php/phpleixing/7.html">PHP类型之布尔类型</a></li><li><a href="/php/phpleixing/8.html">PHP类型之整型</a></li><li><a href="/php/phpleixing/9.html">PHP类型之浮点型</a></li><li><a href="/php/phpleixing/10.html">PHP类型之字符串</a></li><li><a href="/php/phpleixing/11.html">PHP类型之数组</a></li><li><a href="/php/phpleixing/12.html">PHP类型之对象</a></li><li><a href="/php/phpleixing/13.html">PHP类型之资源类型</a></li><li><a href="/php/phpleixing/14.html">PHP类型之NULL</a></li><li><a href="/php/phpleixing/15.html">PHP类型之伪类型</a></li><li><a href="/php/phpleixing/16.html">PHP类型之类型判别</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP变量			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpbianliang/17.html">PHP变量之基础</a></li><li><a href="/php/phpbianliang/18.html">PHP变量之预定义变量</a></li><li><a href="/php/phpbianliang/19.html">PHP变量之变量范围</a></li><li><a href="/php/phpbianliang/20.html">PHP变量之可变变量</a></li><li><a href="/php/phpbianliang/21.html">PHP变量之外部变量</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP运算符			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yunsuanfu/22.html">PHP运算符优先级</a></li><li><a href="/php/yunsuanfu/23.html">算术运算符</a></li><li><a href="/php/yunsuanfu/24.html">赋值运算符</a></li><li><a href="/php/yunsuanfu/25.html">位运算符</a></li><li><a href="/php/yunsuanfu/26.html">比较运算符</a></li><li><a href="/php/yunsuanfu/27.html">错误控制运算符</a></li><li><a href="/php/yunsuanfu/28.html">执行运算符</a></li><li><a href="/php/yunsuanfu/29.html">递增/递减运算符</a></li><li><a href="/php/yunsuanfu/30.html">逻辑运算符</a></li><li><a href="/php/yunsuanfu/31.html">字符串运算符</a></li><li><a href="/php/yunsuanfu/32.html">数组运算符</a></li><li><a href="/php/yunsuanfu/33.html">类型运算符</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP控制结构			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/jiegou/34.html">PHP控制结构之if</a></li><li><a href="/php/jiegou/35.html">PHP控制结构之else</a></li><li><a href="/php/jiegou/36.html">PHP控制结构之elseif/else if</a></li><li><a href="/php/jiegou/37.html">PHP控制结构之替代语法</a></li><li><a href="/php/jiegou/38.html">PHP控制结构之while</a></li><li><a href="/php/jiegou/39.html">PHP控制结构之do-while</a></li><li><a href="/php/jiegou/40.html">PHP控制结构之for</a></li><li><a href="/php/jiegou/41.html">PHP控制结构之foreach</a></li><li><a href="/php/jiegou/42.html">PHP控制结构之break</a></li><li><a href="/php/jiegou/43.html">PHP控制结构之continue</a></li><li><a href="/php/jiegou/44.html">PHP控制结构之switch</a></li><li><a href="/php/jiegou/45.html">PHP控制结构之declare</a></li><li><a href="/php/jiegou/46.html">PHP控制结构之return</a></li><li><a href="/php/jiegou/47.html">PHP控制结构之require</a></li><li><a href="/php/jiegou/48.html">PHP控制结构之include</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP函数			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/hanshu/52.html">用户自定义函数</a></li><li><a href="/php/hanshu/53.html">函数的参数</a></li><li><a href="/php/hanshu/54.html">返回值</a></li><li><a href="/php/hanshu/55.html">可变函数</a></li><li><a href="/php/hanshu/56.html">内部（内置）函数</a></li><li><a href="/php/hanshu/57.html">匿名函数</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP类与对象			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpduixiang/58.html">类与对象前言</a></li><li><a href="/php/phpduixiang/59.html">基本概念</a></li><li><a href="/php/phpduixiang/60.html">属性</a></li><li><a href="/php/phpduixiang/61.html">类常量</a></li><li><a href="/php/phpduixiang/62.html">自动加载对象</a></li><li><a href="/php/phpduixiang/63.html">构造函数和析构函数</a></li><li><a href="/php/phpduixiang/64.html">访问控制</a></li><li><a href="/php/phpduixiang/65.html">对象继承</a></li><li><a href="/php/phpduixiang/66.html">Static关键字</a></li><li><a href="/php/phpduixiang/67.html">抽象类</a></li><li><a href="/php/phpduixiang/68.html">接口</a></li><li><a href="/php/phpduixiang/69.html">Traits</a></li><li><a href="/php/phpduixiang/70.html">重载</a></li><li><a href="/php/phpduixiang/71.html">对象迭代</a></li><li><a href="/php/phpduixiang/72.html">设计模式</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP异常处理			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yichang/81.html">异常处理</a></li><li><a href="/php/yichang/82.html">扩展PHP内置的异常处理类</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP函数库按分类			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpku/83.html">数组</a></li><li><a href="/php/phpku/84.html">Classes/Objects</a></li><li><a href="/php/phpku/85.html">Date/Time</a></li><li><a href="/php/phpku/86.html">Directories</a></li><li><a href="/php/phpku/87.html">错误处理</a></li><li><a href="/php/phpku/88.html">Program execution</a></li><li><a href="/php/phpku/89.html">Filesystem</a></li><li><a href="/php/phpku/90.html">Filter</a></li><li><a href="/php/phpku/91.html">Function Handling</a></li><li><a href="/php/phpku/92.html">PHP 选项/信息</a></li><li><a href="/php/phpku/93.html">Mail</a></li><li><a href="/php/phpku/94.html">Math</a></li><li><a href="/php/phpku/95.html">Misc.</a></li><li><a href="/php/phpku/96.html">Network</a></li><li><a href="/php/phpku/97.html">输出控制</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> php基础			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpbiji/108377.html"></a></li><li><a href="/php/phpbiji/108376.html"></a></li><li><a href="/php/phpbiji/108380.html"></a></li><li><a href="/php/phpbiji/108379.html"></a></li><li><a href="/php/phpbiji/108378.html"></a></li><li><a href="/php/phpbiji/108381.html"></a></li><li><a href="/php/phpbiji/108382.html"></a></li><li><a href="/php/phpbiji/108384.html"></a></li><li><a href="/php/phpbiji/108383.html"></a></li><li><a href="/php/phpbiji/108385.html"></a></li><li><a href="/php/phpbiji/108386.html"></a></li><li><a href="/php/phpbiji/108388.html"></a></li><li><a href="/php/phpbiji/108387.html"></a></li><li><a href="/php/phpbiji/108389.html"></a></li><li><a href="/php/phpbiji/108391.html"></a></li>		</ul>
	</li>
		<li>
	    <a href="/php/biji/" class="waves-effect">
		    <i class="icon-share"></i>
		    <span>PHP笔记
		       	<span class="float-right menu-arrow">
		       	<i class="mdi mdi-chevron-right"></i>
		       	</span>
		    </span>
	    </a>
	</li>
	</ul>
</div>
<!-- Sidebar -->
<div class="clearfix"></div>
</div>
<!-- Sidebar -left -->
</div>
<!-- Left Sidebar End -->
<!-- Start right Content here -->
<div class="content-page">
	<div class="content">
		<div class="container-fluid">
			<div class="page-title-box">
				<div class="row align-items-center">
					<div class="col-sm-6">
						<h1 class="page-title">PHP使用Face++接口开发微信公众平台人脸识别系统的方法</h1>
					</div>
				</div>
				<!-- end row -->
			</div>
			<!-- end page-title -->
			<!-- START ROW -->
			<div class="panel panel-forbid">
				<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>内容摘要</div>
			    <div class="panel-content">
			    <span>本文实例讲述了PHP使用Face++接口开发微信公众平台人脸识别系统的方法。分享给大家供大家参考。具体如下：<br />
效果图如下：<br />
<br />
<br />
具体步骤如下：<br />
首先，先登录Face++的官网注册账号：官网链</span>                                     
		    	</div>
			    <div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>文章正文</div>
			    <div class="panel-content">
			    <span><p>本文实例讲述了PHP使用Face++接口开发微信公众平台人脸识别系统的方法。分享给大家供大家参考。具体如下：</p>
<p>效果图如下：</p>
<p></p>
<p></p>
<p>具体步骤如下：</p>
<p>首先，先登录Face++的官网注册账号：官网链接<br />
注册之后会获取到api_secret和api_key，这些在调用接口的时候需要用到。<br />
然后接下来的就是使用PHP脚本调用API了。<br />
在使用PHP开发微信公共平台的时候，推荐使用Github上的一款不错的框架：wechat-php-sdk<br />
对于微信的常用接口做了一些封装，核心文件wechat.class.php如下：</p>
<div class="phpstudycode">
<pre class="brush:php;">
&lt;&#63;php 
/** 
 * 微信公众平台PHP-SDK, 官方API部分 
 * @author dodge &lt;dodgepudding@gmail.com&gt; 
 * @link https://github.com/dodgepudding/wechat-php-sdk 
 * @version 1.2 
 * usage: 
 *  $options = array( 
 *     'token'=&gt;'tokenaccesskey', //填写你设定的key 
 *     'appid'=&gt;'wxdk1234567890', //填写高级调用功能的app id 
 *     'appsecret'=&gt;'xxxxxxxxxxxxxxxxxxx', //填写高级调用功能的密钥 
 *   ); 
 *  $weObj = new Wechat($options); 
 *  $weObj-&gt;valid(); 
 *  $type = $weObj-&gt;getRev()-&gt;getRevType(); 
 *  switch($type) { 
 *     case Wechat::MSGTYPE_TEXT: 
 *       $weObj-&gt;text("hello, I'm wechat")-&gt;reply(); 
 *       exit; 
 *       break; 
 *     case Wechat::MSGTYPE_EVENT: 
 *       .... 
 *       break; 
 *     case Wechat::MSGTYPE_IMAGE: 
 *       ... 
 *       break; 
 *     default: 
 *       $weObj-&gt;text("help info")-&gt;reply(); 
 *  } 
 *  //获取菜单操作: 
 *  $menu = $weObj-&gt;getMenu(); 
 *  //设置菜单 
 *  $newmenu = array( 
 *     "button"=&gt; 
 *       array( 
 *         array('type'=&gt;'click','name'=&gt;'最新消息','key'=&gt;'MENU_KEY_NEWS'), 
 *         array('type'=&gt;'view','name'=&gt;'我要搜索','url'=&gt;'http://www.baidu.com'), 
 *         ) 
 *     ); 
 *  $result = $weObj-&gt;createMenu($newmenu); 
 */ 
class Wechat 
{ 
  const MSGTYPE_TEXT = 'text'; 
  const MSGTYPE_IMAGE = 'image'; 
  const MSGTYPE_LOCATION = 'location'; 
  const MSGTYPE_LINK = 'link'; 
  const MSGTYPE_EVENT = 'event'; 
  const MSGTYPE_MUSIC = 'music'; 
  const MSGTYPE_NEWS = 'news'; 
  const MSGTYPE_VOICE = 'voice'; 
  const MSGTYPE_VIDEO = 'video'; 
  const API_URL_PREFIX = 'https://api.weixin.qq.com/cgi-bin'; 
  const AUTH_URL = '/token&#63;grant_type=client_credential&'; 
  const MENU_CREATE_URL = '/menu/create&#63;'; 
  const MENU_GET_URL = '/menu/get&#63;'; 
  const MENU_DELETE_URL = '/menu/delete&#63;'; 
  const MEDIA_GET_URL = '/media/get&#63;'; 
  const QRCODE_CREATE_URL='/qrcode/create&#63;'; 
  const QR_SCENE = 0; 
  const QR_LIMIT_SCENE = 1; 
  const QRCODE_IMG_URL='https://mp.weixin.qq.com/cgi-bin/showqrcode&#63;ticket='; 
  const USER_GET_URL='/user/get&#63;'; 
  const USER_INFO_URL='/user/info&#63;'; 
  const GROUP_GET_URL='/groups/get&#63;'; 
  const GROUP_CREATE_URL='/groups/create&#63;'; 
  const GROUP_UPDATE_URL='/groups/update&#63;'; 
  const GROUP_MEMBER_UPDATE_URL='/groups/members/update&#63;'; 
  const CUSTOM_SEND_URL='/message/custom/send&#63;'; 
  const OAUTH_PREFIX = 'https://open.weixin.qq.com/connect/oauth2'; 
  const OAUTH_AUTHORIZE_URL = '/authorize&#63;'; 
  const OAUTH_TOKEN_PREFIX = 'https://api.weixin.qq.com/sns/oauth2'; 
  const OAUTH_TOKEN_URL = '/access_token&#63;'; 
  const OAUTH_REFRESH_URL = '/refresh_token&#63;'; 
  const OAUTH_USERINFO_URL = 'https://api.weixin.qq.com/sns/userinfo&#63;'; 
  private $token; 
  private $appid; 
  private $appsecret; 
  private $access_token; 
  private $user_token; 
  private $_msg; 
  private $_funcflag = false; 
  private $_receive; 
  public $debug = false; 
  public $errCode = 40001; 
  public $errMsg = "no access"; 
  private $_logcallback; 
  public function __construct($options) 
  { 
    $this-&gt;token = isset($options['token'])&#63;$options['token']:''; 
    $this-&gt;appid = isset($options['appid'])&#63;$options['appid']:''; 
    $this-&gt;appsecret = isset($options['appsecret'])&#63;$options['appsecret']:''; 
    $this-&gt;debug = isset($options['debug'])&#63;$options['debug']:false; 
    $this-&gt;_logcallback = isset($options['logcallback'])&#63;$options['logcallback']:false; 
  } 
  /** 
   * For weixin server validation 
   */  
  private function checkSignature() 
  { 
    $signature = isset($_GET["signature"])&#63;$_GET["signature"]:''; 
    $timestamp = isset($_GET["timestamp"])&#63;$_GET["timestamp"]:''; 
    $nonce = isset($_GET["nonce"])&#63;$_GET["nonce"]:''; 
    $token = $this-&gt;token; 
    $tmpArr = array($token, $timestamp, $nonce); 
    sort($tmpArr, SORT_STRING); 
    $tmpStr = implode( $tmpArr ); 
    $tmpStr = sha1( $tmpStr ); 
    if( $tmpStr == $signature ){ 
      return true; 
    }else{ 
      return false; 
    } 
  } 
  /** 
   * For weixin server validation 
   * @param bool $return 是否返回 
   */ 
  public function valid($return=false) 
  { 
    $echoStr = isset($_GET["echostr"]) &#63; $_GET["echostr"]: ''; 
    if ($return) { 
        if ($echoStr) { 
          if ($this-&gt;checkSignature())  
            return $echoStr; 
          else 
            return false; 
        } else  
          return $this-&gt;checkSignature(); 
    } else { 
        if ($echoStr) { 
          if ($this-&gt;checkSignature()) 
            die($echoStr); 
          else  
            die('no access'); 
        } else { 
          if ($this-&gt;checkSignature()) 
            return true; 
          else 
            die('no access'); 
        } 
    } 
    return false; 
  } 
  /** 
   * 设置发送消息 
   * @param array $msg 消息数组 
   * @param bool $append 是否在原消息数组追加 
   */ 
  public function Message($msg = '',$append = false){ 
      if (is_null($msg)) { 
        $this-&gt;_msg =array(); 
      }elseif (is_array($msg)) { 
        if ($append) 
          $this-&gt;_msg = array_merge($this-&gt;_msg,$msg); 
        else 
          $this-&gt;_msg = $msg; 
        return $this-&gt;_msg; 
      } else { 
        return $this-&gt;_msg; 
      } 
  } 
  public function setFuncFlag($flag) { 
      $this-&gt;_funcflag = $flag; 
      return $this; 
  } 
  private function log($log){ 
      if ($this-&gt;debug && function_exists($this-&gt;_logcallback)) { 
        if (is_array($log)) $log = print_r($log,true); 
        return call_user_func($this-&gt;_logcallback,$log); 
      } 
  } 
  /** 
   * 获取微信服务器发来的信息 
   */ 
  public function getRev() 
  { 
    if ($this-&gt;_receive) return $this; 
    $postStr = file_get_contents("php://input"); 
    $this-&gt;log($postStr); 
    if (!empty($postStr)) { 
      $this-&gt;_receive = (array)simplexml_load_string($postStr, 'SimpleXMLElement', LIBXML_NOCDATA); 
    } 
    return $this; 
  } 
  /** 
   * 获取微信服务器发来的信息 
   */ 
  public function getRevData() 
  { 
    return $this-&gt;_receive; 
  } 
  /** 
   * 获取消息发送者 
   */ 
  public function getRevFrom() { 
    if (isset($this-&gt;_receive['FromUserName'])) 
      return $this-&gt;_receive['FromUserName']; 
    else  
      return false; 
  } 
  /** 
   * 获取消息接受者 
   */ 
  public function getRevTo() { 
    if (isset($this-&gt;_receive['ToUserName'])) 
      return $this-&gt;_receive['ToUserName']; 
    else  
      return false; 
  } 
  /** 
   * 获取接收消息的类型 
   */ 
  public function getRevType() { 
    if (isset($this-&gt;_receive['MsgType'])) 
      return $this-&gt;_receive['MsgType']; 
    else  
      return false; 
  } 
  /** 
   * 获取消息ID 
   */ 
  public function getRevID() { 
    if (isset($this-&gt;_receive['MsgId'])) 
      return $this-&gt;_receive['MsgId']; 
    else  
      return false; 
  } 
  /** 
   * 获取消息发送时间 
   */ 
  public function getRevCtime() { 
    if (isset($this-&gt;_receive['CreateTime'])) 
      return $this-&gt;_receive['CreateTime']; 
    else  
      return false; 
  } 
  /** 
   * 获取接收消息内容正文 
   */ 
  public function getRevContent(){ 
    if (isset($this-&gt;_receive['Content'])) 
      return $this-&gt;_receive['Content']; 
    else if (isset($this-&gt;_receive['Recognition'])) //获取语音识别文字内容，需申请开通 
      return $this-&gt;_receive['Recognition']; 
    else 
      return false; 
  } 
  /** 
   * 获取接收消息图片 
   */ 
  public function getRevPic(){ 
    if (isset($this-&gt;_receive['PicUrl'])) 
      return $this-&gt;_receive['PicUrl']; 
    else  
      return false; 
  } 
  /** 
   * 获取接收消息链接 
   */ 
  public function getRevLink(){ 
    if (isset($this-&gt;_receive['Url'])){ 
      return array( 
        'url'=&gt;$this-&gt;_receive['Url'], 
        'title'=&gt;$this-&gt;_receive['Title'], 
        'description'=&gt;$this-&gt;_receive['Description'] 
      ); 
    } else  
      return false; 
  } 
  /** 
   * 获取接收地理位置 
   */ 
  public function getRevGeo(){ 
    if (isset($this-&gt;_receive['Location_X'])){ 
      return array( 
        'x'=&gt;$this-&gt;_receive['Location_X'], 
        'y'=&gt;$this-&gt;_receive['Location_Y'], 
        'scale'=&gt;$this-&gt;_receive['Scale'], 
        'label'=&gt;$this-&gt;_receive['Label'] 
      ); 
    } else  
      return false; 
  } 
  /** 
   * 获取接收事件推送 
   */ 
  public function getRevEvent(){ 
    if (isset($this-&gt;_receive['Event'])){ 
      return array( 
        'event'=&gt;$this-&gt;_receive['Event'], 
        'key'=&gt;$this-&gt;_receive['EventKey'], 
      ); 
    } else  
      return false; 
  } 
  /** 
   * 获取接收语言推送 
   */ 
  public function getRevVoice(){ 
    if (isset($this-&gt;_receive['MediaId'])){ 
      return array( 
        'mediaid'=&gt;$this-&gt;_receive['MediaId'], 
        'format'=&gt;$this-&gt;_receive['Format'], 
      ); 
    } else  
      return false; 
  } 
  /** 
   * 获取接收视频推送 
   */ 
  public function getRevVideo(){ 
    if (isset($this-&gt;_receive['MediaId'])){ 
      return array( 
          'mediaid'=&gt;$this-&gt;_receive['MediaId'], 
          'thumbmediaid'=&gt;$this-&gt;_receive['ThumbMediaId'] 
      ); 
    } else 
      return false; 
  } 
  /** 
   * 获取接收TICKET 
   */ 
  public function getRevTicket(){ 
  if (isset($this-&gt;_receive['Ticket'])){ 
    return $this-&gt;_receive['Ticket']; 
  } else 
    return false; 
  } 
  /** 
   * 获取二维码的场景值 
   */ 
  public function getRevSceneId (){ 
    if (isset($this-&gt;_receive['EventKey'])){ 
      return str_replace('qrscene_','',$this-&gt;_receive['EventKey']); 
    } else{ 
      return false; 
    } 
  } 
  public static function xmlSafeStr($str) 
  {   
    return '&lt;![CDATA['.preg_replace("/[\\x00-\\x08\\x0b-\\x0c\\x0e-\\x1f]/",'',$str).']]&gt;';   
  }  
  /** 
   * 数据XML编码 
   * @param mixed $data 数据 
   * @return string 
   */ 
  public static function data_to_xml($data) { 
    $xml = ''; 
    foreach ($data as $key =&gt; $val) { 
      is_numeric($key) && $key = "item id=\"$key\""; 
      $xml  .= "&lt;$key&gt;"; 
      $xml  .= ( is_array($val) || is_object($val)) &#63; self::data_to_xml($val) : self::xmlSafeStr($val); 
      list($key, ) = explode(' ', $key); 
      $xml  .= "&lt;/$key&gt;"; 
    } 
    return $xml; 
  }   
  /** 
   * XML编码 
   * @param mixed $data 数据 
   * @param string $root 根节点名 
   * @param string $item 数字索引的子节点名 
   * @param string $attr 根节点属性 
   * @param string $id  数字索引子节点key转换的属性名 
   * @param string $encoding 数据编码 
   * @return string 
  */ 
  public function xml_encode($data, $root='xml', $item='item', $attr='', $id='id', $encoding='utf-8') { 
    if(is_array($attr)){ 
      $_attr = array(); 
      foreach ($attr as $key =&gt; $value) { 
        $_attr[] = "{$key}=\"{$value}\""; 
      } 
      $attr = implode(' ', $_attr); 
    } 
    $attr  = trim($attr); 
    $attr  = empty($attr) &#63; '' : " {$attr}"; 
    $xml  = "&lt;{$root}{$attr}&gt;"; 
    $xml  .= self::data_to_xml($data, $item, $id); 
    $xml  .= "&lt;/{$root}&gt;"; 
    return $xml; 
  } 
  /** 
   * 设置回复消息 
   * Examle: $obj-&gt;text('hello')-&gt;reply(); 
   * @param string $text 
   */ 
  public function text($text='') 
  { 
    $FuncFlag = $this-&gt;_funcflag &#63; 1 : 0; 
    $msg = array( 
      'ToUserName' =&gt; $this-&gt;getRevFrom(), 
      'FromUserName'=&gt;$this-&gt;getRevTo(), 
      'MsgType'=&gt;self::MSGTYPE_TEXT, 
      'Content'=&gt;$text, 
      'CreateTime'=&gt;time(), 
      'FuncFlag'=&gt;$FuncFlag 
    ); 
    $this-&gt;Message($msg); 
    return $this; 
  } 
  /** 
   * 设置回复音乐 
   * @param string $title 
   * @param string $desc 
   * @param string $musicurl 
   * @param string $hgmusicurl 
   */ 
  public function music($title,$desc,$musicurl,$hgmusicurl='') { 
    $FuncFlag = $this-&gt;_funcflag &#63; 1 : 0; 
    $msg = array( 
      'ToUserName' =&gt; $this-&gt;getRevFrom(), 
      'FromUserName'=&gt;$this-&gt;getRevTo(), 
      'CreateTime'=&gt;time(), 
      'MsgType'=&gt;self::MSGTYPE_MUSIC, 
      'Music'=&gt;array( 
        'Title'=&gt;$title, 
        'Description'=&gt;$desc, 
        'MusicUrl'=&gt;$musicurl, 
        'HQMusicUrl'=&gt;$hgmusicurl 
      ), 
      'FuncFlag'=&gt;$FuncFlag 
    ); 
    $this-&gt;Message($msg); 
    return $this; 
  } 
  /** 
   * 设置回复图文 
   * @param array $newsData 
   * 数组结构: 
   * array( 
   *   [0]=&gt;array( 
   *     'Title'=&gt;'msg title', 
   *     'Description'=&gt;'summary text', 
   *     'PicUrl'=&gt;'http://www.domain.com/1.jpg', 
   *     'Url'=&gt;'http://www.domain.com/1.html' 
   *   ), 
   *   [1]=&gt;.... 
   * ) 
   */ 
  public function news($newsData=array()) 
  { 
    $FuncFlag = $this-&gt;_funcflag &#63; 1 : 0; 
    $count = count($newsData); 
    $msg = array( 
      'ToUserName' =&gt; $this-&gt;getRevFrom(), 
      'FromUserName'=&gt;$this-&gt;getRevTo(), 
      'MsgType'=&gt;self::MSGTYPE_NEWS, 
      'CreateTime'=&gt;time(), 
      'ArticleCount'=&gt;$count, 
      'Articles'=&gt;$newsData, 
      'FuncFlag'=&gt;$FuncFlag 
    ); 
    $this-&gt;Message($msg); 
    return $this; 
  } 
  /** 
   * 
   * 回复微信服务器, 此函数支持链式操作 
   * @example $this-&gt;text('msg tips')-&gt;reply(); 
   * @param string $msg 要发送的信息, 默认取$this-&gt;_msg 
   * @param bool $return 是否返回信息而不抛出到浏览器 默认:否 
   */ 
  public function reply($msg=array(),$return = false) 
  { 
    if (empty($msg))  
      $msg = $this-&gt;_msg; 
    $xmldata= $this-&gt;xml_encode($msg); 
    $this-&gt;log($xmldata); 
    if ($return) 
      return $xmldata; 
    else 
      echo $xmldata; 
  } 
 
  /** 
   * GET 请求 
   * @param string $url 
   */ 
  private function http_get($url){ 
    $oCurl = curl_init(); 
    if(stripos($url,"https://")!==FALSE){ 
      curl_setopt($oCurl, CURLOPT_SSL_VERIFYPEER, FALSE); 
      curl_setopt($oCurl, CURLOPT_SSL_VERIFYHOST, FALSE); 
    } 
    curl_setopt($oCurl, CURLOPT_URL, $url); 
    curl_setopt($oCurl, CURLOPT_RETURNTRANSFER, 1 ); 
    $sContent = curl_exec($oCurl); 
    $aStatus = curl_getinfo($oCurl); 
    curl_close($oCurl); 
    if(intval($aStatus["http_code"])==200){ 
      return $sContent; 
    }else{ 
      return false; 
    } 
  } 
  /** 
   * POST 请求 
   * @param string $url 
   * @param array $param 
   * @return string content 
   */ 
  private function http_post($url,$param){ 
    $oCurl = curl_init(); 
    if(stripos($url,"https://")!==FALSE){ 
      curl_setopt($oCurl, CURLOPT_SSL_VERIFYPEER, FALSE); 
      curl_setopt($oCurl, CURLOPT_SSL_VERIFYHOST, false); 
    } 
    if (is_string($param)) { 
      $strPOST = $param; 
    } else { 
      $aPOST = array(); 
      foreach($param as $key=&gt;$val){ 
        $aPOST[] = $key."=".urlencode($val); 
      } 
      $strPOST = join("&", $aPOST); 
    } 
    curl_setopt($oCurl, CURLOPT_URL, $url); 
    curl_setopt($oCurl, CURLOPT_RETURNTRANSFER, 1 ); 
    curl_setopt($oCurl, CURLOPT_POST,true); 
    curl_setopt($oCurl, CURLOPT_POSTFIELDS,$strPOST); 
    $sContent = curl_exec($oCurl); 
    $aStatus = curl_getinfo($oCurl); 
    curl_close($oCurl); 
    if(intval($aStatus["http_code"])==200){ 
      return $sContent; 
    }else{ 
      return false; 
    } 
  } 
  /** 
   * 通用auth验证方法，暂时仅用于菜单更新操作 
   * @param string $appid 
   * @param string $appsecret 
   */ 
  public function checkAuth($appid='',$appsecret=''){ 
    if (!$appid || !$appsecret) { 
      $appid = $this-&gt;appid; 
      $appsecret = $this-&gt;appsecret; 
    } 
    //TODO: get the cache access_token 
    $result = $this-&gt;http_get(self::API_URL_PREFIX.self::AUTH_URL.'appid='.$appid.'&secret='.$appsecret); 
    if ($result) 
    { 
      $json = json_decode($result,true); 
      if (!$json || isset($json['errcode'])) { 
        $this-&gt;errCode = $json['errcode']; 
        $this-&gt;errMsg = $json['errmsg']; 
        return false; 
      } 
      $this-&gt;access_token = $json['access_token']; 
      $expire = $json['expires_in'] &#63; intval($json['expires_in'])-100 : 3600; 
      //TODO: cache access_token 
      return $this-&gt;access_token; 
    } 
    return false; 
  } 
  /** 
   * 删除验证数据 
   * @param string $appid 
   */ 
  public function resetAuth($appid=''){ 
    $this-&gt;access_token = ''; 
    //TODO: remove cache 
    return true; 
  } 
  /** 
   * 微信api不支持中文转义的json结构 
   * @param array $arr 
   */ 
  static function json_encode($arr) { 
    $parts = array (); 
    $is_list = false; 
    //Find out if the given array is a numerical array 
    $keys = array_keys ( $arr ); 
    $max_length = count ( $arr ) - 1; 
    if (($keys [0] === 0) && ($keys [$max_length] === $max_length )) { //See if the first key is 0 and last key is length - 1 
      $is_list = true; 
      for($i = 0; $i &lt; count ( $keys ); $i ++) { //See if each key correspondes to its position 
        if ($i != $keys [$i]) { //A key fails at position check. 
          $is_list = false; //It is an associative array. 
          break; 
        } 
      } 
    } 
    foreach ( $arr as $key =&gt; $value ) { 
      if (is_array ( $value )) { //Custom handling for arrays 
        if ($is_list) 
          $parts [] = self::json_encode ( $value ); /* :RECURSION: */ 
        else 
          $parts [] = '"' . $key . '":' . self::json_encode ( $value ); /* :RECURSION: */ 
      } else { 
        $str = ''; 
        if (! $is_list) 
          $str = '"' . $key . '":'; 
        //Custom handling for multiple data types 
        if (is_numeric ( $value ) && $value&lt;2000000000) 
          $str .= $value; //Numbers 
        elseif ($value === false) 
        $str .= 'false'; //The booleans 
        elseif ($value === true) 
        $str .= 'true'; 
        else 
          $str .= '"' . addslashes ( $value ) . '"'; //All other things 
        // :TODO: Is there any more datatype we should be in the lookout for&#63; (Object&#63;) 
        $parts [] = $str; 
      } 
    } 
    $json = implode ( ',', $parts ); 
    if ($is_list) 
      return '[' . $json . ']'; //Return numerical JSON 
    return '{' . $json . '}'; //Return associative JSON 
  } 
  /** 
   * 创建菜单 
   * @param array $data 菜单数组数据 
   * example: 
   { 
   "button":[ 
   { 
   "type":"click", 
   "name":"今日歌曲", 
   "key":"MENU_KEY_MUSIC" 
   }, 
   { 
   "type":"view", 
   "name":"歌手简介", 
   "url":"http://www.qq.com/" 
   }, 
   { 
   "name":"菜单", 
   "sub_button":[ 
   { 
   "type":"click", 
   "name":"hello word", 
   "key":"MENU_KEY_MENU" 
   }, 
   { 
   "type":"click", 
   "name":"赞一下我们", 
   "key":"MENU_KEY_GOOD" 
   }] 
   }] 
   } 
   */ 
  public function createMenu($data){ 
    if (!$this-&gt;access_token && !$this-&gt;checkAuth()) return false; 
    $result = $this-&gt;http_post(self::API_URL_PREFIX.self::MENU_CREATE_URL.'access_token='.$this-&gt;access_token,self::json_encode($data)); 
    if ($result) 
    { 
      $json = json_decode($result,true); 
      if (!$json || !empty($json['errcode'])) { 
        $this-&gt;errCode = $json['errcode']; 
        $this-&gt;errMsg = $json['errmsg']; 
        return false; 
      } 
      return true; 
    } 
    return false; 
  } 
  /** 
   * 获取菜单 
   * @return array('menu'=&gt;array(....s)) 
   */ 
  public function getMenu(){ 
    if (!$this-&gt;access_token && !$this-&gt;checkAuth()) return false; 
    $result = $this-&gt;http_get(self::API_URL_PREFIX.self::MENU_GET_URL.'access_token='.$this-&gt;access_token); 
    if ($result) 
    { 
      $json = json_decode($result,true); 
      if (!$json || isset($json['errcode'])) { 
        $this-&gt;errCode = $json['errcode']; 
        $this-&gt;errMsg = $json['errmsg']; 
        return false; 
      } 
      return $json; 
    } 
    return false; 
  } 
  /** 
   * 删除菜单 
   * @return boolean 
   */ 
  public function deleteMenu(){ 
    if (!$this-&gt;access_token && !$this-&gt;checkAuth()) return false; 
    $result = $this-&gt;http_get(self::API_URL_PREFIX.self::MENU_DELETE_URL.'access_token='.$this-&gt;access_token); 
    if ($result) 
    { 
      $json = json_decode($result,true); 
      if (!$json || !empty($json['errcode'])) { 
        $this-&gt;errCode = $json['errcode']; 
        $this-&gt;errMsg = $json['errmsg']; 
        return false; 
      } 
      return true; 
    } 
    return false; 
  } 
  /** 
   * 根据媒体文件ID获取媒体文件 
   * @param string $media_id 媒体文件id 
   * @return raw data 
   */ 
  public function getMedia($media_id){ 
    if (!$this-&gt;access_token && !$this-&gt;checkAuth()) return false; 
    $result = $this-&gt;http_get(self::API_URL_PREFIX.self::MEDIA_GET_URL.'access_token='.$this-&gt;access_token.'&media_id='.$media_id); 
    if ($result) 
    { 
      $json = json_decode($result,true); 
      if (isset($json['errcode'])) { 
        $this-&gt;errCode = $json['errcode']; 
        $this-&gt;errMsg = $json['errmsg']; 
        return false; 
      } 
      return $json; 
    } 
    return false; 
  }   
  /** 
   * 创建二维码ticket 
   * @param int $scene_id 自定义追踪id 
   * @param int $type 0:临时二维码；1:永久二维码(此时expire参数无效) 
   * @param int $expire 临时二维码有效期，最大为1800秒 
   * @return array('ticket'=&gt;'qrcode字串','expire_seconds'=&gt;1800) 
   */ 
  public function getQRCode($scene_id,$type=0,$expire=1800){ 
    if (!$this-&gt;access_token && !$this-&gt;checkAuth()) return false; 
    $data = array( 
      'action_name'=&gt;$type&#63;"QR_LIMIT_SCENE":"QR_SCENE", 
      'expire_seconds'=&gt;$expire, 
      'action_info'=&gt;array('scene'=&gt;array('scene_id'=&gt;$scene_id)) 
    ); 
    if ($type == 1) { 
      unset($data['expire_seconds']); 
    } 
    $result = $this-&gt;http_post(self::API_URL_PREFIX.self::QRCODE_CREATE_URL.'access_token='.$this-&gt;access_token,self::json_encode($data)); 
    if ($result) 
    { 
      $json = json_decode($result,true); 
      if (!$json || !empty($json['errcode'])) { 
        $this-&gt;errCode = $json['errcode']; 
        $this-&gt;errMsg = $json['errmsg']; 
        return false; 
      } 
      return $json; 
    } 
    return false; 
  } 
  /** 
   * 获取二维码图片 
   * @param string $ticket 传入由getQRCode方法生成的ticket参数 
   * @return string url 返回http地址 
   */ 
  public function getQRUrl($ticket) { 
    return self::QRCODE_IMG_URL.$ticket; 
  } 
  /** 
   * 批量获取关注用户列表 
   * @param unknown $next_openid 
   */ 
  public function getUserList($next_openid=''){ 
    if (!$this-&gt;access_token && !$this-&gt;checkAuth()) return false; 
    $result = $this-&gt;http_get(self::API_URL_PREFIX.self::USER_GET_URL.'access_token='.$this-&gt;access_token.'&next_openid='.$next_openid); 
    if ($result) 
    { 
      $json = json_decode($result,true); 
      if (isset($json['errcode'])) { 
        $this-&gt;errCode = $json['errcode']; 
        $this-&gt;errMsg = $json['errmsg']; 
        return false; 
      } 
      return $json; 
    } 
    return false; 
  } 
  /** 
   * 获取关注者详细信息 
   * @param string $openid 
   * @return array 
   */ 
  public function getUserInfo($openid){ 
    if (!$this-&gt;access_token && !$this-&gt;checkAuth()) return false; 
    $result = $this-&gt;http_get(self::API_URL_PREFIX.self::USER_INFO_URL.'access_token='.$this-&gt;access_token.'&openid='.$openid); 
    if ($result) 
    { 
      $json = json_decode($result,true); 
      if (isset($json['errcode'])) { 
        $this-&gt;errCode = $json['errcode']; 
        $this-&gt;errMsg = $json['errmsg']; 
        return false; 
      } 
      return $json; 
    } 
    return false; 
  } 
  /** 
   * 获取用户分组列表 
   * @return boolean|array 
   */ 
  public function getGroup(){ 
    if (!$this-&gt;access_token && !$this-&gt;checkAuth()) return false; 
    $result = $this-&gt;http_get(self::API_URL_PREFIX.self::GROUP_GET_URL.'access_token='.$this-&gt;access_token); 
    if ($result) 
    { 
      $json = json_decode($result,true); 
      if (isset($json['errcode'])) { 
        $this-&gt;errCode = $json['errcode']; 
        $this-&gt;errMsg = $json['errmsg']; 
        return false; 
      } 
      return $json; 
    } 
    return false; 
  } 
  /** 
   * 新增自定分组 
   * @param string $name 分组名称 
   * @return boolean|array 
   */ 
  public function createGroup($name){ 
    if (!$this-&gt;access_token && !$this-&gt;checkAuth()) return false; 
    $data = array( 
        'group'=&gt;array('name'=&gt;$name) 
    ); 
    $result = $this-&gt;http_post(self::API_URL_PREFIX.self::GROUP_CREATE_URL.'access_token='.$this-&gt;access_token,self::json_encode($data)); 
    if ($result) 
    { 
      $json = json_decode($result,true); 
      if (!$json || !empty($json['errcode'])) { 
        $this-&gt;errCode = $json['errcode']; 
        $this-&gt;errMsg = $json['errmsg']; 
        return false; 
      } 
      return $json; 
    } 
    return false; 
  } 
  /** 
   * 更改分组名称 
   * @param int $groupid 分组id 
   * @param string $name 分组名称 
   * @return boolean|array 
   */ 
  public function updateGroup($groupid,$name){ 
    if (!$this-&gt;access_token && !$this-&gt;checkAuth()) return false; 
    $data = array( 
        'group'=&gt;array('id'=&gt;$groupid,'name'=&gt;$name) 
    ); 
    $result = $this-&gt;http_post(self::API_URL_PREFIX.self::GROUP_UPDATE_URL.'access_token='.$this-&gt;access_token,self::json_encode($data)); 
    if ($result) 
    { 
      $json = json_decode($result,true); 
      if (!$json || !empty($json['errcode'])) { 
        $this-&gt;errCode = $json['errcode']; 
        $this-&gt;errMsg = $json['errmsg']; 
        return false; 
      } 
      return $json; 
    } 
    return false; 
  } 
  /** 
   * 移动用户分组 
   * @param int $groupid 分组id 
   * @param string $openid 用户openid 
   * @return boolean|array 
   */ 
  public function updateGroupMembers($groupid,$openid){ 
    if (!$this-&gt;access_token && !$this-&gt;checkAuth()) return false; 
    $data = array( 
        'openid'=&gt;$openid, 
        'to_groupid'=&gt;$groupid 
    ); 
    $result = $this-&gt;http_post(self::API_URL_PREFIX.self::GROUP_MEMBER_UPDATE_URL.'access_token='.$this-&gt;access_token,self::json_encode($data)); 
    if ($result) 
    { 
      $json = json_decode($result,true); 
      if (!$json || !empty($json['errcode'])) { 
        $this-&gt;errCode = $json['errcode']; 
        $this-&gt;errMsg = $json['errmsg']; 
        return false; 
      } 
      return $json; 
    } 
    return false; 
  } 
  /** 
   * 发送客服消息 
   * @param array $data 消息结构{"touser":"OPENID","msgtype":"news","news":{...}} 
   * @return boolean|array 
   */ 
  public function sendCustomMessage($data){ 
    if (!$this-&gt;access_token && !$this-&gt;checkAuth()) return false; 
    $result = $this-&gt;http_post(self::API_URL_PREFIX.self::CUSTOM_SEND_URL.'access_token='.$this-&gt;access_token,self::json_encode($data)); 
    if ($result) 
    { 
      $json = json_decode($result,true); 
      if (!$json || !empty($json['errcode'])) { 
        $this-&gt;errCode = $json['errcode']; 
        $this-&gt;errMsg = $json['errmsg']; 
        return false; 
      } 
      return $json; 
    } 
    return false; 
  } 
  /** 
   * oauth 授权跳转接口 
   * @param string $callback 回调URI 
   * @return string 
   */ 
  public function getOauthRedirect($callback,$state='',$scope='snsapi_userinfo'){ 
    return self::OAUTH_PREFIX.self::OAUTH_AUTHORIZE_URL.'appid='.$this-&gt;appid.'&redirect_uri='.urlencode($callback).'&response_type=code&scope='.$scope.'&state='.$state.'#wechat_redirect'; 
  } 
  /* 
   * 通过code获取Access Token 
   * @return array {access_token,expires_in,refresh_token,openid,scope} 
   */ 
  public function getOauthAccessToken(){ 
    $code = isset($_GET['code'])&#63;$_GET['code']:''; 
    if (!$code) return false; 
    $result = $this-&gt;http_get(self::OAUTH_TOKEN_PREFIX.self::OAUTH_TOKEN_URL.'appid='.$this-&gt;appid.'&secret='.$this-&gt;appsecret.'&code='.$code.'&grant_type=authorization_code'); 
    if ($result) 
    { 
      $json = json_decode($result,true); 
      if (!$json || !empty($json['errcode'])) { 
        $this-&gt;errCode = $json['errcode']; 
        $this-&gt;errMsg = $json['errmsg']; 
        return false; 
      } 
      $this-&gt;user_token = $json['access_token']; 
      return $json; 
    } 
    return false; 
  } 
  /** 
   * 刷新access token并续期 
   * @param string $refresh_token 
   * @return boolean|mixed 
   */ 
  public function getOauthRefreshToken($refresh_token){ 
    $result = $this-&gt;http_get(self::OAUTH_TOKEN_PREFIX.self::OAUTH_REFRESH_URL.'appid='.$this-&gt;appid.'&grant_type=refresh_token&refresh_token='.$refresh_token); 
    if ($result) 
    { 
      $json = json_decode($result,true); 
      if (!$json || !empty($json['errcode'])) { 
        $this-&gt;errCode = $json['errcode']; 
        $this-&gt;errMsg = $json['errmsg']; 
        return false; 
      } 
      $this-&gt;user_token = $json['access_token']; 
      return $json; 
    } 
    return false; 
  } 
  /** 
   * 获取授权后的用户资料 
   * @param string $access_token 
   * @param string $openid 
   * @return array {openid,nickname,sex,province,city,country,headimgurl,privilege} 
   */ 
  public function getOauthUserinfo($access_token,$openid){ 
    $result = $this-&gt;http_get(self::OAUTH_USERINFO_URL.'access_token='.$access_token.'&openid='.$openid); 
    if ($result) 
    { 
      $json = json_decode($result,true); 
      if (!$json || !empty($json['errcode'])) { 
        $this-&gt;errCode = $json['errcode']; 
        $this-&gt;errMsg = $json['errmsg']; 
        return false; 
      } 
      return $json; 
    } 
    return false; 
  } 
}</pre>
</div>
<p>接下来就是接口对应的index.php文件，处理微信服务器发送来的信息。<br />
因为是工作室的微信公共账号，所以未做任何修改源码搬上来，截取有用的部分即可：</p>
<div class="phpstudycode">
<pre class="brush:php;">
&lt;&#63;php 
/** 
 * WeeGo工作室微信公众平台接口源码 
 * @author CallMeWhy &lt;wanghaiyang@139.me&gt; 
 * @version 1.0 
 */ 
include "wechat.class.php"; 
$options = array 
( 
  'token'=&gt;'weego', 
  'debug'=&gt;true, 
  'logcallback'=&gt;'logdebug' 
); 
$weObj = new Wechat($options); 
// 验证 
$weObj-&gt;valid(); 
// 获取内容 
$weObj-&gt;getRev(); 
// 获取用户的OpenID  
$fromUsername = $weObj-&gt;getRevFrom(); 
// 获取接受信息的类型 
$type = $weObj-&gt;getRev()-&gt;getRevType(); 
 
//**********关注操作则写入数据库**********/ 
if($weObj-&gt;getRevSubscribe()) 
{ 
  // 获取用户OPENID并写入数据库 
  $mysql = new SaeMysql(); 
  $sql = "INSERT INTO `users` (`wxid`) VALUES ('" . $fromUsername . "');"; 
  $mysql-&gt;runSql($sql); 
  $mysql-&gt;closeDb(); 
  // 获得信息的类型 
  $news = array 
  ( 
    array 
    ( 
      'Title'=&gt;'欢迎关注WeeGo工作室', 
      'Description'=&gt;'发送任意内容查看最新开发进展', 
      'PicUrl'=&gt;'http://233.weego.sinaapp.com/images/weego_400_200.png', 
    ) 
  ); 
  $weObj-&gt;news($news)-&gt;reply(); 
} 
//**********取消关注操作则删除数据库**********/ 
if($weObj-&gt;getRevUnsubscribe()) 
{ 
  // 获取用户OPENID并从数据库删除 
  $mysql = new SaeMysql(); 
  $sql = "DELETE FROM `users` WHERE `wxid` = '" . $fromUsername . "'"; 
  $mysql-&gt;runSql($sql); 
  $mysql-&gt;closeDb(); 
} 
switch($type) { 
  case Wechat::MSGTYPE_TEXT: 
    /**********文字信息**********/ 
    $news = array 
    ( 
      array 
      ( 
        'Title'=&gt;"欢迎光临WeeGo工作室", 
        'PicUrl'=&gt;'http://233.weego.sinaapp.com/images/weego_400_200.png', 
        //'Url'=&gt;'http://233.weego.sinaapp.com/web/home.php&#63;wxid='.$fromUsername 
      ),    
      array 
      ( 
        'Title'=&gt;"功能1：发送图片可以查询照片中人脸的年龄和性别信息哦", 
        'PicUrl'=&gt;'http://233.weego.sinaapp.com/images/face.jpg', 
        //'Url'=&gt;'http://233.weego.sinaapp.com/web/home.php&#63;wxid='.$fromUsername 
      ),  
      array 
      ( 
        'Title'=&gt;"功能2：发送一张两人合影的照片可以计算两人的相似程度", 
        'PicUrl'=&gt;'http://233.weego.sinaapp.com/images/mask.png', 
        //'Url'=&gt;'http://233.weego.sinaapp.com/web/home.php&#63;wxid='.$fromUsername 
      ),  
      array 
      ( 
        'Title'=&gt;"功能3：山东大学绩点查询签到等功能正在开发中敬请期待", 
        'PicUrl'=&gt;'http://233.weego.sinaapp.com/images/sdu.jpg', 
        //'Url'=&gt;'http://233.weego.sinaapp.com/web/home.php&#63;wxid='.$fromUsername 
      ) 
    ); 
    // 开发人员通道 
    if($weObj-&gt;getRev()-&gt;getRevContent() === "why"){ 
      $news = array 
      ( 
        array 
        ( 
          'Title'=&gt;'开发人员通道', 
          'Description'=&gt;'开发人员通道', 
          'PicUrl'=&gt;'http://233.weego.sinaapp.com/images/weego_400_200.png', 
          'Url'=&gt;'http://233.weego.sinaapp.com/web/home.php&#63;wxid='.$fromUsername 
        ) 
      ); 
    } 
    $weObj-&gt;news($news)-&gt;reply(); 
    exit; 
    break; 
  case Wechat::MSGTYPE_EVENT: 
    break; 
  case Wechat::MSGTYPE_IMAGE: 
    /**********图片信息**********/ 
    $imgUrl = $weObj-&gt;getRev()-&gt;getRevPic(); 
    $resultStr = face($imgUrl); 
    $weObj-&gt;text($resultStr)-&gt;reply(); 
    break; 
  default: 
    $weObj-&gt;text("Default")-&gt;reply(); 
} 
// 调用人脸识别的API返回识别结果 
function face($imgUrl) 
{ 
  // face++ 链接 
  $jsonStr = 
    file_get_contents("http://apicn.faceplusplus.com/v2/detection/detect&#63;url=".$imgUrl."&api_key=5eb2c984ad24ffc08c352bdb53ee52f8&api_secret=ViX19uvxkT_A0a6d55Hb0Q0QGMTqZ95f&&attribute=glass,pose,gender,age,race,smiling"); 
  $replyDic = json_decode($jsonStr); 
  $resultStr = ""; 
  $faceArray = $replyDic-&gt;{'face'}; 
  $resultStr .= "图中共检测到".count($faceArray)."张脸！\n"; 
  for ($i= 0;$i&lt; count($faceArray); $i++){ 
    $resultStr .= "第".($i+1)."张脸\n"; 
    $tempFace = $faceArray[$i]; 
    // 获取所有属性 
    $tempAttr = $tempFace-&gt;{'attribute'}; 
    // 年龄：包含年龄分析结果 
    // value的值为一个非负整数表示估计的年龄, range表示估计年龄的正负区间 
    $tempAge = $tempAttr-&gt;{'age'}; 
    // 性别：包含性别分析结果 
    // value的值为Male/Female, confidence表示置信度 
    $tempGenger = $tempAttr-&gt;{'gender'};  
    // 种族：包含人种分析结果 
    // value的值为Asian/White/Black, confidence表示置信度 
    $tempRace = $tempAttr-&gt;{'race'};    
    // 微笑：包含微笑程度分析结果 
    //value的值为0-100的实数，越大表示微笑程度越高 
    $tempSmiling = $tempAttr-&gt;{'smiling'}; 
    // 眼镜：包含眼镜佩戴分析结果 
    // value的值为None/Dark/Normal, confidence表示置信度 
    $tempGlass = $tempAttr-&gt;{'glass'};   
    // 造型：包含脸部姿势分析结果 
    // 包括pitch_angle, roll_angle, yaw_angle 
    // 分别对应抬头，旋转（平面旋转），摇头 
    // 单位为角度。 
    $tempPose = $tempAttr-&gt;{'pose'}; 
    //返回年龄 
    $minAge = $tempAge-&gt;{'value'} - $tempAge-&gt;{'range'}; 
    $minAge = $minAge &lt; 0 &#63; 0 : $minAge; 
    $maxAge = $tempAge-&gt;{'value'} + $tempAge-&gt;{'range'}; 
    $resultStr .= "年龄：".$minAge."-".$maxAge."岁\n"; 
    // 返回性别 
    if($tempGenger-&gt;{'value'} === "Male") 
      $resultStr .= "性别：男\n";  
    else if($tempGenger-&gt;{'value'} === "Female") 
      $resultStr .= "性别：女\n"; 
    // 返回种族 
    if($tempRace-&gt;{'value'} === "Asian") 
      $resultStr .= "种族：黄种人\n";   
    else if($tempRace-&gt;{'value'} === "Male") 
      $resultStr .= "种族：白种人\n";   
    else if($tempRace-&gt;{'value'} === "Black") 
      $resultStr .= "种族：黑种人\n";   
    // 返回眼镜 
    if($tempGlass-&gt;{'value'} === "None") 
      $resultStr .= "眼镜：木有眼镜\n";  
    else if($tempGlass-&gt;{'value'} === "Dark") 
      $resultStr .= "眼镜：目测墨镜\n";  
    else if($tempGlass-&gt;{'value'} === "Normal") 
      $resultStr .= "眼镜：普通眼镜\n";  
    //返回微笑 
    $resultStr .= "微笑：".round($tempSmiling-&gt;{'value'})."%\n"; 
  }   
  if(count($faceArray) === 2){ 
    // 获取face_id 
    $tempFace = $faceArray[0]; 
    $tempId1 = $tempFace-&gt;{'face_id'}; 
    $tempFace = $faceArray[1]; 
    $tempId2 = $tempFace-&gt;{'face_id'}; 
 
    // face++ 链接 
    $jsonStr = 
      file_get_contents("https://apicn.faceplusplus.com/v2/recognition/compare&#63;api_secret=ViX19uvxkT_A0a6d55Hb0Q0QGMTqZ95f&api_key=5eb2c984ad24ffc08c352bdb53ee52f8&face_id2=".$tempId2 ."&face_id1=".$tempId1); 
    $replyDic = json_decode($jsonStr); 
    //取出相似程度 
    $tempResult = $replyDic-&gt;{'similarity'}; 
    $resultStr .= "相似程度：".round($tempResult)."%\n"; 
    //具体分析相似处 
    $tempSimilarity = $replyDic-&gt;{'component_similarity'}; 
    $tempEye = $tempSimilarity-&gt;{'eye'}; 
    $tempEyebrow = $tempSimilarity-&gt;{'eyebrow'}; 
    $tempMouth = $tempSimilarity-&gt;{'mouth'}; 
    $tempNose = $tempSimilarity-&gt;{'nose'}; 
    $resultStr .= "相似分析：\n"; 
    $resultStr .= "眼睛：".round($tempEye)."%\n"; 
    $resultStr .= "眉毛：".round($tempEyebrow)."%\n"; 
    $resultStr .= "嘴巴：".round($tempMouth)."%\n"; 
    $resultStr .= "鼻子：".round($tempNose)."%\n"; 
  } 
 
  //如果没有检测到人脸 
  if($resultStr === "") 
    $resultStr = "照片中木有人脸=.="; 
  return $resultStr; 
}; 
// 写入本地日志文件的函数 
function logdebug($text) 
{ 
  file_put_contents('log.txt', $text."\n", FILE_APPEND);    
};</pre>
</div>
<p>希望本文所述对大家基于php的微信公众平台开发有所帮助。</p>
<hr></span>                                     
		    	</div>
		    	<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>代码注释</div>
			    <div class="panel-content">
			    <span></span>                                     
		    	</div>

			</div>

			<!-- END ROW -->
			<div class="newsPage">
				<div class="newsPageTurn">
				    <span><a>上一篇</a><a href='/php/biji/98523.html'>Win10 Mobile Redstone预览版14295出现问题 屏幕闪烁/应用自动关闭等</a><a>下一篇</a><a href='/php/biji/98525.html'>php不用正则验证真假身份证</a></span>
				</div>
			</div>
		</div>


<div id="author-box">
    <h3>作者：喵哥笔记</h3>
        <div class="author-info">
            <div class="author-avatar">
                <img src="/skin1/picture/01.jpg" alt="IDC笔记" class="avatar" width="64" height="64">
            </div>
        <div class="author-description">
            <p>学的不仅是技术，更是梦想！</p>
            <ul class="author-social follows nb">
            	<li>
                    <a target="_blank" href="/" title="IDC笔记">IDC笔记</a>
                </li>
            </ul>
        </div>
        <div class="clear"></div>
    </div>
</div>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
<!-- container-fluid -->
	</div>
<!-- content -->
	<footer class="footer">
	© 2020 IDC笔记 <i class="mdi mdi-heart text-danger"></i>. | 备案号：<a href="https://beian.miit.gov.cn/">辽ICP备18000516号</a>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?674585fbbd2294d3faf910f668ea91b4";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

	</footer>
</div>

</div>
<!-- END wrapper -->
<!-- jQuery  -->
<script src="/skin1/js/jquery.min.js"></script>
<script src="/skin1/js/bootstrap.bundle.min.js"></script>
<script src="/skin1/js/metismenu.min.js"></script>
<script src="/skin1/js/jquery.slimscroll.js"></script>
<script src="/skin1/js/waves.min.js"></script>
<!--Morris Chart-->
<script src="/skin1/js/morris.min.js"></script>
<script src="/skin1/js/raphael.min.js"></script>
<script src="/skin1/js/dashboard.init.js"></script>
<script src="/skin1/js/app.js"></script>
<script src="/foot.js"></script>
</body>
</html>