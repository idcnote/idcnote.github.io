<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <title>RedHat服务器网卡阵列配置攻略_PHP教程_IDC笔记</title>
    <meta name="keywords" content="PHP,PHP笔记,PHP教程" />
    <meta name="description" content="网卡阵列配置<br />
1.修改vi /etc/rc.d/rc.local文件，增加以下内容（注意这里添加的是eth0、eth1两个网口）<br />
<br />
复制代码代码如下:<br />
ifenslave bond0 eth0 eth1<br />
#如果一块网卡失效，系统会" />
    <meta content="Responsive admin theme build on top of Bootstrap 4" name="description" />
    <meta content="idcnote.com" name="author" />
    <link rel="shortcut icon" href="/skin1/images/favicon.ico">
    <!--Morris Chart CSS -->
    <link rel="stylesheet" href="/skin1/css/morris.css">
    <link href="/skin1/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/metismenu.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/icons.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/style.css" rel="stylesheet" type="text/css">
<link href="/SyntaxHighlighter/shCoreDefault.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">
 SyntaxHighlighter.all();
</script>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
</head>
<body>
<!-- Begin page -->
		<div id="wrapper">
			<!-- Top Bar Start -->
			<div class="topbar">
				<!-- LOGO -->
				<div class="topbar-left">
					<a href="/" class="logo">
						<span class="logo-light">
                            <i class="mdi mdi-camera-control"></i>IDC笔记
                        </span>
						<span class="logo-sm">
                            <i class="mdi mdi-camera-control"></i>
                        </span>
					</a>
				</div>
				<nav class="navbar-custom">
					<ul class="navbar-right list-inline float-right mb-0">
						<!--<li class="dropdown notification-list list-inline-item d-none d-md-inline-block">
							<a class="nav-link waves-effect" href="#" id="btn-fullscreen">
								<i class="mdi mdi-arrow-expand-all noti-icon"></i>
							</a>
						</li>
						<li class="dropdown notification-list list-inline-item">
							<div class="dropdown notification-list nav-pro-img">
								<a class="dropdown-toggle nav-link arrow-none nav-user" data-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
									<img src="/skin1/picture/user-4.jpg" alt="user" class="rounded-circle">
								</a>
								<div class="dropdown-menu dropdown-menu-right profile-dropdown ">
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-account-circle"></i> Profile</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-wallet"></i> Wallet</a>
									<a class="dropdown-item d-block" href="#">
										<span class="badge badge-success float-right">11</span>
										<i class="mdi mdi-settings"></i> Settings</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-lock-open-outline"></i> Lock screen</a>
									<div class="dropdown-divider"></div>
									<a class="dropdown-item text-danger" href="#">
										<i class="mdi mdi-power text-danger"></i> Logout</a>
								</div>
							</div>
						</li>
						-->
					</ul>
					<ul class="list-inline menu-left mb-0">
						<li class="float-left">
							<button class="button-menu-mobile open-left waves-effect">
                            <i class="mdi mdi-menu"></i>
                        </button>
						</li>
						<li class="d-none d-md-inline-block">
							<form role="search" class="app-search">
								<div class="form-group mb-0">
									<input type="text" class="form-control" placeholder="Search..">
									<button type="submit"><i class="fa fa-search"></i></button>
								</div>
							</form>
						</li>
					</ul>
				</nav>
			</div>
<!-- ========== Left Sidebar Start ========== -->
<div class="left side-menu">
    <div class="slimscroll-menu" id="remove-scroll">
    <!--- Sidemenu -->
    <div id="sidebar-menu">
    <!-- Left Menu Start -->
    <ul class="metismenu" id="side-menu">
			<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP简介			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/jianjie/1.html">PHP简介</a></li><li><a href="/php/jianjie/2.html">PHP用途</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP基本语法			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yufa/3.html">分离HTML</a></li><li><a href="/php/yufa/4.html">指令分隔符</a></li><li><a href="/php/yufa/5.html">PHP注释</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP类型			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpleixing/6.html">PHP类型简介</a></li><li><a href="/php/phpleixing/7.html">PHP类型之布尔类型</a></li><li><a href="/php/phpleixing/8.html">PHP类型之整型</a></li><li><a href="/php/phpleixing/9.html">PHP类型之浮点型</a></li><li><a href="/php/phpleixing/10.html">PHP类型之字符串</a></li><li><a href="/php/phpleixing/11.html">PHP类型之数组</a></li><li><a href="/php/phpleixing/12.html">PHP类型之对象</a></li><li><a href="/php/phpleixing/13.html">PHP类型之资源类型</a></li><li><a href="/php/phpleixing/14.html">PHP类型之NULL</a></li><li><a href="/php/phpleixing/15.html">PHP类型之伪类型</a></li><li><a href="/php/phpleixing/16.html">PHP类型之类型判别</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP变量			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpbianliang/17.html">PHP变量之基础</a></li><li><a href="/php/phpbianliang/18.html">PHP变量之预定义变量</a></li><li><a href="/php/phpbianliang/19.html">PHP变量之变量范围</a></li><li><a href="/php/phpbianliang/20.html">PHP变量之可变变量</a></li><li><a href="/php/phpbianliang/21.html">PHP变量之外部变量</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP运算符			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yunsuanfu/22.html">PHP运算符优先级</a></li><li><a href="/php/yunsuanfu/23.html">算术运算符</a></li><li><a href="/php/yunsuanfu/24.html">赋值运算符</a></li><li><a href="/php/yunsuanfu/25.html">位运算符</a></li><li><a href="/php/yunsuanfu/26.html">比较运算符</a></li><li><a href="/php/yunsuanfu/27.html">错误控制运算符</a></li><li><a href="/php/yunsuanfu/28.html">执行运算符</a></li><li><a href="/php/yunsuanfu/29.html">递增/递减运算符</a></li><li><a href="/php/yunsuanfu/30.html">逻辑运算符</a></li><li><a href="/php/yunsuanfu/31.html">字符串运算符</a></li><li><a href="/php/yunsuanfu/32.html">数组运算符</a></li><li><a href="/php/yunsuanfu/33.html">类型运算符</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP控制结构			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/jiegou/34.html">PHP控制结构之if</a></li><li><a href="/php/jiegou/35.html">PHP控制结构之else</a></li><li><a href="/php/jiegou/36.html">PHP控制结构之elseif/else if</a></li><li><a href="/php/jiegou/37.html">PHP控制结构之替代语法</a></li><li><a href="/php/jiegou/38.html">PHP控制结构之while</a></li><li><a href="/php/jiegou/39.html">PHP控制结构之do-while</a></li><li><a href="/php/jiegou/40.html">PHP控制结构之for</a></li><li><a href="/php/jiegou/41.html">PHP控制结构之foreach</a></li><li><a href="/php/jiegou/42.html">PHP控制结构之break</a></li><li><a href="/php/jiegou/43.html">PHP控制结构之continue</a></li><li><a href="/php/jiegou/44.html">PHP控制结构之switch</a></li><li><a href="/php/jiegou/45.html">PHP控制结构之declare</a></li><li><a href="/php/jiegou/46.html">PHP控制结构之return</a></li><li><a href="/php/jiegou/47.html">PHP控制结构之require</a></li><li><a href="/php/jiegou/48.html">PHP控制结构之include</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP函数			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/hanshu/52.html">用户自定义函数</a></li><li><a href="/php/hanshu/53.html">函数的参数</a></li><li><a href="/php/hanshu/54.html">返回值</a></li><li><a href="/php/hanshu/55.html">可变函数</a></li><li><a href="/php/hanshu/56.html">内部（内置）函数</a></li><li><a href="/php/hanshu/57.html">匿名函数</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP类与对象			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpduixiang/58.html">类与对象前言</a></li><li><a href="/php/phpduixiang/59.html">基本概念</a></li><li><a href="/php/phpduixiang/60.html">属性</a></li><li><a href="/php/phpduixiang/61.html">类常量</a></li><li><a href="/php/phpduixiang/62.html">自动加载对象</a></li><li><a href="/php/phpduixiang/63.html">构造函数和析构函数</a></li><li><a href="/php/phpduixiang/64.html">访问控制</a></li><li><a href="/php/phpduixiang/65.html">对象继承</a></li><li><a href="/php/phpduixiang/66.html">Static关键字</a></li><li><a href="/php/phpduixiang/67.html">抽象类</a></li><li><a href="/php/phpduixiang/68.html">接口</a></li><li><a href="/php/phpduixiang/69.html">Traits</a></li><li><a href="/php/phpduixiang/70.html">重载</a></li><li><a href="/php/phpduixiang/71.html">对象迭代</a></li><li><a href="/php/phpduixiang/72.html">设计模式</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP异常处理			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yichang/81.html">异常处理</a></li><li><a href="/php/yichang/82.html">扩展PHP内置的异常处理类</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP函数库按分类			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpku/83.html">数组</a></li><li><a href="/php/phpku/84.html">Classes/Objects</a></li><li><a href="/php/phpku/85.html">Date/Time</a></li><li><a href="/php/phpku/86.html">Directories</a></li><li><a href="/php/phpku/87.html">错误处理</a></li><li><a href="/php/phpku/88.html">Program execution</a></li><li><a href="/php/phpku/89.html">Filesystem</a></li><li><a href="/php/phpku/90.html">Filter</a></li><li><a href="/php/phpku/91.html">Function Handling</a></li><li><a href="/php/phpku/92.html">PHP 选项/信息</a></li><li><a href="/php/phpku/93.html">Mail</a></li><li><a href="/php/phpku/94.html">Math</a></li><li><a href="/php/phpku/95.html">Misc.</a></li><li><a href="/php/phpku/96.html">Network</a></li><li><a href="/php/phpku/97.html">输出控制</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> php基础			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpbiji/108377.html"></a></li><li><a href="/php/phpbiji/108376.html"></a></li><li><a href="/php/phpbiji/108380.html"></a></li><li><a href="/php/phpbiji/108379.html"></a></li><li><a href="/php/phpbiji/108378.html"></a></li><li><a href="/php/phpbiji/108381.html"></a></li><li><a href="/php/phpbiji/108382.html"></a></li><li><a href="/php/phpbiji/108384.html"></a></li><li><a href="/php/phpbiji/108383.html"></a></li><li><a href="/php/phpbiji/108385.html"></a></li><li><a href="/php/phpbiji/108386.html"></a></li><li><a href="/php/phpbiji/108388.html"></a></li><li><a href="/php/phpbiji/108387.html"></a></li><li><a href="/php/phpbiji/108389.html"></a></li><li><a href="/php/phpbiji/108391.html"></a></li>		</ul>
	</li>
		<li>
	    <a href="/php/biji/" class="waves-effect">
		    <i class="icon-share"></i>
		    <span>PHP笔记
		       	<span class="float-right menu-arrow">
		       	<i class="mdi mdi-chevron-right"></i>
		       	</span>
		    </span>
	    </a>
	</li>
	</ul>
</div>
<!-- Sidebar -->
<div class="clearfix"></div>
</div>
<!-- Sidebar -left -->
</div>
<!-- Left Sidebar End -->
<!-- Start right Content here -->
<div class="content-page">
	<div class="content">
		<div class="container-fluid">
			<div class="page-title-box">
				<div class="row align-items-center">
					<div class="col-sm-6">
						<h1 class="page-title">RedHat服务器网卡阵列配置攻略</h1>
					</div>
				</div>
				<!-- end row -->
			</div>
			<!-- end page-title -->
			<!-- START ROW -->
			<div class="panel panel-forbid">
				<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>内容摘要</div>
			    <div class="panel-content">
			    <span>网卡阵列配置<br />
1.修改vi /etc/rc.d/rc.local文件，增加以下内容（注意这里添加的是eth0、eth1两个网口）<br />
<br />
复制代码代码如下:<br />
ifenslave bond0 eth0 eth1<br />
#如果一块网卡失效，系统会</span>                                     
		    	</div>
			    <div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>文章正文</div>
			    <div class="panel-content">
			    <span><p><strong>网卡阵列配置<br /></strong>1.修改vi /etc/rc.d/rc.local文件，增加以下内容（注意这里添加的是eth0、eth1两个网口）<br /><br><div class="msgheader"><div class="right"><span style="CURSOR: pointer" onclick="copycode(getid('phpcode17'));"><u>复制代码</u></span></div>代码如下:</div><div class="msgborder" id="phpcode17"><br />ifenslave bond0 eth0 eth1<br />#如果一块网卡失效，系统会按照/etc/rc.d/rc.local里顺序启动网卡，起到失效保护作用。<br />echo "0" &gt;&gt;/proc/sys/net/ipv4/icmp_echo_ignore_broadcasts<br />setsebool ftpd_disable_trans 1<br />service vsftpd restart<br />route add -net 224.0.0.0/4 dev bond0<br />#添加路由来设定发送规则<br /></div><br />2.修改配置文件/etc/sysconfig/network-scripts<br />新增ifcfg-bond0文件，内容如下：<br />DEVICE=bond0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #设备名称<br />BOOTPROTO=static&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #不启用DHCP<br />ONBOOT=yes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #开机自启动<br />IPADDR=192.168.101.X&nbsp;&nbsp;&nbsp;&nbsp; #网卡阵列的ip地址<br />NETMASK=255.255.255.0&nbsp;&nbsp;&nbsp; #掩码<br />GATEWAY=192.168.101.1&nbsp;&nbsp;&nbsp; #网关<br />修改ifcfg-eth0,ifcfg-eth1文件，根据实际配置文件新增修改部分如下：<br /><br><div class="msgheader"><div class="right"><span style="CURSOR: pointer" onclick="copycode(getid('phpcode18'));"><u>复制代码</u></span></div>代码如下:</div><div class="msgborder" id="phpcode18"><br />MASTER=bond0<br />SLAVE=yes<br />BOOTPROTO=static #配置静态地址，不开启DHCP<br />ONBOOT=yes #开机网卡自启动<br /></div><br />3.修改/etc/modprobe.d/dist.conf（按esc用:$回车抵达最后一行在末尾添加下面两句）<br /><br><div class="msgheader"><div class="right"><span style="CURSOR: pointer" onclick="copycode(getid('phpcode19'));"><u>复制代码</u></span></div>代码如下:</div><div class="msgborder" id="phpcode19"><br />alias bond0 bonding<br /></div><br />(Bonding只能提供链路监测，从主机到交换机的链路是否连通，如果只是交换机对外的链路down掉，而交换机本身没有故障，bonding会认为没有故障而继续使用)<br /><br><div class="msgheader"><div class="right"><span style="CURSOR: pointer" onclick="copycode(getid('phpcode20'));"><u>复制代码</u></span></div>代码如下:</div><div class="msgborder" id="phpcode20"><br />options bond0 miimon=100 mode=1<br /></div><br />(miimon用来进行链路监测，每100ms监测一次链路连接状态，如果一条不同转入另一条线路；mode的值表示工作模式，共有1,2,3,4四种模式<br />Mode=0表示load balancing(round-robin)为负载均衡模式<br />Mode=1表示fault- tolerance(active-backup)为冗余模式，主备工作模式)<br /><br><div class="msgheader"><div class="right"><span style="CURSOR: pointer" onclick="copycode(getid('phpcode21'));"><u>复制代码</u></span></div>代码如下:</div><div class="msgborder" id="phpcode21"><br />alias net-pf-10 off #关闭ipv6支持，可以不加<br /></div><br />对于级联小交换机<br /><br><div class="msgheader"><div class="right"><span style="CURSOR: pointer" onclick="copycode(getid('phpcode22'));"><u>复制代码</u></span></div>代码如下:</div><div class="msgborder" id="phpcode22"><br />alias bond0 bonding<br />options bond0 mode=1 arp_interval=500 arp_ip_target=192.168.101.254 arp_validate=all primary=eth0<br /></div><br />#通过定时器，每个slave接口不断发送ARP包来不断更换交换机端口与MAC的对应关系<br />使得每个网卡都在进行工作。这个ARP的发送规则是：<br />每arp_interval（MS）间隔向arp_ip_target发送arp请求，可以向多个arp_ip_target发送arp请求。</p>
<p>4.增加/etc/udev/rules.d/50-hwinterfaces.rules<br />(锁定网卡物理地址，SYSFS{address}==&quot;&quot;双引号中输入物理地址)<br /><br><div class="msgheader"><div class="right"><span style="CURSOR: pointer" onclick="copycode(getid('phpcode23'));"><u>复制代码</u></span></div>代码如下:</div><div class="msgborder" id="phpcode23"><br />KERNEL=="eth*",SYSFS{address}=="",NAME="eth0"<br />KERNEL=="eth*",SYSFS{address}=="",NAME="eth1"<br />KERNEL=="eth*",SYSFS{address}=="",NAME="eth2"<br />KERNEL=="eth*",SYSFS{address}=="",NAME="eth3"<br />KERNEL=="eth*",SYSFS{address}=="",NAME="eth4"<br /></div><br />防止机器网卡的mac地址发生漂移</p>
<p>5.查看网卡阵列的配置情况<br /><br><div class="msgheader"><div class="right"><span style="CURSOR: pointer" onclick="copycode(getid('phpcode24'));"><u>复制代码</u></span></div>代码如下:</div><div class="msgborder" id="phpcode24"><br />#ifconfig -a|grep HWaddr<br /></div><br />查看网卡mac信息，如果bond0，eth0，eth1硬件地址一致，则配置成功<br /><br><div class="msgheader"><div class="right"><span style="CURSOR: pointer" onclick="copycode(getid('phpcode25'));"><u>复制代码</u></span></div>代码如下:</div><div class="msgborder" id="phpcode25"><br />#cat /proc/net/bonding/bond0<br /></div><br />查看bond0工作状态</p>
<p><strong>网卡常用操作方法笔记<br /></strong>1.bond0上的mac地址修改成一致，这些网卡接在同一台交换机上，那么该交换机的arp表同一mac地址对应的端口有多个，交换机无法判断数据包发往的端口，所以要求交换机的相应端口采取聚合模式，聚合后的端口采用同一mac地址。<br />2.使网卡配置马上生效，不用重启机器，命令<br /><br><div class="msgheader"><div class="right"><span style="CURSOR: pointer" onclick="copycode(getid('phpcode26'));"><u>复制代码</u></span></div>代码如下:</div><div class="msgborder" id="phpcode26"><br />#service network restart或<br />#/etc/rc.d/init.d/network restart<br /></div><br />必须关闭NetworkManager服务<br /><br><div class="msgheader"><div class="right"><span style="CURSOR: pointer" onclick="copycode(getid('phpcode27'));"><u>复制代码</u></span></div>代码如下:</div><div class="msgborder" id="phpcode27"><br />#service NetworkManager stop //当前环境下关闭服务<br />#chkconfig NetworkManager off //开机启动关闭服务<br /></div><br />3.重新启动网卡，命令<br /><br><div class="msgheader"><div class="right"><span style="CURSOR: pointer" onclick="copycode(getid('phpcode28'));"><u>复制代码</u></span></div>代码如下:</div><div class="msgborder" id="phpcode28"><br />#ifconfig bond0 down/ifdown bond0<br />#ifconfig eth0 down/ifdown eth0<br />#ifconfig eth1 down/ifdown eth1<br />#ifenslave bond0 eth0 <br />#ifenslave bond0 eth1 <br />#ifconfig bond0 up/ifup bond0<br />#ifconfig eth0 up/ifup eth0<br />#ifconfig eth1 up/ifup eth1<br /></div><br />4. Bonding的模式一共有7种：<br /><br><div class="msgheader"><div class="right"><span style="CURSOR: pointer" onclick="copycode(getid('phpcode29'));"><u>复制代码</u></span></div>代码如下:</div><div class="msgborder" id="phpcode29"><br />#defineBOND_MODE_ROUNDROBIN 0.balance-rr模式,网卡的负载均衡模式<br />#defineBOND_MODE_ACTIVEBACKUP 1.active-backup模式,网卡的容错模式<br />#defineBOND_MODE_XOR 2.balance-xor模式,需要交换机支持<br />#defineBOND_MODE_BROADCAST 3.broadcast模式<br />#defineBOND_MODE_8023AD 4.IEEE 802.3ad动态链路聚合模式,需要交换机支持#defineBOND_MODE_TLB 5.自定义传输负载均衡模式<br />#defineBOND_MODE_ALB 6.网卡虚拟化方式<br /></div><br />bonding模块的所有工作模式可以分为两类：多主型工作模式和主备型工作模式，balance-rr 和broadcast属于多主型工作模式而active-backup属于主备型工作模式。（balance-xor、自适应传输负载均衡模式 （balance-tlb）和自适应负载均衡模式（balance-alb）也属于多主型工作模式，IEEE 802.3ad动态链路聚合模式（802.3ad）属于主备型工作模式。<br />(1)BOND_MODE_ROUNDROBIN模式下，bonding对于发送和接收数据的处理逻辑是不一致的，对于数据的接收，bonding基本不做任何处理，纯粹依靠交换机端口与MAC的变化来实现交替接收数据。发送的话，交换机会根据数据的源MAC来学习端口和MAC之间的关系，所以bonding 做到的就是选择不一样的网卡发送。<br />(2)网卡的容错模式（mode =BOND_MODE_ACTIVEBACKUP）,容错模式的配置方法和负载均衡模式基本差不多，只不过修改一下/etc/modprobe.conf即可。</p>
<p>5.arp检测模式<br />观察交换机端口上所学习到的MAC地址，发现MAC会在两个端口上反复切换在BOND_MODE_ROUNDROBIN模式下，bonding对于发送和接收数据的处理逻辑是不一致的，对于数据的接收，bonding基本不做任何处理，纯粹依靠交换机端口与MAC的变化来实现交替接收数据。发送的话，交换机会根据数据的源MAC来学习端口和MAC之间的关系，所以bonding 做到的就是选择不一样的网卡发送。<br />对于数据的发送，<br /><br><div class="msgheader"><div class="right"><span style="CURSOR: pointer" onclick="copycode(getid('phpcode30'));"><u>复制代码</u></span></div>代码如下:</div><div class="msgborder" id="phpcode30"><br />static inline voidbond_set_mode_ops(struct net_device *bond_dev, int mode)<br />{<br />switch(mode) {<br />case BOND_MODE_ROUNDROBIN:<br />bond_dev-&gt;hard_start_xmit =bond_xmit_roundrobin;<br />break;<br />...<br /></div><br />bond的发送函数被注册为bond_xmit_roundrobin。通过bond_xmit_roundrobin的实现可以发现。<br /><br><div class="msgheader"><div class="right"><span style="CURSOR: pointer" onclick="copycode(getid('phpcode31'));"><u>复制代码</u></span></div>代码如下:</div><div class="msgborder" id="phpcode31"><br />static int bond_xmit_roundrobin(structsk_buff *skb, struct net_device *bond_dev)<br />{<br />ead_lock(&amp;bond-&gt;curr_slave_lock);<br />slave = start_at = bond-&gt;curr_active_slave;<br />read_unlock(&amp;bond-&gt;curr_slave_lock);<br />bond_for_each_slave_from(bond, slave, i,start_at) {<br />if(IS_UP(slave-&gt;dev) &amp;&amp;<br /> (slave-&gt;link == BOND_LINK_UP) &amp;&amp;<br /> (slave-&gt;state ==BOND_STATE_ACTIVE)) {<br />res =bond_dev_queue_xmit(bond, skb, slave-&gt;dev);<br />write_lock(&amp;bond-&gt;curr_slave_lock);<br />bond-&gt;curr_active_slave= slave-&gt;next;<br />write_unlock(&amp;bond-&gt;curr_slave_lock);<br />break;<br />}<br /></div><br />bond_xmit_roundrobin会通过curr_active_slave指针所指向的设备来进行发送，当然 curr_active_slave会在调用bond_dev_queue_xmit完成实际的发送之后指向下一个slave设备。 bond_dev_queue_xmit实际是调用通用的发送函数dev_queue_xmit来进行的，它传递给dev_queue_xmit的是一个 skb，在传递之前skb-&gt;dev就被指定为了当前的slave设备，这样内核就会找到对应的真实网卡设备来进行发送，最后 curr_active_slave指针的轮询切换，实现了bonding的负载均衡工作模式。<br />从这种模式可以看到，bonding实现了一个类似网卡驱动的模块，对应的bond0设备是一个纯粹的虚设备，数据发送虽然说经过了它，但通过一系列调用，转了一圈之后才回到真正的网卡设备那里进行发送，无疑会消耗一定的系统性能。<br />简单用100Mbps速率的UDP数据包测试了一下BOND_MODE_ROUNDROBIN模式。<br />测试过程中发现接收端会有较多的乱序包，观察交换机端口情况，端口之间的切换频率不规则，这个和交换机的配置或者性能应该有很大联系，有必要的话需要进一步研究。数据的正确性和时序性能否保证需要进一步仔细测试。</p>
<p>6. mii链路检测方式<br />与之前arp检测方式不同。这两种链路检测方式在各种mode下都是可以使用的，但要注意不能同时使用。<br />bonding的mii检测实现。首先和arp-monitor一样，mii也是定时器触发<br /><br><div class="msgheader"><div class="right"><span style="CURSOR: pointer" onclick="copycode(getid('phpcode32'));"><u>复制代码</u></span></div>代码如下:</div><div class="msgborder" id="phpcode32"><br />if(bond-&gt;params.miimon) { /* link checkinterval, in milliseconds. */<br />init_timer(mii_timer);<br />mii_timer-&gt;expires= jiffies + 1;<br />mii_timer-&gt;data = (unsigned long)bond_dev;<br />mii_timer-&gt;function = (void*)&amp;bond_mii_monitor;<br />add_timer(mii_timer);<br />}<br /></div><br />bond_mii_monitor函数其本质的原理就是检测网卡的链路状态，bonding定义网卡有4个链路状态：BOND_LINK_UP：<br />正常状态（处于该状态的网卡是是潜在的发送数据包的候选者）<br />BOND_LINK_FAIL：网卡出现故障，向状态BOND_LINK_DOWN 切换中<br />BOND_LINK_DOWN：失效状态<br />BOND_LINK_BACK：网卡恢复，向状态BOND_LINK_UP切换中<br />从上到下，表示了网卡链路从正常到失效再到恢复状态。bond_mii_monitor函数就是依次检查网卡的链路状态是否处于这些状态，然后通过标记 do_failover变量来说明当前是否需要切换slave网卡。代码篇幅较大，但逻辑还是很清晰的，故此处不罗列了。<br />在BOND_MODE_ACTIVEBACKUP模式下，两块网卡其实有一块是不工作的，被设置为IFF_NOARP的状态。同时，bond虚设备，还有 slave设备的MAC地址均一致，所以这张网卡不会被外界察觉存在。交换机也不存在想该端口发包的情况。当bond的mii检测发现当前的active 设备失效了之后，会切换到这个备份设备上。<br />在bond_change_active_slave函数中<br /><br><div class="msgheader"><div class="right"><span style="CURSOR: pointer" onclick="copycode(getid('phpcode33'));"><u>复制代码</u></span></div>代码如下:</div><div class="msgborder" id="phpcode33"><br />if (bond-&gt;params.mode ==BOND_MODE_ACTIVEBACKUP) {<br />if (old_active) {<br />bond_set_slave_inactive_flags(old_active);<br />}<br />if (new_active) {<br />bond_set_slave_active_flags(new_active);<br />}<br />}<br /></div><br />这个就是在BOND_MODE_ACTIVEBACKUP模式下的切换逻辑，很简单，需要注意的是，在 bond_set_slave_inactive_flags(old_active)中，需要将接口的状态设置为IFF_NOARP，不然交换机就可能 会把数据包发送到一个错误的端口上。</p>
<hr></span>                                     
		    	</div>
		    	<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>代码注释</div>
			    <div class="panel-content">
			    <span></span>                                     
		    	</div>

			</div>

			<!-- END ROW -->
			<div class="newsPage">
				<div class="newsPageTurn">
				    <span><a>上一篇</a><a href='/php/biji/97073.html'>php实现用于验证所有类型的信用卡类</a><a>下一篇</a><a href='/php/biji/97075.html'>利用Ajax实现在脚本里传值实例介绍</a></span>
				</div>
			</div>
		</div>


<div id="author-box">
    <h3>作者：喵哥笔记</h3>
        <div class="author-info">
            <div class="author-avatar">
                <img src="/skin1/picture/01.jpg" alt="IDC笔记" class="avatar" width="64" height="64">
            </div>
        <div class="author-description">
            <p>学的不仅是技术，更是梦想！</p>
            <ul class="author-social follows nb">
            	<li>
                    <a target="_blank" href="/" title="IDC笔记">IDC笔记</a>
                </li>
            </ul>
        </div>
        <div class="clear"></div>
    </div>
</div>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
<!-- container-fluid -->
	</div>
<!-- content -->
	<footer class="footer">
	© 2020 IDC笔记 <i class="mdi mdi-heart text-danger"></i>. | 备案号：<a href="https://beian.miit.gov.cn/">辽ICP备18000516号</a>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?674585fbbd2294d3faf910f668ea91b4";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

	</footer>
</div>

</div>
<!-- END wrapper -->
<!-- jQuery  -->
<script src="/skin1/js/jquery.min.js"></script>
<script src="/skin1/js/bootstrap.bundle.min.js"></script>
<script src="/skin1/js/metismenu.min.js"></script>
<script src="/skin1/js/jquery.slimscroll.js"></script>
<script src="/skin1/js/waves.min.js"></script>
<!--Morris Chart-->
<script src="/skin1/js/morris.min.js"></script>
<script src="/skin1/js/raphael.min.js"></script>
<script src="/skin1/js/dashboard.init.js"></script>
<script src="/skin1/js/app.js"></script>
<script src="/foot.js"></script>
</body>
</html>