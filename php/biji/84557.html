<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <title>Android中利用SurfaceView制作抽奖转盘的全流程攻略_PHP教程_IDC笔记</title>
    <meta name="keywords" content="PHP,PHP笔记,PHP教程" />
    <meta name="description" content="一、概述<br />
<br />
今天给大家带来SurfaceView的一个实战案例，话说自定义View也是各种写，一直没有写过SurfaceView，这个玩意是什么东西？什么时候用比较好呢？<br />
<br />
可以看到SurfaceView也是继" />
    <meta content="Responsive admin theme build on top of Bootstrap 4" name="description" />
    <meta content="idcnote.com" name="author" />
    <link rel="shortcut icon" href="/skin1/images/favicon.ico">
    <!--Morris Chart CSS -->
    <link rel="stylesheet" href="/skin1/css/morris.css">
    <link href="/skin1/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/metismenu.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/icons.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/style.css" rel="stylesheet" type="text/css">
<link href="/SyntaxHighlighter/shCoreDefault.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">
 SyntaxHighlighter.all();
</script>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
</head>
<body>
<!-- Begin page -->
		<div id="wrapper">
			<!-- Top Bar Start -->
			<div class="topbar">
				<!-- LOGO -->
				<div class="topbar-left">
					<a href="/" class="logo">
						<span class="logo-light">
                            <i class="mdi mdi-camera-control"></i>IDC笔记
                        </span>
						<span class="logo-sm">
                            <i class="mdi mdi-camera-control"></i>
                        </span>
					</a>
				</div>
				<nav class="navbar-custom">
					<ul class="navbar-right list-inline float-right mb-0">
						<!--<li class="dropdown notification-list list-inline-item d-none d-md-inline-block">
							<a class="nav-link waves-effect" href="#" id="btn-fullscreen">
								<i class="mdi mdi-arrow-expand-all noti-icon"></i>
							</a>
						</li>
						<li class="dropdown notification-list list-inline-item">
							<div class="dropdown notification-list nav-pro-img">
								<a class="dropdown-toggle nav-link arrow-none nav-user" data-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
									<img src="/skin1/picture/user-4.jpg" alt="user" class="rounded-circle">
								</a>
								<div class="dropdown-menu dropdown-menu-right profile-dropdown ">
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-account-circle"></i> Profile</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-wallet"></i> Wallet</a>
									<a class="dropdown-item d-block" href="#">
										<span class="badge badge-success float-right">11</span>
										<i class="mdi mdi-settings"></i> Settings</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-lock-open-outline"></i> Lock screen</a>
									<div class="dropdown-divider"></div>
									<a class="dropdown-item text-danger" href="#">
										<i class="mdi mdi-power text-danger"></i> Logout</a>
								</div>
							</div>
						</li>
						-->
					</ul>
					<ul class="list-inline menu-left mb-0">
						<li class="float-left">
							<button class="button-menu-mobile open-left waves-effect">
                            <i class="mdi mdi-menu"></i>
                        </button>
						</li>
						<li class="d-none d-md-inline-block">
							<form role="search" class="app-search">
								<div class="form-group mb-0">
									<input type="text" class="form-control" placeholder="Search..">
									<button type="submit"><i class="fa fa-search"></i></button>
								</div>
							</form>
						</li>
					</ul>
				</nav>
			</div>
<!-- ========== Left Sidebar Start ========== -->
<div class="left side-menu">
    <div class="slimscroll-menu" id="remove-scroll">
    <!--- Sidemenu -->
    <div id="sidebar-menu">
    <!-- Left Menu Start -->
    <ul class="metismenu" id="side-menu">
			<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP简介			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/jianjie/1.html">PHP简介</a></li><li><a href="/php/jianjie/2.html">PHP用途</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP基本语法			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yufa/3.html">分离HTML</a></li><li><a href="/php/yufa/4.html">指令分隔符</a></li><li><a href="/php/yufa/5.html">PHP注释</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP类型			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpleixing/6.html">PHP类型简介</a></li><li><a href="/php/phpleixing/7.html">PHP类型之布尔类型</a></li><li><a href="/php/phpleixing/8.html">PHP类型之整型</a></li><li><a href="/php/phpleixing/9.html">PHP类型之浮点型</a></li><li><a href="/php/phpleixing/10.html">PHP类型之字符串</a></li><li><a href="/php/phpleixing/11.html">PHP类型之数组</a></li><li><a href="/php/phpleixing/12.html">PHP类型之对象</a></li><li><a href="/php/phpleixing/13.html">PHP类型之资源类型</a></li><li><a href="/php/phpleixing/14.html">PHP类型之NULL</a></li><li><a href="/php/phpleixing/15.html">PHP类型之伪类型</a></li><li><a href="/php/phpleixing/16.html">PHP类型之类型判别</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP变量			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpbianliang/17.html">PHP变量之基础</a></li><li><a href="/php/phpbianliang/18.html">PHP变量之预定义变量</a></li><li><a href="/php/phpbianliang/19.html">PHP变量之变量范围</a></li><li><a href="/php/phpbianliang/20.html">PHP变量之可变变量</a></li><li><a href="/php/phpbianliang/21.html">PHP变量之外部变量</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP运算符			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yunsuanfu/22.html">PHP运算符优先级</a></li><li><a href="/php/yunsuanfu/23.html">算术运算符</a></li><li><a href="/php/yunsuanfu/24.html">赋值运算符</a></li><li><a href="/php/yunsuanfu/25.html">位运算符</a></li><li><a href="/php/yunsuanfu/26.html">比较运算符</a></li><li><a href="/php/yunsuanfu/27.html">错误控制运算符</a></li><li><a href="/php/yunsuanfu/28.html">执行运算符</a></li><li><a href="/php/yunsuanfu/29.html">递增/递减运算符</a></li><li><a href="/php/yunsuanfu/30.html">逻辑运算符</a></li><li><a href="/php/yunsuanfu/31.html">字符串运算符</a></li><li><a href="/php/yunsuanfu/32.html">数组运算符</a></li><li><a href="/php/yunsuanfu/33.html">类型运算符</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP控制结构			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/jiegou/34.html">PHP控制结构之if</a></li><li><a href="/php/jiegou/35.html">PHP控制结构之else</a></li><li><a href="/php/jiegou/36.html">PHP控制结构之elseif/else if</a></li><li><a href="/php/jiegou/37.html">PHP控制结构之替代语法</a></li><li><a href="/php/jiegou/38.html">PHP控制结构之while</a></li><li><a href="/php/jiegou/39.html">PHP控制结构之do-while</a></li><li><a href="/php/jiegou/40.html">PHP控制结构之for</a></li><li><a href="/php/jiegou/41.html">PHP控制结构之foreach</a></li><li><a href="/php/jiegou/42.html">PHP控制结构之break</a></li><li><a href="/php/jiegou/43.html">PHP控制结构之continue</a></li><li><a href="/php/jiegou/44.html">PHP控制结构之switch</a></li><li><a href="/php/jiegou/45.html">PHP控制结构之declare</a></li><li><a href="/php/jiegou/46.html">PHP控制结构之return</a></li><li><a href="/php/jiegou/47.html">PHP控制结构之require</a></li><li><a href="/php/jiegou/48.html">PHP控制结构之include</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP函数			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/hanshu/52.html">用户自定义函数</a></li><li><a href="/php/hanshu/53.html">函数的参数</a></li><li><a href="/php/hanshu/54.html">返回值</a></li><li><a href="/php/hanshu/55.html">可变函数</a></li><li><a href="/php/hanshu/56.html">内部（内置）函数</a></li><li><a href="/php/hanshu/57.html">匿名函数</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP类与对象			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpduixiang/58.html">类与对象前言</a></li><li><a href="/php/phpduixiang/59.html">基本概念</a></li><li><a href="/php/phpduixiang/60.html">属性</a></li><li><a href="/php/phpduixiang/61.html">类常量</a></li><li><a href="/php/phpduixiang/62.html">自动加载对象</a></li><li><a href="/php/phpduixiang/63.html">构造函数和析构函数</a></li><li><a href="/php/phpduixiang/64.html">访问控制</a></li><li><a href="/php/phpduixiang/65.html">对象继承</a></li><li><a href="/php/phpduixiang/66.html">Static关键字</a></li><li><a href="/php/phpduixiang/67.html">抽象类</a></li><li><a href="/php/phpduixiang/68.html">接口</a></li><li><a href="/php/phpduixiang/69.html">Traits</a></li><li><a href="/php/phpduixiang/70.html">重载</a></li><li><a href="/php/phpduixiang/71.html">对象迭代</a></li><li><a href="/php/phpduixiang/72.html">设计模式</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP异常处理			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yichang/81.html">异常处理</a></li><li><a href="/php/yichang/82.html">扩展PHP内置的异常处理类</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP函数库按分类			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpku/83.html">数组</a></li><li><a href="/php/phpku/84.html">Classes/Objects</a></li><li><a href="/php/phpku/85.html">Date/Time</a></li><li><a href="/php/phpku/86.html">Directories</a></li><li><a href="/php/phpku/87.html">错误处理</a></li><li><a href="/php/phpku/88.html">Program execution</a></li><li><a href="/php/phpku/89.html">Filesystem</a></li><li><a href="/php/phpku/90.html">Filter</a></li><li><a href="/php/phpku/91.html">Function Handling</a></li><li><a href="/php/phpku/92.html">PHP 选项/信息</a></li><li><a href="/php/phpku/93.html">Mail</a></li><li><a href="/php/phpku/94.html">Math</a></li><li><a href="/php/phpku/95.html">Misc.</a></li><li><a href="/php/phpku/96.html">Network</a></li><li><a href="/php/phpku/97.html">输出控制</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> php基础			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpbiji/108377.html"></a></li><li><a href="/php/phpbiji/108376.html"></a></li><li><a href="/php/phpbiji/108380.html"></a></li><li><a href="/php/phpbiji/108379.html"></a></li><li><a href="/php/phpbiji/108378.html"></a></li><li><a href="/php/phpbiji/108381.html"></a></li><li><a href="/php/phpbiji/108382.html"></a></li><li><a href="/php/phpbiji/108384.html"></a></li><li><a href="/php/phpbiji/108383.html"></a></li><li><a href="/php/phpbiji/108385.html"></a></li><li><a href="/php/phpbiji/108386.html"></a></li><li><a href="/php/phpbiji/108388.html"></a></li><li><a href="/php/phpbiji/108387.html"></a></li><li><a href="/php/phpbiji/108389.html"></a></li><li><a href="/php/phpbiji/108391.html"></a></li>		</ul>
	</li>
		<li>
	    <a href="/php/biji/" class="waves-effect">
		    <i class="icon-share"></i>
		    <span>PHP笔记
		       	<span class="float-right menu-arrow">
		       	<i class="mdi mdi-chevron-right"></i>
		       	</span>
		    </span>
	    </a>
	</li>
	</ul>
</div>
<!-- Sidebar -->
<div class="clearfix"></div>
</div>
<!-- Sidebar -left -->
</div>
<!-- Left Sidebar End -->
<!-- Start right Content here -->
<div class="content-page">
	<div class="content">
		<div class="container-fluid">
			<div class="page-title-box">
				<div class="row align-items-center">
					<div class="col-sm-6">
						<h1 class="page-title">Android中利用SurfaceView制作抽奖转盘的全流程攻略</h1>
					</div>
				</div>
				<!-- end row -->
			</div>
			<!-- end page-title -->
			<!-- START ROW -->
			<div class="panel panel-forbid">
				<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>内容摘要</div>
			    <div class="panel-content">
			    <span>一、概述<br />
<br />
今天给大家带来SurfaceView的一个实战案例，话说自定义View也是各种写，一直没有写过SurfaceView，这个玩意是什么东西？什么时候用比较好呢？<br />
<br />
可以看到SurfaceView也是继</span>                                     
		    	</div>
			    <div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>文章正文</div>
			    <div class="panel-content">
			    <span><p><strong>一、概述<br />
</strong>今天给大家带来SurfaceView的一个实战案例，话说自定义View也是各种写，一直没有写过SurfaceView，这个玩意是什么东西？什么时候用比较好呢？<br />
可以看到SurfaceView也是继承了View，但是我们并不需要去实现它的draw方法来绘制自己，为什么呢？<br />
因为它和View有一个很大的区别，View在UI线程去更新自己；而SurfaceView则在一个子线程中去更新自己；这也显示出了它的优势，当制作游戏等需要不断刷新View时，因为是在子线程，避免了对UI线程的阻塞。<br />
知道了优势以后，你会想那么不使用draw方法，哪来的canvas使用呢？<br />
大家都记得更新View的时候draw方法提供了一个canvas，SurfaceView内部内嵌了一个专门用于绘制的Surface，而这个Surface中包含一个Canvas。<br />
有了Canvas，我们如何获取呢？<br />
SurfaceView里面有个getHolder方法，我们可以获取一个SurfaceHolder。通过SurfaceHolder可以监听SurfaceView的生命周期以及获取Canvas对象。</p>
<p><strong>二、SurfaceView一般的写法<br />
</strong>综上所述，一般SurfaceView类中我们会这么写代码：</p>
<div class="phpstudycode">
<pre class="brush:java;">
public class SurfaceViewTemplate extends SurfaceView implements Callback, Runnable 
{ 
 
  private SurfaceHolder mHolder; 
  /** 
   * 与SurfaceHolder绑定的Canvas 
   */ 
  private Canvas mCanvas; 
  /** 
   * 用于绘制的线程 
   */ 
  private Thread t; 
  /** 
   * 线程的控制开关 
   */ 
  private boolean isRunning; 
 
  public SurfaceViewTemplate(Context context) 
  { 
    this(context, null); 
  } 
 
  public SurfaceViewTemplate(Context context, AttributeSet attrs) 
  { 
    super(context, attrs); 
 
    mHolder = getHolder(); 
    mHolder.addCallback(this); 
 
    // setZOrderOnTop(true);// 设置画布 背景透明 
    // mHolder.setFormat(PixelFormat.TRANSLUCENT); 
     
    //设置可获得焦点 
    setFocusable(true); 
    setFocusableInTouchMode(true); 
    //设置常亮 
    this.setKeepScreenOn(true); 
 
  } 
 
  @Override 
  public void surfaceCreated(SurfaceHolder holder) 
  { 
 
    // 开启线程 
    isRunning = true; 
    t = new Thread(this); 
    t.start(); 
  } 
 
  @Override 
  public void surfaceChanged(SurfaceHolder holder, int format, int width, 
      int height) 
  { 
    // TODO Auto-generated method stub 
 
  } 
 
  @Override 
  public void surfaceDestroyed(SurfaceHolder holder) 
  { 
    // 通知关闭线程 
    isRunning = false; 
  } 
 
  @Override 
  public void run() 
  { 
    // 不断的进行draw 
    while (isRunning) 
    { 
      draw(); 
    } 
 
  } 
 
  private void draw() 
  { 
    try 
    { 
      // 获得canvas 
      mCanvas = mHolder.lockCanvas(); 
      if (mCanvas != null) 
      { 
        // drawSomething.. 
      } 
    } catch (Exception e) 
    { 
    } finally 
    { 
      if (mCanvas != null) 
        mHolder.unlockCanvasAndPost(mCanvas); 
    } 
  } 
} 

</pre>
</div>
<p>结合上面我们的介绍，我们在构造中通过getHolder拿到SurfaceHolder对象，然后设置一个addCallback回调，去监听SurfaceView的生命周期，生命周期有三个方法，分别为create,change,destory;我们一般在create里面进行初始化的一些操作，然后开启线程；在destroy里面设置关闭线程；<br />
所有的绘制流程都是线程的run方法里面，可以看到我们的draw方法。<br />
注意下，我们在draw里面进行了try catch然后很多的判空，主要是因为，当用户点击back或者按下home键以后，surfaceview会被销毁；<br />
&nbsp;mHolder.lockCanvas();返回的就是null了，所以为了避免造成空指针错误，我们各种判null，甚至还加了个try catch。<br />
说了这么多，竟然没看到效果图，这怎么能行~~</p>
<p><strong>三、效果图<br />
</strong></p>
<p></p>
<p>就这么个效果，当然了模拟器录制的效果肯定没有真机上效果流畅。<br />
结合上面我们给出的模版，我们需要改变的就是，在create回调里面需要去初始化一些变量，在draw方法里面去绘制我们的文本、图片、扇形块块等等。整体架构没有变化。</p>
<p><strong>四、转盘的制作</strong></p>
<p><strong>1.构造方法以及变量</strong></p>
<div class="phpstudycode">
<pre class="brush:java;">
public class LuckyPanView extends SurfaceView implements Callback, Runnable 
{ 
 
  private SurfaceHolder mHolder; 
  /** 
   * 与SurfaceHolder绑定的Canvas 
   */ 
  private Canvas mCanvas; 
  /** 
   * 用于绘制的线程 
   */ 
  private Thread t; 
  /** 
   * 线程的控制开关 
   */ 
  private boolean isRunning; 
 
  /** 
   * 抽奖的文字 
   */ 
  private String[] mStrs = new String[] { "单反相机", "IPAD", "恭喜发财", "IPHONE", 
      "妹子一只", "恭喜发财" }; 
  /** 
   * 每个盘块的颜色 
   */ 
  private int[] mColors = new int[] { 0xFFFFC300, 0xFFF17E01, 0xFFFFC300, 
      0xFFF17E01, 0xFFFFC300, 0xFFF17E01 }; 
  /** 
   * 与文字对应的图片 
   */ 
  private int[] mImgs = new int[] { R.drawable.danfan, R.drawable.ipad, 
      R.drawable.f040, R.drawable.iphone, R.drawable.meizi, 
      R.drawable.f040 }; 
 
  /** 
   * 与文字对应图片的bitmap数组 
   */ 
  private Bitmap[] mImgsBitmap; 
  /** 
   * 盘块的个数 
   */ 
  private int mItemCount = 6; 
 
  /** 
   * 绘制盘块的范围 
   */ 
  private RectF mRange = new RectF(); 
  /** 
   * 圆的直径 
   */ 
  private int mRadius; 
  /** 
   * 绘制盘快的画笔 
   */ 
  private Paint mArcPaint; 
 
  /** 
   * 绘制文字的画笔 
   */ 
  private Paint mTextPaint; 
 
  /** 
   * 滚动的速度 
   */ 
  private double mSpeed; 
  private volatile float mStartAngle = 0; 
  /** 
   * 是否点击了停止 
   */ 
  private boolean isShouldEnd; 
 
  /** 
   * 控件的中心位置 
   */ 
  private int mCenter; 
  /** 
   * 控件的padding，这里我们认为4个padding的值一致，以paddingleft为标准 
   */ 
  private int mPadding; 
 
  /** 
   * 背景图的bitmap 
   */ 
  private Bitmap mBgBitmap = BitmapFactory.decodeResource(getResources(), 
      R.drawable.bg2); 
  /** 
   * 文字的大小 
   */ 
  private float mTextSize = TypedValue.applyDimension( 
      TypedValue.COMPLEX_UNIT_SP, 20, getResources().getDisplayMetrics()); 
 
  public LuckyPanView(Context context) 
  { 
    this(context, null); 
  } 
 
  public LuckyPanView(Context context, AttributeSet attrs) 
  { 
    super(context, attrs); 
 
    mHolder = getHolder(); 
    mHolder.addCallback(this); 
 
    // setZOrderOnTop(true);// 设置画布 背景透明 
    // mHolder.setFormat(PixelFormat.TRANSLUCENT); 
 
    setFocusable(true); 
    setFocusableInTouchMode(true); 
    this.setKeepScreenOn(true); 
 
  } 

</pre>
</div>
<p>我们在构造中设置了Callback回调，然后通过成员变量，大家应该也能看得出来每个变量的作用，以及可能有的代码快。</p>
<p><strong>2.onMeasure<br />
</strong>这里我简单重写了一下onMeasure，使我们的控件为正方形</p>
<div class="phpstudycode">
<pre class="brush:java;">
/** 
   * 设置控件为正方形 
   */ 
  @Override 
  protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) 
  { 
    super.onMeasure(widthMeasureSpec, heightMeasureSpec); 
 
    int width = Math.min(getMeasuredWidth(), getMeasuredHeight()); 
    // 获取圆形的直径 
    mRadius = width - getPaddingLeft() - getPaddingRight(); 
    // padding值 
    mPadding = getPaddingLeft(); 
    // 中心点 
    mCenter = width / 2; 
    setMeasuredDimension(width, width); 
  } 

</pre>
</div>
<p>并且为我们的mRadius和mCenter进行了赋值。</p>
<p><strong>3.surfaceCreated</strong></p>
<div class="phpstudycode">
<pre class="brush:java;">
@Override 
  public void surfaceCreated(SurfaceHolder holder) 
  { 
    // 初始化绘制圆弧的画笔 
    mArcPaint = new Paint(); 
    mArcPaint.setAntiAlias(true); 
    mArcPaint.setDither(true); 
    // 初始化绘制文字的画笔 
    mTextPaint = new Paint(); 
    mTextPaint.setColor(0xFFffffff); 
    mTextPaint.setTextSize(mTextSize); 
    // 圆弧的绘制范围 
    mRange = new RectF(getPaddingLeft(), getPaddingLeft(), mRadius 
        + getPaddingLeft(), mRadius + getPaddingLeft()); 
 
    // 初始化图片 
    mImgsBitmap = new Bitmap[mItemCount]; 
    for (int i = 0; i &lt; mItemCount; i++) 
    { 
      mImgsBitmap[i] = BitmapFactory.decodeResource(getResources(), 
          mImgs[i]); 
    } 
 
    // 开启线程 
    isRunning = true; 
    t = new Thread(this); 
    t.start(); 
  } 

</pre>
</div>
<p>surfaceCreated我们初始化了绘制需要用到的变量，以及开启了线程。<br />
surfaceDestroyed中就一行代码，顺便贴出。</p>
<div class="phpstudycode">
<pre class="brush:java;">
@Override 
  public void surfaceChanged(SurfaceHolder holder, int format, int width, 
      int height) 
  { 
    // TODO Auto-generated method stub 
 
  } 
 
  @Override 
  public void surfaceDestroyed(SurfaceHolder holder) 
  { 
    // 通知关闭线程 
    isRunning = false; 
  } 

</pre>
</div>
<p>可以猜到核心的代码都在我们的线程的run里面了。</p>
<p><strong>4.draw</strong></p>
<div class="phpstudycode">
<pre class="brush:java;">
@Override 
  public void run() 
  { 
    // 不断的进行draw 
    while (isRunning) 
    { 
      long start = System.currentTimeMillis(); 
      draw(); 
      long end = System.currentTimeMillis(); 
      try 
      { 
        if (end - start &lt; 50) 
        { 
          Thread.sleep(50 - (end - start)); 
        } 
      } catch (InterruptedException e) 
      { 
        e.printStackTrace(); 
      } 
 
    } 
 
  } 
 
  private void draw() 
  { 
    try 
    { 
      // 获得canvas 
      mCanvas = mHolder.lockCanvas(); 
      if (mCanvas != null) 
      { 
        // 绘制背景图 
        drawBg(); 
 
        /** 
         * 绘制每个块块，每个块块上的文本，每个块块上的图片 
         */ 
        float tmpAngle = mStartAngle; 
        float sweepAngle = (float) (360 / mItemCount); 
        for (int i = 0; i &lt; mItemCount; i++) 
        { 
          // 绘制快快 
          mArcPaint.setColor(mColors[i]); 
          mCanvas.drawArc(mRange, tmpAngle, sweepAngle, true, 
              mArcPaint); 
          // 绘制文本 
          drawText(tmpAngle, sweepAngle, mStrs[i]); 
          // 绘制Icon 
          drawIcon(tmpAngle, i); 
 
          tmpAngle += sweepAngle; 
        } 
 
        // 如果mSpeed不等于0，则相当于在滚动 
        mStartAngle += mSpeed; 
 
        // 点击停止时，设置mSpeed为递减，为0值转盘停止 
        if (isShouldEnd) 
        { 
          mSpeed -= 1; 
        } 
        if (mSpeed &lt;= 0) 
        { 
          mSpeed = 0; 
          isShouldEnd = false; 
        } 
        // 根据当前旋转的mStartAngle计算当前滚动到的区域 
        calInExactArea(mStartAngle); 
      } 
    } catch (Exception e) 
    { 
      e.printStackTrace(); 
    } finally 
    { 
      if (mCanvas != null) 
        mHolder.unlockCanvasAndPost(mCanvas); 
    } 
 
  } 

</pre>
</div>
<p>可以看到我们的run里面调用了draw，和上面模版一致。<br />
使用通过 mHolder.lockCanvas();获得我们的Canvas，然后就可以尽情的绘制了。<br />
<strong>（1）绘制背景drawBg();</strong></p>
<div class="phpstudycode">
<pre class="brush:java;">
/** 
 * 根据当前旋转的mStartAngle计算当前滚动到的区域 绘制背景，不重要，完全为了美观 
 */ 
private void drawBg() 
{ 
  mCanvas.drawColor(0xFFFFFFFF); 
  mCanvas.drawBitmap(mBgBitmap, null, new Rect(mPadding / 2, 
      mPadding / 2, getMeasuredWidth() - mPadding / 2, 
      getMeasuredWidth() - mPadding / 2), null); 
} 

</pre>
</div>
<p>这个比较简单，其实就是绘制一个棕色的圆盘，在运行代码前，你可以忽略掉，不影响。<br />
接下来一个for循环，且角度每次递增(360 / mItemCount);就是绘制每个盘块以及盘块上的字体和图标了。</p>
<p><strong>（2）绘制盘块</strong></p>
<div class="phpstudycode">
<pre class="brush:java;">
// 绘制快快 
          mArcPaint.setColor(mColors[i]); 
          mCanvas.drawArc(mRange, tmpAngle, sweepAngle, true, 
              mArcPaint); 

</pre>
</div>
<p>这个比较简单了~~</p>
<p><strong>（3）绘制文本</strong></p>
<div class="phpstudycode">
<pre class="brush:java;">
/** 
   * 绘制文本 
   * 
   * @param rect 
   * @param startAngle 
   * @param sweepAngle 
   * @param string 
   */ 
  private void drawText(float startAngle, float sweepAngle, String string) 
  { 
    Path path = new Path(); 
    path.addArc(mRange, startAngle, sweepAngle); 
    float textWidth = mTextPaint.measureText(string); 
    // 利用水平偏移让文字居中 
    float hOffset = (float) (mRadius * Math.PI / mItemCount / 2 - textWidth / 2);// 水平偏移 
    float vOffset = mRadius / 2 / 6;// 垂直偏移 
    mCanvas.drawTextOnPath(string, path, hOffset, vOffset, mTextPaint); 
  } 

</pre>
</div>
<p>利用Path，添加入一个Arc，然后设置水平和垂直的偏移量，垂直偏移量就是当前Arc朝着圆心移动的距离；水平偏移量，就是顺时针去旋转，<br />
我们偏移了 (mRadius * Math.PI / mItemCount / 2 - textWidth / 2);目的是为了文字居中。mRadius * Math.PI 是圆的周长；周长/ mItemCount / 2 是每个Arc的一半的长度；<br />
拿Arc一半的长度减去textWidth / 2，就把文字设置居中了。<br />
最后，用过path去绘制文本即可。<br />
凑合看个图：<br />
</p>
<p></p>
<p>本来字的位置在外围的横线处，我们希望到内部的横线位置，需要调节水平和垂直的偏移；水平和垂直的平移方向为绿色的箭头；大概就这样。</p>
<p><strong>（4）绘制图像</strong></p>
<div class="phpstudycode">
<pre class="brush:java;">
/** 
   * 绘制图片 
   * 
   * @param startAngle 
   * @param sweepAngle 
   * @param i 
   */ 
  private void drawIcon(float startAngle, int i) 
  { 
    // 设置图片的宽度为直径的1/8 
    int imgWidth = mRadius / 8; 
 
    float angle = (float) ((30 + startAngle) * (Math.PI / 180)); 
 
    int x = (int) (mCenter + mRadius / 2 / 2 * Math.cos(angle)); 
    int y = (int) (mCenter + mRadius / 2 / 2 * Math.sin(angle)); 
 
    // 确定绘制图片的位置 
    Rect rect = new Rect(x - imgWidth / 2, y - imgWidth / 2, x + imgWidth 
        / 2, y + imgWidth / 2); 
 
    mCanvas.drawBitmap(mImgsBitmap[i], null, rect, null); 
 
  } 

</pre>
</div>
<p>绘制图片主要就是图片的中心的确定，这里我们固定图片大小为直径的1/8；至于圆心的确定，看下图：<br />
我们需要图片的中心，为每个块块的中间：<br />
</p>
<p></p>
<p>我们希望图片在中间的那个点，点距离圆心即center的距离为r = mRadius /2 / 2 ;<br />
绿线与水平线的夹角为a = 360 / count / 2 ，本图为30 ；<br />
于是那个点的坐标为：(mCenter + r * cos a , mCenter + r * sina );<br />
其他的点同理，唯一变化就是a 的角度 ，在计算时需要把a转化为弧度制。<br />
&nbsp;集合图和上面的代码好好理解下。<br />
到此基本我们的圆盘就绘制好了。</p>
<p><strong>5.让圆盘先滚一会<br />
</strong>怎么让圆盘滚动呢？如果你足够细心，应该发现我们的draw里面有这么一句：<br />
</p>
<div class="phpstudycode">
<pre class="brush:java;">
mStartAngle += mSpeed;
</pre>
</div>
<p>其实每次draw都会让mStartAngle += mSpeed;看起来就是滚动了。<br />
那么滚动，其实就是去设置mSpeed即可。<br />
嗯，是的，如果单纯想滚动，只要去设置mSpeed就行了；但是，这样就行了么，就拿我们这个奖项来说，你敢1/6的概率拿到大奖么，你个IT公司让人抽到妹子一只咋办。<br />
所以我们还要来控制用户抽奖的概率，这里我们让用户中奖的产品在开始滚的时候就决定了。是不是玩转盘的时候很傻很天真，以为可以中大奖。</p>
<div class="phpstudycode">
<pre class="brush:java;">
/** 
   * 点击开始旋转 
   * 
   * @param luckyIndex 
   */ 
  public void luckyStart(int luckyIndex) 
  { 
    // 每项角度大小 
    float angle = (float) (360 / mItemCount); 
    // 中奖角度范围（因为指针向上，所以水平第一项旋转到指针指向，需要旋转210-270；） 
    float from = 270 - (luckyIndex + 1) * angle; 
    float to = from + angle; 
    // 停下来时旋转的距离 
    float targetFrom = 4 * 360 + from; 
    /** 
     * &lt;pre&gt; 
     * (v1 + 0) * (v1+1) / 2 = target ; 
     * v1*v1 + v1 - 2target = 0 ; 
     * v1=-1+(1*1 + 8 *1 * target)/2; 
     * &lt;/pre&gt; 
     */ 
    float v1 = (float) (Math.sqrt(1 * 1 + 8 * 1 * targetFrom) - 1) / 2; 
    float targetTo = 4 * 360 + to; 
    float v2 = (float) (Math.sqrt(1 * 1 + 8 * 1 * targetTo) - 1) / 2; 
 
    mSpeed = (float) (v1 + Math.random() * (v2 - v1)); 
    isShouldEnd = false; 
  } 

</pre>
</div>
<p>当外部调用luckyStart即可以旋转，index为停下来的位置，水平位置开始算，即0为相机，1为IPAD。<br />
这里又开始牵扯数学了：</p>
<div class="phpstudycode">
<pre class="brush:java;">
float from = 270 - (luckyIndex + 1) * angle; 
    float to = from + angle; 

</pre>
</div>
<p>这个from , to 比较简单，就是确定中将范围，比如我index=0，则只要转了210-270之间，我们的相机都会被垂直向上的指针指向。<br />
那么这个targetFrom是干嘛的，是决定你点击停止的时候转多长距离，这里我们设置为4圈多一点，这个多一点就是上面的from和to。<br />
最麻烦就是v1的计算了，既然我们希望决定停下里的位置，那么这个速度就是我们去计算出来的，怎么算呢？<br />
我们旋转的距离有了targetFrom，然后我们点击的时候mSpeed -= 1;也就是说速度是递减的，每次减去1。<br />
递减说明是个等差数列，等差数列的和是targetFrom。<br />
等差数列的求和公式大家记得否：（首项+末项）*（项数）/ 2<br />
我们的首项是v1 ，末项肯定是0 ， 项数 （v1/ 1 + 1）加个1为向上进一位。 <br />
那么式子就是： （v1 + 0 ) * (v1 / 1 +1) /2 = targetFrom ; 只有v1是未知数，一元二次方程的解，大家还记得否，不记得我来写 :</p>
<p>于是我们的v1就是v1=-1+(1*1 + 8 *1 * target)/2;<br />
好了，尼玛求出来v1，为啥我们代码还有个v2，这是因为v1停下来永远在某个块块的边界，我们屌丝又不傻，你每次停一个位置，都知道你造假。<br />
那么我们就求个v2，这个停下块块的最后位置。<br />
最后我们的速度为v1，v2间的一个随机数，也就是在某个块块中间任意位置。这样就可以让你觉得每次都在这个块块，但是指针位置还不同。<br />
好了，这里就是最复杂的地方了，如果你比较善良，不想内置这个功能，那就随便设置个速度吧。</p>
<p><strong>6.让圆盘停止滚动<br />
</strong>别忘了，我们5计算那么多，都是从水平那个距离为0开始计算的，于是我们的停止代码是这样的：</p>
<div class="phpstudycode">
<pre class="brush:java;">
public void luckyEnd() 
  { 
    mStartAngle = 0; 
    isShouldEnd = true; 
  } 

</pre>
</div>
<p>最后贴出我们的主布局文件和Activity</p>
<p><strong>7、布局文件和MainActivity</strong></p>
<div class="phpstudycode">
<pre class="brush:java;">
package com.zhy.demo_zhy_06_choujiangzhuanpan; 
 
import android.app.Activity; 
import android.os.Bundle; 
import android.view.View; 
import android.view.View.OnClickListener; 
import android.widget.ImageView; 
 
import com.zhy.view.LuckyPanView; 
 
public class MainActivity extends Activity 
{ 
  private LuckyPanView mLuckyPanView; 
  private ImageView mStartBtn; 
 
  @Override 
  protected void onCreate(Bundle savedInstanceState) 
  { 
    super.onCreate(savedInstanceState); 
    setContentView(R.layout.activity_main); 
 
    mLuckyPanView = (LuckyPanView) findViewById(R.id.id_luckypan); 
    mStartBtn = (ImageView) findViewById(R.id.id_start_btn); 
 
    mStartBtn.setOnClickListener(new OnClickListener() 
    { 
      @Override 
      public void onClick(View v) 
      { 
        if (!mLuckyPanView.isStart()) 
        { 
          mStartBtn.setImageResource(R.drawable.stop); 
          mLuckyPanView.luckyStart(1); 
        } else 
        { 
          if (!mLuckyPanView.isShouldEnd()) 
 
          { 
            mStartBtn.setImageResource(R.drawable.start); 
            mLuckyPanView.luckyEnd(); 
          } 
        } 
      } 
    }); 
  } 
 
} 

</pre>
</div>
<div class="phpstudycode">
<pre class="brush:xml;">
&lt;RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android" 
  xmlns:tools="http://schemas.android.com/tools" 
  android:layout_width="match_parent" 
  android:background="#ffffff" 
  android:layout_height="match_parent" &gt; 
 
  &lt;com.zhy.view.LuckyPanView 
    android:id="@+id/id_luckypan" 
    android:layout_width="fill_parent" 
    android:layout_height="fill_parent" 
    android:layout_centerInParent="true" 
    android:padding="30dp" /&gt; 
   
  &lt;ImageView  
    android:id="@+id/id_start_btn" 
    android:src="@drawable/start" 
    android:layout_centerInParent="true" 
    android:layout_width="wrap_content" 
    android:layout_height="wrap_content" 
    /&gt; 
 
 
&lt;/RelativeLayout&gt; 
</pre>
</div>
<p><br />
</p>
<p>终于写完了，数学把我这类渣渣计算的不行不行的。ps：抠图真恶心，爱歌撒时候给我传递些艺术的造诣和ps的技术呢。。。。<br />
好了，我们的按钮是用布局文件加上的，方便大家自己定制按钮~~~并且大家的奖项，颜色，以及图片可以自己定义，这个不用说了吧，修改count，以及那几个数组就行。<br />
</p>
<hr></span>                                     
		    	</div>
		    	<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>代码注释</div>
			    <div class="panel-content">
			    <span></span>                                     
		    	</div>

			</div>

			<!-- END ROW -->
			<div class="newsPage">
				<div class="newsPageTurn">
				    <span><a>上一篇</a><a href='/php/biji/84556.html'>iOS开发中使app获取本机通讯录的实现代码实例</a><a>下一篇</a><a href='/php/biji/84558.html'>Win10定义桌面背景上下有黑边问题的解决方法</a></span>
				</div>
			</div>
		</div>


<div id="author-box">
    <h3>作者：喵哥笔记</h3>
        <div class="author-info">
            <div class="author-avatar">
                <img src="/skin1/picture/01.jpg" alt="IDC笔记" class="avatar" width="64" height="64">
            </div>
        <div class="author-description">
            <p>学的不仅是技术，更是梦想！</p>
            <ul class="author-social follows nb">
            	<li>
                    <a target="_blank" href="/" title="IDC笔记">IDC笔记</a>
                </li>
            </ul>
        </div>
        <div class="clear"></div>
    </div>
</div>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
<!-- container-fluid -->
	</div>
<!-- content -->
	<footer class="footer">
	© 2020 IDC笔记 <i class="mdi mdi-heart text-danger"></i>. | 备案号：<a href="https://beian.miit.gov.cn/">辽ICP备18000516号</a>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?674585fbbd2294d3faf910f668ea91b4";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

	</footer>
</div>

</div>
<!-- END wrapper -->
<!-- jQuery  -->
<script src="/skin1/js/jquery.min.js"></script>
<script src="/skin1/js/bootstrap.bundle.min.js"></script>
<script src="/skin1/js/metismenu.min.js"></script>
<script src="/skin1/js/jquery.slimscroll.js"></script>
<script src="/skin1/js/waves.min.js"></script>
<!--Morris Chart-->
<script src="/skin1/js/morris.min.js"></script>
<script src="/skin1/js/raphael.min.js"></script>
<script src="/skin1/js/dashboard.init.js"></script>
<script src="/skin1/js/app.js"></script>
<script src="/foot.js"></script>
</body>
</html>