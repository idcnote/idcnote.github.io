<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <title>phpcms模块开发swfupload用法示例_PHP教程_IDC笔记</title>
    <meta name="keywords" content="PHP,PHP笔记,PHP教程" />
    <meta name="description" content="这篇文章主要为大家详细介绍了phpcms模块开发swfupload用法示例，具有一定的参考价值，可以用来参考一下。<br />
<br />
感兴趣的小伙伴，下面一起跟随php教程的小玲来看看吧！<br />
正式接触phpcms" />
    <meta content="Responsive admin theme build on top of Bootstrap 4" name="description" />
    <meta content="idcnote.com" name="author" />
    <link rel="shortcut icon" href="/skin1/images/favicon.ico">
    <!--Morris Chart CSS -->
    <link rel="stylesheet" href="/skin1/css/morris.css">
    <link href="/skin1/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/metismenu.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/icons.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/style.css" rel="stylesheet" type="text/css">
<link href="/SyntaxHighlighter/shCoreDefault.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">
 SyntaxHighlighter.all();
</script>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
</head>
<body>
<!-- Begin page -->
		<div id="wrapper">
			<!-- Top Bar Start -->
			<div class="topbar">
				<!-- LOGO -->
				<div class="topbar-left">
					<a href="/" class="logo">
						<span class="logo-light">
                            <i class="mdi mdi-camera-control"></i>IDC笔记
                        </span>
						<span class="logo-sm">
                            <i class="mdi mdi-camera-control"></i>
                        </span>
					</a>
				</div>
				<nav class="navbar-custom">
					<ul class="navbar-right list-inline float-right mb-0">
						<!--<li class="dropdown notification-list list-inline-item d-none d-md-inline-block">
							<a class="nav-link waves-effect" href="#" id="btn-fullscreen">
								<i class="mdi mdi-arrow-expand-all noti-icon"></i>
							</a>
						</li>
						<li class="dropdown notification-list list-inline-item">
							<div class="dropdown notification-list nav-pro-img">
								<a class="dropdown-toggle nav-link arrow-none nav-user" data-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
									<img src="/skin1/picture/user-4.jpg" alt="user" class="rounded-circle">
								</a>
								<div class="dropdown-menu dropdown-menu-right profile-dropdown ">
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-account-circle"></i> Profile</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-wallet"></i> Wallet</a>
									<a class="dropdown-item d-block" href="#">
										<span class="badge badge-success float-right">11</span>
										<i class="mdi mdi-settings"></i> Settings</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-lock-open-outline"></i> Lock screen</a>
									<div class="dropdown-divider"></div>
									<a class="dropdown-item text-danger" href="#">
										<i class="mdi mdi-power text-danger"></i> Logout</a>
								</div>
							</div>
						</li>
						-->
					</ul>
					<ul class="list-inline menu-left mb-0">
						<li class="float-left">
							<button class="button-menu-mobile open-left waves-effect">
                            <i class="mdi mdi-menu"></i>
                        </button>
						</li>
						<li class="d-none d-md-inline-block">
							<form role="search" class="app-search">
								<div class="form-group mb-0">
									<input type="text" class="form-control" placeholder="Search..">
									<button type="submit"><i class="fa fa-search"></i></button>
								</div>
							</form>
						</li>
					</ul>
				</nav>
			</div>
<!-- ========== Left Sidebar Start ========== -->
<div class="left side-menu">
    <div class="slimscroll-menu" id="remove-scroll">
    <!--- Sidemenu -->
    <div id="sidebar-menu">
    <!-- Left Menu Start -->
    <ul class="metismenu" id="side-menu">
			<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP简介			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/jianjie/1.html">PHP简介</a></li><li><a href="/php/jianjie/2.html">PHP用途</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP基本语法			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yufa/3.html">分离HTML</a></li><li><a href="/php/yufa/4.html">指令分隔符</a></li><li><a href="/php/yufa/5.html">PHP注释</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP类型			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpleixing/6.html">PHP类型简介</a></li><li><a href="/php/phpleixing/7.html">PHP类型之布尔类型</a></li><li><a href="/php/phpleixing/8.html">PHP类型之整型</a></li><li><a href="/php/phpleixing/9.html">PHP类型之浮点型</a></li><li><a href="/php/phpleixing/10.html">PHP类型之字符串</a></li><li><a href="/php/phpleixing/11.html">PHP类型之数组</a></li><li><a href="/php/phpleixing/12.html">PHP类型之对象</a></li><li><a href="/php/phpleixing/13.html">PHP类型之资源类型</a></li><li><a href="/php/phpleixing/14.html">PHP类型之NULL</a></li><li><a href="/php/phpleixing/15.html">PHP类型之伪类型</a></li><li><a href="/php/phpleixing/16.html">PHP类型之类型判别</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP变量			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpbianliang/17.html">PHP变量之基础</a></li><li><a href="/php/phpbianliang/18.html">PHP变量之预定义变量</a></li><li><a href="/php/phpbianliang/19.html">PHP变量之变量范围</a></li><li><a href="/php/phpbianliang/20.html">PHP变量之可变变量</a></li><li><a href="/php/phpbianliang/21.html">PHP变量之外部变量</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP运算符			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yunsuanfu/22.html">PHP运算符优先级</a></li><li><a href="/php/yunsuanfu/23.html">算术运算符</a></li><li><a href="/php/yunsuanfu/24.html">赋值运算符</a></li><li><a href="/php/yunsuanfu/25.html">位运算符</a></li><li><a href="/php/yunsuanfu/26.html">比较运算符</a></li><li><a href="/php/yunsuanfu/27.html">错误控制运算符</a></li><li><a href="/php/yunsuanfu/28.html">执行运算符</a></li><li><a href="/php/yunsuanfu/29.html">递增/递减运算符</a></li><li><a href="/php/yunsuanfu/30.html">逻辑运算符</a></li><li><a href="/php/yunsuanfu/31.html">字符串运算符</a></li><li><a href="/php/yunsuanfu/32.html">数组运算符</a></li><li><a href="/php/yunsuanfu/33.html">类型运算符</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP控制结构			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/jiegou/34.html">PHP控制结构之if</a></li><li><a href="/php/jiegou/35.html">PHP控制结构之else</a></li><li><a href="/php/jiegou/36.html">PHP控制结构之elseif/else if</a></li><li><a href="/php/jiegou/37.html">PHP控制结构之替代语法</a></li><li><a href="/php/jiegou/38.html">PHP控制结构之while</a></li><li><a href="/php/jiegou/39.html">PHP控制结构之do-while</a></li><li><a href="/php/jiegou/40.html">PHP控制结构之for</a></li><li><a href="/php/jiegou/41.html">PHP控制结构之foreach</a></li><li><a href="/php/jiegou/42.html">PHP控制结构之break</a></li><li><a href="/php/jiegou/43.html">PHP控制结构之continue</a></li><li><a href="/php/jiegou/44.html">PHP控制结构之switch</a></li><li><a href="/php/jiegou/45.html">PHP控制结构之declare</a></li><li><a href="/php/jiegou/46.html">PHP控制结构之return</a></li><li><a href="/php/jiegou/47.html">PHP控制结构之require</a></li><li><a href="/php/jiegou/48.html">PHP控制结构之include</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP函数			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/hanshu/52.html">用户自定义函数</a></li><li><a href="/php/hanshu/53.html">函数的参数</a></li><li><a href="/php/hanshu/54.html">返回值</a></li><li><a href="/php/hanshu/55.html">可变函数</a></li><li><a href="/php/hanshu/56.html">内部（内置）函数</a></li><li><a href="/php/hanshu/57.html">匿名函数</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP类与对象			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpduixiang/58.html">类与对象前言</a></li><li><a href="/php/phpduixiang/59.html">基本概念</a></li><li><a href="/php/phpduixiang/60.html">属性</a></li><li><a href="/php/phpduixiang/61.html">类常量</a></li><li><a href="/php/phpduixiang/62.html">自动加载对象</a></li><li><a href="/php/phpduixiang/63.html">构造函数和析构函数</a></li><li><a href="/php/phpduixiang/64.html">访问控制</a></li><li><a href="/php/phpduixiang/65.html">对象继承</a></li><li><a href="/php/phpduixiang/66.html">Static关键字</a></li><li><a href="/php/phpduixiang/67.html">抽象类</a></li><li><a href="/php/phpduixiang/68.html">接口</a></li><li><a href="/php/phpduixiang/69.html">Traits</a></li><li><a href="/php/phpduixiang/70.html">重载</a></li><li><a href="/php/phpduixiang/71.html">对象迭代</a></li><li><a href="/php/phpduixiang/72.html">设计模式</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP异常处理			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yichang/81.html">异常处理</a></li><li><a href="/php/yichang/82.html">扩展PHP内置的异常处理类</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP函数库按分类			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpku/83.html">数组</a></li><li><a href="/php/phpku/84.html">Classes/Objects</a></li><li><a href="/php/phpku/85.html">Date/Time</a></li><li><a href="/php/phpku/86.html">Directories</a></li><li><a href="/php/phpku/87.html">错误处理</a></li><li><a href="/php/phpku/88.html">Program execution</a></li><li><a href="/php/phpku/89.html">Filesystem</a></li><li><a href="/php/phpku/90.html">Filter</a></li><li><a href="/php/phpku/91.html">Function Handling</a></li><li><a href="/php/phpku/92.html">PHP 选项/信息</a></li><li><a href="/php/phpku/93.html">Mail</a></li><li><a href="/php/phpku/94.html">Math</a></li><li><a href="/php/phpku/95.html">Misc.</a></li><li><a href="/php/phpku/96.html">Network</a></li><li><a href="/php/phpku/97.html">输出控制</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> php基础			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpbiji/122.html"></a></li><li><a href="/php/phpbiji/123.html"></a></li><li><a href="/php/phpbiji/124.html"></a></li><li><a href="/php/phpbiji/125.html"></a></li><li><a href="/php/phpbiji/126.html"></a></li><li><a href="/php/phpbiji/127.html"></a></li><li><a href="/php/phpbiji/128.html"></a></li><li><a href="/php/phpbiji/129.html"></a></li><li><a href="/php/phpbiji/130.html"></a></li><li><a href="/php/phpbiji/108377.html"></a></li><li><a href="/php/phpbiji/108376.html"></a></li><li><a href="/php/phpbiji/108380.html"></a></li><li><a href="/php/phpbiji/108379.html"></a></li><li><a href="/php/phpbiji/108378.html"></a></li><li><a href="/php/phpbiji/108381.html"></a></li>		</ul>
	</li>
		<li>
	    <a href="/php/biji/" class="waves-effect">
		    <i class="icon-share"></i>
		    <span>PHP笔记
		       	<span class="float-right menu-arrow">
		       	<i class="mdi mdi-chevron-right"></i>
		       	</span>
		    </span>
	    </a>
	</li>
	</ul>
</div>
<!-- Sidebar -->
<div class="clearfix"></div>
</div>
<!-- Sidebar -left -->
</div>
<!-- Left Sidebar End -->
<!-- Start right Content here -->
<div class="content-page">
	<div class="content">
		<div class="container-fluid">
			<div class="page-title-box">
				<div class="row align-items-center">
					<div class="col-sm-6">
						<h1 class="page-title">phpcms模块开发swfupload用法示例</h1>
					</div>
				</div>
				<!-- end row -->
			</div>
			<!-- end page-title -->
			<!-- START ROW -->
			<div class="panel panel-forbid">
				<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>内容摘要</div>
			    <div class="panel-content">
			    <span>这篇文章主要为大家详细介绍了phpcms模块开发swfupload用法示例，具有一定的参考价值，可以用来参考一下。<br />
<br />
感兴趣的小伙伴，下面一起跟随php教程的小玲来看看吧！<br />
正式接触phpcms</span>                                     
		    	</div>
			    <div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>文章正文</div>
			    <div class="panel-content">
			    <span><p>这篇文章主要为大家详细介绍了phpcms模块开发swfupload用法示例，具有一定的参考价值，可以用来参考一下。</p>

<p>感兴趣的小伙伴，下面一起跟随php教程的小玲来看看吧！</p>
<p>正式接触phpcms模块开发后.开发了几个功能模块.其中遇到了需要批量上传图片的问题.于是开始挖掘phpcms里面的swfupload的用法.</p>
<p>在phpcms里面自带的内容类型里面能够直接指定图片组.不过这样的图片组功能并不是我想用的.我需要上传一整个静态的html文件.需要</p>
<p>能够找到一个方法上传整个文件夹.并且能够保留原来的文件名称.</p>
<p><strong>目的总结如下:</strong></p>
<p><strong>1,不改变系统的文件和目录结构.</strong></p>
<p><strong>2,实现多附件上传功能.</strong></p>
<p><strong>3,能够得到上传后的文件夹名称.</strong></p>
<p>在phpcms中自带了附件上传的功能.我想去用swfupload功能,而这个功能被phpcms的附件上传功能集成进去了.那我要做的就是抽出来并加以修改.</p>
<p><strong>第一步,我来研究研究这个是怎么调用的.</strong></p>
<p>首先,打开firefox浏览器的firebug 打开网络面板.找到phpcm中swfupload呗调出的那个按钮.看看系统是请求的什么连接.</p>
<p>代码如下:</p>
<pre>

<code>?m=attachment&amp;c=attachments&amp;a=swfupload&amp;args=10,,1&amp;module=&amp;catid=&amp;authkey=b756a93dea2e627293e88fa9d62af709&amp;pc_hash=iXFbo1
</code></pre>我们捕捉到一串这样的请求.调用了attachment模块的attachements控制器里面的swfupload方法.
<p></p>
<p>我们去找到这个模块中的这个控制器里面的这个方法.</p>
<p>在phpcms/modoules/attachemet/attachemts.php里面</p>
<p><strong>打开看看,代码如下</strong></p>
<p>代码如下:</p>
<pre>

<code>public function swfupload(){
        $grouplist = getcache('grouplist','member');
        if(isset($_POST['dosubmit'])){
　　　　　　//if里面的内容我们暂时不看.因为这是上传之后的处理.我们要先找到是如何引入swfupload的.
        } else {
            if($this-&gt;isadmin==0 &amp;&amp; !$grouplist[$this-&gt;groupid]['allowattachment']) showmessage(L('att_no_permission'));
            $args = $_GET['args'];//得到参数
            $authkey = $_GET['authkey'];//得到密匙
            if(upload_key($args) != $authkey) showmessage(L('attachment_parameter_error'));//验证密匙
            extract(getswfinit($_GET['args']));//拆分参数
            $siteid = $this-&gt;get_siteid();//得到网站id
            $site_setting = get_site_setting($siteid);//得到网站设置
            $file_size_limit = sizecount($site_setting['upload_maxsize']*1024);//允许上传大小
            $att_not_used = param::get_cookie('att_json');//得到未处理的文件列表
            if(empty($att_not_used) || !isset($att_not_used)) $tab_status = ' class="on"';//如果有未处理的设置标签样式为on
            if(!empty($att_not_used)) $div_status = ' hidden';//否则隐藏标签            
            $att = $this-&gt;att_not_used();//获取临时未处理文件列表
            include $this-&gt;admin_tpl('swfupload');//这个地方才是关键.加载了这个模板.
        }
    }
</code></pre>前面的我们就先不管了 ,那是处理上传的东西.我从else开始看.首先验证了是否允许附件上传
<p></p>
<p>然后从$_GET里面得到swfupload的参数args,然后去验证了密匙,密匙通过了去解析args.得到网站的id,得到网站的设置,得到允许上传附件的大小.从cookie里面得到未使用的附件列表.</p>
<p>设置模板里面的各种显示.最后也是最关键的.它使用了swfupload模板.也就是说我要找到这个模板.看看swfupload是怎么引过来的.</p>
<p>模板在这里:phpcms/modules/attachment/templates/swfupload.tpl.php</p>
<p>打开模板文件.模板文件上面引入了一堆文件:</p>
<p>代码如下:</p>
<pre>

<code>&lt;?php
/*   php教程 www.512Pic.com   */
 $show_header = $show_validator = $show_scroll = 1; include $this-&gt;admin_tpl('header', 'attachment');?&gt;
&lt;link href="&lt;?php
/*   php教程 www.512Pic.com   */
 echo JS_PATH?&gt;swfupload/swfupload.css" rel="stylesheet" type="text/css" /&gt;
&lt;script language="JavaScript" type="text/javascript" src="&lt;?php
/*   php教程 www.512Pic.com   */
 echo JS_PATH?&gt;swfupload/swfupload.js"&gt;&lt;/script&gt;
&lt;script language="JavaScript" type="text/javascript" src="&lt;?php
/*   php教程 www.512Pic.com   */
 echo JS_PATH?&gt;swfupload/fileprogress.js"&gt;&lt;/script&gt;
&lt;script language="JavaScript" type="text/javascript" src="&lt;?php
/*   php教程 www.512Pic.com   */
 echo JS_PATH?&gt;swfupload/handlers2.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript"&gt;
&lt;?php
/*   php教程 www.512Pic.com   */
 echo initupload($_GET['module'],$_GET['catid'],$args,$this-&gt;userid,$this-&gt;groupid,$this-&gt;isadmin)?&gt;
&lt;/script&gt;
</code></pre>首先是引入了头文件.我大概看里一下.里面有jquery什么的.是必要文件.所以一会我们要用的时候也要引入这个头.
<p></p>
<p>之后是swfupload的样式文件和必要的JS.这里调用了一个系统函数initupload,这个函数到底是干嘛的.</p>
<p>千万别小觑这行.整个swfupload的配置都在这里了.</p>
<p>我们去找找看这个函数.</p>
<p>在phpcms/modules/attachment/functions/golable.func.php里面找到了它的踪迹.代码如下,这个函数的主要作用就是配置swfupload这个插件.</p>
<p>代码如下:</p>
<pre>

<code>/* flash上传初始化
     * 初始化swfupload上传中需要的参数
     * @param $module 模块名称
     * @param $catid 栏目id
     * @param $args 传递参数
     * @param $userid 用户id
     * @param $groupid 用户组id
     * @param $isadmin 是否为管理员模式
     */
    function initupload($module, $catid,$args, $userid, $groupid = '8', $isadmin = '0'){
        $grouplist = getcache('grouplist','member');
        if($isadmin==0 &amp;&amp; !$grouplist[$groupid]['allowattachment']) return false;
        extract(getswfinit($args));
        $siteid = param::get_cookie('siteid');
        $site_setting = get_site_setting($siteid);
        $file_size_limit = $site_setting['upload_maxsize'];
        $sess_id = SYS_TIME;
        $swf_auth_key = md5(pc_base::load_config('system','auth_key').$sess_id);
        $init =  'var swfu = \'\';
        $(document).ready(function(){
        swfu = new SWFUpload({
            flash_url:"'.JS_PATH.'swfupload/swfupload.swf?"+Math.random(),
            upload_url:"'.APP_PATH.'index.php?m=attachment&amp;c=attachments&amp;a=swfupload&amp;dosubmit=1",
            file_post_name : "Filedata",
            post_params:{"SWFUPLOADSESSID":"'.$sess_id.'","module":"'.$module.'","catid":"'.$_GET['catid'].'","userid":"'.$userid.'","siteid":"'.$siteid.'","dosubmit":"1","thumb_width":"'.$thumb_width.'","thumb_height":"'.$thumb_height.'","watermark_enable":"'.$watermark_enable.'","filetype_post":"'.$file_types_post.'","swf_auth_key":"'.$swf_auth_key.'","isadmin":"'.$isadmin.'","groupid":"'.$groupid.'"},
            file_size_limit:"'.$file_size_limit.'",
            file_types:"'.$file_types.'",
            file_types_description:"All Files",
            file_upload_limit:"'.$file_upload_limit.'",
            custom_settings : {progressTarget : "fsUploadProgress",cancelButtonId : "btnCancel"},</code></pre>
<p></p><code> </code>
<p><code> button_image_url: &quot;&quot;, button_width: 75, button_height: 28, button_placeholder_id: &quot;buttonPlaceHolder&quot;, button_text_style: &quot;&quot;, button_text_top_padding: 3, button_text_left_padding: 12, button_window_mode: SWFUpload.WINDOW_MODE.TRANSPARENT, button_cursor: SWFUpload.CURSOR.HAND,</code></p><code> </code>
<p><code> file_dialog_start_handler : fileDialogStart, file_queued_handler : fileQueued, file_queue_error_handler:fileQueueError, file_dialog_complete_handler:fileDialogComplete, upload_progress_handler:uploadProgress, upload_error_handler:uploadError, upload_success_handler:uploadSuccess, upload_complete_handler:uploadComplete }); })&#39;; return $init; }</code></p>回到正题.我们来看模板swfupload.tpl.php
<p></p>
<p>这个模板使用了一个js来控制&lt;li&gt;以页签的形式显示.我们可以用firebug去找到带有我们要找到的swfupload按钮的那个页签的id</p>
<p>那个id是tab_swf_1</p>
<p><strong>这个是一个div 代码如下.</strong></p>
<p>代码如下:</p>
<pre>

<code>&lt;div id="div_swf_1" class="content pad-10 &lt;?php
/*   php教程 www.512Pic.com   */
 echo $div_status?&gt;"&gt;
            &lt;div&gt;
                &lt;div class="addnew" id="addnew"&gt;
                    &lt;span id="buttonPlaceHolder"&gt;&lt;/span&gt;
                &lt;/div&gt;
                &lt;input type="button" id="btupload" value="&lt;?php
/*   php教程 www.512Pic.com   */
 echo L('start_upload')?&gt;" onClick="swfu.startUpload();" /&gt;
                &lt;div id="nameTip" class="onShow"&gt;&lt;?php
/*   php教程 www.512Pic.com   */
 echo L('upload_up_to')?&gt;&lt;font color="red"&gt; &lt;?php
/*   php教程 www.512Pic.com   */
 echo $file_upload_limit?&gt;&lt;/font&gt; &lt;?php
/*   php教程 www.512Pic.com   */
 echo L('attachments')?&gt;,&lt;?php
/*   php教程 www.512Pic.com   */
 echo L('largest')?&gt; &lt;font color="red"&gt;&lt;?php
/*   php教程 www.512Pic.com   */
 echo $file_size_limit?&gt;&lt;/font&gt;&lt;/div&gt;
                &lt;div class="bk3"&gt;&lt;/div&gt;</code></pre>
<p></p><code> </code>
<p><code> &lt;div class=&quot;lh24&quot;&gt;&lt;?php /* php教程 www.512Pic.com */ echo L(&#39;supported&#39;)?&gt; &lt;font style=&quot;font-family: Arial, Helvetica, sans-serif&quot;&gt;&lt;?php /* php教程 www.512Pic.com */ echo str_replace(array(&#39;*.&#39;,&#39;;&#39;),array(&#39;&#39;,&#39;、&#39;),$file_types)?&gt;&lt;/font&gt; &lt;?php /* php教程 www.512Pic.com */ echo L(&#39;formats&#39;)?&gt;&lt;/div&gt;&lt;input type=&quot;checkbox&quot; id=&quot;watermark_enable&quot; value=&quot;1&quot; &lt;?php /* php教程 www.512Pic.com */ if(isset($watermark_enable) &amp;&amp;$watermark_enable == 1) echo &#39;checked&#39;?&gt; onclick=&quot;change_params()&quot;&gt; &lt;?php /* php教程 www.512Pic.com */ echo L(&#39;watermark_enable&#39;)?&gt; &lt;/div&gt; &lt;div class=&quot;bk10&quot;&gt;&lt;/div&gt; &lt;fieldset class=&quot;blue pad-10&quot; id=&quot;swfupload&quot;&gt; &lt;legend&gt;&lt;?php /* php教程 www.512Pic.com */ echo L(&#39;lists&#39;)?&gt;&lt;/legend&gt; &lt;ul class=&quot;attachment-list&quot; id=&quot;fsUploadProgress&quot;&gt; &lt;/ul&gt; &lt;/fieldset&gt; &lt;/div&gt;</code></p>在这里我们看到有一个span id是buttonPlaceHolder 而在配置文件中有这么一行button_placeholder_id: &quot;buttonPlaceHolder&quot;,很明显.当页面被加载的时候 id为buttonPlaceHolder的元素会被JS替换成swfupload的上传控件.
<p></p>
<p>之后一步我们要在点选完文件之后触发swf的上传方法</p>
<p>会在代码中找到如下代码.这里面调用了swfu.startUpload()方法.这个方法定义的地方在swfupload.js里面.我们无需理会.</p>
<p>代码如下:</p>
<pre>

<code>&lt;input type="button" id="btupload" value="&lt;?php
/*   php教程 www.512Pic.com   */
 echo L('start_upload')?&gt;" onClick="swfu.startUpload();" /&gt;
</code></pre><strong>至此.我们已经找到了swfupload的上传控件使用方法</strong>
<p></p>
<p>怎么在我的程序里面调用这个东东呢</p>
<p>首先一点 我们需要在这个控件出现的模板里面引入这些必要的文件</p>
<p>代码如下:</p>
<pre>

<code>&lt;link href="&lt;?php
/*   php教程 www.512Pic.com   */
 echo JS_PATH?&gt;swfupload/swfupload.css" rel="stylesheet" type="text/css" /&gt;
&lt;script language="JavaScript" type="text/javascript" src="&lt;?php
/*   php教程 www.512Pic.com   */
 echo JS_PATH?&gt;swfupload/swfupload.js"&gt;&lt;/script&gt;
&lt;script language="JavaScript" type="text/javascript" src="&lt;?php
/*   php教程 www.512Pic.com   */
 echo JS_PATH?&gt;swfupload/fileprogress.js"&gt;&lt;/script&gt;
&lt;script language="JavaScript" type="text/javascript" src="&lt;?php
/*   php教程 www.512Pic.com   */
 echo JS_PATH?&gt;swfupload/handlers2.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript"&gt;
&lt;?php
/*   php教程 www.512Pic.com   */
 echo initupload($_GET['module'],$_GET['catid'],$args,$this-&gt;userid,$this-&gt;groupid,$this-&gt;isadmin)?&gt;
&lt;/script&gt;
</code></pre><strong>代码如上所示.</strong>
<p></p>
<p>然后在我们的模板里面想要放置swfupload的地方写上这样的标签</p>
<p>代码如下:</p>
<pre>

<code>&lt;span id="buttonPlaceHolder"&gt;&lt;/span&gt;
&lt;input type="button" id="btupload" value="&lt;?php
/*   php教程 www.512Pic.com   */
 echo L('start_upload')?&gt;" onClick="swfu.startUpload();
</code></pre>这样我们就已经把swfupload引入到我们需要的地方了.接着就是能够正常执行上传等功能.
<p></p>
<p>但是这样还不能达到我们的需求.而且有一个问题.我们把文件上传到神马地方去了.那我们就来找找我们把文件上传到神马地方去了</p>
<p>在配置文件(用initupload函数输出的)里面有这样一行</p>
<p>代码如下:</p>
<pre>

<code>upload_url:"'.APP_PATH.'index.php?m=attachment&amp;c=attachments&amp;a=swfupload&amp;dosubmit=1",
</code></pre>这个很明显就透露出了我们把文件上传到了attachment模块中attachments控制器里面的swfupload方法去处理了
<p></p>
<p>这个地方也就是我之前没有关注的if里面的东西.</p>
<p>拿出来看看</p>
<p>代码如下:</p>
<pre>

<code>if( $_POST['swf_auth_key'] != md5(pc_base::load_config('system','auth_key').$_POST['SWFUPLOADSESSID']) || ($_POST['isadmin']==0 &amp;&amp; !$grouplist[$_POST['groupid']]['allowattachment'])) exit();
            pc_base::load_sys_class('attachment','',0);
            $attachment = new attachment($_POST['module'],$_POST['catid'],$_POST['siteid']);
            $attachment-&gt;set_userid($_POST['userid']);
            $aids = $attachment-&gt;upload('Filedata',$_POST['filetype_post'],'','',array($_POST['thumb_width'],$_POST['thumb_height']),$_POST['watermark_enable']);
            if($aids[0]) {
                $filename= (strtolower(CHARSET) != 'utf-8') ? iconv('gbk', 'utf-8', $attachment-&gt;uploadedfiles[0]['filename']) : $attachment-&gt;uploadedfiles[0]['filename'];
                if($attachment-&gt;uploadedfiles[0]['isimage']) {
                    echo $aids[0].','.$this-&gt;upload_url.$attachment-&gt;uploadedfiles[0]['filepath'].','.$attachment-&gt;uploadedfiles[0]['isimage'].','.$filename;
                } else {
                    $fileext = $attachment-&gt;uploadedfiles[0]['fileext'];
                    if($fileext == 'zip' || $fileext == 'rar') $fileext = 'rar';
                    elseif($fileext == 'doc' || $fileext == 'docx') $fileext = 'doc';
                    elseif($fileext == 'xls' || $fileext == 'xlsx') $fileext = 'xls';
                    elseif($fileext == 'ppt' || $fileext == 'pptx') $fileext = 'ppt';
                    elseif ($fileext == 'flv' || $fileext == 'swf' || $fileext == 'rm' || $fileext == 'rmvb') $fileext = 'flv';
                    else $fileext = 'do';
                    echo $aids[0].','.$this-&gt;upload_url.$attachment-&gt;uploadedfiles[0]['filepath'].','.$fileext.','.$filename;
                }
                exit;
            } else {
                echo '0,'.$attachment-&gt;error();
                exit;
</code></pre><strong>这个里面有几行是比较重要的.</strong>
<p></p>
<p>首先它载入了系统的attachment类.并且用到了里面的方法.</p>
<p>程序对上传成功做了echo操作.返回的东西是 返回了编号,上传后的地址,拓展名,文件名.</p>
<p>这些东西是给谁用的啊 我们还得回去看配置文件.</p>
<p>配置文件里面有一段是上传过程中各个事件将触发的方法. 有开始上传的.有上传成功的,有上传失败的.等等.</p>
<p>我们可以看见有一个方法是file_dialog_complete_handler:fileDialogComplete,</p>
<p>其实这些已经升级到swfupload的范畴了.有兴趣可以去研究研究</p>
<p>然后我们在phpcms/static/swfupload/handler.js里面找到这个方法.</p>
<p>看见上传成功后echo出来的数据被解析了.</p>
<p><strong>解析的方法如下</strong></p>
<p>代码如下:</p>
<pre>

<code>function att_show(serverData,file)
{
    var serverData = serverData.replace(/&lt;div.*?&lt;\/div&gt;/g,'');
    var data = serverData.split(',');
    var id = data[0];
    var src = data[1];
    var ext = data[2];
    var filename = data[3];
    if(id == 0) {
        alert(src)
        return false;
    }
    if(ext == 1) {
        var img = '&lt;a href="javascript:;" onclick="javascript:att_cancel(this,'+id+',\'upload\')" class="on"&gt;&lt;div class="icon"&gt;&lt;/div&gt;&lt;img src="'+src+'" width="80" imgid="'+id+'" path="'+src+'" title="'+filename+'"/&gt;&lt;/a&gt;';
    } else {
        var img = '&lt;a href="javascript:;" onclick="javascript:att_cancel(this,'+id+',\'upload\')" class="on"&gt;&lt;div class="icon"&gt;&lt;/div&gt;&lt;img src="statics/images/ext/'+ext+'.png" width="80" imgid="'+id+'" path="'+src+'" title="'+filename+'"/&gt;&lt;/a&gt;';
    }
    $.get('index.php?m=attachment&amp;c=attachments&amp;a=swfupload_json&amp;aid='+id+'&amp;src='+src+'&amp;filename='+filename);
    $('#fsUploadProgress').append('&lt;li&gt;&lt;div id="attachment_'+id+'" class="img-wrap"&gt;&lt;/div&gt;&lt;/li&gt;');
    $('#attachment_'+id).html(img);
    $('#att-status').append('|'+src);
    $('#att-name').append('|'+filename);
}
</code></pre>这个方法的目的是在id为fsuuploadprogress的元素里面添加我们上传成功的附件.但是我们还木有找到文件到底去哪里了
<p></p>
<p>关键的地方来了.我们在swfupload方法里面不是有个attachment的系统类的实例么</p>
<p>真正上传附件是在这里实现的.我们调用了attachment里面的upload方法来实现了文件的上传.</p>
<p>这个attachment文件里面的upload方法在系统类里面 也就是phpcms/libs/classes/attachment.class.php里面</p>
<p>在这个类里面我们可以找到upload方法里面有这样一行</p>
<p>代码如下:</p>
<pre>

<code>$this-&gt;savepath = $this-&gt;upload_root.$this-&gt;upload_dir.date('Y/md/');
</code></pre>这个自然就是指定了上传到的目录.文件名是通过getname方法来获取的.
<p></p>
<p><strong>到这里我们就理清思路了.</strong></p>
<p><strong>系统是这么运行的 </strong></p>
<p>首先在模板里面引用swfupload(配置文件是用函数生成的)-&gt;上传文件-&gt;attachment模块里的swfupload方法处理(使用系统的attachment类里面的upload方法循环上传附件.并返回结果给swfupload方法)-&gt;处理结果通过swfupload的方法(fileDialogComplete)返回给页面.</p>
<p>在上面我们已经实现了在模板里面引入swfupload.但是我们使用的配置文件和上传附件的方法等都是系统原来自带的.并不能实现我想要的目录结构和文件命名方法.怎么办..</p>
<p>改.</p>
<p>怎么改,首先们要把配置文件改掉. 在自己的模块里面的functions文件夹里面建立自己的函数.我们用自己的函数名称 文件命名为global.func.php这样系统会通过auto_load把我们的函数加载</p>
<p>进去我们把系统中attachment模块functions文件夹下面的global.func.php里面的initupload函数全盘拷贝进来.只修改其中的一行</p>
<p>代码如下:</p>
<pre>

<code>upload_url:"'.APP_PATH.'index.php?m=你的模块名称&amp;c=你的控制器名称&amp;a=你的方法名称&amp;dosubmit=1",
</code></pre>这样文件就会提交到我们的控制器下面.并且调用我们自己写的方法
<p></p>
<p>然后我们去改系统的attachment类 我们在自己的模块下的classes文件夹下面建立一个myattachment.class.php</p>
<p>写一个我们自己的类.去集成系统的attachment类.(记得吧里面的私有方法copy过来.)我们需要修改几行.首先一点是吧upload方法里面的上传目录改掉.然后是改掉文件名的命名方法.</p>
<p>代码如下:</p>
<pre>

<code>function upload($field, $alowexts = '', $maxsize = 0, $overwrite = 0,$thumb_setting = array(), $watermark_enable = 1) {
        if(!isset($_FILES[$field])) {
            $this-&gt;error = UPLOAD_ERR_OK;
            return false;
        }
        if(empty($alowexts) || $alowexts == '') {
            $site_setting = $this-&gt;_get_site_setting($this-&gt;siteid);
            $alowexts = $site_setting['upload_allowext'];
        }
        $fn = $_GET['CKEditorFuncNum'] ? $_GET['CKEditorFuncNum'] : '1';</code></pre>
<p></p><code> </code>
<p><code> $this-&gt;field = $field; $this-&gt;savepath = $this-&gt;upload_root.$this-&gt;upload_dir.date(&#39;Ymd&#39;);//这里我们需要修改下.也可以不修改.在我们实例化这个类的时候再来指定目录. $this-&gt;alowexts = $alowexts; $this-&gt;maxsize = $maxsize; $this-&gt;overwrite = $overwrite; $uploadfiles = array(); $description = isset($GLOBALS[$field.&#39;_description&#39;]) ? $GLOBALS[$field.&#39;_description&#39;] : array(); if(is_array($_FILES[$field][&#39;error&#39;])) { $this-&gt;uploads = count($_FILES[$field][&#39;error&#39;]); foreach($_FILES[$field][&#39;error&#39;] as $key =&gt; $error) { if($error === UPLOAD_ERR_NO_FILE) continue; if($error !== UPLOAD_ERR_OK) { $this-&gt;error = $error; return false; } $uploadfiles[$key] = array(&#39;tmp_name&#39; =&gt; $_FILES[$field][&#39;tmp_name&#39;][$key], &#39;name&#39; =&gt; $_FILES[$field][&#39;name&#39;][$key], &#39;type&#39; =&gt; $_FILES[$field][&#39;type&#39;][$key], &#39;size&#39; =&gt; $_FILES[$field][&#39;size&#39;][$key], &#39;error&#39; =&gt; $_FILES[$field][&#39;error&#39;][$key], &#39;description&#39;=&gt;$description[$key],&#39;fn&#39;=&gt;$fn); } } else { $this-&gt;uploads = 1; if(!$description) $description = &#39;&#39;; $uploadfiles[0] = array(&#39;tmp_name&#39; =&gt; $_FILES[$field][&#39;tmp_name&#39;], &#39;name&#39; =&gt; $_FILES[$field][&#39;name&#39;], &#39;type&#39; =&gt; $_FILES[$field][&#39;type&#39;], &#39;size&#39; =&gt; $_FILES[$field][&#39;size&#39;], &#39;error&#39; =&gt; $_FILES[$field][&#39;error&#39;], &#39;description&#39;=&gt;$description,&#39;fn&#39;=&gt;$fn); }</code></p><code> </code>
<p><code> if(!dir_create($this-&gt;savepath)) { $this-&gt;error = &#39;8&#39;; return false; } if(!is_dir($this-&gt;savepath)) { $this-&gt;error = &#39;8&#39;; return false; } @chmod($this-&gt;savepath, 0777);</code></p><code> </code>
<p><code> if(!is_writeable($this-&gt;savepath)) { $this-&gt;error = &#39;9&#39;; return false; } if(!$this-&gt;is_allow_upload()) { $this-&gt;error = &#39;13&#39;; return false; } $aids = array(); foreach($uploadfiles as $k=&gt;$file) { $fileext = fileext($file[&#39;name&#39;]); if($file[&#39;error&#39;] != 0) { $this-&gt;error = $file[&#39;error&#39;]; return false; } if(!preg_match(&quot;/^(&quot;.$this-&gt;alowexts.&quot;)$/&quot;, $fileext)) { $this-&gt;error = &#39;10&#39;; return false; } if($this-&gt;maxsize &amp;&amp; $file[&#39;size&#39;] &gt; $this-&gt;maxsize) { $this-&gt;error = &#39;11&#39;; return false; } if(!$this-&gt;isuploadedfile($file[&#39;tmp_name&#39;])) { $this-&gt;error = &#39;12&#39;; return false; } //$temp_filename = $this-&gt;getname($fileext);//名称在这里.我们需要修改下　　　　　　　$temp_filename = $file[&#39;tmp_name&#39;].$fileext; //修改成原来的系统文件名称.　　　　　　　$savefile = $this-&gt;savepath.$temp_filename; $savefile = preg_replace(&quot;/(php|phtml|php3|php4|jsp|exe|dll|asp|cer|asa|shtml|shtm|aspx|asax|cgi|fcgi|pl)(\.|$)/i&quot;, &quot;_\\1\\2&quot;, $savefile); $filepath = preg_replace(new_addslashes(&quot;|^&quot;.$this-&gt;upload_root.&quot;|&quot;), &quot;&quot;, $savefile); if(!$this-&gt;overwrite &amp;&amp; file_exists($savefile)) continue; $upload_func = $this-&gt;upload_func; if(@$upload_func($file[&#39;tmp_name&#39;], $savefile)) { $this-&gt;uploadeds++; @chmod($savefile, 0644); @unlink($file[&#39;tmp_name&#39;]); $file[&#39;name&#39;] = iconv(&quot;utf-8&quot;,CHARSET,$file[&#39;name&#39;]); $uploadedfile = array(&#39;filename&#39;=&gt;$file[&#39;name&#39;], &#39;filepath&#39;=&gt;$filepath, &#39;filesize&#39;=&gt;$file[&#39;size&#39;], &#39;fileext&#39;=&gt;$fileext, &#39;fn&#39;=&gt;$file[&#39;fn&#39;]); $thumb_enable = is_array($thumb_setting) &amp;&amp; ($thumb_setting[0] &gt; 0 || $thumb_setting[1] &gt; 0 ) ? 1 : 0; $image = new image($thumb_enable,$this-&gt;siteid); if($thumb_enable) { $image-&gt;thumb($savefile,&#39;&#39;,$thumb_setting[0],$thumb_setting[1]); } if($watermark_enable) { $image-&gt;watermark($savefile, $savefile); } $aids[] = $this-&gt;add($uploadedfile); } } return $aids; }</code></p>注:这里我们可以再系统的attachment模块下建立MY_attachment.php 但是这样会影响系统的附件上传功能.
<p></p>
<p><strong>在我们自己的控制器里面.我们这个时候就需要加载自己写的类了.</strong></p>
<p>代码如下:</p>
<pre>

<code>pc_base::load_app_class('你的模块名','',0);
</code></pre>其余的操作可以参照系统的attachment模块下的attachments控制器里面的swfupload方法来修改.
<p></p>
<p>至此.我便完成了我的目的.在不改变系统文件目录的基础上.完成我自己想要的文件上传功能.</p>

<p>注：关于phpcms模块开发swfupload用法示例的内容就先介绍到这里，更多相关文章的可以留意</span>                                     
		    	</div>
		    	<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>代码注释</div>
			    <div class="panel-content">
			    <span></span>                                     
		    	</div>

			</div>

			<!-- END ROW -->
			<div class="newsPage">
				<div class="newsPageTurn">
				    <span><a>上一篇</a><a href='/php/biji/110795.html'>PHP利用class中self,parent,this用法示例</a><a>下一篇</a><a href='/php/biji/110809.html'>解决php选择排序的问题</a></span>
				</div>
			</div>
		</div>


<div id="author-box">
    <h3>作者：喵哥笔记</h3>
        <div class="author-info">
            <div class="author-avatar">
                <img src="/skin1/picture/01.jpg" alt="IDC笔记" class="avatar" width="64" height="64">
            </div>
        <div class="author-description">
            <p>学的不仅是技术，更是梦想！</p>
            <ul class="author-social follows nb">
            	<li>
                    <a target="_blank" href="/" title="IDC笔记">IDC笔记</a>
                </li>
            </ul>
        </div>
        <div class="clear"></div>
    </div>
</div>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
<!-- container-fluid -->
	</div>
<!-- content -->
	<footer class="footer">
	© 2020 IDC笔记 <i class="mdi mdi-heart text-danger"></i>. | 备案号：<a href="https://beian.miit.gov.cn/">辽ICP备18000516号</a>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?674585fbbd2294d3faf910f668ea91b4";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

	</footer>
</div>

</div>
<!-- END wrapper -->
<!-- jQuery  -->
<script src="/skin1/js/jquery.min.js"></script>
<script src="/skin1/js/bootstrap.bundle.min.js"></script>
<script src="/skin1/js/metismenu.min.js"></script>
<script src="/skin1/js/jquery.slimscroll.js"></script>
<script src="/skin1/js/waves.min.js"></script>
<!--Morris Chart-->
<script src="/skin1/js/morris.min.js"></script>
<script src="/skin1/js/raphael.min.js"></script>
<script src="/skin1/js/dashboard.init.js"></script>
<script src="/skin1/js/app.js"></script>
<script src="/foot.js"></script>
</body>
</html>