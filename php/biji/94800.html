<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <title>在ASP.NET 2.0中操作数据之六十四：GridView批量添加数据_PHP教程_IDC笔记</title>
    <meta name="keywords" content="PHP,PHP笔记,PHP教程" />
    <meta name="description" content="导言：<br />
　　在前面的第62章《GridView批量更新数据》里，我们用GridView控件里定制了一个批编辑界面，同样的我们也可以定制一个批添加界面.假设有这种情况，我们接受一批从Tokyo(东" />
    <meta content="Responsive admin theme build on top of Bootstrap 4" name="description" />
    <meta content="idcnote.com" name="author" />
    <link rel="shortcut icon" href="/skin1/images/favicon.ico">
    <!--Morris Chart CSS -->
    <link rel="stylesheet" href="/skin1/css/morris.css">
    <link href="/skin1/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/metismenu.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/icons.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/style.css" rel="stylesheet" type="text/css">
<link href="/SyntaxHighlighter/shCoreDefault.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">
 SyntaxHighlighter.all();
</script>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
</head>
<body>
<!-- Begin page -->
		<div id="wrapper">
			<!-- Top Bar Start -->
			<div class="topbar">
				<!-- LOGO -->
				<div class="topbar-left">
					<a href="/" class="logo">
						<span class="logo-light">
                            <i class="mdi mdi-camera-control"></i>IDC笔记
                        </span>
						<span class="logo-sm">
                            <i class="mdi mdi-camera-control"></i>
                        </span>
					</a>
				</div>
				<nav class="navbar-custom">
					<ul class="navbar-right list-inline float-right mb-0">
						<!--<li class="dropdown notification-list list-inline-item d-none d-md-inline-block">
							<a class="nav-link waves-effect" href="#" id="btn-fullscreen">
								<i class="mdi mdi-arrow-expand-all noti-icon"></i>
							</a>
						</li>
						<li class="dropdown notification-list list-inline-item">
							<div class="dropdown notification-list nav-pro-img">
								<a class="dropdown-toggle nav-link arrow-none nav-user" data-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
									<img src="/skin1/picture/user-4.jpg" alt="user" class="rounded-circle">
								</a>
								<div class="dropdown-menu dropdown-menu-right profile-dropdown ">
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-account-circle"></i> Profile</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-wallet"></i> Wallet</a>
									<a class="dropdown-item d-block" href="#">
										<span class="badge badge-success float-right">11</span>
										<i class="mdi mdi-settings"></i> Settings</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-lock-open-outline"></i> Lock screen</a>
									<div class="dropdown-divider"></div>
									<a class="dropdown-item text-danger" href="#">
										<i class="mdi mdi-power text-danger"></i> Logout</a>
								</div>
							</div>
						</li>
						-->
					</ul>
					<ul class="list-inline menu-left mb-0">
						<li class="float-left">
							<button class="button-menu-mobile open-left waves-effect">
                            <i class="mdi mdi-menu"></i>
                        </button>
						</li>
						<li class="d-none d-md-inline-block">
							<form role="search" class="app-search">
								<div class="form-group mb-0">
									<input type="text" class="form-control" placeholder="Search..">
									<button type="submit"><i class="fa fa-search"></i></button>
								</div>
							</form>
						</li>
					</ul>
				</nav>
			</div>
<!-- ========== Left Sidebar Start ========== -->
<div class="left side-menu">
    <div class="slimscroll-menu" id="remove-scroll">
    <!--- Sidemenu -->
    <div id="sidebar-menu">
    <!-- Left Menu Start -->
    <ul class="metismenu" id="side-menu">
			<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP简介			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/jianjie/1.html">PHP简介</a></li><li><a href="/php/jianjie/2.html">PHP用途</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP基本语法			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yufa/3.html">分离HTML</a></li><li><a href="/php/yufa/4.html">指令分隔符</a></li><li><a href="/php/yufa/5.html">PHP注释</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP类型			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpleixing/6.html">PHP类型简介</a></li><li><a href="/php/phpleixing/7.html">PHP类型之布尔类型</a></li><li><a href="/php/phpleixing/8.html">PHP类型之整型</a></li><li><a href="/php/phpleixing/9.html">PHP类型之浮点型</a></li><li><a href="/php/phpleixing/10.html">PHP类型之字符串</a></li><li><a href="/php/phpleixing/11.html">PHP类型之数组</a></li><li><a href="/php/phpleixing/12.html">PHP类型之对象</a></li><li><a href="/php/phpleixing/13.html">PHP类型之资源类型</a></li><li><a href="/php/phpleixing/14.html">PHP类型之NULL</a></li><li><a href="/php/phpleixing/15.html">PHP类型之伪类型</a></li><li><a href="/php/phpleixing/16.html">PHP类型之类型判别</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP变量			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpbianliang/17.html">PHP变量之基础</a></li><li><a href="/php/phpbianliang/18.html">PHP变量之预定义变量</a></li><li><a href="/php/phpbianliang/19.html">PHP变量之变量范围</a></li><li><a href="/php/phpbianliang/20.html">PHP变量之可变变量</a></li><li><a href="/php/phpbianliang/21.html">PHP变量之外部变量</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP运算符			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yunsuanfu/22.html">PHP运算符优先级</a></li><li><a href="/php/yunsuanfu/23.html">算术运算符</a></li><li><a href="/php/yunsuanfu/24.html">赋值运算符</a></li><li><a href="/php/yunsuanfu/25.html">位运算符</a></li><li><a href="/php/yunsuanfu/26.html">比较运算符</a></li><li><a href="/php/yunsuanfu/27.html">错误控制运算符</a></li><li><a href="/php/yunsuanfu/28.html">执行运算符</a></li><li><a href="/php/yunsuanfu/29.html">递增/递减运算符</a></li><li><a href="/php/yunsuanfu/30.html">逻辑运算符</a></li><li><a href="/php/yunsuanfu/31.html">字符串运算符</a></li><li><a href="/php/yunsuanfu/32.html">数组运算符</a></li><li><a href="/php/yunsuanfu/33.html">类型运算符</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP控制结构			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/jiegou/34.html">PHP控制结构之if</a></li><li><a href="/php/jiegou/35.html">PHP控制结构之else</a></li><li><a href="/php/jiegou/36.html">PHP控制结构之elseif/else if</a></li><li><a href="/php/jiegou/37.html">PHP控制结构之替代语法</a></li><li><a href="/php/jiegou/38.html">PHP控制结构之while</a></li><li><a href="/php/jiegou/39.html">PHP控制结构之do-while</a></li><li><a href="/php/jiegou/40.html">PHP控制结构之for</a></li><li><a href="/php/jiegou/41.html">PHP控制结构之foreach</a></li><li><a href="/php/jiegou/42.html">PHP控制结构之break</a></li><li><a href="/php/jiegou/43.html">PHP控制结构之continue</a></li><li><a href="/php/jiegou/44.html">PHP控制结构之switch</a></li><li><a href="/php/jiegou/45.html">PHP控制结构之declare</a></li><li><a href="/php/jiegou/46.html">PHP控制结构之return</a></li><li><a href="/php/jiegou/47.html">PHP控制结构之require</a></li><li><a href="/php/jiegou/48.html">PHP控制结构之include</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP函数			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/hanshu/52.html">用户自定义函数</a></li><li><a href="/php/hanshu/53.html">函数的参数</a></li><li><a href="/php/hanshu/54.html">返回值</a></li><li><a href="/php/hanshu/55.html">可变函数</a></li><li><a href="/php/hanshu/56.html">内部（内置）函数</a></li><li><a href="/php/hanshu/57.html">匿名函数</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP类与对象			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpduixiang/58.html">类与对象前言</a></li><li><a href="/php/phpduixiang/59.html">基本概念</a></li><li><a href="/php/phpduixiang/60.html">属性</a></li><li><a href="/php/phpduixiang/61.html">类常量</a></li><li><a href="/php/phpduixiang/62.html">自动加载对象</a></li><li><a href="/php/phpduixiang/63.html">构造函数和析构函数</a></li><li><a href="/php/phpduixiang/64.html">访问控制</a></li><li><a href="/php/phpduixiang/65.html">对象继承</a></li><li><a href="/php/phpduixiang/66.html">Static关键字</a></li><li><a href="/php/phpduixiang/67.html">抽象类</a></li><li><a href="/php/phpduixiang/68.html">接口</a></li><li><a href="/php/phpduixiang/69.html">Traits</a></li><li><a href="/php/phpduixiang/70.html">重载</a></li><li><a href="/php/phpduixiang/71.html">对象迭代</a></li><li><a href="/php/phpduixiang/72.html">设计模式</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP异常处理			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yichang/81.html">异常处理</a></li><li><a href="/php/yichang/82.html">扩展PHP内置的异常处理类</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP函数库按分类			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpku/83.html">数组</a></li><li><a href="/php/phpku/84.html">Classes/Objects</a></li><li><a href="/php/phpku/85.html">Date/Time</a></li><li><a href="/php/phpku/86.html">Directories</a></li><li><a href="/php/phpku/87.html">错误处理</a></li><li><a href="/php/phpku/88.html">Program execution</a></li><li><a href="/php/phpku/89.html">Filesystem</a></li><li><a href="/php/phpku/90.html">Filter</a></li><li><a href="/php/phpku/91.html">Function Handling</a></li><li><a href="/php/phpku/92.html">PHP 选项/信息</a></li><li><a href="/php/phpku/93.html">Mail</a></li><li><a href="/php/phpku/94.html">Math</a></li><li><a href="/php/phpku/95.html">Misc.</a></li><li><a href="/php/phpku/96.html">Network</a></li><li><a href="/php/phpku/97.html">输出控制</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> php基础			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpbiji/108377.html"></a></li><li><a href="/php/phpbiji/108376.html"></a></li><li><a href="/php/phpbiji/108380.html"></a></li><li><a href="/php/phpbiji/108379.html"></a></li><li><a href="/php/phpbiji/108378.html"></a></li><li><a href="/php/phpbiji/108381.html"></a></li><li><a href="/php/phpbiji/108382.html"></a></li><li><a href="/php/phpbiji/108384.html"></a></li><li><a href="/php/phpbiji/108383.html"></a></li><li><a href="/php/phpbiji/108385.html"></a></li><li><a href="/php/phpbiji/108386.html"></a></li><li><a href="/php/phpbiji/108388.html"></a></li><li><a href="/php/phpbiji/108387.html"></a></li><li><a href="/php/phpbiji/108389.html"></a></li><li><a href="/php/phpbiji/108391.html"></a></li>		</ul>
	</li>
		<li>
	    <a href="/php/biji/" class="waves-effect">
		    <i class="icon-share"></i>
		    <span>PHP笔记
		       	<span class="float-right menu-arrow">
		       	<i class="mdi mdi-chevron-right"></i>
		       	</span>
		    </span>
	    </a>
	</li>
	</ul>
</div>
<!-- Sidebar -->
<div class="clearfix"></div>
</div>
<!-- Sidebar -left -->
</div>
<!-- Left Sidebar End -->
<!-- Start right Content here -->
<div class="content-page">
	<div class="content">
		<div class="container-fluid">
			<div class="page-title-box">
				<div class="row align-items-center">
					<div class="col-sm-6">
						<h1 class="page-title">在ASP.NET 2.0中操作数据之六十四：GridView批量添加数据</h1>
					</div>
				</div>
				<!-- end row -->
			</div>
			<!-- end page-title -->
			<!-- START ROW -->
			<div class="panel panel-forbid">
				<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>内容摘要</div>
			    <div class="panel-content">
			    <span>导言：<br />
　　在前面的第62章《GridView批量更新数据》里，我们用GridView控件里定制了一个批编辑界面，同样的我们也可以定制一个批添加界面.假设有这种情况，我们接受一批从Tokyo(东</span>                                     
		    	</div>
			    <div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>文章正文</div>
			    <div class="panel-content">
			    <span><p><strong>导言：</strong></p>
<p>　　在前面的第62章《GridView批量更新数据》里，我们用GridView控件里定制了一个批编辑界面，同样的我们也可以定制一个批添加界面.假设有这种情况，我们接受一批从Tokyo(东京)发过来的货物：6种不同的tea 和 coffee，如果用户在一个DetailsView控件里一次输入一个产品，他将会重复的输入很多相同的值，比如相同的种类(Beverages),相同的供应商(Tokyo Traders),相同的discontinued值(False),以及相同的order值(0).重复性的输入这些相同的值不仅累，还很容易出错.只需额外多做一些工作，我们就可以创建一个批添加界面。用户只需一次行的选择supplier 和category，输入一系列产品的names 和unit prices，再点击一个按钮就可以将这些新产品添加进数据库(如图1所示).这些添加的产品的ProductName 和UnitPrice数据由界面上方的2个DropDownList控件指定，Discontinued 和UnitsOnOrder的值由“硬编辑”指定，分别为false和0.</p>
<p><br />
<strong>图1：批添加界面</strong></p>
<p><br />
本教程，我们将创建一个如图1所示的批添加界面。在前面2章的基础上我们将把添加过程用事务封装以保证原子操作.让我们开始吧！</p>
<p><strong>第一步：创建一个展示界面</strong></p>
<p>　　我们将创建一个包含2个区域的单一页面：展示区域和添加区域.我们在这一步创建的是展示区域，它包含一个用于展示产品的GridView控件以及一个标题为“Process Product Shipment”的button按钮.当点击该按钮时，展示界面将替换为一个如图1所示的添加界面.如果点“Add Products from Shipment” 或 “Cancel”按钮时又会返回展示页面.添加界面将在第二步完成.</p>
<p>　　这个包含2个界面的页面每次只能让一个界面可见。我们将用2个Panel Web控件作为容器包含这2个界面——一个Panel Web控件包含一个界面.</p>
<p>　　首先打开BatchData文件夹里的BatchInsert.aspx页面，在设计器模式里从工具箱里拖一个Panel控件到页面(如图2所示)，设置其ID为DisplayInterface.当将Panel控件拖到页面时其Height 和 Width属性分别为50px 和 125px.在属性窗口里清除这些属性.</p>
<p><br />
<strong>图2：从工具箱里拖一个Panel控件到页面</strong></p>
<p>　　然后拖一个Button 和 GridView控件到Panel控件里。设Button的ID为ProcessShipment ，Text属性为“Process Product Shipment”.&nbsp; 设GridView的ID为ProductsGrid，从其智能标签里将其绑定到一个名为ProductsDataSource的ObjectDataSource.设置该ObjectDataSource调用ProductsBLL class类的GetProducts方法.由于该GridView控件只用来展示数据，从UPDATE, INSERT, DELETE标签里选“(None)”. 点Finish完成设置</p>
<p><br />
<strong>图3：调用ProductsBLL Class类的GetProducts方法来显示数据</strong></p>
<p><br />
<strong>图4：在UPDATE, INSERT, DELETE标签里选“(None)”</strong></p>
<p>　　完成ObjectDataSource设置后，Visual Studio会自动地添加一些BoundFields以及一个CheckBoxField。只保留ProductName, CategoryName, SupplierName, UnitPrice, 以及Discontinued这几列.你可以再做一些外观的改进.我将UnitPrice列定制为货币值，重新对列进行了排序，再对一些列的HeaderText值进行了修改.再在GridView的智能标签里启用了“分页”和“排序”功能.完成上述工作后，页面的声明代码看起来应该和下面的差不多：</p>
<div class="phpstudycode">
<pre class="brush:csharp;">
&lt;asp:Panel ID="DisplayInterface" runat="server"&gt;
 &lt;p&gt;
 &lt;asp:Button ID="ProcessShipment" runat="server"
  Text="Process Product Shipment" /&gt;
 &lt;/p&gt;
 &lt;asp:GridView ID="ProductsGrid" runat="server" AllowPaging="True"
 AllowSorting="True" AutoGenerateColumns="False"
 DataKeyNames="ProductID" DataSourceID="ProductsDataSource"&gt;
 &lt;Columns&gt;
  &lt;asp:BoundField DataField="ProductName" HeaderText="Product"
  SortExpression="ProductName" /&gt;
  &lt;asp:BoundField DataField="CategoryName" HeaderText="Category"
  ReadOnly="True" SortExpression="CategoryName" /&gt;
  &lt;asp:BoundField DataField="SupplierName" HeaderText="Supplier"
  ReadOnly="True" SortExpression="SupplierName" /&gt;
  &lt;asp:BoundField DataField="UnitPrice" DataFormatString="{0:c}"
  HeaderText="Price" HtmlEncode="False"
  SortExpression="UnitPrice"&gt;
  &lt;ItemStyle HorizontalAlign="Right" /&gt;
  &lt;/asp:BoundField&gt;
  &lt;asp:CheckBoxField DataField="Discontinued" HeaderText="Discontinued"
  SortExpression="Discontinued"&gt;
  &lt;ItemStyle HorizontalAlign="Center" /&gt;
  &lt;/asp:CheckBoxField&gt;
 &lt;/Columns&gt;
 &lt;/asp:GridView&gt;
 &lt;asp:ObjectDataSource ID="ProductsDataSource" runat="server"
 OldValuesParameterFormatString="original_{0}"
 SelectMethod="GetProducts" TypeName="ProductsBLL"&gt;
 &lt;/asp:ObjectDataSource&gt;
&lt;/asp:Panel&gt;

</pre>
</div>
<p>　　我们注意到Button 和 GridView控件的声明代码出现在&lt;asp:Panel&gt;标签内部，因为这些控件置于名为DisplayInterface的Panel控件里面，我们可以将Panel控件的Visible 属性设置为false来隐藏这些控件.我们将在第三步看到，当点击一个按钮时，通过编程的方式改变Panel控件的Visible属性以显示添加界面.</p>
<p>　　花点时间在浏览器里登录该页面.如图5所示，你将看到一个显示为“Process Product Shipment”的button按钮，其下的GridView控件每次列出10个产品.</p>
<p><br />
<strong>图5：GridView列出了产品并启用排序和分页功能</strong></p>
<p><strong>第二步：创建添加界面</strong></p>
<p>　　创建完展示界面后，我们将创建添加界面。在本教程，我们的添加界面允许用户同时添加5个产品，且这5个产品的category 和 supplier是一样的，而names 和 nit price值不同.在ID为DisplayInterface的Panel控件下面，从工具箱里拖一个Panel控件到页面，设置其ID为InsertingInterface，Visible属性为false，并清除其Height 和 Width属性值。我们将在第三步添加代码将其Visible属性改为true.</p>
<p>　　接下来我们将创建如图1所示的添加界面。该界面本来可以通过一些HTML技术来创建的，不过在这里我们将使用一个很简单的4列7行的table表.</p>
<p>　　注意：虽然在设计器模式里可以使用工具箱的工具来添加&lt;table&gt; elements元素，不过那样会自动添加一些我们不需要的style属性设置.因此，我更偏向于在源视图模式里添加HTML &lt;table&gt; elements元素. 当写好类&lt;table&gt;声明代码后，我喜欢立即切换到设计器模式，再添加Web控件并设置其属性。当心中有数，已经想好了要创建几行几列的时候，我倾向于使用静态HTML(static HTML)而不是Table Web控件，原因是如果使用Table Web控件的话，我们必须通过FindControl("controlID")的方式来访问放置在里面的的Web控件.不过话又说回来，如果是要创建一个动态变化的表(dynamically-sized tables)的话——比如该表的行和列都绑定到数据库或者基于用户自定义的标准格式，我还是要使用Table Web控件，原因很简单，我们可以通过编程来创建该Table Web控件.</p>
<p>在ID为InsertingInterface的Panel控件的&lt;asp:Panel&gt;标签里输入如下的声明代码:</p>
<div class="phpstudycode">
<pre class="brush:xhtml;">
&lt;table class="DataWebControlStyle" cellspacing="0"&gt;
 &lt;tr class="BatchInsertHeaderRow"&gt;
 &lt;td class="BatchInsertLabel"&gt;Supplier:&lt;/td&gt;
 &lt;td&gt;&lt;/td&gt;
 &lt;td class="BatchInsertLabel"&gt;Category:&lt;/td&gt;
 &lt;td&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr class="BatchInsertRow"&gt;
 &lt;td class="BatchInsertLabel"&gt;Product:&lt;/td&gt;
 &lt;td&gt;&lt;/td&gt;
 &lt;td class="BatchInsertLabel"&gt;Price:&lt;/td&gt;
 &lt;td&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr class="BatchInsertAlternatingRow"&gt;
 &lt;td class="BatchInsertLabel"&gt;Product:&lt;/td&gt;
 &lt;td&gt;&lt;/td&gt;
 &lt;td class="BatchInsertLabel"&gt;Price:&lt;/td&gt;
 &lt;td&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr class="BatchInsertRow"&gt;
 &lt;td class="BatchInsertLabel"&gt;Product:&lt;/td&gt;
 &lt;td&gt;&lt;/td&gt;
 &lt;td class="BatchInsertLabel"&gt;Price:&lt;/td&gt;
 &lt;td&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr class="BatchInsertAlternatingRow"&gt;
 &lt;td class="BatchInsertLabel"&gt;Product:&lt;/td&gt;
 &lt;td&gt;&lt;/td&gt;
 &lt;td class="BatchInsertLabel"&gt;Price:&lt;/td&gt;
 &lt;td&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr class="BatchInsertRow"&gt;
 &lt;td class="BatchInsertLabel"&gt;Product:&lt;/td&gt;
 &lt;td&gt;&lt;/td&gt;
 &lt;td class="BatchInsertLabel"&gt;Price:&lt;/td&gt;
 &lt;td&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr class="BatchInsertFooterRow"&gt;
 &lt;td colspan="4"&gt;
 &lt;/td&gt;
 &lt;/tr&gt;
&lt;/table&gt;

</pre>
</div>
<p>　　该&lt;table&gt;声明代码里暂时还未包含任何的Web控件。我们注意到每一个&lt;tr&gt; element元素都有明确的CSS class设置：放置名为supplier 和category的DropDownLists控件的“头顶行”对应的是BatchInsertHeaderRow；放置“Add Products from Shipment” 和“Cancel”按钮的“底部行”对应的是BatchInsertFooterRow；那些包含product和unit price的TextBox控件的行交替的运用BatchInsertRow和BatchInsertAlternatingRow.我已经在Styles.css文件里创建里相应的CSS classes，代码如下：</p>
<div class="phpstudycode">
<pre class="brush:css;">
/*** Styles for ~/BatchData/BatchInsert.aspx tutorial ***/
.BatchInsertLabel
{
 font-weight: bold;
 text-align: right;
}

.BatchInsertHeaderRow td
{
 color: White;
 background-color: #900;
 padding: 11px;
}

.BatchInsertFooterRow td
{
 text-align: center;
 padding-top: 5px;
}

.BatchInsertRow
{
}

.BatchInsertAlternatingRow
{
 background-color: #fcc;
}

</pre>
</div>
<p>输入这些代码后，切换到设计视图，该&lt;table&gt;看起来是一个4列7行的表，如图6所示：</p>
<p><br />
<strong>图6：添加界面为一个4列7行的表</strong></p>
<p>　　现在我们在添加界面里添加Web控件.从工具箱拖2个DropDownList到表的相应方格里——一个用来显示supplier另一个用来显示category.</p>
<p>　　将用来显示supplier的那个DropDownList的ID设为Suppliers，并将其绑定到一个名为SuppliersDataSource的ObjectDataSource.设置该ObjectDataSource调用SuppliersBLL class类的GetSuppliers方法.并在UPDATE标签里选“(None)”，点击Finish完成设置向导.</p>
<p><br />
<strong>图7：设置ObjectDataSource调用SuppliersBLL Class类的GetSuppliers方法</strong></p>
<p>设置该DropDownList显示CompanyName列，而传递的值为SupplierID列.</p>
<p><br />
<strong>图8：显示CompanyName列，传递的是SupplierID列的值</strong></p>
<p>　　将第2个DropDownList的ID设为Categories，并将其绑定到一个名为CategoriesDataSource的ObjectDataSource.该ObjectDataSource调用CategoriesBLL class类的GetCategories方法. 在UPDATE标签里选“(None)”，再点Finish完成设置. 最后设置该DropDownList控件显示CategoryName列，传递CategoryID列的值.</p>
<p>当添加这2个DropDownList控件并绑定到相应的ObjectDataSources后，你的屏幕看起来应该和图9差不多：</p>
<p><br />
<strong>图9：“头部行”包含显示Suppliers和Categories的DropDownList控件</strong></p>
<p>　　我们现在需要创建收集每个产品的name和price信息的TextBox控件。在下面的每行对应的name和price方格里各拖放一个TextBox控件. 分别设置它们的ID为ProductName1, UnitPrice1，ProductName2, UnitPrice2，依次类推.</p>
<p>　　对每个price TextBoxes添加一个CompareValidator控件，设置其ControlToValidate属性为相应控件的ID值.同时将Operator属性设置为GreaterThanEqual，ValueToCompare 属性设置为“0”, Type属性设置为Currency.这样一来可以保证输入的价格为有效的大于或等于0的货币值.同时将Text属性设置为“*”；ErrorMessage属性为“The price must be greater than or equal to zero. Also, please omit any currency symbols.”。<br />
</p>
<p>　　<span style="color: #ff0000">注意：我们并没有在添加界面里包含任何的RequiredFieldValidator控件，即便是数据库表Products的ProductName不允许为NULL值.举个例子，如果用户只想在前3行输入产品的name和unit price，而最后2行为空，我们就仅仅向数据库添加了3个产品。由于ProductName是必需的，当输入了name值后，我们只需要通过编程检查用户是否输入了该产品的unit price值.我们将在第四步进行该检查.</span></p>
<p>　　当用户输入了数据，但如果输入值包含货币符号的话，CompareValidator控件将报告无效数据.在每个unit price TextBoxe控件前添加一个“$”符合，提示用户输入数据的时候忽略货币符号.</p>
<p>　　最后，在InsertingInterface Panel控件里添加一个ValidationSummary控件，设置其ShowMessageBox属性为true，ShowSummary属性为false.有了这些设置后，当用户输入一个无效的unit price值后，在TextBox控件旁边将会出现一个星号，且ValidationSummary控件将显示一个客户端的消息框，显示相应的错误消息.</p>
<p>　　此时，你的屏幕看起来和图10差不多.</p>
<p><br />
<strong>图10：添加界面现在包含显示产品的Names和Prices的TextBox控件</strong></p>
<p>　　接下来我们要在底部行添加“Add Products from Shipment” 和 “Cancel”按钮.从工具箱拖2个Button控件到界面的底部，分别设置其ID为AddProducts和CancelButton；同时分别设其Text属性为“Add Products from Shipment”和“Cancel”.此外，将 CancelButton按钮的CausesValidation属性设置为false.</p>
<p>　　最后，我们需要添加一个Label Web控件来显示有关这2个界面的状态信息.比如：当用户成功地添加了一批产品时我们希望切换到展示界面并显示确认消息.当然，如果用户输入产品信息时只提供了price而没有提供name信息，我们就需要显示一个警告信息，提示用户ProductName是必需的.由于我们需要显示与这2个界面有关的信息，将该控件放在这2个Panel控件的上方.</p>
<p>　　从工具箱里拖一个Label Web控件到页面顶部，设其ID为StatusLabel，清除其Text属性，设其Visible属性和EnableViewState属性为false. 我们在以前的教程里探讨过，将EnableViewState属性设为false的话，我们可以通过编程的方式改变Label控件的属性值，而当发生页面回传时其又回到默认状态.当发生某些用户行为(user action)时，会显示状态信息，而当页面回传时，状态信息又消失了.最后设置StatusLabel的CssClass属性为“Warning”，这是我们在Styles.css文件里定义的CSS class名称.</p>
<p>下图显示的是添加并设置Label控件后的样子</p>
<p><br />
<strong>图11：在Panel控件上面放置id为StatusLabel的Label控件</strong></p>
<p><strong>第三步：在展示界面和添加界面之间切换</strong></p>
<p>到此，我们已经完成了展示和添加界面，不过我们仍然有2个任务要做：</p>
<p>1.在展示界面和添加界面之间切换<br />
2.将产品添加到数据库</p>
<p>当前，展示界面是可见的而添加界面是隐藏的.这是因为DisplayInterface Panel控件的Visible属性为true(默认值), 而InsertingInterface Panel控件的Visible属性为false.</p>
<p>当点击“Process Product Shipment”按钮时，我们向从展示界面切换到添加界面。为此，创建该按钮的Click事件处理器，包含以下代码：<br />
</p>
<div class="phpstudycode">
<pre class="brush:csharp;">
protected void ProcessShipment_Click(object sender, EventArgs e)
{
 DisplayInterface.Visible = false;
 InsertingInterface.Visible = true;
}</pre>
</div>
<p>该代码仅仅隐藏DisplayInterface Panel而显示InsertingInterface Panel.</p>
<p>　　接下来，我们为添加界面里的“Add Products from Shipment”和“Cancel” 按钮创建事件处理器.当任何一个按钮点击时，我们需要切换到展示界面.创建这2个按钮的Click事件处理器以调用ReturnToDisplayInterface方法——我们马上就要创建该方法.</p>
<p>　　该方法除了隐藏InsertingInterface Panel并显示DisplayInterface Panel外，还需要将Web控件返回到其预编辑状态(pre-editing state).即把DropDownList控件的属性SelectedIndex设置为0，清除TextBox控件的Text属性.</p>
<p>　　<span style="color: #ff0000">注意：仔细思考一下，如果在返回展示界面以前，我们没有将这些控件返回到预编辑状态的话将会发生什么事情呢？</span>比如用户点击“Process Products from Shipment”按钮，然后输入产品信息，再点“Add Products from Shipment”按钮，这样将添加产品并返回展示页面。如果用户又想添加另一批产品，一旦点击“Process Product Shipment”按钮时将切换到添加界面，但是DropDownList控件的值和TextBox控件的值依然是以前的值.</p>
<div class="phpstudycode">
<pre class="brush:csharp;">
protected void AddProducts_Click(object sender, EventArgs e)
{
 // TODO: Save the products

 // Revert to the display interface
 ReturnToDisplayInterface();
}

protected void CancelButton_Click(object sender, EventArgs e)
{
 // Revert to the display interface
 ReturnToDisplayInterface();
}

const int firstControlID = 1;
const int lastControlID = 5;

private void ReturnToDisplayInterface()
{
 // Reset the control values in the inserting interface
 Suppliers.SelectedIndex = 0;
 Categories.SelectedIndex = 0;

 for (int i = firstControlID; i &lt;= lastControlID; i++)
 {
 ((TextBox)InsertingInterface.FindControl("ProductName" + i.ToString())).Text =
  string.Empty;
 ((TextBox)InsertingInterface.FindControl("UnitPrice" + i.ToString())).Text =
  string.Empty;
 }

 DisplayInterface.Visible = true;
 InsertingInterface.Visible = false;
}

</pre>
</div>
<p>　　上述2个Click事件处理器都仅仅简单的调用ReturnToDisplayInterface方法，不过我们将在第四步完善“Add Products from Shipment”的Click事件，添加代码以保存产品.<br />
</p>
<p>　　ReturnToDisplayInterface方法一开始就把Suppliers和Categories的DropDownList控件返回其第一项；常量firstControlID和lastControlID分别用来设置添加界面里的标明产品名称和单价的TextBoxe控件的开始和结束索引值. 在一个for循环里设置这些控件的Text属性为空字符串.最后重新设置Panels控件的Visible属性，以显示展示界面而隐藏添加界面.</p>
<p>　　花点时间在浏览器里测试该页面，当首次登录时你将看到如图5所示的画面，点“Process Product Shipment”按钮，页面将回传并切换到如图12所示的添加界面，不管点“Add Products from Shipment”还是“Cancel”按钮都将返回展示界面.</p>
<p>　　注意：当浏览添加界面时，测试一下与unit price TextBox对应的验证控件。如果你输入的不是货币值或价格比0小，当点击“Add Products from Shipment”按钮时，就会弹出一个客户端的警告消息.</p>
<p><br />
<strong>图12：点击Process Product Shipment” 按钮后，将切换到添加界面.</strong></p>
<p><strong>第四步：添加产品</strong></p>
<p>　　剩下要做的事情是在“Add Products from Shipment”按钮的Click事件处理器里将产品添加到数据库.为此，我们可以创建一个ProductsDataTable，并为要插入的产品添加一个ProductsRow instance实例。一旦添加完ProductsRows后，我们就调用并把ProductsDataTable传递给ProductsBLL class类的UpdateWithTransaction方法.记得我们是在第61章《在事务里对数据库修改进行封装》里创建的UpdateWithTransaction方法，该方法将ProductsDataTable传递给ProductsTableAdapter的UpdateWithTransaction方法.于是启动一个ADO.NET事务，TableAdatper针对添加的每一个ProductsRow向数据库发出一个INSERT命令.如果所有的添加无误则提交事务，否则对事务回滚.</p>
<p>　　对“Add Products from Shipment”按钮的Click处理器进行编码时，应该执行一些误差校验，因为我们没有在添加界面里使用RequiredFieldValidators控件，某个用户可能输入了产品的price而忽视里其name。由于产品的name是必须的，如果出现这种情况的话，我们需要提醒用户并中断inserts操作.完整的代码如下：</p>
<div class="phpstudycode">
<pre class="brush:csharp;">
protected void AddProducts_Click(object sender, EventArgs e)
{
 // Make sure that the UnitPrice CompareValidators report valid data...
 if (!Page.IsValid)
 return;

 // Add new ProductsRows to a ProductsDataTable...
 Northwind.ProductsDataTable products = new Northwind.ProductsDataTable();
 for (int i = firstControlID; i &lt;= lastControlID; i++)
 {
 // Read in the values for the product name and unit price
 string productName = ((TextBox)InsertingInterface.FindControl
  ("ProductName" + i.ToString())).Text.Trim();
 string unitPrice = ((TextBox)InsertingInterface.FindControl
  ("UnitPrice" + i.ToString())).Text.Trim();

 // Ensure that if unitPrice has a value, so does productName
 if (unitPrice.Length &gt; 0 && productName.Length == 0)
 {
  // Display a warning and exit this event handler
  StatusLabel.Text = "If you provide a unit price you must also " +
  "include the name of the product.";
  StatusLabel.Visible = true;
  return;
 }

 // Only add the product if a product name value is provided
 if (productName.Length &gt; 0)
 {
  // Add a new ProductsRow to the ProductsDataTable
  Northwind.ProductsRow newProduct = products.NewProductsRow();

  // Assign the values from the web page
  newProduct.ProductName = productName;
  newProduct.SupplierID = Convert.ToInt32(Suppliers.SelectedValue);
  newProduct.CategoryID = Convert.ToInt32(Categories.SelectedValue);
  if (unitPrice.Length &gt; 0)
  newProduct.UnitPrice = Convert.ToDecimal(unitPrice);

  // Add any "default" values
  newProduct.Discontinued = false;
  newProduct.UnitsOnOrder = 0;

  products.AddProductsRow(newProduct);
 }
 }

 // If we reach here, see if there were any products added
 if (products.Count &gt; 0)
 {
 // Add the new products to the database using a transaction
 ProductsBLL productsAPI = new ProductsBLL();
 productsAPI.UpdateWithTransaction(products);

 // Rebind the data to the grid so that the producst just added are displayed
 ProductsGrid.DataBind();

 // Display a confirmation (don't use the Warning CSS class, though)
 StatusLabel.CssClass = string.Empty;
 StatusLabel.Text = string.Format(
  "{0} products from supplier {1} have been added and filed under " +
  "category {2}.", products.Count, Suppliers.SelectedItem.Text,
  Categories.SelectedItem.Text);
 StatusLabel.Visible = true;

 // Revert to the display interface
 ReturnToDisplayInterface();
 }
 else
 {
 // No products supplied!
 StatusLabel.Text = "No products were added. Please enter the product " +
  "names and unit prices in the textboxes.";
 StatusLabel.Visible = true;
 }
}

</pre>
</div>
<p>　　该事件处理器开始时检查Page.IsValid属性返回的值是否为true。如果返回的为false,那就意味着至少有一个CompareValidators控件发现了无效的数据.此时，我们要么停止添加产品；要么将用户键入的unit price值向ProductsRow的UnitPrice属性赋值时，以抛出一个异常告终.</p>
<p>　　接下来创建一个新的ProductsDataTable instance实例(也就是products)，在一个for循环里遍历有关name和unit price的TextBox控件，并将其Text属性读取到局部变量productName 和 unitPrice里.如果用户输入了产品的unit price值而没有输入产品的name值，那么StatusLabel控件就会显示消息“If you provide a unit price you must also include the name of the product”并退出事件处理器.</p>
<p>　　如果用户输入了产品name的话，就用ProductsDataTable的NewProductsRow方法创建一个新的ProductsRow instance实例.对实例的ProductName属性而言，是用相应的TextBox来赋值；而对SupplierID 和 CategoryID属性而言，是用添加界面顶部的相应的DropDownList控件的SelectedValue属性值来赋值的；如果用户输入里产品的价格，就对ProductsRow instance实例的UnitPrice属性进行赋值，如果用户没有输入价格那么就置空，向数据库添加数据时UnitPrice的值就为NULL值.最后，对Discontinued 和 UnitsOnOrder属性用硬编码的值“false”和“0”分别赋值.</p>
<p>　　完成对ProductsRow instance实例的相关属性赋值后，将其添加到ProductsDataTable.</p>
<p>　　完成for循环后我们将检查是否已经添加了产品.毕竟，用户可能没有输入任何的信息就点击了“Add Products from Shipment”按钮.如果在ProductsDataTable里至少存在一个产品，将调用ProductsBLL class类的UpdateWithTransaction方法，接下来对名为ProductsGrid的GridView控件重新进行绑定，最新添加的产品就会出现在出现在展示界面里.StatusLabel将被更新以显示一个确认消息，然后调用ReturnToDisplayInterface，隐藏添加界面而显示展示界面.</p>
<p>　　如果没有添加任何产品，添加界面照样会隐藏，不过会显示一个消息“No products were added. Please enter the product names and unit prices in the textboxes”.</p>
<p>图13显示的情况是用户输入了unit price值而没有输入相应的产品name；图14显示的是成功添加3个产品后的展示界面.图15显示的是其中2个产品的界面(还有1个在前面那一页)</p>
<p><br />
<strong>图13：当输入Unit Price值，产品的Name也是必需的</strong></p>
<p><br />
<strong>图14：添加了3个由供应商Mayumi提供的Veggies类产品</strong></p>
<p><br />
<strong>图15：新添加的产品可以在GridView里的最后一页找到</strong></p>
<p>　　<span style="color: #ff0000">注意：本文使用的批添加逻辑将insert封装在一个事务里.要证实的话，我们可以有意的导入一个数据库级的错误(database-level error).</span>比如：对ProductsRow instance实例的 CategoryID属性而言，我们不像上面那样用Categories DropDownList控件的selected值来赋值，而是用i * 5对其赋值.这里的i是指介于1到5之间的循环索引值(loop indexer).因此，当添加2个或更多的产品时，第一个产品的CategoryID值(5)是有效的，而后面的产品的CategoryID值就无效了，因为其值与表Categories里的CategoryID值不匹配(译注：因为第2个产品的CategoryID值为10；第3个的为15，依次类推).后果是第一个产品的INSERT操作成功，后面的操作失败，因为违反了外键约束.由于我们的该批添加是原子操作，第一个INSERT会回滚，数据库就会返回到开始批添加前的状态</p>
<p><strong>结语：</strong></p>
<p>　　在本文及前2章，我们创建里对数据进行批更新、批删除、批添加的界面.这些界面都用到了事务。该事务，我们是在第61章《在事务里对数据库修改进行封装》里在数据访问层Data Access Layer里添加的.在某些情况下，这些批数据处理界面可以极大的提升最终用户的效率.</p>
<p>　　对处理批数据的考察到此为止.接下来的系列文章里我们将考察Data Access Layer数据访问层里的多种更高级的情况。包括在TableAdapter的方法里使用存储过程、在DAL里进行连接和命令级(connection- and command-level)的设置、对连接字符串进行加密等.</p>
<p>　　祝编程快乐！</p>
<p><strong>作者简介</strong></p>
<p>　　本系列教程作者 Scott Mitchell，著有六本ASP/ASP.NET方面的书，是4GuysFromRolla.com的创始人，自1998年以来一直应用 微软Web技术。大家可以点击查看全部教程《[翻译]Scott Mitchell 的ASP.NET 2.0数据教程》，希望对大家的学习ASP.NET有所帮助。</p>
<hr></span>                                     
		    	</div>
		    	<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>代码注释</div>
			    <div class="panel-content">
			    <span></span>                                     
		    	</div>

			</div>

			<!-- END ROW -->
			<div class="newsPage">
				<div class="newsPageTurn">
				    <span><a>上一篇</a><a href='/php/biji/94799.html'>javascript实现很浪漫的气泡冒出特效</a><a>下一篇</a><a href='/php/biji/94801.html'>DIV+CSS 清除浮动常用方法总结</a></span>
				</div>
			</div>
		</div>


<div id="author-box">
    <h3>作者：喵哥笔记</h3>
        <div class="author-info">
            <div class="author-avatar">
                <img src="/skin1/picture/01.jpg" alt="IDC笔记" class="avatar" width="64" height="64">
            </div>
        <div class="author-description">
            <p>学的不仅是技术，更是梦想！</p>
            <ul class="author-social follows nb">
            	<li>
                    <a target="_blank" href="/" title="IDC笔记">IDC笔记</a>
                </li>
            </ul>
        </div>
        <div class="clear"></div>
    </div>
</div>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
<!-- container-fluid -->
	</div>
<!-- content -->
	<footer class="footer">
	© 2020 IDC笔记 <i class="mdi mdi-heart text-danger"></i>. | 备案号：<a href="https://beian.miit.gov.cn/">辽ICP备18000516号</a>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?674585fbbd2294d3faf910f668ea91b4";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

	</footer>
</div>

</div>
<!-- END wrapper -->
<!-- jQuery  -->
<script src="/skin1/js/jquery.min.js"></script>
<script src="/skin1/js/bootstrap.bundle.min.js"></script>
<script src="/skin1/js/metismenu.min.js"></script>
<script src="/skin1/js/jquery.slimscroll.js"></script>
<script src="/skin1/js/waves.min.js"></script>
<!--Morris Chart-->
<script src="/skin1/js/morris.min.js"></script>
<script src="/skin1/js/raphael.min.js"></script>
<script src="/skin1/js/dashboard.init.js"></script>
<script src="/skin1/js/app.js"></script>
<script src="/foot.js"></script>
</body>
</html>