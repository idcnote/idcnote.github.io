<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <title>Puppet使用方法总结_PHP教程_IDC笔记</title>
    <meta name="keywords" content="PHP,PHP笔记,PHP教程" />
    <meta name="description" content="1. 概述 <br />
puppet是一个开源的软件自动化配置和部署工具，它使用简单且功能强大，正得到了越来越多地关注，现在很多大型IT公司均在使用puppet对集群中的软件进行管理和部署，如googl" />
    <meta content="Responsive admin theme build on top of Bootstrap 4" name="description" />
    <meta content="idcnote.com" name="author" />
    <link rel="shortcut icon" href="/skin1/images/favicon.ico">
    <!--Morris Chart CSS -->
    <link rel="stylesheet" href="/skin1/css/morris.css">
    <link href="/skin1/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/metismenu.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/icons.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/style.css" rel="stylesheet" type="text/css">
<link href="/SyntaxHighlighter/shCoreDefault.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">
 SyntaxHighlighter.all();
</script>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
</head>
<body>
<!-- Begin page -->
		<div id="wrapper">
			<!-- Top Bar Start -->
			<div class="topbar">
				<!-- LOGO -->
				<div class="topbar-left">
					<a href="/" class="logo">
						<span class="logo-light">
                            <i class="mdi mdi-camera-control"></i>IDC笔记
                        </span>
						<span class="logo-sm">
                            <i class="mdi mdi-camera-control"></i>
                        </span>
					</a>
				</div>
				<nav class="navbar-custom">
					<ul class="navbar-right list-inline float-right mb-0">
						<!--<li class="dropdown notification-list list-inline-item d-none d-md-inline-block">
							<a class="nav-link waves-effect" href="#" id="btn-fullscreen">
								<i class="mdi mdi-arrow-expand-all noti-icon"></i>
							</a>
						</li>
						<li class="dropdown notification-list list-inline-item">
							<div class="dropdown notification-list nav-pro-img">
								<a class="dropdown-toggle nav-link arrow-none nav-user" data-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
									<img src="/skin1/picture/user-4.jpg" alt="user" class="rounded-circle">
								</a>
								<div class="dropdown-menu dropdown-menu-right profile-dropdown ">
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-account-circle"></i> Profile</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-wallet"></i> Wallet</a>
									<a class="dropdown-item d-block" href="#">
										<span class="badge badge-success float-right">11</span>
										<i class="mdi mdi-settings"></i> Settings</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-lock-open-outline"></i> Lock screen</a>
									<div class="dropdown-divider"></div>
									<a class="dropdown-item text-danger" href="#">
										<i class="mdi mdi-power text-danger"></i> Logout</a>
								</div>
							</div>
						</li>
						-->
					</ul>
					<ul class="list-inline menu-left mb-0">
						<li class="float-left">
							<button class="button-menu-mobile open-left waves-effect">
                            <i class="mdi mdi-menu"></i>
                        </button>
						</li>
						<li class="d-none d-md-inline-block">
							<form role="search" class="app-search">
								<div class="form-group mb-0">
									<input type="text" class="form-control" placeholder="Search..">
									<button type="submit"><i class="fa fa-search"></i></button>
								</div>
							</form>
						</li>
					</ul>
				</nav>
			</div>
<!-- ========== Left Sidebar Start ========== -->
<div class="left side-menu">
    <div class="slimscroll-menu" id="remove-scroll">
    <!--- Sidemenu -->
    <div id="sidebar-menu">
    <!-- Left Menu Start -->
    <ul class="metismenu" id="side-menu">
			<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP简介			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/jianjie/1.html">PHP简介</a></li><li><a href="/php/jianjie/2.html">PHP用途</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP基本语法			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yufa/3.html">分离HTML</a></li><li><a href="/php/yufa/4.html">指令分隔符</a></li><li><a href="/php/yufa/5.html">PHP注释</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP类型			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpleixing/6.html">PHP类型简介</a></li><li><a href="/php/phpleixing/7.html">PHP类型之布尔类型</a></li><li><a href="/php/phpleixing/8.html">PHP类型之整型</a></li><li><a href="/php/phpleixing/9.html">PHP类型之浮点型</a></li><li><a href="/php/phpleixing/10.html">PHP类型之字符串</a></li><li><a href="/php/phpleixing/11.html">PHP类型之数组</a></li><li><a href="/php/phpleixing/12.html">PHP类型之对象</a></li><li><a href="/php/phpleixing/13.html">PHP类型之资源类型</a></li><li><a href="/php/phpleixing/14.html">PHP类型之NULL</a></li><li><a href="/php/phpleixing/15.html">PHP类型之伪类型</a></li><li><a href="/php/phpleixing/16.html">PHP类型之类型判别</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP变量			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpbianliang/17.html">PHP变量之基础</a></li><li><a href="/php/phpbianliang/18.html">PHP变量之预定义变量</a></li><li><a href="/php/phpbianliang/19.html">PHP变量之变量范围</a></li><li><a href="/php/phpbianliang/20.html">PHP变量之可变变量</a></li><li><a href="/php/phpbianliang/21.html">PHP变量之外部变量</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP运算符			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yunsuanfu/22.html">PHP运算符优先级</a></li><li><a href="/php/yunsuanfu/23.html">算术运算符</a></li><li><a href="/php/yunsuanfu/24.html">赋值运算符</a></li><li><a href="/php/yunsuanfu/25.html">位运算符</a></li><li><a href="/php/yunsuanfu/26.html">比较运算符</a></li><li><a href="/php/yunsuanfu/27.html">错误控制运算符</a></li><li><a href="/php/yunsuanfu/28.html">执行运算符</a></li><li><a href="/php/yunsuanfu/29.html">递增/递减运算符</a></li><li><a href="/php/yunsuanfu/30.html">逻辑运算符</a></li><li><a href="/php/yunsuanfu/31.html">字符串运算符</a></li><li><a href="/php/yunsuanfu/32.html">数组运算符</a></li><li><a href="/php/yunsuanfu/33.html">类型运算符</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP控制结构			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/jiegou/34.html">PHP控制结构之if</a></li><li><a href="/php/jiegou/35.html">PHP控制结构之else</a></li><li><a href="/php/jiegou/36.html">PHP控制结构之elseif/else if</a></li><li><a href="/php/jiegou/37.html">PHP控制结构之替代语法</a></li><li><a href="/php/jiegou/38.html">PHP控制结构之while</a></li><li><a href="/php/jiegou/39.html">PHP控制结构之do-while</a></li><li><a href="/php/jiegou/40.html">PHP控制结构之for</a></li><li><a href="/php/jiegou/41.html">PHP控制结构之foreach</a></li><li><a href="/php/jiegou/42.html">PHP控制结构之break</a></li><li><a href="/php/jiegou/43.html">PHP控制结构之continue</a></li><li><a href="/php/jiegou/44.html">PHP控制结构之switch</a></li><li><a href="/php/jiegou/45.html">PHP控制结构之declare</a></li><li><a href="/php/jiegou/46.html">PHP控制结构之return</a></li><li><a href="/php/jiegou/47.html">PHP控制结构之require</a></li><li><a href="/php/jiegou/48.html">PHP控制结构之include</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP函数			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/hanshu/52.html">用户自定义函数</a></li><li><a href="/php/hanshu/53.html">函数的参数</a></li><li><a href="/php/hanshu/54.html">返回值</a></li><li><a href="/php/hanshu/55.html">可变函数</a></li><li><a href="/php/hanshu/56.html">内部（内置）函数</a></li><li><a href="/php/hanshu/57.html">匿名函数</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP类与对象			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpduixiang/58.html">类与对象前言</a></li><li><a href="/php/phpduixiang/59.html">基本概念</a></li><li><a href="/php/phpduixiang/60.html">属性</a></li><li><a href="/php/phpduixiang/61.html">类常量</a></li><li><a href="/php/phpduixiang/62.html">自动加载对象</a></li><li><a href="/php/phpduixiang/63.html">构造函数和析构函数</a></li><li><a href="/php/phpduixiang/64.html">访问控制</a></li><li><a href="/php/phpduixiang/65.html">对象继承</a></li><li><a href="/php/phpduixiang/66.html">Static关键字</a></li><li><a href="/php/phpduixiang/67.html">抽象类</a></li><li><a href="/php/phpduixiang/68.html">接口</a></li><li><a href="/php/phpduixiang/69.html">Traits</a></li><li><a href="/php/phpduixiang/70.html">重载</a></li><li><a href="/php/phpduixiang/71.html">对象迭代</a></li><li><a href="/php/phpduixiang/72.html">设计模式</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP异常处理			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yichang/81.html">异常处理</a></li><li><a href="/php/yichang/82.html">扩展PHP内置的异常处理类</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP函数库按分类			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpku/83.html">数组</a></li><li><a href="/php/phpku/84.html">Classes/Objects</a></li><li><a href="/php/phpku/85.html">Date/Time</a></li><li><a href="/php/phpku/86.html">Directories</a></li><li><a href="/php/phpku/87.html">错误处理</a></li><li><a href="/php/phpku/88.html">Program execution</a></li><li><a href="/php/phpku/89.html">Filesystem</a></li><li><a href="/php/phpku/90.html">Filter</a></li><li><a href="/php/phpku/91.html">Function Handling</a></li><li><a href="/php/phpku/92.html">PHP 选项/信息</a></li><li><a href="/php/phpku/93.html">Mail</a></li><li><a href="/php/phpku/94.html">Math</a></li><li><a href="/php/phpku/95.html">Misc.</a></li><li><a href="/php/phpku/96.html">Network</a></li><li><a href="/php/phpku/97.html">输出控制</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> php基础			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpbiji/108377.html"></a></li><li><a href="/php/phpbiji/108376.html"></a></li><li><a href="/php/phpbiji/108380.html"></a></li><li><a href="/php/phpbiji/108379.html"></a></li><li><a href="/php/phpbiji/108378.html"></a></li><li><a href="/php/phpbiji/108381.html"></a></li><li><a href="/php/phpbiji/108382.html"></a></li><li><a href="/php/phpbiji/108384.html"></a></li><li><a href="/php/phpbiji/108383.html"></a></li><li><a href="/php/phpbiji/108385.html"></a></li><li><a href="/php/phpbiji/108386.html"></a></li><li><a href="/php/phpbiji/108388.html"></a></li><li><a href="/php/phpbiji/108387.html"></a></li><li><a href="/php/phpbiji/108389.html"></a></li><li><a href="/php/phpbiji/108391.html"></a></li>		</ul>
	</li>
		<li>
	    <a href="/php/biji/" class="waves-effect">
		    <i class="icon-share"></i>
		    <span>PHP笔记
		       	<span class="float-right menu-arrow">
		       	<i class="mdi mdi-chevron-right"></i>
		       	</span>
		    </span>
	    </a>
	</li>
	</ul>
</div>
<!-- Sidebar -->
<div class="clearfix"></div>
</div>
<!-- Sidebar -left -->
</div>
<!-- Left Sidebar End -->
<!-- Start right Content here -->
<div class="content-page">
	<div class="content">
		<div class="container-fluid">
			<div class="page-title-box">
				<div class="row align-items-center">
					<div class="col-sm-6">
						<h1 class="page-title">Puppet使用方法总结</h1>
					</div>
				</div>
				<!-- end row -->
			</div>
			<!-- end page-title -->
			<!-- START ROW -->
			<div class="panel panel-forbid">
				<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>内容摘要</div>
			    <div class="panel-content">
			    <span>1. 概述 <br />
puppet是一个开源的软件自动化配置和部署工具，它使用简单且功能强大，正得到了越来越多地关注，现在很多大型IT公司均在使用puppet对集群中的软件进行管理和部署，如googl</span>                                     
		    	</div>
			    <div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>文章正文</div>
			    <div class="panel-content">
			    <span><strong>1. 概述</strong> <br />puppet是一个开源的软件自动化配置和部署工具，它使用简单且功能强大，正得到了越来越多地关注，现在很多大型IT公司均在使用puppet对集群中的软件进行管理和部署，如google利用puppet管理超过6000台地mac桌面电脑（2007年数据）。 <br />本文主要介绍puppet安装方法，设计架构及使用方法。 <br /><strong>2. 设计架构 <br /></strong>puppet是基于c/s架构的。服务器端保存着所有对客户端服务器的配置代码，在puppet里面叫做manifest. 客户端下载manifest之后，可以根据manifest对服务器进行配置，例如软件包管理，用户管理和文件管理等等。<br /><br /><br />
<p>如上图所示，puppet的工作流程如下：（1）客户端puppetd调用facter，facter探测出主机的一些变量，例如主机名，内存大小，ip地址等。pupppetd 把这些信息通过ssl连接发送到服务器端； （2）服务器端的puppetmaster 检测客户端的主机名，然后找到manifest里面对应的node配置， 并对该部分内容进行解析，facter送过来的信息可以作为变量处理，node牵涉到的代码才解析，其他没牵涉的代码不解析。解析分为几个阶段，语法检查，如果语法错误就报错。如果语法没错，就继续解析，解析的结果生成一个中间的&ldquo;伪代码&rdquo;，然后把伪代码发给客户端；（3）客户端接收到&ldquo;伪代码&rdquo;，并且执行，客户端把执行结果发送给服务器；（4）服务器端把客户端的执行结果写入日志。</p>
<p>puppet工作过程中有两点值得注意，第一，为了保证安全，client和master之间是基于ssl和证书的，只有经master证书认证的client可以与master通信；第二，puppet会让系统保持在你所期望的某种状态并一直维持下去，如检测某个文件并保证其一直存在，保证ssh服务始终开启，如果文件被删除了或者ssh服务被关闭了，puppet下次执行时（默认30分钟），会重新创建该文件或者启动ssh服务。</p>
<p><strong>3.&nbsp; 软件安装</strong></p>
<p>不推荐使用apt-get命令进行安装，因为该命令下载的puppet存在bug。可直接从源代码进行安装，需要安装的软件有ruby，facter和puppet。</p>
<p>3.1&nbsp;&nbsp; 安装步骤</p>
<p>编辑/etc/host以修改主机名，因为puppet是基于证书的，证书中包含主机名；</p>
<p>在master和slave上依次安装ruby、facter和puppet，安装facter和puppet时，要使用ruby install.rb。</p>
<p>3.2&nbsp;&nbsp;&nbsp; 安装后的目录结构</p>
<p>(1)&nbsp;&nbsp;&nbsp; 安装目录</p>
<p>安装目录默认存为/etc/puppet，该目录下的manifests存放manifest文件。</p>
<p>其他可执行文件在/user/sbin下，主要有：</p>
<p>puppet： 用于执行用户所写独立的mainfests文件，如：</p>
<p>puppet -l /tmp/manifest.log manifest.pp</p>
<p>puppetd： 运行在被管理主机上的客户端程序，如：</p>
<p>puppet &ndash;server servername &ndash;waitforcert 60</p>
<p>puppetmasterd：运行在管理机上的服务器程序，如：</p>
<p>puppetmasterd &ndash;debug</p>
<p>puppetca puppet认证程序，主要用于对slave的证书进行认证，如：</p>
<p>查看需认证的slave：puppetca &ndash;list</p>
<p>对这些slave进行认证：puppetca -s &ndash;a</p>
<p>puppetrun 用于连接客户端，强制运行本地配置文件，如：</p>
<p>puppetrun -p 10 &ndash;host host1 &ndash;host host2 -t remotefile -t webserver</p>
<p>(2)&nbsp;&nbsp;&nbsp; 配置文件</p>
<p>puppet.conf</p>
<p>Puppet的主配置文件，如果是root用户，配置文件为/etc/puppet/puppet.conf，普通用户，配置文件为：~user/.puppet/puppet.conf</p>
<p>具体配置参数，参见：</p>
<p>http://docs.puppetlabs.com/references/stable/configuration.html#configuration-files</p>
<p>fileserver.conf</p>
<p>puppet文件服务器的配置文件。用path配置文件路径，allow/deny配置访问权限，具体参见：http://docs.puppetlabs.com/guides/file_serving.html</p>
<p>3.3&nbsp;&nbsp; 验证安装是否成功</p>
<p>选定一个slave与master进行验证，假设slave的host为slave00，master的host为masterhost，在slave00上输入：</p>
<p>puppetd &ndash;test &ndash;server servername</p>
<p>然后在masterhost上查看待认证的slave：</p>
<p>puppetca &ndash;list</p>
<p>如果没问题的话，此时可以看到slave00，对该slave的证书进行签名：</p>
<p>puppetca -s -a</p>
<p>这样slave00通过了证书验证，可以与master进行进一步交互了。</p>
<p>在masterhost的/etc/puppet/manifests目录下编写site.pp文件，内容如下：<br /><br><div class="msgheader"><div class="right"><span style="CURSOR: pointer" onclick="copycode(getid('phpcode13'));"><u>复制代码</u></span></div>代码如下:</div><div class="msgborder" id="phpcode13"><br />node default {<br />file {<br />&ldquo;/tmp/test&rdquo;:<br />content=&gt;&rdquo;hello\n&rdquo;,<br />mode =&gt; 0644;<br />}<br />}<br /></div><br />同时在slave00上输入：puppetd &ndash;test &ndash;server servername， 查看slave00的/tmp文件夹，生成了一个新文件test，里面的内容是hello，该文件的权限是-rw-r&mdash;r&mdash;。这样，便证明puppet安装成功，如果出现错误，查看第六节。</p>
<p><strong>4.&nbsp; 配置脚本编写</strong></p>
<p>本节介绍puppet的配置脚本编写方法，主要是指puppet的manifest编写方法。puppet把需要管理的内容抽象成为资源，每种资源有不同的属性，因此puppet语言就是描述这些资源的属性以及资源之间关系的语言。</p>
<p>为了便于管理，puppet将资源模块化，即每个功能模块的manifest单独放在一个目录下。每个模块包含一个主要的manifest文件（init.pp，它是模块的入口，类似于C语言中的main函数），里面包含若干个class对该模块的资源进行封装，常见的资源有file，package，service等，每种资源由自己的属性，如file有属性name，owner，mode等。</p>
<p>本节主要介绍puppet中manifest的编写方法，将依次介绍资源属性，资源，节点管理，函数和模块的编写方法。</p>
<p>4.1&nbsp;&nbsp; 资源属性</p>
<p>资源属性有两种，一种是资源专属属性，另一种是资源共同属性，对于资源专属属性，将在下一节介绍；而资源共同属性是所有资源共有的属性，主要有：</p>
<p>before</p>
<p>用于控制不同对象（资源）的执行顺序关系，表示某个对象（资源）在另一个对象之后发生（require与之相反，它表示之前发生）。如：</p>
<p><br><div class="msgheader"><div class="right"><span style="CURSOR: pointer" onclick="copycode(getid('phpcode14'));"><u>复制代码</u></span></div>代码如下:</div><div class="msgborder" id="phpcode14"><br />file { &ldquo;/var/nagios/configuration&rdquo;:<br />source =&gt; &ldquo;&hellip;&rdquo;,<br />recurse =&gt; true,<br />before =&gt; Exec["nagios-rebuid"]<br />}<br />exec { &ldquo;nagios-rebuild&rdquo;:<br />command =&gt; &ldquo;/usr/bin/make&rdquo;,<br />cwd =&gt; &ldquo;/var/nagios/configuration&rdquo;<br />}<br /></div><br /><br />这段代码保证用make编译之前，所有代码都是最新的。也可以before多个资源，如：</p>
<p>before =&gt; [ File[&quot;/usr/local&quot;], File[&quot;/usr/local/scripts&quot;] ]</p>
<p>subscribe</p>
<p>检测某个资源，当它发生变化时，该资源会重新加载，如：<br /><br><div class="msgheader"><div class="right"><span style="CURSOR: pointer" onclick="copycode(getid('phpcode15'));"><u>复制代码</u></span></div>代码如下:</div><div class="msgborder" id="phpcode15"><br />class nagios {<br />file { &ldquo;/etc/nagios/nagios.conf&rdquo;:<br />source =&gt; &ldquo;puppet://server/module/nagios.conf&rdquo;,<br />alias =&gt; nagconf # just to make things easier for me<br />}<br />service { nagios:<br />ensure =&gt; running,<br />subscribe =&gt; File[nagconf]<br />}<br />}<br /></div><br />当检测到文件nagconf被修改时，服务nagios会相应的更新。需要注意的是，目前支持subscribe的资源只有exec，service和mount。</p>
<p>更多资料，参见：http://docs.puppetlabs.com/references/latest/metaparameter.html</p>
<p>4.2&nbsp;&nbsp; 资源</p>
<p>常用的资源主要有以下几个：</p>
<p>file：文件管理</p>
<p>package：软件包管理</p>
<p>service：系统服务管理</p>
<p>cron：配置定期任务</p>
<p>exec：运行shell命令</p>
<p>(1)&nbsp;&nbsp;&nbsp; file资源</p>
<p>更详细资料，可参见：http://puppet.wikidot.com/file</p>
<p>(2)&nbsp;&nbsp;&nbsp; package资源</p>
<p>更详细资料，可参见：http://puppet.wikidot.com/package</p>
<p>(3)&nbsp;&nbsp;&nbsp; service资源</p>
<p>更详细资料，可参见：http://puppet.wikidot.com/srv</p>
<p>(4)&nbsp;&nbsp;&nbsp; exec资源</p>
<p>更详细资料，可参见：http://puppet.wikidot.com/exec</p>
<p>(5)&nbsp;&nbsp;&nbsp; cron资源</p>
<p>更详细资料，可参见：http://puppet.wikidot.com/cron</p>
<p>4.3&nbsp;&nbsp; 节点管理</p>
<p>puppet如何区分不同的客户端，并且给不同的服务端分配manifest呢？puppet使用node资源做这件事情，node 后面跟客户端的主机名，例如：</p>
<p>node &lsquo; slave00 &lsquo; {<br />include ssh<br />}<br />node &lsquo; slave11 &lsquo; {<br />$networktype=&rdquo;tele&rdquo;<br />$nagioscheckport=&rdquo;80,22,3306&Prime;<br />include apache, mysql, php<br />}<br />资源node中可使用变量，也可直接通过include把其他manifest包含进来。</p>
<p>更详细资料，可参见：http://docs.puppetlabs.com/references/latest/type.html</p>
<p>4.4&nbsp;&nbsp; 类和函数</p>
<p>类可以把多个相关的资源定义在一起,组成一个类。类可以继承，具体参见：http://docs.puppetlabs.com/guides/language_guide.html#resource-collections</p>
<p>函数（在puppet中称为&ldquo;defination&rdquo;）可以把多个资源包装成一个资源，或者把一个资源包装成一个模型，便于使用。例如，在debian里面管理一个apache虚拟机非常简单,把一个虚拟主机的配置文件放到/etc/sites-available/里面,然后做一个符号链接到/etc/sites-enabled目录。 你可以为你每个虚拟主机复制同样的配置代码，但是如果你使用下面的代码就会更好和更简单：</p>
<p>define virtual_host($docroot, $ip, $order = 500, $ensure = &ldquo;enabled&rdquo;) {<br />$file = &ldquo;/etc/sites-available/$name.conf&rdquo;<br /># The template fills in the docroot, ip, and name.<br />file { $file:<br />content =&gt; template(&ldquo;virtual_host.erb&rdquo;),<br />notify&nbsp; =&gt; Service[apache]<br />}<br />file { &ldquo;/etc/sites-enabled/$order-$name.conf&rdquo;:<br />ensure =&gt; $ensure ? {<br />enabled&nbsp; =&gt; $file,<br />disabled =&gt; absent<br />}<br />}<br />}<br />然后,你就可以使用这个定义来管理一个apache虚拟主机，如下面代码所示：</p>
<p>virtual_host { &ldquo;reductivelabs.com&rdquo;:</p>
<p>order&nbsp;&nbsp; =&gt; 100,</p>
<p>ip&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; =&gt; &ldquo;192.168.0.100&Prime;,</p>
<p>docroot =&gt; &ldquo;/var/www/reductivelabs.com/htdocs&rdquo;</p>
<p>}</p>
<p>4.5&nbsp;&nbsp; 模块</p>
<p>一个模块就是一个/etc/puppet/modules目录下面的一个目录和它的子目录，在puppet的主文件site.pp里面用import modulename可以插入模块。新版本的puppet可以自动插入/etc/puppet/modules目录下的模块。引入模块，可以结构化代码，便于分享和管理。例如关于apache的所有配置都写到apache模块下面。一个模块目录下面通常包括三个目录：files，manifests，templates。manifests 里面必须要包括一个init.pp的文件，这是该模块的初始（入口）文件，导入一个模块的时候，会从init.pp开始执行。可以把所有的代码都写到init.pp里面，也可以分成多个pp文件，init 再去包含其他文件。files目录是该模块的文件发布目录，puppet提供一个文件分发机制，类似rsync的模块。templates 目录包含erb模型文件，这个和file资源的template属性有关。</p>
<p>puppet安装好以后，modules目录是没有的，自己建立一个就行，然后在里面可以新增加你的模块。</p>
<p>5.&nbsp; 编程实例</p>
<p>5.1 &nbsp;&nbsp; Hello World</p>
<p>本节介绍了一个非常简单的编程实例：一个slave从master中获取其manifest，该maniftest要求slave依次做以下工作：安装gcc，创建文件夹/home/dxc/test，下载文件hello.c程序，编译hello.c。</p>
<p>(1)&nbsp;&nbsp;&nbsp; 代码结构组织</p>
<p>Master上代码的目录结构如下：</p>
<p>|&ndash; auth.conf</p>
<p>|&ndash; fileserver.conf&nbsp;&nbsp; #puppet文件服务器配置文件</p>
<p>|&ndash; manifests&nbsp;&nbsp; #puppet主文件所在目录</p>
<p>|&nbsp;&nbsp; |&ndash; modules.pp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #puppet各个模块汇总</p>
<p>|&nbsp;&nbsp; |&ndash; nodes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #各个slave要处理的模块</p>
<p>|&nbsp;&nbsp; |&nbsp;&nbsp; `&ndash; execHello.pp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #hello模块对应由那些slave处理</p>
<p>|&nbsp;&nbsp; `&ndash; site.pp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #puppet主文件（入口文件）</p>
<p>|&ndash; modules&nbsp;&nbsp;&nbsp;&nbsp; #puppet的各个模块所在文件</p>
<p>|&nbsp;&nbsp; `&ndash; hello&nbsp;&nbsp; #hello模块</p>
<p>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&ndash; files&nbsp;&nbsp;&nbsp; #该模块对应的文件资源，可能是要发送给slave的配置文件等</p>
<p>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp; `&ndash; hello.c</p>
<p>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; `&ndash; manifests&nbsp;&nbsp; #模块的manifest文件</p>
<p>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; `&ndash; init.pp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #模块入口文件</p>
<p>`&ndash; ssl &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #puppet的证书文件目录</p>
<p>(2)&nbsp;&nbsp;&nbsp; 程序执行流程</p>
<p>代码调用顺序是：</p>
<p>Slave发起连接请求 &agrave; site.pp &agrave; nodes &agrave;modules &agrave; init.pp</p>
<p>首先，slave向发起master连接请求，进行证书验证；</p>
<p>接着，证书验证通过后，master会直接找到入口文件manifests目录下的site.pp文件，该文件可能包含一些全局变量，参数缺省值（当各个模块没有设置这些参数时，它们的缺省值）以及其它pp文件的调用（在该例子中，会调用modules.pp和nodes下的各个pp文件）；</p>
<p>然后，master通过nodes下的各个pp文件定位到该slave要执行的模块（init.pp是各个模块的入口），汇总这些模块代码返回给slave；</p>
<p>最后，slave根据master发过来的manifest，配置信息。</p>
<p>(3)&nbsp;&nbsp;&nbsp; 代码解释</p>
<p>直接<span>在此处下载代码</span>。</p>
<p>5.2&nbsp;&nbsp; 一个更复杂的实例</p>
<p>本节介绍了一个更为复杂的某个公司正在使用实例，puppet代码布局与上一个实例一致，只不过该实例涉及到更多模块，更复杂的依赖管理。代码具体内容本节就不解释了，具体<span>参见代码</span>。</p>
<p>6.&nbsp; 可能遇到的问题</p>
<p>Q: puppet的证书机制</p>
<p>A: puppet证书问题是初学者最容易遇到的问题，这里讲一下怎么处理。puppet服务器端在安装或者首次启动的时候，会自动生产一个根证书和服务器证书，证书和主机名相关，因此如果证书生成后友改了主机名，那就会出问题。 puppet客户端在首次启动的时候，也会自动生成证书；但是这个证书需要得到puppet服务器端的签名才行，因此；puppet客户端第一次连接服务器的时候，会发送一个证书请求；服务器端需要对这个证书进行签名。puppet客户端在下次连接服务器的时候就会下载签名好的证书。</p>
<p>Q:Ubuntu下面的证书出错，怎么解决?</p>
<p>A:本方法是提供给初学者的测试环境，生成环境不建议这么做。首先在puppetmaster(服务器端)删除/var/lib/puppet/ssl目录;然后启动puppetmasterd；然后在客户端也删除/var/lib/puppet/ssl目录。把puppetmaster机器的主机名和对应的ip地址写入客户端机器的/etc/hosts。</p>
<p>然后执行：puppetd &ndash;test &ndash;server server.example.com. 把server.example.com替</p>
<p>换成你自己的服务器主机名。 执行这个命令，会有提示信息，不用理会。</p>
<p>然后登录到puppetmaster服务器机器，执行puppetca &ndash;list 命令，看看是否有客户端的证书请求；如果没有，请检查前面的步骤是执行正确，以及网络连接是否正常。 如果puppetca &ndash;list 能看到请求，那么执行puppetca -s -a 命令；对所有的证书请求签名。最后回到puppet客户端机器，执行</p>
<p>puppetd &ndash;test &ndash;server server.example.com.</p>
<p>就能建立连接了，如果你的site.pp写好了.就可以测试puppet了。</p>
<p>补充：如果客户端和服务器端的时间不一致也会导致证书认证失败，因此出现证书问题的时候需要检查两台机器的时间是否一致，如果不一致用date命令或者ntpdate命令让两台机器的时间一致。</p>
<p>Q:出现错误[Puppet Users] err: Could not retrieve catalog; skipping run</p>
<p>A：可能是由于安装了两个版本的ruby或者facter的原因，解决方案见：</p>
<p>https://projects.puppetlabs.com/issues/5279</p>
<p>7.&nbsp; 总结</p>
<p>随着服务器集群规模越来越大，自动化配置和部署这些服务器能够使管理变得非常容易并大大减小管理部署成本，因而得到IT公司的高度重视。</p>
<p>本文档介绍了puppet，一种新型的软件自动化配置和部署工具。本文主要内容涉及puppet的架构，安装和使用方法，并给出了两个使用实例。</p>
<p>在大规模的生成环境中，如果只有一台puppetmaster会忙不过来的，因为puppet是用ruby写的，ruby是解析型语言，每个客户端来访问，都要解析一次，当客户端多了就忙不过来，所以需要扩展成一个服务器组。puppetmaster可以看作一个web服务器，实际上也是由ruby提供的web服务器模块来做的。因此可以利用web代理软件来配合puppetmaster做集群设置，具体参见：http://puppet.wikidot.com/puppetnginx。http://www.puppetlabs.com/</p>
<p>puppet中文wiki：http://puppet.chinaec2.com/</p>
<p>puppet中文博客：http://www.comeonsa.com</p>
<p>9.&nbsp; 代码下载</p>
<p>(1)5.2节实例代码下载</span></p>
<p>原创文章，转载请注明：转载自董的博客</p>
<hr></span>                                     
		    	</div>
		    	<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>代码注释</div>
			    <div class="panel-content">
			    <span></span>                                     
		    	</div>

			</div>

			<!-- END ROW -->
			<div class="newsPage">
				<div class="newsPageTurn">
				    <span><a>上一篇</a><a href='/php/biji/86414.html'>VMware克隆Linux提示找不到eth0的解决方法</a><a>下一篇</a><a href='/php/biji/86416.html'>AJAX跨域请求json数据的实现方法</a></span>
				</div>
			</div>
		</div>


<div id="author-box">
    <h3>作者：喵哥笔记</h3>
        <div class="author-info">
            <div class="author-avatar">
                <img src="/skin1/picture/01.jpg" alt="IDC笔记" class="avatar" width="64" height="64">
            </div>
        <div class="author-description">
            <p>学的不仅是技术，更是梦想！</p>
            <ul class="author-social follows nb">
            	<li>
                    <a target="_blank" href="/" title="IDC笔记">IDC笔记</a>
                </li>
            </ul>
        </div>
        <div class="clear"></div>
    </div>
</div>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
<!-- container-fluid -->
	</div>
<!-- content -->
	<footer class="footer">
	© 2020 IDC笔记 <i class="mdi mdi-heart text-danger"></i>. | 备案号：<a href="https://beian.miit.gov.cn/">辽ICP备18000516号</a>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?674585fbbd2294d3faf910f668ea91b4";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

	</footer>
</div>

</div>
<!-- END wrapper -->
<!-- jQuery  -->
<script src="/skin1/js/jquery.min.js"></script>
<script src="/skin1/js/bootstrap.bundle.min.js"></script>
<script src="/skin1/js/metismenu.min.js"></script>
<script src="/skin1/js/jquery.slimscroll.js"></script>
<script src="/skin1/js/waves.min.js"></script>
<!--Morris Chart-->
<script src="/skin1/js/morris.min.js"></script>
<script src="/skin1/js/raphael.min.js"></script>
<script src="/skin1/js/dashboard.init.js"></script>
<script src="/skin1/js/app.js"></script>
<script src="/foot.js"></script>
</body>
</html>