<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <title>解析用PHP读写音频文件信息的详解(支持WMA和MP3)_PHP教程_IDC笔记</title>
    <meta name="keywords" content="PHP,PHP笔记,PHP教程" />
    <meta name="description" content="复制代码 代码如下:&lt;?php// AudioExif.class.php// 用PHP进行音频文件头部信息的读取与写入// 目前只支持 WMA 和 MP3 两种格式, 只支持常用的几个头部信息//// 写入信息支" />
    <meta content="Responsive admin theme build on top of Bootstrap 4" name="description" />
    <meta content="idcnote.com" name="author" />
    <link rel="shortcut icon" href="/skin1/images/favicon.ico">
    <!--Morris Chart CSS -->
    <link rel="stylesheet" href="/skin1/css/morris.css">
    <link href="/skin1/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/metismenu.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/icons.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/style.css" rel="stylesheet" type="text/css">
<link href="/SyntaxHighlighter/shCoreDefault.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">
 SyntaxHighlighter.all();
</script>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
</head>
<body>
<!-- Begin page -->
		<div id="wrapper">
			<!-- Top Bar Start -->
			<div class="topbar">
				<!-- LOGO -->
				<div class="topbar-left">
					<a href="/" class="logo">
						<span class="logo-light">
                            <i class="mdi mdi-camera-control"></i>IDC笔记
                        </span>
						<span class="logo-sm">
                            <i class="mdi mdi-camera-control"></i>
                        </span>
					</a>
				</div>
				<nav class="navbar-custom">
					<ul class="navbar-right list-inline float-right mb-0">
						<!--<li class="dropdown notification-list list-inline-item d-none d-md-inline-block">
							<a class="nav-link waves-effect" href="#" id="btn-fullscreen">
								<i class="mdi mdi-arrow-expand-all noti-icon"></i>
							</a>
						</li>
						<li class="dropdown notification-list list-inline-item">
							<div class="dropdown notification-list nav-pro-img">
								<a class="dropdown-toggle nav-link arrow-none nav-user" data-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
									<img src="/skin1/picture/user-4.jpg" alt="user" class="rounded-circle">
								</a>
								<div class="dropdown-menu dropdown-menu-right profile-dropdown ">
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-account-circle"></i> Profile</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-wallet"></i> Wallet</a>
									<a class="dropdown-item d-block" href="#">
										<span class="badge badge-success float-right">11</span>
										<i class="mdi mdi-settings"></i> Settings</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-lock-open-outline"></i> Lock screen</a>
									<div class="dropdown-divider"></div>
									<a class="dropdown-item text-danger" href="#">
										<i class="mdi mdi-power text-danger"></i> Logout</a>
								</div>
							</div>
						</li>
						-->
					</ul>
					<ul class="list-inline menu-left mb-0">
						<li class="float-left">
							<button class="button-menu-mobile open-left waves-effect">
                            <i class="mdi mdi-menu"></i>
                        </button>
						</li>
						<li class="d-none d-md-inline-block">
							<form role="search" class="app-search">
								<div class="form-group mb-0">
									<input type="text" class="form-control" placeholder="Search..">
									<button type="submit"><i class="fa fa-search"></i></button>
								</div>
							</form>
						</li>
					</ul>
				</nav>
			</div>
<!-- ========== Left Sidebar Start ========== -->
<div class="left side-menu">
    <div class="slimscroll-menu" id="remove-scroll">
    <!--- Sidemenu -->
    <div id="sidebar-menu">
    <!-- Left Menu Start -->
    <ul class="metismenu" id="side-menu">
			<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP简介			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/jianjie/1.html">PHP简介</a></li><li><a href="/php/jianjie/2.html">PHP用途</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP基本语法			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yufa/3.html">分离HTML</a></li><li><a href="/php/yufa/4.html">指令分隔符</a></li><li><a href="/php/yufa/5.html">PHP注释</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP类型			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpleixing/6.html">PHP类型简介</a></li><li><a href="/php/phpleixing/7.html">PHP类型之布尔类型</a></li><li><a href="/php/phpleixing/8.html">PHP类型之整型</a></li><li><a href="/php/phpleixing/9.html">PHP类型之浮点型</a></li><li><a href="/php/phpleixing/10.html">PHP类型之字符串</a></li><li><a href="/php/phpleixing/11.html">PHP类型之数组</a></li><li><a href="/php/phpleixing/12.html">PHP类型之对象</a></li><li><a href="/php/phpleixing/13.html">PHP类型之资源类型</a></li><li><a href="/php/phpleixing/14.html">PHP类型之NULL</a></li><li><a href="/php/phpleixing/15.html">PHP类型之伪类型</a></li><li><a href="/php/phpleixing/16.html">PHP类型之类型判别</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP变量			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpbianliang/17.html">PHP变量之基础</a></li><li><a href="/php/phpbianliang/18.html">PHP变量之预定义变量</a></li><li><a href="/php/phpbianliang/19.html">PHP变量之变量范围</a></li><li><a href="/php/phpbianliang/20.html">PHP变量之可变变量</a></li><li><a href="/php/phpbianliang/21.html">PHP变量之外部变量</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP运算符			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yunsuanfu/22.html">PHP运算符优先级</a></li><li><a href="/php/yunsuanfu/23.html">算术运算符</a></li><li><a href="/php/yunsuanfu/24.html">赋值运算符</a></li><li><a href="/php/yunsuanfu/25.html">位运算符</a></li><li><a href="/php/yunsuanfu/26.html">比较运算符</a></li><li><a href="/php/yunsuanfu/27.html">错误控制运算符</a></li><li><a href="/php/yunsuanfu/28.html">执行运算符</a></li><li><a href="/php/yunsuanfu/29.html">递增/递减运算符</a></li><li><a href="/php/yunsuanfu/30.html">逻辑运算符</a></li><li><a href="/php/yunsuanfu/31.html">字符串运算符</a></li><li><a href="/php/yunsuanfu/32.html">数组运算符</a></li><li><a href="/php/yunsuanfu/33.html">类型运算符</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP控制结构			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/jiegou/34.html">PHP控制结构之if</a></li><li><a href="/php/jiegou/35.html">PHP控制结构之else</a></li><li><a href="/php/jiegou/36.html">PHP控制结构之elseif/else if</a></li><li><a href="/php/jiegou/37.html">PHP控制结构之替代语法</a></li><li><a href="/php/jiegou/38.html">PHP控制结构之while</a></li><li><a href="/php/jiegou/39.html">PHP控制结构之do-while</a></li><li><a href="/php/jiegou/40.html">PHP控制结构之for</a></li><li><a href="/php/jiegou/41.html">PHP控制结构之foreach</a></li><li><a href="/php/jiegou/42.html">PHP控制结构之break</a></li><li><a href="/php/jiegou/43.html">PHP控制结构之continue</a></li><li><a href="/php/jiegou/44.html">PHP控制结构之switch</a></li><li><a href="/php/jiegou/45.html">PHP控制结构之declare</a></li><li><a href="/php/jiegou/46.html">PHP控制结构之return</a></li><li><a href="/php/jiegou/47.html">PHP控制结构之require</a></li><li><a href="/php/jiegou/48.html">PHP控制结构之include</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP函数			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/hanshu/52.html">用户自定义函数</a></li><li><a href="/php/hanshu/53.html">函数的参数</a></li><li><a href="/php/hanshu/54.html">返回值</a></li><li><a href="/php/hanshu/55.html">可变函数</a></li><li><a href="/php/hanshu/56.html">内部（内置）函数</a></li><li><a href="/php/hanshu/57.html">匿名函数</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP类与对象			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpduixiang/58.html">类与对象前言</a></li><li><a href="/php/phpduixiang/59.html">基本概念</a></li><li><a href="/php/phpduixiang/60.html">属性</a></li><li><a href="/php/phpduixiang/61.html">类常量</a></li><li><a href="/php/phpduixiang/62.html">自动加载对象</a></li><li><a href="/php/phpduixiang/63.html">构造函数和析构函数</a></li><li><a href="/php/phpduixiang/64.html">访问控制</a></li><li><a href="/php/phpduixiang/65.html">对象继承</a></li><li><a href="/php/phpduixiang/66.html">Static关键字</a></li><li><a href="/php/phpduixiang/67.html">抽象类</a></li><li><a href="/php/phpduixiang/68.html">接口</a></li><li><a href="/php/phpduixiang/69.html">Traits</a></li><li><a href="/php/phpduixiang/70.html">重载</a></li><li><a href="/php/phpduixiang/71.html">对象迭代</a></li><li><a href="/php/phpduixiang/72.html">设计模式</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP异常处理			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yichang/81.html">异常处理</a></li><li><a href="/php/yichang/82.html">扩展PHP内置的异常处理类</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP函数库按分类			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpku/83.html">数组</a></li><li><a href="/php/phpku/84.html">Classes/Objects</a></li><li><a href="/php/phpku/85.html">Date/Time</a></li><li><a href="/php/phpku/86.html">Directories</a></li><li><a href="/php/phpku/87.html">错误处理</a></li><li><a href="/php/phpku/88.html">Program execution</a></li><li><a href="/php/phpku/89.html">Filesystem</a></li><li><a href="/php/phpku/90.html">Filter</a></li><li><a href="/php/phpku/91.html">Function Handling</a></li><li><a href="/php/phpku/92.html">PHP 选项/信息</a></li><li><a href="/php/phpku/93.html">Mail</a></li><li><a href="/php/phpku/94.html">Math</a></li><li><a href="/php/phpku/95.html">Misc.</a></li><li><a href="/php/phpku/96.html">Network</a></li><li><a href="/php/phpku/97.html">输出控制</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> php基础			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpbiji/108377.html"></a></li><li><a href="/php/phpbiji/108376.html"></a></li><li><a href="/php/phpbiji/108380.html"></a></li><li><a href="/php/phpbiji/108379.html"></a></li><li><a href="/php/phpbiji/108378.html"></a></li><li><a href="/php/phpbiji/108381.html"></a></li><li><a href="/php/phpbiji/108382.html"></a></li><li><a href="/php/phpbiji/108384.html"></a></li><li><a href="/php/phpbiji/108383.html"></a></li><li><a href="/php/phpbiji/108385.html"></a></li><li><a href="/php/phpbiji/108386.html"></a></li><li><a href="/php/phpbiji/108388.html"></a></li><li><a href="/php/phpbiji/108387.html"></a></li><li><a href="/php/phpbiji/108389.html"></a></li><li><a href="/php/phpbiji/108391.html"></a></li>		</ul>
	</li>
		<li>
	    <a href="/php/biji/" class="waves-effect">
		    <i class="icon-share"></i>
		    <span>PHP笔记
		       	<span class="float-right menu-arrow">
		       	<i class="mdi mdi-chevron-right"></i>
		       	</span>
		    </span>
	    </a>
	</li>
	</ul>
</div>
<!-- Sidebar -->
<div class="clearfix"></div>
</div>
<!-- Sidebar -left -->
</div>
<!-- Left Sidebar End -->
<!-- Start right Content here -->
<div class="content-page">
	<div class="content">
		<div class="container-fluid">
			<div class="page-title-box">
				<div class="row align-items-center">
					<div class="col-sm-6">
						<h1 class="page-title">解析用PHP读写音频文件信息的详解(支持WMA和MP3)</h1>
					</div>
				</div>
				<!-- end row -->
			</div>
			<!-- end page-title -->
			<!-- START ROW -->
			<div class="panel panel-forbid">
				<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>内容摘要</div>
			    <div class="panel-content">
			    <span>复制代码 代码如下:&lt;?php// AudioExif.class.php// 用PHP进行音频文件头部信息的读取与写入// 目前只支持 WMA 和 MP3 两种格式, 只支持常用的几个头部信息//// 写入信息支</span>                                     
		    	</div>
			    <div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>文章正文</div>
			    <div class="panel-content">
			    <span><div class="codetitle"><span><a style="CURSOR: pointer" data="27653" class="copybut" id="copybut27653" onclick="doCopy('code27653')"><U>复制代码</U></a></span> 代码如下:</div><div class="codebody" id="code27653"><BR>&lt;?php<BR>// AudioExif.class.php<BR>// 用PHP进行音频文件头部信息的读取与写入<BR>// 目前只支持 WMA 和 MP3 两种格式, 只支持常用的几个头部信息<BR>//<BR>// 写入信息支持: Title(名称), Artist(艺术家), Copyright(版权), Description (描述)<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Year(年代),&nbsp; Genre (流派),&nbsp;&nbsp; AlbumTitle (专辑标题)<BR>// 其中 mp3 和 wma 略有不同, 具体返回的信息还可能更多, 但只有以上信息可以被写入<BR>// mp3 还支持 Track (曲目编号写入)<BR>// 对于 MP3 文件支持 ID3v1也支持ID3v2, 读取时优先 v2, 写入时总是会写入v1, 必要时写入v2<BR>//<BR>// 用法说明: (由于 wma 使用 Unicode 存取, 故还需要 mb_convert_encoding() 扩展<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 返回数据及写入数据均为 ANSI 编码, 即存什么就显示什么 (中文_GB2312)<BR>//<BR>// require ('AudioExif.class.php');<BR>// $AE = new AudioExif;<BR>// $file = '/path/to/test.mp3';<BR>//<BR>// 1. 检查文件是否完整 (only for wma, mp3始终返回 true)<BR>//<BR>// $AE-&gt;CheckSize($file);<BR>//<BR>// 2. 读取信息, 返回值由信息组成的数组, 键名解释参见上方<BR>//<BR>// print_r($AE-&gt;GetInfo($file));<BR>//<BR>// 3. 写入信息, 第二参数是一个哈希数组, 键-&gt;值, 支持的参见上方的, mp3也支持 Track<BR>//&nbsp;&nbsp;&nbsp; 要求第一参数的文件路径可由本程序写入<BR>// $pa = array('Title' =&gt; '新标题', 'AlbumTitle' =&gt; '新的专辑名称');<BR>// $AE-&gt;SetInfo($file, $pa);<BR>//<BR>//<BR>// 其它: 该插件花了不少时间搜集查找 wma及mp3 的文件格式说明文档与网页, 希望对大家有用.<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 其实网上已经有不少类似的程序, 但对 wma 实在太少了, 只能在 win 平台下通过 M$ 的<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; API 来操作, 而 MP3 也很少有可以在 unix/linux 命令行操作的, 所以特意写了这个模块<BR>//<BR>// 如果发现 bug 或提交 patch, 或加以改进使它更加健壮, 请告诉我.<BR>// (关于 ID3和Wma的文件格式及结构 在网上应该都可以找到参考资料)<BR>//<BR>if (!extension_loaded('mbstring'))<BR>{<BR>&nbsp; trigger_error('PHP Extension module `mbstring` is required for AudioExif', E_USER_WARNING);<BR>&nbsp; return true;<BR>}<BR>// the Main Class<BR>class AudioExif<BR>{<BR>&nbsp; // public vars<BR>&nbsp; var $_wma = false;<BR>&nbsp; var $_mp3 = false;<BR>&nbsp; // Construct<BR>&nbsp; function AudioExif()<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; // nothing to do<BR>&nbsp; }<BR>&nbsp; // check the filesize<BR>&nbsp; function CheckSize($file)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; $handler = &$this-&gt;_get_handler($file);<BR>&nbsp;&nbsp;&nbsp; if (!$handler) return false;<BR>&nbsp;&nbsp;&nbsp; return $handler-&gt;check_size($file);<BR>&nbsp; }<BR>&nbsp; // get the infomations<BR>&nbsp; function GetInfo($file)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; $handler = &$this-&gt;_get_handler($file);<BR>&nbsp;&nbsp;&nbsp; if (!$handler) return false;<BR>&nbsp;&nbsp;&nbsp; return $handler-&gt;get_info($file);<BR>&nbsp; }<BR>&nbsp; // write the infomations<BR>&nbsp; function SetInfo($file, $pa)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; if (!is_writable($file))<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; trigger_error('AudioExif: file `' . $file . '` can not been overwritten', E_USER_WARNING);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return false;<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; $handler = &$this-&gt;_get_handler($file);<BR>&nbsp;&nbsp;&nbsp; if (!$handler) return false;<BR>&nbsp;&nbsp;&nbsp; return $handler-&gt;set_info($file, $pa);<BR>&nbsp; }<BR>&nbsp; // private methods<BR>&nbsp; function &_get_handler($file)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; $ext = strtolower(strrchr($file, '.'));<BR>&nbsp;&nbsp;&nbsp; $ret = false;<BR>&nbsp;&nbsp;&nbsp; if ($ext == '.mp3')<BR>&nbsp;&nbsp;&nbsp; {&nbsp; // MP3<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $ret = &$this-&gt;_mp3;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!$ret) $ret = new _Mp3Exif();<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; else if ($ext == '.wma')<BR>&nbsp;&nbsp;&nbsp; {&nbsp; // wma<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $ret = &$this-&gt;_wma;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!$ret) $ret = new _WmaExif();<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; else<BR>&nbsp;&nbsp;&nbsp; {&nbsp; // unknown<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; trigger_error('AudioExif not supported `' . $ext . '` file.', E_USER_WARNING);<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; return $ret;<BR>&nbsp; }<BR>}<BR>// DBCS =&gt; gb2312<BR>function dbcs_gbk($str)<BR>{<BR>&nbsp; // strip the last ""<BR>&nbsp; $str = substr($str, 0, -2);<BR>&nbsp; return mb_convert_encoding($str, 'GBK', 'UCS-2LE');<BR>}<BR>// gb2312 =&gt; DBCS<BR>function gbk_dbcs($str)<BR>{<BR>&nbsp; $str&nbsp; = mb_convert_encoding($str, 'UCS-2LE', 'GBK');<BR>&nbsp; $str .= "";<BR>&nbsp; return $str;<BR>}<BR>// file exif<BR>class _AudioExif<BR>{<BR>&nbsp; var $fd;<BR>&nbsp; var $head;<BR>&nbsp; var $head_off;<BR>&nbsp; var $head_buf;<br><br>&nbsp; // init the file handler<BR>&nbsp; function _file_init($fpath, $write = false)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; $mode = ($write ? 'rb+' : 'rb');<BR>&nbsp;&nbsp;&nbsp; $this-&gt;fd = @fopen($fpath, $mode);<BR>&nbsp;&nbsp;&nbsp; if (!$this-&gt;fd)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; trigger_error('AudioExif: `' . $fpath . '` can not be opened with mode `' . $mode . '`', E_USER_WARNING);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return false;<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; $this-&gt;head = false;<BR>&nbsp;&nbsp;&nbsp; $this-&gt;head_off = 0;<BR>&nbsp;&nbsp;&nbsp; $this-&gt;head_buf = '';<BR>&nbsp;&nbsp;&nbsp; return true;<BR>&nbsp; }<BR>&nbsp; // read buffer from the head_buf & move the off pointer<BR>&nbsp; function _read_head_buf($len)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; if ($len &lt;= 0) return NULL;<BR>&nbsp;&nbsp;&nbsp; $buf = substr($this-&gt;head_buf, $this-&gt;head_off, $len);<BR>&nbsp;&nbsp;&nbsp; $this-&gt;head_off += strlen($buf);<BR>&nbsp;&nbsp;&nbsp; return $buf;<BR>&nbsp; }<BR>&nbsp; // read one short value<BR>&nbsp; function _read_head_short()<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; $ord1 = ord(substr($this-&gt;head_buf, $this-&gt;head_off, 1));<BR>&nbsp;&nbsp;&nbsp; $ord2 = ord(substr($this-&gt;head_buf, $this-&gt;head_off+1, 1));<BR>&nbsp;&nbsp;&nbsp; $this-&gt;head_off += 2;<BR>&nbsp;&nbsp;&nbsp; return ($ord1 + ($ord2&lt;&lt;8));<BR>&nbsp; }<BR>&nbsp; // save the file head<BR>&nbsp; function _file_save($head, $olen, $nlen = 0)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; if ($nlen == 0) $nlen = strlen($head);<BR>&nbsp;&nbsp;&nbsp; if ($nlen == $olen)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // shorter<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; flock($this-&gt;fd, LOCK_EX);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fseek($this-&gt;fd, 0, SEEK_SET);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fwrite($this-&gt;fd, $head, $nlen);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; flock($this-&gt;fd, LOCK_UN);<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; else<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // longer, buffer required<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $stat = fstat($this-&gt;fd);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $fsize = $stat['size'];<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // buf required (4096?) 应该不会 nlen - olen &gt; 4096 吧<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $woff = 0;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $roff = $olen;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // read first buffer<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; flock($this-&gt;fd, LOCK_EX);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fseek($this-&gt;fd, $roff, SEEK_SET);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $buf = fread($this-&gt;fd, 4096);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // seek to start<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fseek($this-&gt;fd, $woff, SEEK_SET);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fwrite($this-&gt;fd, $head, $nlen);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $woff += $nlen;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // seek to woff & write the data<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $buf2 = $buf;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $roff += 4096;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($roff &lt; $fsize)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fseek($this-&gt;fd, $roff, SEEK_SET);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $buf = fread($this-&gt;fd, 4096);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // save last buffer<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $len2 = strlen($buf2);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fseek($this-&gt;fd, $woff, SEEK_SET);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fwrite($this-&gt;fd, $buf2, $len2);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $woff += $len2;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while ($roff &lt; $fsize);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ftruncate($this-&gt;fd, $woff);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; flock($this-&gt;fd, LOCK_UN);<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR>&nbsp; // close the file<BR>&nbsp; function _file_deinit()<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; if ($this-&gt;fd)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fclose($this-&gt;fd);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $this-&gt;fd = false;<BR>&nbsp;&nbsp;&nbsp; }&nbsp; <BR>&nbsp; }<BR>}<BR>// wma class<BR>class _WmaExif extends _AudioExif<BR>{<BR>&nbsp; var $items1 = array('Title', 'Artist', 'Copyright', 'Description', 'Reserved');<BR>&nbsp; var $items2 = array('Year', 'Genre', 'AlbumTitle');<BR>&nbsp; // check file size (length) maybe invalid file<BR>&nbsp; function check_size($file)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; $ret = false;<BR>&nbsp;&nbsp;&nbsp; if (!$this-&gt;_file_init($file)) return true;<BR>&nbsp;&nbsp;&nbsp; if ($this-&gt;_init_header())<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $buf = fread($this-&gt;fd, 24);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $tmp = unpack('H32id/Vlen/H8unused', $buf); <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($tmp['id'] == '3626b2758e66cf11a6d900aa0062ce6c')<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $stat = fstat($this-&gt;fd);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $ret = ($stat['size'] == ($this-&gt;head['len'] + $tmp['len']));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; $this-&gt;_file_deinit();<BR>&nbsp;&nbsp;&nbsp; return $ret;<BR>&nbsp; }<BR>&nbsp; // set info (save the infos)<BR>&nbsp; function set_info($file, $pa)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; // check the pa<BR>&nbsp;&nbsp;&nbsp; settype($pa, 'array');<BR>&nbsp;&nbsp;&nbsp; if (!$this-&gt;_file_init($file, true)) return false;<BR>&nbsp;&nbsp;&nbsp; if (!$this-&gt;_init_header())<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $this-&gt;_file_deinit();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return false;<BR>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; // parse the old header & generate the new header<BR>&nbsp;&nbsp;&nbsp; $head_body = '';<BR>&nbsp;&nbsp;&nbsp; $st_found = $ex_found = false;<BR>&nbsp;&nbsp;&nbsp; $head_num = $this-&gt;head['num'];<BR>&nbsp;&nbsp;&nbsp; while (($tmp = $this-&gt;_get_head_frame()) && ($head_num &gt; 0))<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $head_num--;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($tmp['id'] == '3326b2758e66cf11a6d900aa0062ce6c')<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp; // Standard Info<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // 1-4<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $st_found = true;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $st_body1 = $st_body2 = '';&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $lenx = unpack('v5', $this-&gt;_read_head_buf(10));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $tmp['len'] -= 34;&nbsp; // 10 + 24<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for ($i = 0; $i &lt; count($this-&gt;items1); $i++)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $l = $lenx[$i+1];<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $k = $this-&gt;items1[$i];<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $tmp['len'] -= $l;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $data = $this-&gt;_read_head_buf($l);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (isset($pa[$k])) $data = gbk_dbcs($pa[$k]);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $st_body2 .= $data;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $st_body1 .= pack('v', strlen($data));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // left length<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($tmp['len'] &gt; 0) $st_body2 .= $this-&gt;_read_head_buf($tmp['len']);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // save to head_body<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $head_body .= pack('H32VH8', $tmp['id'], strlen($st_body1 . $st_body2)+24, $tmp['unused']);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $head_body .= $st_body1 . $st_body2;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else if ($tmp['id'] == '40a4d0d207e3d21197f000a0c95ea850')<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp; // extended info<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $ex_found = true;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $inum = $this-&gt;_read_head_short();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $inum2 = $inum;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $tmp['len'] -= 26;&nbsp; // 24 + 2<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $et_body = '';<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while ($tmp['len'] &gt; 0 && $inum &gt; 0)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // attribute name<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $nlen = $this-&gt;_read_head_short();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $nbuf = $this-&gt;_read_head_buf($nlen);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // the flag & value&nbsp; length<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $flag = $this-&gt;_read_head_short();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $vlen = $this-&gt;_read_head_short();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $vbuf = $this-&gt;_read_head_buf($vlen);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // set the length<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $tmp['len'] -= (6 + $nlen + $vlen);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $inum--;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // save the data?<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $name = dbcs_gbk($nbuf);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $k = substr($name, 3);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (in_array($k, $this-&gt;items2) && isset($pa[$k]))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $vbuf = gbk_dbcs($pa[$k]);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $vlen = strlen($vbuf);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; unset($pa[$k]);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $et_body .= pack('v', $nlen) . $nbuf . pack('vv', $flag, $vlen) . $vbuf;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // new tag insert??<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach ($this-&gt;items2 as $k)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (isset($pa[$k]))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $inum2++;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $nbuf = gbk_dbcs('WM/' . $k);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $nlen = strlen($nbuf);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $vbuf = gbk_dbcs($pa[$k]);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $vlen = strlen($vbuf);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $et_body .= pack('v', $nlen) . $nbuf . pack('vv', 0, $vlen) . $vbuf;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // left buf?<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($tmp['len'] &gt; 0) $et_body .= $this-&gt;_read_head_buf($tmp['len']);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // save to head_body<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $head_body .= pack('H32VH8v', $tmp['id'], strlen($et_body)+26, $tmp['unused'], $inum2);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $head_body .= $et_body;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // just keep other head frame<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $head_body .= pack('H32VH8', $tmp['id'], $tmp['len'], $tmp['unused']);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($tmp['len'] &gt; 24) $head_body .= $this-&gt;_read_head_buf($tmp['len']-24);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; // st not found?<BR>&nbsp;&nbsp;&nbsp; if (!$st_found)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $st_body1 = $st_body2 = '';<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach ($this-&gt;items1 as $k)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $data = (isset($pa[$k]) ? gbk_dbcs($pa[$k]) : "");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $st_body1 .= pack('v', strlen($data));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $st_body2 .= $data;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // save to head_body<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $head_body .= pack('H32Va4', '3326b2758e66cf11a6d900aa0062ce6c', strlen($st_body1 . $st_body2)+24, '');<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $head_body .= $st_body1 . $st_body2;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $this-&gt;head['num']++;<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; // ex not found?<BR>&nbsp;&nbsp;&nbsp; if (!$ex_found)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $inum = 0;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $et_body = '';<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach ($this-&gt;items2 as $k)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $nbuf = gbk_dbcs('WM/' . $k);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $vbuf = (isset($pa[$k]) ? gbk_dbcs($pa[$k]) : "");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $et_body .= pack('v', strlen($nbuf)) . $nbuf . pack('vv', 0, strlen($vbuf)) . $vbuf;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $inum++;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $head_body .= pack('H32Va4v', '40a4d0d207e3d21197f000a0c95ea850', strlen($et_body)+26, '', $inum);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $head_body .= $et_body;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $this-&gt;head['num']++;<BR>&nbsp;&nbsp;&nbsp; }&nbsp; <BR>&nbsp;&nbsp;&nbsp; // after save<BR>&nbsp;&nbsp;&nbsp; $new_len = strlen($head_body) + 30;<BR>&nbsp;&nbsp;&nbsp; $old_len = $this-&gt;head['len'];<BR>&nbsp;&nbsp;&nbsp; if ($new_len &lt; $old_len)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $head_body .= str_repeat("", $old_len - $new_len);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $new_len = $old_len;<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; $tmp = $this-&gt;head;<BR>&nbsp;&nbsp;&nbsp; $head_buf = pack('H32VVVH4', $tmp['id'], $new_len, $tmp['len2'], $tmp['num'], $tmp['unused']);<BR>&nbsp;&nbsp;&nbsp; $head_buf .= $head_body;<BR>&nbsp;&nbsp;&nbsp; $this-&gt;_file_save($head_buf, $old_len, $new_len);<BR>&nbsp;&nbsp;&nbsp; // close the file & return<BR>&nbsp;&nbsp;&nbsp; $this-&gt;_file_deinit();<BR>&nbsp;&nbsp;&nbsp; return true;<BR>&nbsp; }<BR>&nbsp; // get info<BR>&nbsp; function get_info($file)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; $ret = array();<BR>&nbsp;&nbsp;&nbsp; if (!$this-&gt;_file_init($file)) return false;<BR>&nbsp;&nbsp;&nbsp; if (!$this-&gt;_init_header())<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $this-&gt;_file_deinit();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return false;<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; // get the data from head_buf<BR>&nbsp;&nbsp;&nbsp; $head_num = $this-&gt;head['num'];&nbsp; // num of head_frame<BR>&nbsp;&nbsp;&nbsp; while (($tmp = $this-&gt;_get_head_frame()) && $head_num &gt; 0)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $head_num--;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($tmp['id'] == '3326b2758e66cf11a6d900aa0062ce6c')<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp; // Standard Info<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $lenx = unpack('v*', $this-&gt;_read_head_buf(10));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for ($i = 1; $i &lt;= count($this-&gt;items1); $i++)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $k = $this-&gt;items1[$i-1];<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $ret[$k] = dbcs_gbk($this-&gt;_read_head_buf($lenx[$i]));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else if ($tmp['id'] == '40a4d0d207e3d21197f000a0c95ea850')<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp; // Extended Info<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $inum = $this-&gt;_read_head_short();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $tmp['len'] -= 26;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while ($inum &gt; 0 && $tmp['len'] &gt; 0)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // attribute name<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $nlen = $this-&gt;_read_head_short();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $nbuf = $this-&gt;_read_head_buf($nlen);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // the flag & value&nbsp; length<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $flag = $this-&gt;_read_head_short();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $vlen = $this-&gt;_read_head_short();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $vbuf = $this-&gt;_read_head_buf($vlen);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // update the XX<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $tmp['len'] -= (6 + $nlen + $vlen);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $inum--;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $name = dbcs_gbk($nbuf);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $k = substr($name, 3);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (in_array($k, $this-&gt;items2))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp; // all is string value (refer to falg for other tags)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $ret[$k] = dbcs_gbk($vbuf);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp; // skip only<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($tmp['len'] &gt; 24) $this-&gt;head_off += ($tmp['len'] - 24);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; $this-&gt;_file_deinit();<BR>&nbsp;&nbsp;&nbsp; return $ret;<BR>&nbsp; }<BR>&nbsp; // get the header?<BR>&nbsp; function _init_header()<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; fseek($this-&gt;fd, 0, SEEK_SET);<BR>&nbsp;&nbsp;&nbsp; $buf = fread($this-&gt;fd, 30);<BR>&nbsp;&nbsp;&nbsp; if (strlen($buf) != 30) return false;<BR>&nbsp;&nbsp;&nbsp; $tmp = unpack('H32id/Vlen/Vlen2/Vnum/H4unused', $buf);<BR>&nbsp;&nbsp;&nbsp; if ($tmp['id'] != '3026b2758e66cf11a6d900aa0062ce6c')<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return false;<BR>&nbsp;&nbsp;&nbsp; $this-&gt;head_buf = fread($this-&gt;fd, $tmp['len'] - 30);<BR>&nbsp;&nbsp;&nbsp; $this-&gt;head = $tmp;<BR>&nbsp;&nbsp;&nbsp; return true;<BR>&nbsp; }<BR>&nbsp; // _get_head_frame()<BR>&nbsp; function _get_head_frame()<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; $buf = $this-&gt;_read_head_buf(24);&nbsp; <BR>&nbsp;&nbsp;&nbsp; if (strlen($buf) != 24) return false;<BR>&nbsp;&nbsp;&nbsp; $tmp = unpack('H32id/Vlen/H8unused', $buf);<BR>&nbsp;&nbsp;&nbsp; return $tmp;<BR>&nbsp; }<BR>}<BR>// mp3 class (if not IDv2 then select IDv1)<BR>class _Mp3Exif extends _AudioExif<BR>{<BR>&nbsp; var $head1;<BR>&nbsp; var $genres = array('Blues','Classic Rock','Country','Dance','Disco','Funk','Grunge','Hip-Hop','Jazz','Metal','New Age','Oldies','Other','Pop','R&B','Rap','Reggae','Rock','Techno','Industrial','Alternative','Ska','Death Metal','Pranks','Soundtrack','Euro-Techno','Ambient','Trip-Hop','Vocal','Jazz+Funk','Fusion','Trance','Classical','Instrumental','Acid','House','Game','Sound Clip','Gospel','Noise','AlternRock','Bass','Soul','Punk','Space','Meditative','Instrumental Pop','Instrumental Rock','Ethnic','Gothic','Darkwave','Techno-Industrial','Electronic','Pop-Folk','Eurodance','Dream','Southern Rock','Comedy','Cult','Gangsta','Top 40','Christian Rap','Pop/Funk','Jungle','Native American','Cabaret','New Wave','Psychadelic','Rave','Showtunes','Trailer','Lo-Fi','Tribal','Acid Punk','Acid Jazz','Polka','Retro','Musical','Rock & Roll','Hard Rock','Unknown');<BR>&nbsp; // MP3 always return true<BR>&nbsp; function check_size($file)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; return true;<BR>&nbsp; }<BR>&nbsp; // get info<BR>&nbsp; function get_info($file)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; if (!$this-&gt;_file_init($file)) return false;&nbsp; <BR>&nbsp;&nbsp;&nbsp; $ret = false;<BR>&nbsp;&nbsp;&nbsp; if ($this-&gt;_init_header())<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $ret = ($this-&gt;head ? $this-&gt;_get_v2_info() : $this-&gt;_get_v1_info());<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $ret['meta'] = $this-&gt;_get_meta_info();<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; $this-&gt;_file_deinit();<BR>&nbsp;&nbsp;&nbsp; return $ret;<BR>&nbsp; }<BR>&nbsp; // set info<BR>&nbsp; function set_info($file, $pa)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; if (!$this-&gt;_file_init($file, true)) return false;<BR>&nbsp;&nbsp;&nbsp; if ($this-&gt;_init_header())<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // always save v1 info<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $this-&gt;_set_v1_info($pa);&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // set v2 first if need<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $this-&gt;_set_v2_info($pa);<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; $this-&gt;_file_deinit();<BR>&nbsp;&nbsp;&nbsp; return true;<BR>&nbsp; }<BR>&nbsp; // get the header information[v1+v2], call after file_init<BR>&nbsp; function _init_header()<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; $this-&gt;head1 = false;<BR>&nbsp;&nbsp;&nbsp; $this-&gt;head = false;<BR>&nbsp;&nbsp;&nbsp; // try to get ID3v1 first<BR>&nbsp;&nbsp;&nbsp; fseek($this-&gt;fd, -128, SEEK_END);<BR>&nbsp;&nbsp;&nbsp; $buf = fread($this-&gt;fd, 128);<BR>&nbsp;&nbsp;&nbsp; if (strlen($buf) == 128 && substr($buf, 0, 3) == 'TAG')<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $tmp = unpack('a3id/a30Title/a30Artist/a30AlbumTitle/a4Year/a28Description/CReserved/CTrack/CGenre', $buf);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $this-&gt;head1 = $tmp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; // try to get ID3v2<BR>&nbsp;&nbsp;&nbsp; fseek($this-&gt;fd, 0, SEEK_SET);<BR>&nbsp;&nbsp;&nbsp; $buf = fread($this-&gt;fd, 10);<BR>&nbsp;&nbsp;&nbsp; if (strlen($buf) == 10 && substr($buf, 0, 3) == 'ID3')<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $tmp = unpack('a3id/Cver/Crev/Cflag/C4size', $buf);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $tmp['size'] = ($tmp['size1']&lt;&lt;21)|($tmp['size2']&lt;&lt;14)|($tmp['size3']&lt;&lt;7)|$tmp['size4'];<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; unset($tmp['size1'], $tmp['size2'], $tmp['size3'], $tmp['size4']);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $this-&gt;head = $tmp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $this-&gt;head_buf = fread($this-&gt;fd, $tmp['size']);<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; return ($this-&gt;head1 || $this-&gt;head);<BR>&nbsp; }<BR>&nbsp; // get v1 info<BR>&nbsp; function _get_v1_info()<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; $ret = array();<BR>&nbsp;&nbsp;&nbsp; $tmpa = array('Title', 'Artist', 'Copyright', 'Description', 'Year', 'AlbumTitle');<BR>&nbsp;&nbsp;&nbsp; foreach ($tmpa as $tmp)<BR>&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $ret[$tmp] = $this-&gt;head1[$tmp];<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($pos = strpos($ret[$tmp], ""))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $ret[$tmp] = substr($ret[$tmp], 0, $pos);<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; // count the Genre, [Track]<BR>&nbsp;&nbsp;&nbsp; if ($this-&gt;head1['Reserved'] == 0) $ret['Track'] = $this-&gt;head1['Track'];<BR>&nbsp;&nbsp;&nbsp; else $ret['Description'] .= chr($ret['Reserved']) . chr($ret['Track']);<BR>&nbsp;&nbsp;&nbsp; // Genre_idx<BR>&nbsp;&nbsp;&nbsp; $g = $this-&gt;head1['Genre'];<BR>&nbsp;&nbsp;&nbsp; if (!isset($this-&gt;genres[$g])) $ret['Genre'] = 'Unknown';<BR>&nbsp;&nbsp;&nbsp; else $ret['Genre'] = $this-&gt;genres[$g];<BR>&nbsp;&nbsp;&nbsp; // return the value<BR>&nbsp;&nbsp;&nbsp; $ret['ID3v1'] = 'yes';<BR>&nbsp;&nbsp;&nbsp; return $ret;<BR>&nbsp; }<BR>&nbsp; // get v2 info<BR>&nbsp; function _get_v2_info()<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; $ret = array();<BR>&nbsp;&nbsp;&nbsp; $items = array(&nbsp; 'TCOP'=&gt;'Copyright', 'TPE1'=&gt;'Artist', 'TIT2'=&gt;'Title', 'TRCK'=&gt; 'Track',<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'TCON'=&gt;'Genre', 'COMM'=&gt;'Description', 'TYER'=&gt;'Year', 'TALB'=&gt;'AlbumTitle');<BR>&nbsp;&nbsp;&nbsp; while (true)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $buf = $this-&gt;_read_head_buf(10);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (strlen($buf) != 10) break;&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $tmp = unpack('a4fid/Nsize/nflag', $buf);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($tmp['size'] == 0) break;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $tmp['dat'] = $this-&gt;_read_head_buf($tmp['size']);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // 0x6000 (11000000 00000000)&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($tmp['flag'] & 0x6000) continue;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // mapping the data<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($k = $items[$tmp['fid']])<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp; // If first char is "", just skip<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (substr($tmp['dat'], 0, 1) == "") $tmp['dat'] = substr($tmp['dat'], 1);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $ret[$k] = $tmp['dat'];<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; // reset the genre<BR>&nbsp;&nbsp;&nbsp; if ($g = $ret['Genre'])<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (substr($g,0,1) == '(' && substr($g,-1,1) == ')') $g = substr($g, 1, -1);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (is_numeric($g))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $g = intval($g);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $ret['Genre'] = (isset($this-&gt;genres[$g]) ? $this-&gt;genres[$g] : 'Unknown');<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; $ret['ID3v1'] = 'no';<BR>&nbsp;&nbsp;&nbsp; return $ret;<BR>&nbsp; }<BR>&nbsp; // get meta info of MP3<BR>&nbsp; function _get_meta_info()<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; // seek to the lead buf: 0xff<BR>&nbsp;&nbsp;&nbsp; $off = 0;<BR>&nbsp;&nbsp;&nbsp; if ($this-&gt;head) $off = $this-&gt;head['size'] + 10;<BR>&nbsp;&nbsp;&nbsp; fseek($this-&gt;fd, $off, SEEK_SET);<BR>&nbsp;&nbsp;&nbsp; while (!feof($this-&gt;fd))<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $skip = ord(fread($this-&gt;fd, 1));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($skip == 0xff) break;<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; if ($skip != 0xff) return false;<BR>&nbsp;&nbsp;&nbsp; $buf = fread($this-&gt;fd, 3);<BR>&nbsp;&nbsp;&nbsp; if (strlen($buf) != 3) return false;<BR>&nbsp;&nbsp;&nbsp; $tmp = unpack('C3', $buf);<BR>&nbsp;&nbsp;&nbsp; if (($tmp[1] & 0xf0) != 0xf0) return false;<BR>&nbsp;&nbsp;&nbsp; // get the meta info<BR>&nbsp;&nbsp;&nbsp; $meta = array();<BR>&nbsp;&nbsp;&nbsp; // get mpeg version<BR>&nbsp;&nbsp;&nbsp; $meta['mpeg']&nbsp; = ($tmp[1] & 0x08 ? 1 : 2);<BR>&nbsp;&nbsp;&nbsp; $meta['layer']&nbsp; = ($tmp[1] & 0x04) ? (($tmp[1] & 0x02) ? 1 : 2) : (($tmp[1] & 0x02) ? 3 : 0);<BR>&nbsp;&nbsp;&nbsp; $meta['epro']&nbsp; = ($tmp[1] & 0x01) ? 'no' : 'yes';<BR>&nbsp;&nbsp;&nbsp; // bit rates<BR>&nbsp;&nbsp;&nbsp; $bit_rates = array(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 =&gt; array(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 =&gt; array(0,32,64,96,128,160,192,224,256,288,320,352,384,416,448,0),<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 =&gt; array(0,32,48,56,64,80,96,112,128,160,192,224,256,320,384,0),<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3 =&gt; array(0,32,40,48,56,64,80,96,112,128,160,192,224,256,320,0)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ),<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 =&gt; array(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 =&gt; array(0,32,48,56,64,80,96,112,128,144,160,176,192,224,256,0),<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 =&gt; array(0,8,16,24,32,40,48,56,64,80,96,112,128,144,160,0),<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3 =&gt; array(0,8,16,24,32,40,48,56,64,80,96,112,128,144,160,0)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; )<BR>&nbsp;&nbsp;&nbsp; );<BR>&nbsp;&nbsp;&nbsp; $i = $meta['mpeg'];<BR>&nbsp;&nbsp;&nbsp; $j = $meta['layer'];<BR>&nbsp;&nbsp;&nbsp; $k = ($tmp[2]&gt;&gt;4);<BR>&nbsp;&nbsp;&nbsp; $meta['bitrate'] = $bit_rates[$i][$j][$k];<BR>&nbsp;&nbsp;&nbsp; // sample rates &lt;采样率&gt;<BR>&nbsp;&nbsp;&nbsp; $sam_rates = array(1=&gt;array(44100,48000,32000,0), 2=&gt;array(22050,24000,16000,0));<BR>&nbsp;&nbsp;&nbsp; $meta['samrate'] = $sam_rates[$i][$k];<BR>&nbsp;&nbsp;&nbsp; $meta["padding"] = ($tmp[2] & 0x02) ? 'on' : 'off';<BR>&nbsp;&nbsp;&nbsp; $meta["private"] = ($tmp[2] & 0x01) ? 'on' : 'off';<BR>&nbsp;&nbsp;&nbsp; // mode & mode_ext<BR>&nbsp;&nbsp;&nbsp; $k = ($tmp[3]&gt;&gt;6);<BR>&nbsp;&nbsp;&nbsp; $channel_modes = array('stereo', 'joint stereo', 'dual channel', 'single channel');<BR>&nbsp;&nbsp;&nbsp; $meta['mode'] = $channel_modes[$k];<BR>&nbsp;&nbsp;&nbsp; $k = (($tmp[3]&gt;&gt;4) & 0x03);<BR>&nbsp;&nbsp;&nbsp; $extend_modes = array('MPG_MD_LR_LR', 'MPG_MD_LR_I', 'MPG_MD_MS_LR', 'MPG_MD_MS_I');<BR>&nbsp;&nbsp;&nbsp; $meta['ext_mode'] = $extend_modes[$k];<BR>&nbsp;&nbsp;&nbsp; $meta['copyright'] = ($tmp[3] & 0x08) ? 'yes' : 'no';<BR>&nbsp;&nbsp;&nbsp; $meta['original'] = ($tmp[3] & 0x04) ? 'yes' : 'no';<BR>&nbsp;&nbsp;&nbsp; $emphasis = array('none', '50/15 microsecs', 'rreserved', 'CCITT J 17');<BR>&nbsp;&nbsp;&nbsp; $k = ($tmp[3] & 0x03);<BR>&nbsp;&nbsp;&nbsp; $meta['emphasis'] = $emphasis[$k];<BR>&nbsp;&nbsp;&nbsp; return $meta;<BR>&nbsp; }<BR>&nbsp; // set v1 info<BR>&nbsp; function _set_v1_info($pa)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; // ID3v1 (simpled)<BR>&nbsp;&nbsp;&nbsp; $off = -128;<BR>&nbsp;&nbsp;&nbsp; if (!($tmp = $this-&gt;head1))<BR>&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $off = 0;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $tmp['id'] = 'TAG';<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $tmp['Title'] = $tmp['Artist'] = $tmp['AlbumTitle'] = $tmp['Year'] = $tmp['Description'] = '';<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $tmp['Reserved'] = $tmp['Track'] = $tmp['Genre'] = 0;<BR>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; // basic items<BR>&nbsp;&nbsp;&nbsp; $items = array('Title', 'Artist', 'Copyright', 'Description', 'Year', 'AlbumTitle');<BR>&nbsp;&nbsp;&nbsp; foreach ($items as $k)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (isset($pa[$k])) $tmp[$k] = $pa[$k];<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; // genre index<BR>&nbsp;&nbsp;&nbsp; if (isset($pa['Genre']))<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $g = 0;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach ($this-&gt;genres as $gtmp)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!strcasecmp($gtmp, $pa['Genre']))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $g++;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $tmp['Genre'] = $g;<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; if (isset($pa['Track'])) $tmp['Track'] = intval($pa['Track']);<BR>&nbsp;&nbsp;&nbsp; // pack the data<BR>&nbsp;&nbsp;&nbsp; $buf = pack('a3a30a30a30a4a28CCC',&nbsp; $tmp['id'], $tmp['Title'], $tmp['Artist'], $tmp['AlbumTitle'],<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $tmp['Year'], $tmp['Description'], 0, $tmp['Track'], $tmp['Genre']);<BR>&nbsp;&nbsp;&nbsp; flock($this-&gt;fd, LOCK_EX);<BR>&nbsp;&nbsp;&nbsp; fseek($this-&gt;fd, $off, SEEK_END);<BR>&nbsp;&nbsp;&nbsp; fwrite($this-&gt;fd, $buf, 128);<BR>&nbsp;&nbsp;&nbsp; flock($this-&gt;fd, LOCK_UN);<BR>&nbsp; }<BR>&nbsp; // set v2 info<BR>&nbsp; function _set_v2_info($pa)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; if (!$this-&gt;head)<BR>&nbsp;&nbsp;&nbsp; {&nbsp; // insert ID3<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;&nbsp; // 没有就算了<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /**<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $tmp = array('id'=&gt;'ID3','ver'=&gt;3,'rev'=&gt;0,'flag'=&gt;0);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $tmp['size'] = -10;&nbsp; // +10 =&gt; 0<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $this-&gt;head = $tmp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $this-&gt;head_buf = '';<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $this-&gt;head_off = 0;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; **/<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; $items = array(&nbsp; 'TCOP'=&gt;'Copyright', 'TPE1'=&gt;'Artist', 'TIT2'=&gt;'Title', 'TRAC'=&gt;'Track',<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'TCON'=&gt;'Genre', 'COMM'=&gt;'Description', 'TYER'=&gt;'Year', 'TALB'=&gt;'AlbumTitle');<BR>&nbsp;&nbsp;&nbsp; $head_body = '';<BR>&nbsp;&nbsp;&nbsp; while (true)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $buf = $this-&gt;_read_head_buf(10);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (strlen($buf) != 10) break;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $tmp = unpack('a4fid/Nsize/nflag', $buf);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($tmp['size'] == 0) break;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $data = $this-&gt;_read_head_buf($tmp['size']);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (($k = $items[$tmp['fid']]) && isset($pa[$k]))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // the data should prefix by "" [replace]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $data = "" . $pa[$k];<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; unset($pa[$k]);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $head_body .= pack('a4Nn', $tmp['fid'], strlen($data), $tmp['flag']) . $data;<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; // reverse the items & set the new tags<BR>&nbsp;&nbsp;&nbsp; $items = array_flip($items);<BR>&nbsp;&nbsp;&nbsp; foreach ($pa as $k =&gt; $v)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($fid = $items[$k])<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $head_body .= pack('a4Nn', $fid, strlen($v) + 1, 0) . "" . $v;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; // new length<BR>&nbsp;&nbsp;&nbsp; $new_len = strlen($head_body) + 10;<BR>&nbsp;&nbsp;&nbsp; $old_len = $this-&gt;head['size'] + 10;<BR>&nbsp;&nbsp;&nbsp; if ($new_len &lt; $old_len)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $head_body .= str_repeat("", $old_len - $new_len);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $new_len = $old_len;&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; // count the size1,2,3,4, no include the header<BR>&nbsp;&nbsp;&nbsp; // 较为变态的算法... :p (28bytes integer)<BR>&nbsp;&nbsp;&nbsp; $size = array();<BR>&nbsp;&nbsp;&nbsp; $nlen = $new_len - 10;<BR>&nbsp;&nbsp;&nbsp; for ($i = 4; $i &gt; 0; $i--)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $size[$i] = ($nlen & 0x7f);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $nlen &gt;&gt;= 7;<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; $tmp = $this-&gt;head;<BR>&nbsp;&nbsp;&nbsp; //echo "old_len : $old_len new_len: $new_len ";<BR>&nbsp;&nbsp;&nbsp; $head_buf = pack('a3CCCCCCC', $tmp['id'], $tmp['ver'], $tmp['rev'], $tmp['flag'],<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $size[1], $size[2], $size[3], $size[4]);<BR>&nbsp;&nbsp;&nbsp; $head_buf .= $head_body;<BR>&nbsp;&nbsp;&nbsp; $this-&gt;_file_save($head_buf, $old_len, $new_len);<BR>&nbsp; }<BR>}<BR>?&gt;<BR></div>
<hr></span>                                     
		    	</div>
		    	<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>代码注释</div>
			    <div class="panel-content">
			    <span></span>                                     
		    	</div>

			</div>

			<!-- END ROW -->
			<div class="newsPage">
				<div class="newsPageTurn">
				    <span><a>上一篇</a><a href='/php/biji/85657.html'>JS获取时间的方法</a><a>下一篇</a><a href='/php/biji/85659.html'>javascript中定义类的方法详解</a></span>
				</div>
			</div>
		</div>


<div id="author-box">
    <h3>作者：喵哥笔记</h3>
        <div class="author-info">
            <div class="author-avatar">
                <img src="/skin1/picture/01.jpg" alt="IDC笔记" class="avatar" width="64" height="64">
            </div>
        <div class="author-description">
            <p>学的不仅是技术，更是梦想！</p>
            <ul class="author-social follows nb">
            	<li>
                    <a target="_blank" href="/" title="IDC笔记">IDC笔记</a>
                </li>
            </ul>
        </div>
        <div class="clear"></div>
    </div>
</div>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
<!-- container-fluid -->
	</div>
<!-- content -->
	<footer class="footer">
	© 2020 IDC笔记 <i class="mdi mdi-heart text-danger"></i>. | 备案号：<a href="https://beian.miit.gov.cn/">辽ICP备18000516号</a>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?674585fbbd2294d3faf910f668ea91b4";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

	</footer>
</div>

</div>
<!-- END wrapper -->
<!-- jQuery  -->
<script src="/skin1/js/jquery.min.js"></script>
<script src="/skin1/js/bootstrap.bundle.min.js"></script>
<script src="/skin1/js/metismenu.min.js"></script>
<script src="/skin1/js/jquery.slimscroll.js"></script>
<script src="/skin1/js/waves.min.js"></script>
<!--Morris Chart-->
<script src="/skin1/js/morris.min.js"></script>
<script src="/skin1/js/raphael.min.js"></script>
<script src="/skin1/js/dashboard.init.js"></script>
<script src="/skin1/js/app.js"></script>
<script src="/foot.js"></script>
</body>
</html>