<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <title>微信JS-SDK坐标位置如何转换为百度地图坐标_PHP教程_IDC笔记</title>
    <meta name="keywords" content="PHP,PHP笔记,PHP教程" />
    <meta name="description" content="微信JS-SDK开发过程中，使用getLocation获取坐标位置，如何将微信获取的坐标直接应用到百度地图中，显示以下效果：<br />
<br />
说明：红色图标是从微信转换过来的位置，蓝色图标是周边位置。首先" />
    <meta content="Responsive admin theme build on top of Bootstrap 4" name="description" />
    <meta content="idcnote.com" name="author" />
    <link rel="shortcut icon" href="/skin1/images/favicon.ico">
    <!--Morris Chart CSS -->
    <link rel="stylesheet" href="/skin1/css/morris.css">
    <link href="/skin1/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/metismenu.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/icons.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/style.css" rel="stylesheet" type="text/css">
<link href="/SyntaxHighlighter/shCoreDefault.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">
 SyntaxHighlighter.all();
</script>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
</head>
<body>
<!-- Begin page -->
		<div id="wrapper">
			<!-- Top Bar Start -->
			<div class="topbar">
				<!-- LOGO -->
				<div class="topbar-left">
					<a href="/" class="logo">
						<span class="logo-light">
                            <i class="mdi mdi-camera-control"></i>IDC笔记
                        </span>
						<span class="logo-sm">
                            <i class="mdi mdi-camera-control"></i>
                        </span>
					</a>
				</div>
				<nav class="navbar-custom">
					<ul class="navbar-right list-inline float-right mb-0">
						<!--<li class="dropdown notification-list list-inline-item d-none d-md-inline-block">
							<a class="nav-link waves-effect" href="#" id="btn-fullscreen">
								<i class="mdi mdi-arrow-expand-all noti-icon"></i>
							</a>
						</li>
						<li class="dropdown notification-list list-inline-item">
							<div class="dropdown notification-list nav-pro-img">
								<a class="dropdown-toggle nav-link arrow-none nav-user" data-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
									<img src="/skin1/picture/user-4.jpg" alt="user" class="rounded-circle">
								</a>
								<div class="dropdown-menu dropdown-menu-right profile-dropdown ">
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-account-circle"></i> Profile</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-wallet"></i> Wallet</a>
									<a class="dropdown-item d-block" href="#">
										<span class="badge badge-success float-right">11</span>
										<i class="mdi mdi-settings"></i> Settings</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-lock-open-outline"></i> Lock screen</a>
									<div class="dropdown-divider"></div>
									<a class="dropdown-item text-danger" href="#">
										<i class="mdi mdi-power text-danger"></i> Logout</a>
								</div>
							</div>
						</li>
						-->
					</ul>
					<ul class="list-inline menu-left mb-0">
						<li class="float-left">
							<button class="button-menu-mobile open-left waves-effect">
                            <i class="mdi mdi-menu"></i>
                        </button>
						</li>
						<li class="d-none d-md-inline-block">
							<form role="search" class="app-search">
								<div class="form-group mb-0">
									<input type="text" class="form-control" placeholder="Search..">
									<button type="submit"><i class="fa fa-search"></i></button>
								</div>
							</form>
						</li>
					</ul>
				</nav>
			</div>
<!-- ========== Left Sidebar Start ========== -->
<div class="left side-menu">
    <div class="slimscroll-menu" id="remove-scroll">
    <!--- Sidemenu -->
    <div id="sidebar-menu">
    <!-- Left Menu Start -->
    <ul class="metismenu" id="side-menu">
			<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP简介			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/jianjie/1.html">PHP简介</a></li><li><a href="/php/jianjie/2.html">PHP用途</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP基本语法			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yufa/3.html">分离HTML</a></li><li><a href="/php/yufa/4.html">指令分隔符</a></li><li><a href="/php/yufa/5.html">PHP注释</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP类型			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpleixing/6.html">PHP类型简介</a></li><li><a href="/php/phpleixing/7.html">PHP类型之布尔类型</a></li><li><a href="/php/phpleixing/8.html">PHP类型之整型</a></li><li><a href="/php/phpleixing/9.html">PHP类型之浮点型</a></li><li><a href="/php/phpleixing/10.html">PHP类型之字符串</a></li><li><a href="/php/phpleixing/11.html">PHP类型之数组</a></li><li><a href="/php/phpleixing/12.html">PHP类型之对象</a></li><li><a href="/php/phpleixing/13.html">PHP类型之资源类型</a></li><li><a href="/php/phpleixing/14.html">PHP类型之NULL</a></li><li><a href="/php/phpleixing/15.html">PHP类型之伪类型</a></li><li><a href="/php/phpleixing/16.html">PHP类型之类型判别</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP变量			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpbianliang/17.html">PHP变量之基础</a></li><li><a href="/php/phpbianliang/18.html">PHP变量之预定义变量</a></li><li><a href="/php/phpbianliang/19.html">PHP变量之变量范围</a></li><li><a href="/php/phpbianliang/20.html">PHP变量之可变变量</a></li><li><a href="/php/phpbianliang/21.html">PHP变量之外部变量</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP运算符			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yunsuanfu/22.html">PHP运算符优先级</a></li><li><a href="/php/yunsuanfu/23.html">算术运算符</a></li><li><a href="/php/yunsuanfu/24.html">赋值运算符</a></li><li><a href="/php/yunsuanfu/25.html">位运算符</a></li><li><a href="/php/yunsuanfu/26.html">比较运算符</a></li><li><a href="/php/yunsuanfu/27.html">错误控制运算符</a></li><li><a href="/php/yunsuanfu/28.html">执行运算符</a></li><li><a href="/php/yunsuanfu/29.html">递增/递减运算符</a></li><li><a href="/php/yunsuanfu/30.html">逻辑运算符</a></li><li><a href="/php/yunsuanfu/31.html">字符串运算符</a></li><li><a href="/php/yunsuanfu/32.html">数组运算符</a></li><li><a href="/php/yunsuanfu/33.html">类型运算符</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP控制结构			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/jiegou/34.html">PHP控制结构之if</a></li><li><a href="/php/jiegou/35.html">PHP控制结构之else</a></li><li><a href="/php/jiegou/36.html">PHP控制结构之elseif/else if</a></li><li><a href="/php/jiegou/37.html">PHP控制结构之替代语法</a></li><li><a href="/php/jiegou/38.html">PHP控制结构之while</a></li><li><a href="/php/jiegou/39.html">PHP控制结构之do-while</a></li><li><a href="/php/jiegou/40.html">PHP控制结构之for</a></li><li><a href="/php/jiegou/41.html">PHP控制结构之foreach</a></li><li><a href="/php/jiegou/42.html">PHP控制结构之break</a></li><li><a href="/php/jiegou/43.html">PHP控制结构之continue</a></li><li><a href="/php/jiegou/44.html">PHP控制结构之switch</a></li><li><a href="/php/jiegou/45.html">PHP控制结构之declare</a></li><li><a href="/php/jiegou/46.html">PHP控制结构之return</a></li><li><a href="/php/jiegou/47.html">PHP控制结构之require</a></li><li><a href="/php/jiegou/48.html">PHP控制结构之include</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP函数			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/hanshu/52.html">用户自定义函数</a></li><li><a href="/php/hanshu/53.html">函数的参数</a></li><li><a href="/php/hanshu/54.html">返回值</a></li><li><a href="/php/hanshu/55.html">可变函数</a></li><li><a href="/php/hanshu/56.html">内部（内置）函数</a></li><li><a href="/php/hanshu/57.html">匿名函数</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP类与对象			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpduixiang/58.html">类与对象前言</a></li><li><a href="/php/phpduixiang/59.html">基本概念</a></li><li><a href="/php/phpduixiang/60.html">属性</a></li><li><a href="/php/phpduixiang/61.html">类常量</a></li><li><a href="/php/phpduixiang/62.html">自动加载对象</a></li><li><a href="/php/phpduixiang/63.html">构造函数和析构函数</a></li><li><a href="/php/phpduixiang/64.html">访问控制</a></li><li><a href="/php/phpduixiang/65.html">对象继承</a></li><li><a href="/php/phpduixiang/66.html">Static关键字</a></li><li><a href="/php/phpduixiang/67.html">抽象类</a></li><li><a href="/php/phpduixiang/68.html">接口</a></li><li><a href="/php/phpduixiang/69.html">Traits</a></li><li><a href="/php/phpduixiang/70.html">重载</a></li><li><a href="/php/phpduixiang/71.html">对象迭代</a></li><li><a href="/php/phpduixiang/72.html">设计模式</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP异常处理			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/yichang/81.html">异常处理</a></li><li><a href="/php/yichang/82.html">扩展PHP内置的异常处理类</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> PHP函数库按分类			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpku/83.html">数组</a></li><li><a href="/php/phpku/84.html">Classes/Objects</a></li><li><a href="/php/phpku/85.html">Date/Time</a></li><li><a href="/php/phpku/86.html">Directories</a></li><li><a href="/php/phpku/87.html">错误处理</a></li><li><a href="/php/phpku/88.html">Program execution</a></li><li><a href="/php/phpku/89.html">Filesystem</a></li><li><a href="/php/phpku/90.html">Filter</a></li><li><a href="/php/phpku/91.html">Function Handling</a></li><li><a href="/php/phpku/92.html">PHP 选项/信息</a></li><li><a href="/php/phpku/93.html">Mail</a></li><li><a href="/php/phpku/94.html">Math</a></li><li><a href="/php/phpku/95.html">Misc.</a></li><li><a href="/php/phpku/96.html">Network</a></li><li><a href="/php/phpku/97.html">输出控制</a></li>		</ul>
	</li>
		<li>
		<a href="javascript:void(0);" class="waves-effect">
			<i class="icon-share"></i>
			<span> php基础			<span class="float-right menu-arrow">
			<i class="mdi mdi-chevron-right"></i>
			</span> 
			</span>
		</a>
		<ul class="submenu">
			 <li><a href="/php/phpbiji/108377.html"></a></li><li><a href="/php/phpbiji/108376.html"></a></li><li><a href="/php/phpbiji/108380.html"></a></li><li><a href="/php/phpbiji/108379.html"></a></li><li><a href="/php/phpbiji/108378.html"></a></li><li><a href="/php/phpbiji/108381.html"></a></li><li><a href="/php/phpbiji/108382.html"></a></li><li><a href="/php/phpbiji/108384.html"></a></li><li><a href="/php/phpbiji/108383.html"></a></li><li><a href="/php/phpbiji/108385.html"></a></li><li><a href="/php/phpbiji/108386.html"></a></li><li><a href="/php/phpbiji/108388.html"></a></li><li><a href="/php/phpbiji/108387.html"></a></li><li><a href="/php/phpbiji/108389.html"></a></li><li><a href="/php/phpbiji/108391.html"></a></li>		</ul>
	</li>
		<li>
	    <a href="/php/biji/" class="waves-effect">
		    <i class="icon-share"></i>
		    <span>PHP笔记
		       	<span class="float-right menu-arrow">
		       	<i class="mdi mdi-chevron-right"></i>
		       	</span>
		    </span>
	    </a>
	</li>
	</ul>
</div>
<!-- Sidebar -->
<div class="clearfix"></div>
</div>
<!-- Sidebar -left -->
</div>
<!-- Left Sidebar End -->
<!-- Start right Content here -->
<div class="content-page">
	<div class="content">
		<div class="container-fluid">
			<div class="page-title-box">
				<div class="row align-items-center">
					<div class="col-sm-6">
						<h1 class="page-title">微信JS-SDK坐标位置如何转换为百度地图坐标</h1>
					</div>
				</div>
				<!-- end row -->
			</div>
			<!-- end page-title -->
			<!-- START ROW -->
			<div class="panel panel-forbid">
				<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>内容摘要</div>
			    <div class="panel-content">
			    <span>微信JS-SDK开发过程中，使用getLocation获取坐标位置，如何将微信获取的坐标直接应用到百度地图中，显示以下效果：<br />
<br />
说明：红色图标是从微信转换过来的位置，蓝色图标是周边位置。首先</span>                                     
		    	</div>
			    <div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>文章正文</div>
			    <div class="panel-content">
			    <span><p>微信JS-SDK开发过程中，使用getLocation获取坐标位置，如何将微信获取的坐标直接应用到百度地图中，显示以下效果：</p>
<p style="text-align: center"></p>
<p>说明：红色图标是从微信转换过来的位置，蓝色图标是周边位置。首先从微信开发流程讲解。</p>
<p><strong>1、微信JS-SDK开发文档 </strong></p>
<p>首先进入官网的帮助文档：https://mp.weixin.qq.com/wiki&#63;t=resource/res_main&id=mp1421141115&token=&lang=zh_CN</p>
<p>可对文档进行详细的研读，要获取位置信息，分以下步骤：</p>
<p><strong>第一步：</strong>绑定域名</p>
<p>进入微信公众号，找到“公众号设置”菜单，进入“功能设置”面板，</p>
<p style="text-align: center"></p>
<p>点击“设置”可设置引用js的相关域名：</p>
<p style="text-align: center"></p>
<p><strong>第二步：</strong>引用官方js类库</p>
<p>在需要调用JS接口的页面引入如下JS文件，（支持https）：http://res.wx.qq.com/open/js/jweixin-1.0.0.js 。</p>
<p>引用页面是location.aspx，如下：<br />
</p>
<div class="phpstudycode">
<pre class="brush:xhtml;">
&lt;%@ Page Title="获取位置" Language="C#" AutoEventWireup="true" MasterPageFile="~/wxcrm/Site.Master" CodeFile="location.aspx.cs" Inherits="DTcms.Web.wxcrm.location" %&gt;

&lt;asp:Content ID="Content1" ContentPlaceHolderID="cphHead" runat="server"&gt;
 &lt;script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"&gt;&lt;/script&gt;
 &lt;script type="text/javascript"&gt;
  $("#mask").show();
  wx.config({
   debug: false, //开启调试模式，如为true，则弹出每个js函数调用情况
   appId: '&lt;%= ResultJsData.GetValue("appid") %&gt;', //必填，公众号的唯一标识
   timestamp: &lt;%= ResultJsData.GetValue("timestamp") %&gt;, //必填，生成签名的时间戳
   nonceStr: '&lt;%= ResultJsData.GetValue("noncestr") %&gt;', //必填，生成签名的随机串
   signature: '&lt;%= ResultJsData.GetValue("signature") %&gt;', //必填，签名
   jsApiList: [
    'checkJsApi',
    'onMenuShareTimeline',
    'onMenuShareAppMessage',
    'onMenuShareQQ',
    'onMenuShareWeibo',
    'hideMenuItems',
    'showMenuItems',
    'hideAllNonBaseMenuItem',
    'showAllNonBaseMenuItem',
    'translateVoice',
    'startRecord',
    'stopRecord',
    'onRecordEnd',
    'playVoice',
    'pauseVoice',
    'stopVoice',
    'uploadVoice',
    'downloadVoice',
    'chooseImage',
    'previewImage',
    'uploadImage',
    'downloadImage',
    'getNetworkType',
    'openLocation',
    'getLocation',
    'hideOptionMenu',
    'showOptionMenu',
    'closeWindow',
    'scanQRCode',
    'chooseWXPay',
    'openProductSpecificView',
    'addCard',
    'chooseCard',
    'openCard'
   ]
  });
  wx.ready(function(){
   wx.checkJsApi({
    jsApiList: [
     'getNetworkType',
     'previewImage',
     'getLocation'
    ],
    success: function (res) {
    }
   });
   wx.getLocation({
    type: 'wgs84', // 默认为wgs84的gps坐标，如果要返回直接给openLocation用的火星坐标，可传入'gcj02'
    success: function (res) {
     try {
      var latitude = res.latitude; // 纬度，浮点数，范围为90 ~ -90
      var longitude = res.longitude; // 经度，浮点数，范围为180 ~ -180。
      var speed = res.speed; // 速度，以米/每秒计
      var accuracy = res.accuracy; // 位置精度
      //alert(JsonUti.convertToString(res));
      //wx.openLocation({
      // latitude: res.latitude, // 纬度，浮点数，范围为90 ~ -90
      // longitude: res.longitude, // 经度，浮点数，范围为180 ~ -180。
      // name: '当前位置', // 位置名
      // address: '点击查看', // 地址详情说明
      // scale: 28, // 地图缩放级别,整形值,范围从1~28。默认为最大
      // infoUrl: "location1.aspx&#63;m=Home&c=Index&a=getlocation&latitude="+latitude+"&longitude="+longitude // 在查看位置界面底部显示的超链接,可点击跳转
      //});
      //alert(latitude+"-"+longitude);
      $("#mask").hide();
      window.location.href = "location1.aspx&#63;m=Home&c=Index&a=getlocation&latitude=" +
       latitude +
       "&longitude=" +
       longitude +
       "&=speed" +
       speed +
       "&accuracy=" +
       accuracy;
     } catch (e) {
      alert(e.message);
     }
    },
    cancel: function (res) {
     window.location.href="none.aspx&#63;msg=拒绝获取地理位置&r=" + Math.random();//拒绝
    },
    fail:function() {
     alert("未能获取地理位置！首先检查手机是否启用微信定位。");
    }
   });
  });

  wx.error(function(res) {
   // config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开config的debug模式查看，也可以在返回的res参数中查看，对于SPA可以在这里更新签名。
  });

  wx.fail(function(res) {
  });
 &lt;/script&gt;
&lt;/asp:Content&gt;
&lt;asp:Content ID="Content2" ContentPlaceHolderID="cphTitle" runat="server"&gt;
 获取位置
&lt;/asp:Content&gt;
&lt;asp:Content ID="Content3" ContentPlaceHolderID="cphContainer" runat="server"&gt;
 &lt;br /&gt;
 &lt;br /&gt;
 &lt;center style="display: block;"&gt;

  &lt;i class="weui_icon_msg weui_icon_info"&gt;&lt;/i&gt;

  &lt;div class="input_errow" style="width: 60%; height: 60%; text-align: center;"&gt;
   正在获取地理位置信息...
  &lt;/div&gt;
 &lt;/center&gt;

 &lt;div class="mask" style="display: none;"&gt;
  &lt;span&gt;
   &lt;img src="/templates/txwap/images/mask.gif" /&gt;
  &lt;/span&gt;
 &lt;/div&gt;
&lt;/asp:Content&gt;

</pre>
</div>
<p>页面效果：</p>
<p style="text-align: center"></p>
<p><span style="color: #800000"><strong>注意事项：</strong></span></p>
<p>（1）如果手机设置不允许微信获取位置信息，则提示以上信息。</p>
<p>（2）上图参数获取的是GPS坐标，如使用百度地图，要做一定转换，将在location1.aspx中体现。</p>
<p>（3）所有需要使用JS-SDK的页面必须先注入配置信息，否则将无法调用。</p>
<p>对应location.aspx.cs实现：</p>
<div class="phpstudycode">
<pre class="brush:csharp;">
using Payment.WxWebHlper;
using Payment.WxWebHlper.Actions;
using System;
using System.Globalization;
using WxJsSDK;
using WxPayAPI;

namespace DTcms.Web.wxcrm
{
 public partial class location : PageBase
 {
 protected string appId { get; set; }
 protected string timestamp { get; set; }
 protected string nonceStr { get; set; }
 protected string signature { get; set; }
 public static string WxJsApiParam { get; set; }
 public WxJsData ResultJsData { get; set; }

 protected void Page_Load(object sender, EventArgs e)
 {
  JudgeCode();
  var webAuthorize = new WebAuthorizeAction();
  Code2TokenResult = webAuthorize.Code2Token(Request["code"]);
  if (Code2TokenResult.HasError())
  {
  Response.Redirect(Urls.PageOfLocation);
  GotoNonePage("获取用户凭证失败，请重新获取");
  return;
  }
  GetUserInfoResult = webAuthorize.GetUserInfo(Code2TokenResult.access_token);
  if (GetUserInfoResult.HasError())
  {
  GotoNonePage("获取用户信息失败，请重新获取");
  }
  var userid = wxOperation.HasBind(GetUserInfoResult.openid);
  if (userid.Equals(Guid.Empty))
  {
  Response.Redirect(Urls.Oauth2Url);
  GotoNonePage("微信用户未绑定");
  }

  appId = WxPayConfig.APPID;
  timestamp = WxPayApi.GenerateTimeStamp();
  nonceStr = WxPayApi.GenerateNonceStr();
  //以下实现将在3、核心代码实现 体现  var jsApi = new JsApi(this);
  ResultJsData = jsApi.GetJsData();
  WxJsApiParam = jsApi.GetJsApiParameters();//获取H5调起JS API参数
 }
 }
}
</pre>
</div>
<p><strong>2、将微信GPS坐标转换为百度坐标</strong></p>
<p>微信获取坐标成功后，页面自动跳转到location1.aspx，处理流程如下：</p>
<p><span style="color: #800000"><strong>微信坐标—&gt;转换为百度地图坐标—&gt;根据百度地图API获取位置信息—&gt;根据百度地图API显示坐标</strong></span></p>
<p></p>
<div class="phpstudycode">
<pre class="brush:xhtml;">
&lt;%@ Page Title="在线签到" Language="C#" MasterPageFile="~/wxcrm/Site.Master" AutoEventWireup="true" CodeFile="location1.aspx.cs" Inherits="DTcms.Web.wxcrm.location1" %&gt;

&lt;asp:Content ID="Content1" ContentPlaceHolderID="cphHead" runat="server"&gt;
 &lt;meta name="viewport" content="initial-scale=1.0, user-scalable=no" /&gt;
 &lt;style type="text/css"&gt;
 #allmap { width: 100%; height: 300px; }
 &lt;/style&gt;
 &lt;script type="text/javascript" src="http://api.map.baidu.com/api&#63;v=2.0&ak=dhRLKMR9QUO4wHmnnSZTarta"&gt;&lt;/script&gt;
 &lt;script type="text/javascript"&gt;
 //GPS坐标
 var yy = &lt;%= this.Request["longitude"] %&gt;; //经度，浮点数，范围为180 ~ -180。
 var xx = &lt;%= this.Request["latitude"] %&gt;; //纬度，浮点数，范围为90 ~ -90
 var gpsPoint = new BMap.Point(xx,yy);
 var bxx = 0.0;
 var byy = 0.0;

 /*
 * http://lbsyun.baidu.com/index.php&#63;title=webapi/guide/changeposition
 */
 var PositionUrl = "http://api.map.baidu.com/geoconv/v1/&#63;";
 function changePosition(){
  var str = "coords="+yy+","+xx+"&from=1&to=5";
  var url = PositionUrl + str;
  $("#positionUrl").html(url+"&ak=dhRLKMR9QUO4wHmnnSZTartg");
  var script = document.createElement('script');
  script.src = url + '&ak=dhRLKMR9QUO4wHmnnSZTarta&callback=dealResult';
  document.getElementsByTagName("head")[0].appendChild(script);
 }
 function dealResult(msg){
  if(msg.status != 0){
  alert("无正确的返回结果。");
  $("#mask").hide();
  return;
  }
  //JsonUti.convertToString(msg);
  bxx = msg.result[0].x;
  byy = msg.result[0].y;
  doOptions();
 }

 function getBaiduPosition() {
  var url ="http://api.map.baidu.com/geoconv/v1/&#63;coords="+yy+","+xx+"&from=1&to=5&ak=dhRLKMR9QUO4wHmnnSZTarta";
  $.ajax({
  url: url,
  success: function(data,status,xhr) {
   alert(status);
   alert(data.status);
  },
  dataType: json
  });
 }

 var ADVANCED_POST = '';
 var advancedOptions = '';
 var address;
 var map;

 function renderOption(response) {
  var html = '';
  if (response.status ) {
  $("#mask").hide();
  var text = "无正确的返回结果！";
  alert(text);
  return;
  }
  var result = response.result;
  var location = response.result.location;
  var uri = 'http://api.map.baidu.com/marker&#63;location='+ location.lat+','+location.lng +'&title='+response.result.level+'&content='+address+'&output=html';
  var staticimageUrl = "http://api.map.baidu.com/staticimage&#63;center=" + location.lng+','+location.lat + "&markers=" + location.lng+','+location.lat;
  html = '&lt;p&gt;坐标：纬度: ' + location.lat + " 经度: " + location.lng+'&lt;br /&gt;';
  html += '精度: '+response.result.precise+'&lt;br /&gt;' ;
  html += '可信度: '+response.result.confidence +'&lt;br /&gt;';
  html += '地址类型: '+response.result.level+'&lt;/p&gt;' ;
  html += '&lt;p&gt;&lt;img src="' + staticimageUrl + '" /&gt;&lt;/p&gt;' ;
  html += '&lt;p&gt;分享该点: &lt;a href="' + uri + '" target="_blank"&gt;' + uri + '&lt;/a&gt;&lt;/p&gt;'; //将该链接设置成可单击
  // 百度地图API功能
  map = new BMap.Map("allmap");
  var point = new BMap.Point(bxx, byy);
  var marker = new BMap.Marker(point); // 创建标注
  map.addOverlay(marker);  // 将标注添加到地图中
  map.centerAndZoom(point, 100);
  var opts = {
  width: 200, // 信息窗口宽度
  height: 100, // 信息窗口高度
  title: "我的位置", // 信息窗口标题
  enableMessage: true,//设置允许信息窗发送短息
  message: result.formatted_address
  }

  $("#divPo").html("当前位置：" + result.formatted_address);
  var infoWindow = new BMap.InfoWindow(result.formatted_address, opts); // 创建信息窗口对象
  marker.addEventListener("click", function () {
  map.openInfoWindow(infoWindow, point); //开启信息窗口
  });

  var myIcon = new BMap.Icon("http://api.map.baidu.com/img/markers.png", new BMap.Size(23, 25), {
  offset: new BMap.Size(10, 25), // 指定定位位置
  imageOffset: new BMap.Size(0, 0 - 10 * 25) // 设置图片偏移
  });

  var pois = result.pois;
  for(var i=0;i&lt;pois.length;i++){
  var marker = new BMap.Marker(new BMap.Point(pois[i].point.x,pois[i].point.y),{icon:myIcon}); // 创建标注
  var name = pois[i].name;
  var addr = pois[i].addr;
  map.addOverlay(marker);  // 将标注添加到地图中
  addClickHandler(name,addr,marker);
  }

  $("#mask").hide();
  $("#btnSign").show();
  return;
 }

 function addClickHandler(name,addr,marker){
  marker.addEventListener("click",function(e){
  openInfo(name,addr,e)}
  );
 }

 function openInfo(name,addr,e){
  var p = e.target;
  var point = new BMap.Point(p.getPosition().lng, p.getPosition().lat);
  var opts = {
  width: 200, // 信息窗口宽度
  height: 100, // 信息窗口高度
  title: name, // 信息窗口标题
  enableMessage: true,//设置允许信息窗发送短息
  message: addr
  }
  var infoWindow = new BMap.InfoWindow(addr,opts); // 创建信息窗口对象
  map.openInfoWindow(infoWindow,point); //开启信息窗口
 }

 function doOptions() {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  ADVANCED_POST ="http://api.map.baidu.com/geocoder/v2/&#63;ak=dhRLKMR9QUO4wHmnnSZTartg&callback=renderOption&location=" + byy + ","+bxx+ "&output=json&pois=2";
  script.src = ADVANCED_POST;
  document.body.appendChild(script);
 };

 $(function () {
  $("#mask").show();
  $("#btnSign").hide();
  changePosition();
 });
 &lt;/script&gt;
&lt;/asp:Content&gt;
&lt;asp:Content ID="Content2" ContentPlaceHolderID="cphTitle" runat="server"&gt;
 在线签到
&lt;/asp:Content&gt;
&lt;asp:Content ID="Content3" ContentPlaceHolderID="cphContainer" runat="server"&gt;
 &lt;form id="frmLocation" runat="server"&gt;
 &lt;div class="box mb50"&gt;
  &lt;div class="hd"&gt;&lt;span&gt;位置信息&lt;/span&gt;&lt;/div&gt;
  &lt;div class="bd" style="padding-left: 0"&gt;
  &lt;ul class="stipx" style="height: 300px;"&gt;
   &lt;div id="allmap"&gt;&lt;/div&gt;
  &lt;/ul&gt;
  &lt;/div&gt;
  &lt;div class="bd" style="padding-left: 0"&gt;
  &lt;ul class="stipx"&gt;
   &lt;div id="divPo"&gt;&lt;/div&gt;
  &lt;/ul&gt;
  &lt;/div&gt;
 &lt;/div&gt;
 &lt;div class="next_btn" style="text-align: center; margin-top: -50px;"&gt;
  &lt;input id="btnSign" type="button" value="我要签到" style="cursor: pointer; width: 210px; height: 50px; border-radius: 15px; background-color: #00CD00; border: 0px #FE6714 solid; cursor: pointer; color: white; font-size: 16px;" /&gt;
 &lt;/div&gt;
 &lt;div class="mask" style="display: none;"&gt;
  &lt;span&gt;
  &lt;img src="/templates/txwap/images/mask.gif" /&gt;
  &lt;/span&gt;
 &lt;/div&gt;
 &lt;/form&gt;
&lt;/asp:Content&gt;
</pre>
</div>
<p>本页面主要涉及到百度地图开放平台，要申请百度地图ag。否则调用js则提示：APP不存在，AK有误请重新检查在重试。</p>
<p><span style="color: #3366ff"><strong>（1）百度地图技术一：</strong></span>坐标转换API</p>
<p>官网地址：http://lbsyun.baidu.com/index.php&#63;title=webapi/guide/changeposition</p>
<p>API服务地址：http://api.map.baidu.com/geoconv/v1/&#63;</p>
<p style="text-align: center"></p>
<p>文档有详细的说明，不再赘述哦。</p>
<p><span style="color: #3366ff"><strong>（2）百度地图技术二：</strong></span>根据坐标获取位置</p>
<p>官网网址：http://lbsyun.baidu.com/index.php&#63;title=webapi/guide/webservice-geocoding</p>
<p style="text-align: center"></p>
<p>Geocoding API包括地址解析和逆地址解析功能：</p>
<p>地理编码：即地址解析，由详细到街道的结构化地址得到百度经纬度信息，例如：“北京市海淀区中关村南大街27号”地址解析的结果是“lng:116.31985,lat:39.959836”。同时，地理编码也支持名胜古迹、标志性建筑名称直接解析返回百度经纬度，例如：“百度大厦”地址解析的结果是“lng:116.30815,lat:40.056885” ，通用的POI检索需求，建议使用Place API。</p>
<p>逆地理编码：即逆地址解析，由百度经纬度信息得到结构化地址信息，例如：“lat:31.325152,lng:120.558957”逆地址解析的结果是“江苏省苏州市虎丘区塔园路318号”。</p>
<p>API服务地址：http://api.map.baidu.com/geocoder/v2/</p>
<p>具体参数可查看官方文档。</p>
<p>示例：http://api.map.baidu.com/geocoder/v2/&#63;ak=申请的百度KEY&location=34.79563,114.23075222912&callback=showLocation&output=xml&pois=1</p>
<p style="text-align: center"></p>
<p><span style="color: #800000"><strong>注意事项：</strong></span></p>
<p>（1）百度开发者key申请</p>
<p>（2）百度地图坐标系统与微信的坐标系统不同</p>
<p>（3）api调用地址及参数说明</p>
<p>（4）api回调函数意义</p>
<p>（5）理解json与jsonp的含义</p>
<p><strong>3、微信JS-SDK核心代码</strong></p>
<p>（1）JsAPI.cs生成相关JS-SDK配置参数</p>
<div class="phpstudycode">
<pre class="brush:csharp;">
using System;
using System.Globalization;
using System.Linq;
using System.Web.Security;
using System.Web.UI;
using WxPayAPI;

namespace WxJsSDK
{
 public class JsApi
 {
 /// &lt;summary&gt;
 /// 保存页面对象，因为要在类的方法中使用Page的Request对象
 /// &lt;/summary&gt;
 private Page page { get; set; }

 public WxJsData ResultJsData { get; set; }

 /// &lt;summary&gt;
 ///
 /// &lt;/summary&gt;
 /// &lt;param name="page"&gt;&lt;/param&gt;
 public JsApi(Page page)
 {
  this.page = page;
 }

 public WxJsData GetJsData()
 {
  var data = new WxJsData();
  data.SetValue("appid", WxPayConfig.APPID);//公众账号ID
  data.SetValue("timestamp", WxPayApi.GenerateTimeStamp());
  data.SetValue("noncestr", WxPayApi.GenerateNonceStr());//随机字符串

  var url = GetUrl();
  data.SetValue("url", url);
  var jsToken = GetJsApiTicket();
  data.SetValue("jsapi_ticket", jsToken);
  var signature = MakeSignature(jsToken, data.GetValue("noncestr").ToString(), data.GetValue("timestamp").ToString(), url);
  data.SetValue("signature", signature);

  ResultJsData = data;
  return data;
 }

 private string MakeSignature(string jsapiTicket, string noncestr, string timestamp, string url)
 {
  string[] arrayList =
  {
  "jsapi_ticket=" + jsapiTicket,
  "timestamp=" + timestamp,
  "noncestr=" + noncestr,
  "url=" + url
  };
  Array.Sort(arrayList);
  var signature = string.Join("&", arrayList);
  signature = FormsAuthentication.HashPasswordForStoringInConfigFile(signature, "SHA1").ToLower();
  return signature;
 }

 private string GetJsApiTicket()
 {
  var jsAuth = new JsAuthorizeAction();
  var token = jsAuth.GetToken();
  var nd = DateTime.Now - token.CreateDate;
  Log.Error(this.GetType().ToString(), token.access_token);
  Log.Error(this.GetType().ToString(), token.IsValid().ToString());
  if (token.IsValid())
  return jsAuth.GetJsApiTicket(token.access_token).ticket;
  return "";
 }

 private string GetUrl()
 {
  string host = page.Request.Url.Host;
  string path = page.Request.Path;
  string queryString = page.Request.Url.Query;
  //这个地方要注意，参与签名的是网页授权获取用户信息时微信后台回传的完整url
  string url = "http://" + host + path + queryString;
  return url;
 }

 public string GetJsApiParameters()
 {
  Log.Debug(this.GetType().ToString(), "JsApi ::GetJsApiParam is processing...");

  string parameters = ResultJsData.ToJson();

  Log.Debug(this.GetType().ToString(), "Get JsApi : " + parameters);
  return parameters;
 }
 }
}
</pre>
</div>
<p>（2）JsAuthorizeAction.cs微信JS-SDK相关API调用函数</p>
<div class="phpstudycode">
<pre class="brush:csharp;">
using Payment.WxWebHlper;
using Payment.WxWebHlper.Results;
using System;
using WxPayAPI;

namespace WxJsSDK
{
 public class JsAuthorizeAction
 {
 private static TokenResult Token = new TokenResult() { errcode = -1 };
 private static JsApiTicketResult JsApiTicket = new JsApiTicketResult() { errcode = -1 };

 public TokenResult GetToken()
 {
  Log.Error(this.GetType().ToString(), "GetToken");
  if (!Token.IsValid())
  {
  Token = GeTokenResult();
  Log.Error(this.GetType().ToString(), Token.ToString());
  }
  return Token;
 }

 /// &lt;summary&gt;
 ///
 /// &lt;/summary&gt;
 /// &lt;returns&gt;&lt;/returns&gt;
 public TokenResult GeTokenResult()
 {
  var result = new TokenResult();
  try
  {
  var webUtils = new WebUtils();
  var url = string.Format("https://api.weixin.qq.com/cgi-bin/token&#63;grant_type=client_credential&appid={0}&secret={1}", WxPayConfig.APPID, WxPayConfig.APPSECRET);
  var strRtn = webUtils.Get(url);
  result = Tools.JsonStringToObj&lt;TokenResult&gt;(strRtn);
  }
  catch (Exception ex)
  {
  Log.Error(this.GetType().ToString(), ex.Message);
  result = new TokenResult() { errcode = -1086 };
  }
  return result;
 }

 /// &lt;summary&gt;
 ///
 /// &lt;/summary&gt;
 /// &lt;param name="token"&gt;&lt;/param&gt;
 /// &lt;returns&gt;&lt;/returns&gt;
 public JsApiTicketResult GetJsApiTicket(string token)
 {
  Log.Error(this.GetType().ToString(), "GetJsApiTicket传入token：" + token);
  if (!JsApiTicket.IsValid())
  {
  JsApiTicket = GetJsApiTicketResult(token);
  }
  return JsApiTicket;
 }

 /// &lt;summary&gt;
 ///
 /// &lt;/summary&gt;
 /// &lt;param name="token"&gt;&lt;/param&gt;
 /// &lt;returns&gt;&lt;/returns&gt;
 public JsApiTicketResult GetJsApiTicketResult(string token)
 {
  JsApiTicketResult result;
  try
  {
  var webUtils = new WebUtils();
  var url = string.Format("https://api.weixin.qq.com/cgi-bin/ticket/getticket&#63;access_token={0}&type=jsapi", token);
  var strRtn = webUtils.Get(url);
  result = Tools.JsonStringToObj&lt;JsApiTicketResult&gt;(strRtn);
  }
  catch (Exception ex)
  {
  Log.Error(this.GetType().ToString(), ex.Message);
  result = new JsApiTicketResult() { errcode = -1086 };
  }
  return result;
 }
 }

 public class JsApiTicketResult : ReturnResult
 {
 /// &lt;summary&gt;
 /// 构造函数
 /// &lt;/summary&gt;
 public JsApiTicketResult()
 {
  CreateDate = DateTime.Now;
 }

 /// &lt;summary&gt;
 ///
 /// &lt;/summary&gt;
 public string ticket { get; set; }

 /// &lt;summary&gt;
 /// access_token接口调用凭证超时时间，单位（秒）
 /// &lt;/summary&gt;
 public int expires_in { get; set; }

 /// &lt;summary&gt;
 /// 创建时间
 /// &lt;/summary&gt;
 public DateTime CreateDate { get; set; }

 /// &lt;summary&gt;
 /// 判断是否有效
 /// &lt;/summary&gt;
 /// &lt;returns&gt;&lt;/returns&gt;
 public bool IsValid()
 {
  if (this.errcode != 0)
  return false;
  var nd = DateTime.Now - CreateDate;
  return nd.Seconds &lt; 7200;
 }
 }

 public class TokenResult : ReturnResult
 {
 /// &lt;summary&gt;
 /// 构造函数
 /// &lt;/summary&gt;
 public TokenResult()
 {
  CreateDate = DateTime.Now;
 }

 /// &lt;summary&gt;
 /// 网页授权接口调用凭证,注意：此access_token与基础支持的access_token不同
 /// &lt;/summary&gt;
 public string access_token { get; set; }

 /// &lt;summary&gt;
 /// access_token接口调用凭证超时时间，单位（秒）
 /// &lt;/summary&gt;
 public int expires_in { get; set; }

 /// &lt;summary&gt;
 /// 创建时间
 /// &lt;/summary&gt;
 public DateTime CreateDate { get; set; }

 /// &lt;summary&gt;
 /// 判断是否有效
 /// &lt;/summary&gt;
 /// &lt;returns&gt;&lt;/returns&gt;
 public bool IsValid()
 {
  if (this.errcode != 0)
  return false;
  var nd = DateTime.Now - CreateDate;
  return nd.Seconds &lt; 7200;
 }
 }
}
</pre>
</div>
<p>（3）WxJsData.cs微信JS-SDK参数类</p>
<div class="phpstudycode">
<pre class="brush:csharp;">
using LitJson;
using System.Collections.Generic;
using System.Security.Cryptography;
using System.Text;
using System.Xml;
using WxPayAPI;

namespace WxJsSDK
{
 public class WxJsData
 {
 private SortedDictionary&lt;string, object&gt; m_values = new SortedDictionary&lt;string, object&gt;();
 /**
 * 设置某个字段的值
 * @param key 字段名
 * @param value 字段值
 */

 public void SetValue(string key, object value)
 {
  m_values[key] = value;
 }

 /**
 * 根据字段名获取某个字段的值
 * @param key 字段名
  * @return key对应的字段值
 */

 public object GetValue(string key)
 {
  object o = null;
  m_values.TryGetValue(key, out o);
  return o;
 }

 /**
  * 判断某个字段是否已设置
  * @param key 字段名
  * @return 若字段key已被设置，则返回true，否则返回false
  */

 public bool IsSet(string key)
 {
  object o = null;
  m_values.TryGetValue(key, out o);
  if (null != o)
  return true;
  return false;
 }

 /**
 * @将Dictionary转成xml
 * @return 经转换得到的xml串
 * @throws WxPayException
 **/

 public string ToXml()
 {
  //数据为空时不能转化为xml格式
  if (0 == m_values.Count)
  {
  Log.Error(this.GetType().ToString(), "WxPayData数据为空!");
  throw new WxPayException("WxPayData数据为空!");
  }

  string xml = "&lt;xml&gt;";
  foreach (KeyValuePair&lt;string, object&gt; pair in m_values)
  {
  //字段值不能为null，会影响后续流程
  if (pair.Value == null)
  {
   Log.Error(this.GetType().ToString(), "WxPayData内部含有值为null的字段!");
   throw new WxPayException("WxPayData内部含有值为null的字段!");
  }

  if (pair.Value.GetType() == typeof(int) || pair.Value.GetType() == typeof(decimal))
  {
   xml += "&lt;" + pair.Key + "&gt;" + pair.Value.ToString() + "&lt;/" + pair.Key + "&gt;";
  }
  else if (pair.Value.GetType() == typeof(string))
  {
   xml += "&lt;" + pair.Key + "&gt;" + "&lt;![CDATA[" + pair.Value + "]]&gt;&lt;/" + pair.Key + "&gt;";
  }
  else//除了string和int类型不能含有其他数据类型
  {
   Log.Error(this.GetType().ToString(), "WxPayData字段数据类型错误!");
   throw new WxPayException("WxPayData字段数据类型错误!");
  }
  }
  xml += "&lt;/xml&gt;";
  return xml;
 }

 /**
 * @将xml转为WxPayData对象并返回对象内部的数据
 * @param string 待转换的xml串
 * @return 经转换得到的Dictionary
 * @throws WxPayException
 */

 public SortedDictionary&lt;string, object&gt; FromXml(string xml)
 {
  if (string.IsNullOrEmpty(xml))
  {
  Log.Error(this.GetType().ToString(), "将空的xml串转换为WxPayData不合法!");
  throw new WxPayException("将空的xml串转换为WxPayData不合法!");
  }

  XmlDocument xmlDoc = new XmlDocument();
  xmlDoc.LoadXml(xml);
  XmlNode xmlNode = xmlDoc.FirstChild;//获取到根节点&lt;xml&gt;
  XmlNodeList nodes = xmlNode.ChildNodes;
  foreach (XmlNode xn in nodes)
  {
  XmlElement xe = (XmlElement)xn;
  m_values[xe.Name] = xe.InnerText;//获取xml的键值对到WxPayData内部的数据中
  }

  try
  {
  //2015-06-29 错误是没有签名
  if (m_values["return_code"] != "SUCCESS")
  {
   return m_values;
  }
  CheckSign();//验证签名,不通过会抛异常
  }
  catch (WxPayException ex)
  {
  throw new WxPayException(ex.Message);
  }

  return m_values;
 }

 /**
 * @Dictionary格式转化成url参数格式
 * @ return url格式串, 该串不包含sign字段值
 */

 public string ToUrl()
 {
  string buff = "";
  foreach (KeyValuePair&lt;string, object&gt; pair in m_values)
  {
  if (pair.Value == null)
  {
   Log.Error(this.GetType().ToString(), "WxPayData内部含有值为null的字段!");
   throw new WxPayException("WxPayData内部含有值为null的字段!");
  }

  if (pair.Key != "sign" && pair.Value.ToString() != "")
  {
   buff += pair.Key + "=" + pair.Value + "&";
  }
  }
  buff = buff.Trim('&');
  return buff;
 }

 /**
 * @Dictionary格式化成Json
  * @return json串数据
 */

 public string ToJson()
 {
  string jsonStr = JsonMapper.ToJson(m_values);
  return jsonStr;
 }

 /**
 * @values格式化成能在Web页面上显示的结果（因为web页面上不能直接输出xml格式的字符串）
 */

 public string ToPrintStr()
 {
  string str = "";
  foreach (KeyValuePair&lt;string, object&gt; pair in m_values)
  {
  if (pair.Value == null)
  {
   Log.Error(this.GetType().ToString(), "WxPayData内部含有值为null的字段!");
   throw new WxPayException("WxPayData内部含有值为null的字段!");
  }

  str += string.Format("{0}={1}&lt;br&gt;", pair.Key, pair.Value.ToString());
  }
  Log.Debug(this.GetType().ToString(), "Print in Web Page : " + str);
  return str;
 }

 /**
 * @生成签名，详见签名生成算法
 * @return 签名, sign字段不参加签名
 */

 public string MakeSign()
 {
  //转url格式
  string str = ToUrl();
  //在string后加入API KEY
  str += "&key=" + WxPayConfig.KEY;
  //MD5加密
  var md5 = MD5.Create();
  var bs = md5.ComputeHash(Encoding.UTF8.GetBytes(str));
  var sb = new StringBuilder();
  foreach (byte b in bs)
  {
  sb.Append(b.ToString("x2"));
  }
  //所有字符转为大写
  string result = sb.ToString().ToUpper();
  return result;
 }

 public string MakeAppSign()
 {
  //转url格式
  string str = ToUrl();
  //在string后加入API KEY
  str += "&key=" + WxPayConfig.KEYofAPP;
  //MD5加密
  var md5 = MD5.Create();
  var bs = md5.ComputeHash(Encoding.UTF8.GetBytes(str));
  var sb = new StringBuilder();
  foreach (byte b in bs)
  {
  sb.Append(b.ToString("x2"));
  }
  //所有字符转为大写
  string result = sb.ToString().ToUpper();
  return result;
 }

 /**
 *
 * 检测签名是否正确
 * 正确返回true，错误抛异常
 */

 public bool CheckSign()
 {
  //如果没有设置签名，则跳过检测
  if (!IsSet("sign"))
  {
  Log.Error(this.GetType().ToString(), "WxPayData签名存在但不合法!");
  throw new WxPayException("WxPayData签名存在但不合法!");
  }
  //如果设置了签名但是签名为空，则抛异常
  if (GetValue("sign") == null || GetValue("sign").ToString() == "")
  {
  Log.Error(this.GetType().ToString(), "WxPayData签名存在但不合法!");
  throw new WxPayException("WxPayData签名存在但不合法!");
  }

  //获取接收到的签名
  string return_sign = GetValue("sign").ToString();

  //在本地计算新的签名
  string cal_sign = MakeSign();

  if (cal_sign == return_sign)
  {
  return true;
  }

  Log.Error(this.GetType().ToString(), "WxPayData签名验证错误!");
  throw new WxPayException("WxPayData签名验证错误!");
 }

 /**
 * @获取Dictionary
 */

 public SortedDictionary&lt;string, object&gt; GetValues()
 {
  return m_values;
 }
 }
}
</pre>
</div>
<p><strong>提示信息：</strong>相关解析思路可参考微信公众号支付官方SDK，下载地址：https://pay.weixin.qq.com/wiki/doc/api/jsapi_sl.php&#63;chapter=11_1。</p>
<p style="text-align: center"></p>
<p>以上就是本文的全部内容，希望对大家的学习有所帮助，也希望大家多多支持phpstudy。</p>
<hr></span>                                     
		    	</div>
		    	<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>代码注释</div>
			    <div class="panel-content">
			    <span></span>                                     
		    	</div>

			</div>

			<!-- END ROW -->
			<div class="newsPage">
				<div class="newsPageTurn">
				    <span><a>上一篇</a><a href='/php/biji/101772.html'>Win10系统日历应用如何显示中国的农历？win10日历显示农历的方法</a><a>下一篇</a><a href='/php/biji/101774.html'>Redis基本知识、安装、部署、配置笔记</a></span>
				</div>
			</div>
		</div>


<div id="author-box">
    <h3>作者：喵哥笔记</h3>
        <div class="author-info">
            <div class="author-avatar">
                <img src="/skin1/picture/01.jpg" alt="IDC笔记" class="avatar" width="64" height="64">
            </div>
        <div class="author-description">
            <p>学的不仅是技术，更是梦想！</p>
            <ul class="author-social follows nb">
            	<li>
                    <a target="_blank" href="/" title="IDC笔记">IDC笔记</a>
                </li>
            </ul>
        </div>
        <div class="clear"></div>
    </div>
</div>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
<!-- container-fluid -->
	</div>
<!-- content -->
	<footer class="footer">
	© 2020 IDC笔记 <i class="mdi mdi-heart text-danger"></i>. | 备案号：<a href="https://beian.miit.gov.cn/">辽ICP备18000516号</a>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?674585fbbd2294d3faf910f668ea91b4";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

	</footer>
</div>

</div>
<!-- END wrapper -->
<!-- jQuery  -->
<script src="/skin1/js/jquery.min.js"></script>
<script src="/skin1/js/bootstrap.bundle.min.js"></script>
<script src="/skin1/js/metismenu.min.js"></script>
<script src="/skin1/js/jquery.slimscroll.js"></script>
<script src="/skin1/js/waves.min.js"></script>
<!--Morris Chart-->
<script src="/skin1/js/morris.min.js"></script>
<script src="/skin1/js/raphael.min.js"></script>
<script src="/skin1/js/dashboard.init.js"></script>
<script src="/skin1/js/app.js"></script>
<script src="/foot.js"></script>
</body>
</html>