<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <title>MySQL-canal-rabbitmq 安装部署的解决办法_mysql教程_IDC笔记</title>
    <meta name="keywords" content="PHP,PHP笔记,PHP教程" />
    <meta name="description" content="这篇文章主要为大家详细介绍了MySQL-canal-rabbitmq 安装部署的简单示例，具有一定的参考价值，可以用来参考一下。

感兴趣的小伙伴，下面一起跟随512笔记的小玲来看看吧！

目录" />
    <meta content="Responsive admin theme build on top of Bootstrap 4" name="description" />
    <meta content="idcnote.com" name="author" />
    <link rel="shortcut icon" href="/skin1/images/favicon.ico">
    <!--Morris Chart CSS -->
    <link rel="stylesheet" href="/skin1/css/morris.css">
    <link href="/skin1/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/metismenu.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/icons.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/style.css" rel="stylesheet" type="text/css">
<link href="/SyntaxHighlighter/shCoreDefault.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">
 SyntaxHighlighter.all();
</script>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
</head>
<body>
<!-- Begin page -->
		<div id="wrapper">
			<!-- Top Bar Start -->
			<div class="topbar">
				<!-- LOGO -->
				<div class="topbar-left">
					<a href="/" class="logo">
						<span class="logo-light">
                            <i class="mdi mdi-camera-control"></i>IDC笔记
                        </span>
						<span class="logo-sm">
                            <i class="mdi mdi-camera-control"></i>
                        </span>
					</a>
				</div>
				<nav class="navbar-custom">
					<ul class="navbar-right list-inline float-right mb-0">
						<!--<li class="dropdown notification-list list-inline-item d-none d-md-inline-block">
							<a class="nav-link waves-effect" href="#" id="btn-fullscreen">
								<i class="mdi mdi-arrow-expand-all noti-icon"></i>
							</a>
						</li>
						<li class="dropdown notification-list list-inline-item">
							<div class="dropdown notification-list nav-pro-img">
								<a class="dropdown-toggle nav-link arrow-none nav-user" data-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
									<img src="/skin1/picture/user-4.jpg" alt="user" class="rounded-circle">
								</a>
								<div class="dropdown-menu dropdown-menu-right profile-dropdown ">
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-account-circle"></i> Profile</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-wallet"></i> Wallet</a>
									<a class="dropdown-item d-block" href="#">
										<span class="badge badge-success float-right">11</span>
										<i class="mdi mdi-settings"></i> Settings</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-lock-open-outline"></i> Lock screen</a>
									<div class="dropdown-divider"></div>
									<a class="dropdown-item text-danger" href="#">
										<i class="mdi mdi-power text-danger"></i> Logout</a>
								</div>
							</div>
						</li>
						-->
					</ul>
					<ul class="list-inline menu-left mb-0">
						<li class="float-left">
							<button class="button-menu-mobile open-left waves-effect">
                            <i class="mdi mdi-menu"></i>
                        </button>
						</li>
						<li class="d-none d-md-inline-block">
							<form role="search" class="app-search">
								<div class="form-group mb-0">
									<input type="text" class="form-control" placeholder="Search..">
									<button type="submit"><i class="fa fa-search"></i></button>
								</div>
							</form>
						</li>
					</ul>
				</nav>
			</div>
<!-- ========== Left Sidebar Start ========== -->
<div class="left side-menu">
    <div class="slimscroll-menu" id="remove-scroll">
    <!--- Sidemenu -->
    <div id="sidebar-menu">
    <!-- Left Menu Start -->
    <ul class="metismenu" id="side-menu">
			<li>
	    <a href="/mysql/biji/" class="waves-effect">
		    <i class="icon-share"></i>
		    <span>数据库笔记
		       	<span class="float-right menu-arrow">
		       	<i class="mdi mdi-chevron-right"></i>
		       	</span>
		    </span>
	    </a>
	</li>
	</ul>
</div>
<!-- Sidebar -->
<div class="clearfix"></div>
</div>
<!-- Sidebar -left -->
</div>
<!-- Left Sidebar End -->
<!-- Start right Content here -->
<div class="content-page">
	<div class="content">
		<div class="container-fluid">
			<div class="page-title-box">
				<div class="row align-items-center">
					<div class="col-sm-6">
						<h1 class="page-title">MySQL-canal-rabbitmq 安装部署的解决办法</h1>
					</div>
                    <div class="panel-title">
                        2022-11-12 09:14:02                    </div>
				</div>
				<!-- end row -->
			</div>
			<!-- end page-title -->
			<!-- START ROW -->
			<div class="panel panel-forbid">
				<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>内容摘要</div>
			    <div class="panel-content">
			    <span>这篇文章主要为大家详细介绍了MySQL-canal-rabbitmq 安装部署的简单示例，具有一定的参考价值，可以用来参考一下。

感兴趣的小伙伴，下面一起跟随512笔记的小玲来看看吧！

目录</span>                                     
		    	</div>
			    <div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>文章正文</div>
			    <div class="panel-content">
			    <span><p>这篇文章主要为大家详细介绍了MySQL-canal-rabbitmq 安装部署的简单示例，具有一定的参考价值，可以用来参考一下。</p>

<p>感兴趣的小伙伴，下面一起跟随数据库教程的小编来看看吧！</p>
<div id="navCategory">
<h5 class="catalogue">目录</h5>
<ul class="first_class_ul">
	<li>1.1. 开启 MySQL 的 binlog 日志</li>
	<li>1.2. 配置 rabbitmq Exchanges 和 Queues</li>
	<li>1.3. 安装单机 canal
	<ul class="second_class_ul">
		<li>1.3.1. 下载安装</li>
		<li>1.3.2. 配置文件</li>
		<li>1.3.3. 启动 canal 服务</li>
	</ul></li>
	<li>1.4. 安装集群 canal
	<ul class="second_class_ul">
		<li>1.4.1. 安装 canal-admin</li>
		<li>1.4.2. 添加单机 canal-server 节点</li>
		<li>1.4.3. 添加集群 canal-server 节点</li>
	</ul></li>
	<li>1.5. canal 配置说明
	<ul class="second_class_ul">
		<li>1.5.1. canal.properties</li>
		<li>1.5.2. instance.properties</li>
		<li>1.5.3. properties 配置文件</li>
	</ul></li>
	<li>1.6. 问题处理
	<ul class="second_class_ul">
	</ul></li>
	<li>1.7. 参考资料
	<ul class="second_class_ul">
	</ul></li>
</ul>
<p>原文</p>
<p class="maodian"></p>
<h2>1.1. 开启 MySQL 的 binlog 日志</h2>
<p>1.修改 <code>my.cnf</code> 或 <code>my.ini</code>(windows), 添加配置项:</p>
<p>代码如下：</p>
<pre>
<code>
# binlog 日志存放路径
log-bin=D:\env\mysql-5.7.28-winx64\binlog
# 日志中记录每一行数据被修改的形式
binlog-format=ROW
# 当前机器的服务 ID, 如果为集群时不能重复
server_id=1</code></pre>
<p>MySQL-canal-rabbitmq 安装部署超详细教程</p>
<p>2.重启 mysql 服务后, 查看配置变量是否生效:</p>
<p>代码如下：</p>
<pre>
<code>
mysql&gt; show variables like '%log_bin%';
+---------------------------------+----------------------+
| Variable_name          | Value        |
+---------------------------------+----------------------+
| log_bin             | ON          |
| log_bin_basename        | D:\env\mysql-5    |
| log_bin_index          | D:\env\mysql-5.index |
| log_bin_trust_function_creators | OFF         |
| log_bin_use_v1_row_events    | OFF         |
| sql_log_bin           | ON          |
+---------------------------------+----------------------+
6 rows in set, 1 warning (0.00 sec)</code></pre>
<p>MySQL-canal-rabbitmq 安装部署超详细教程</p>
<p>配置 mysql 数据库的 <code>canal</code> 用户</p>
<p><code>mysql -uroot -p</code> 登录 mysql, 创建并授权用户 <code>canal</code>;</p>
<p>代码如下：</p>
<pre>
<code>
CREATE USER canal IDENTIFIED BY 'canal';
GRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'canal'@'%';
FLUSH PRIVILEGES;</code></pre>
<p>MySQL-canal-rabbitmq 安装部署超详细教程</p>
<p class="maodian"></p>
<h2>1.2. 配置 rabbitmq Exchanges 和 Queues</h2>
<p>1.新建 <code>Queue</code></p>
<p style="text-align: center"><!---ecms -ecms 
【图缺】
--></p>
<p>2.新建 <code>Exchange</code></p>
<p style="text-align: center"><!---ecms -ecms 
【图缺】
--></p>
<p>3.设置 Queue 里的 Bindings, 填写 <code>Exchange</code> 名称, 以及路由 <code>Routing key</code>;</p>
<p style="text-align: center"><!---ecms -ecms 
【图缺】
--></p>
<p class="maodian"></p>
<h2>1.3. 安装单机 canal</h2>
<p class="maodian"></p>
<h3>1.3.1. 下载安装</h3>
<p>下载 并解压缩;</p>
<p>代码如下：</p>
<pre>
<code>
sudo wget https://github.com/alibaba/canal/releases/download/canal-1.1.4/canal.deployer-1.1.4.tar.gz
sudo tar -zxvf canal.deployer-1.1.4.tar.gz</code></pre>
<p>MySQL-canal-rabbitmq 安装部署超详细教程</p>
<p>最新版本 <code>1.1.5</code>的安装</p>
<p>代码如下：</p>
<pre>
<code>
sudo wget https://github.com/alibaba/canal/releases/download/canal-1.1.5-alpha-1/canal.deployer-1.1.5-SNAPSHOT.tar.gz
sudo tar -zxvf canal.deployer-1.1.5-SNAPSHOT.tar.gz</code></pre>
<p>MySQL-canal-rabbitmq 安装部署超详细教程</p>
<p class="maodian"></p>
<h3>1.3.2. 配置文件</h3>
<p>1.3.2.1. 节点配置文件 canal.properties</p>
<p>代码如下：</p>
<pre>
<code>
# tcp bind ip, 当前节点的 IP 地址
canal.ip = 192.168.2.108
# register ip to zookeeper, 注册到 ZK 的 IP 地址, 如下图1.
canal.register.ip = 192.168.2.108

canal.zkServers = zk集群

# tcp, kafka, RocketMQ, 最新版本 1.1.5 可以直接连接 rabbitmq
canal.serverMode = rabbitmq

# destinations, 当前 server 上部署的 instance 列表, 对应各个实例文件夹(../conf/&lt;instance_name&gt;)名称
canal.destinations = example2

# 设置 mq 服务器地址, 此处为 rabbitmq 的服务器地址
# !! 此处下载后默认的配置是有配置IP:端口的
# rabbitmq 此处则不需要配置端口
canal.mq.servers = 192.168.208.100

# 一下几项均为 1.1.5 新版本新增支持 rabbitmq 的配置
canal.mq.vhost=/
canal.mq.exchange=example2-ex # 指定 rabbitmq 上的 exchange 名称, "新建 `Exchange`" 步骤新建的名称
canal.mq.username=admin # 连接 rabbitmq 的用户名
canal.mq.password=**** # 连接 rabbitmq 的密码
canal.mq.aliyunuid=</code></pre>
<p>MySQL-canal-rabbitmq 安装部署超详细教程</p>
<p style="text-align: center"><!---ecms -ecms 
【图缺】
--></p>
<p>1.3.2.2. 实例配置文件 instance.properties</p>
<p>代码如下：</p>
<pre>
<code>
# position info, 数据库的连接信息
canal.instance.master.address=192.168.2.108:3306
# 以下两个配置, 需要在上面配置的 address 的数据库中执行 `SHOW MASTER STATUS` 获取的 `File` 和 `Position` 两个字段值
canal.instance.master.journal.name=mysql-5.7
canal.instance.master.position=674996

# table meta tsdb info, 禁用 tsdb 记录 table meta 的时间序列版本
canal.instance.tsdb.enable=false

# username/password, 实例连接数据的用户名和密码
canal.instance.dbUsername=canal
canal.instance.dbPassword=canal

# table regex, 正则匹配需要监听的数据库表
canal.instance.filter.regex=ysb\\.useropcosttimes_prod

# mq config, 指定 rabbitmq 设置绑定的路由, 详见"配置rabbitmq"步骤里的第三步配置的`Routing key`
canal.mq.topic=example2-routingkey</code></pre>
<p>MySQL-canal-rabbitmq 安装部署超详细教程</p>
<p class="maodian"></p>
<h3>1.3.3. 启动 canal 服务</h3>
<p>Linux 对应的启动脚本 <code>./bin/startup.sh</code>, Windows 对应的启动脚本 <code>./bin/startup.bat</code>; 以 Windows 为例:</p>
<p>代码如下：</p>
<pre>
<code>
λ .\startup.bat
start cmd : java  -Xms128m -Xmx512m -XX:PermSize=128m -Djava.awt.headless=true -Djava.net.preferIPv4Stack=true -Dapplication.codeset=UTF-8 -Dfile.encoding=UTF-8 -server -Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,address=9099,server=y,suspend=n -DappName=otter-canal -Dlogback.configurationFile="d:\env\green\canal-1.1.5\bin\\..\conf\logback.xml" -Dcanal.conf="d:\env\green\canal-1.1.5\bin\\..\conf\canal.properties" -classpath "d:\env\green\canal-1.1.5\bin\\..\conf\..\lib\*;d:\env\green\canal-1.1.5\bin\\..\conf" java  -Xms128m -Xmx512m -XX:PermSize=128m -Djava.awt.headless=true -Djava.net.preferIPv4Stack=true -Dapplication.codeset=UTF-8 -Dfile.encoding=UTF-8 -server -Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,address=9099,server=y,suspend=n -DappName=otter-canal -Dlogback.configurationFile="d:\env\green\canal-1.1.5\bin\\..\conf\logback.xml" -Dcanal.conf="d:\env\green\canal-1.1.5\bin\\..\conf\canal.properties" -classpath "d:\env\green\canal-1.1.5\bin\\..\conf\..\lib\*;d:\env\green\canal-1.1.5\bin\\..\conf" com.alibaba.otter.canal.deployer.CanalLauncher
Java HotSpot(TM) Server VM warning: ignoring option PermSize=128m; support was removed in 8.0
Listening for transport dt_socket at address: 9099</code></pre>
<p>MySQL-canal-rabbitmq 安装部署超详细教程</p>
<p>最后手动修改数据库数据, 或者等待其他的修改, 再查看一下 rabbitmq 上的监控即可知道流程是否走通了.</p>
<p style="text-align: center"><!---ecms -ecms 
【图缺】
--></p>
<p class="maodian"></p>
<h2>1.4. 安装集群 canal</h2>
<p class="maodian"></p>
<h3>1.4.1. 安装 canal-admin</h3>
<p>1.4.1.1. 下载安装</p>
<p>下载并解压缩</p>
<p>代码如下：</p>
<pre>
<code>
sudo wget https://github.com/alibaba/canal/releases/download/canal-1.1.5-alpha-1/canal.admin-1.1.5-SNAPSHOT.tar.gz
sudo tar -zxvf canal.admin-1.1.5-SNAPSHOT.tar.gz</code></pre>
<p>MySQL-canal-rabbitmq 安装部署超详细教程</p>
<p>1.4.1.2. 配置文件</p>
<p><code>application.yml</code></p>
<p>代码如下：</p>
<pre>
<code>
server:
 port: 8089
spring:
 jackson:
  date-format: yyyy-MM-dd HH:mm:ss
  time-zone: GMT+8

spring.datasource:
 address: 192.168.2.108:3306
 database: canal_manager
 username: canal
 password: canal
 driver-class-name: com.mysql.jdbc.Driver
 # 数据库连接字符串末尾需添加`serverTimezone=UTC`, 否则启动时会报时区异常;
 url: jdbc:mysql://${spring.datasource.address}/${spring.datasource.database}?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=UTC
 hikari:
  maximum-pool-size: 30
  minimum-idle: 1

canal:
 # 配置 canal-admin 的管理员账号和密码
 adminUser: admin
 adminPasswd: 123456</code></pre>
<p>MySQL-canal-rabbitmq 安装部署超详细教程</p>
<p><code>canal_manager.sql</code></p>
<p>在管理<code>canal-admin</code>数据的数据库中执行该 sql 脚本, 初始化一些表;</p>
<p>1.4.1.3. 启动 canal-admin 服务</p>
<p>Linux 对应的启动脚本 <code>./bin/startup.sh</code>, Windows 对应的启动脚本 <code>./bin/startup.bat</code>; 以 Windows 为例:</p>
<p>代码如下：</p>
<pre>
<code>
λ .\startup.bat
start cmd : java  -Xms128m -Xmx512m -Djava.awt.headless=true -Djava.net.preferIPv4Stack=true -Dapplication.codeset=UTF-8 -Dfile.encoding=UTF-8 -DappName=canal-admin -classpath "D:\env\green\canal-1.1.5-admin\bin\\..\conf\..\lib\*;D:\env\green\canal-1.1.5-admin\bin\\..\conf" com.alibaba.otter.canal.admin.CanalAdminApplication
2020-04-13 20:01:39.495 [main] INFO com.alibaba.otter.canal.admin.CanalAdminApplication - Starting CanalAdminApplication on Memento-PC with PID 50696 (D:\env\green\canal-1.1.5-admin\lib\canal-admin-server-1.1.5-SNAPSHOT.jar started by Memento in D:\env\green\canal-1.1.5-admin\bin)
2020-04-13 20:01:39.527 [main] INFO com.alibaba.otter.canal.admin.CanalAdminApplication - No active profile set, falling back to default profiles: default
2020-04-13 20:01:39.566 [main] INFO o.s.b.w.s.c.AnnotationConfigServletWebServerApplicationContext - Refreshing org.springframework.boot.web.servlet.context.AnnotationConfigServletWebServerApplicationContext@13a5bf6: startup date [Mon Apr 13 20:01:39 CST 2020]; root of context hierarchy
2020-04-13 20:01:41.149 [main] INFO o.s.boot.web.embedded.tomcat.TomcatWebServer - Tomcat initialized with port(s): 8089 (http)
2020-04-13 20:01:41.166 [main] INFO org.apache.coyote.http11.Http11NioProtocol - Initializing ProtocolHandler ["http-nio-8089"]
2020-04-13 20:01:41.176 [main] INFO org.apache.catalina.core.StandardService - Starting service [Tomcat]
2020-04-13 20:01:41.177 [main] INFO org.apache.catalina.core.StandardEngine - Starting Servlet Engine: Apache Tomcat/8.5.29
...
2020-04-13 20:01:42.996 [main] INFO org.apache.coyote.http11.Http11NioProtocol - Starting ProtocolHandler ["http-nio-8089"]
2020-04-13 20:01:43.007 [main] INFO org.apache.tomcat.util.net.NioSelectorPool - Using a shared selector for servlet write/read
2020-04-13 20:01:43.019 [main] INFO o.s.boot.web.embedded.tomcat.TomcatWebServer - Tomcat started on port(s): 8089 (http) with context path ''
2020-04-13 20:01:43.024 [main] INFO com.alibaba.otter.canal.admin.CanalAdminApplication - Started CanalAdminApplication in 3.919 seconds (JVM running for 5.241)</code></pre>
<p>MySQL-canal-rabbitmq 安装部署超详细教程</p>
<p>1.4.1.4. 注意事项</p>
<p><code>canal-admin</code> 连接数据库的账号, 必须有建表, 读写数据的权限, 如果还是采用上文中创建的 <code>canal</code> 账号, 需要另外扩展一下权限:</p>
<p>代码如下：</p>
<pre>
<code>
GRANT ALL PRIVILEGES ON *.* TO 'canal'@'%' ;</code></pre>
<p>MySQL-canal-rabbitmq 安装部署超详细教程</p>
<p class="maodian"></p>
<h3>1.4.2. 添加单机 canal-server 节点</h3>
<p>1.4.2.1. 启动 canal-server 节点服务</p>
<p>单机 canal-server 照常启动, 此时, canal-server 默认加载的 <code>../conf/canal.properties</code> 里的配置信息, 可以从 <code>../bin/startup.bat[startup.sh]</code> 脚本中获悉, 获取从执行的脚本命令提示里获悉;</p>
<p>1.4.2.2. 新建单机 server</p>
<p>在 <code>canal-admin</code> 中新建一个单机 <code>server</code></p>
<p style="text-align: center"><!---ecms -ecms 
【图缺】
--></p>
<p>该 <code>server</code> 会自动识别已启动的 <code>canal-server</code> 节点, 但是此时由 <code>admin</code> 接管后, 不会自动加载 <code>../conf/canal.properties</code> 的配置文件, 点击最右侧的 <code>操作-配置</code> 查看, 该 server 加载的是默认的配置信息</p>
<p style="text-align: center"><!---ecms -ecms 
【图缺】
--><!---ecms -ecms 
【图缺】
--></p>
<p>需要手动将 <code>1.3.2</code> 中配置好的 <code>../conf/canal.properties</code> 里的配置信息拷贝到该配置里进行覆盖!</p>
<p>1.4.2.3. 新建实例 instance</p>
<p>手动在 <code>canal-admin</code> 中新建一个 <code>instance</code>, 对应单机 <code>canal-server</code> 配置下的实例 <code>example2</code>; 同样, 需要手动将 <code>./conf/&lt;实例名称&gt;/instance.properies</code> 配置文件手动拷贝到 admin 中</p>
<p style="text-align: center"><!---ecms -ecms 
【图缺】
--></p>
<p style="text-align: center"><!---ecms -ecms 
【图缺】
--></p>
<p>!!注意在新建或启动 <code>instance</code> 实例时, 先删除实例文件夹下的 <code>meta.dat</code> 文件, 并更新 <code>canal.instance.master.journal.name=...</code>, <code>canal.instance.master.position=...</code> 两个配置项;</p>
<p class="maodian"></p>
<h3>1.4.3. 添加集群 canal-server 节点</h3>
<p>1.4.3.1. 新建集群</p>
<p>需要指定集群名称, 以及配置集群绑定的 <code>zookeeper</code> 集群地址;</p>
<p style="text-align: center"><!---ecms -ecms 
【图缺】
--></p>
<p>新建成功后, 在最右侧的 <code>操作-主配置</code> 中配置集群的通用 server 配置信息</p>
<p style="text-align: center"><!---ecms -ecms 
【图缺】
--></p>
<p>此处也可以将之前配置的 <code>../conf/canal.properties</code> 配置直接拷贝过来, 稍微修改一下就可以用了</p>
<p>代码如下：</p>
<pre>
<code>
# canal admin config
canal.admin.manager = 192.168.2.108:8089

canal.instance.global.mode = manager</code></pre>
<p>MySQL-canal-rabbitmq 安装部署超详细教程</p>
<p>1.4.3.2. 新建 server</p>
<p>指定所属集群, 为 <code>1.4.3.1</code> 中设定的集群名称;</p>
<p style="text-align: center"><!---ecms -ecms 
【图缺】
--></p>
<p>如果先前已经启动了 <code>canal-server</code> 节点服务, 则新建的 server 会自动识别为 <code>启动</code> 状态, 否则为 <code>断开</code> 状态;</p>
<p style="text-align: center"><!---ecms -ecms 
【图缺】
--></p>
<p>这里有一点需要十分注意的地方</p>
<p>细心的人可能会发现, 除了 <code>canal.properties</code> 配置文件, 还有一个 <code>canal_local.properties</code> 的配置文件, 后者比前者的内容少了很多, 因为这个文件就是用于搭建 <code>canal</code> 集群时, 本地节点的配置文件, 而前者配置文件里的其他信息都是交由 <code>canal-admin</code> 集中配置管理的;</p>
<p>在 <code>./bin/startup.bat[startup.sh]</code> 启动脚本里, 默认是加载 <code>canal.properties</code> 配置文件, 即以单机形式启动的服务;</p>
<p>windows 在搭建 <code>canal</code> 集群时, 需要手动修改 <code>startup.bat</code>, 蓝色标注处是加载 <code>%canal_conf%</code> 变量的配置文件路径, 所以需要将红色框内的变量调整为:</p>
<p>代码如下：</p>
<pre>
<code>
@rem set canal_conf=...
set canal_conf=%conf_dir%\canal_local.properties</code></pre>
<p>MySQL-canal-rabbitmq 安装部署超详细教程</p>
<p>使启动时加载 <code>canal_local.properties</code> 的配置文件</p>
<p style="text-align: center"><!---ecms -ecms 
【图缺】
--></p>
<p>1.4.3.3. 新建 instance</p>
<p>此处配置也可以基于单机 server 中的实例 <code>1.4.2.3</code> 配置进行调整使用;</p>
<p>代码如下：</p>
<pre>
<code>
# 2. position info, 指定 mysql 开始同步的 binlog 位置信息
canal.instance.master.address=192.168.0.25:63306
canal.instance.master.journal.name=mysql-bin.001349
canal.instance.master.position=198213313

# 3. username/password, 设置同步 mysql 的数据库用户名和密码
canal.instance.dbUsername=xxxx
canal.instance.dbPassword=xxx

# 4. table regex, 正则匹配需要同步的数据表
canal.instance.filter.regex=xxxx

# 5. mq config, 指定 mysql 上的路由绑定, 见 `1.2.3`
canal.mq.topic=example2-routingkey</code></pre>
<p>MySQL-canal-rabbitmq 安装部署超详细教程</p>
<p>保存后即可在 操作 中启动该实例</p>
<p style="text-align: center"><!---ecms -ecms 
【图缺】
--></p>
<p>后话如果此处的 instance 无法启动, 按一下几个步骤检查操作一下试试:</p>
<p>检查集群里的<code>主配置</code>里的<code>canal.destinations</code>是否包含新建的实例<code>instance</code>名称;检查<code>canal-server</code>节点是否加载的<code>canal_local.properties</code>配置文件;删除实例文件夹下的 <code>.db</code>, <code>.bat</code> 文件, 更新实例配置文件中的 <code>canal.instance.master.position</code> 的 <code>binglog</code> 位置后, 启动 <code>instance</code>;</p>
<p class="maodian"></p>
<h2>1.5. canal 配置说明</h2>
<p class="maodian"></p>
<h3>1.5.1. canal.properties</h3>
<ol>
	<li>canal.ip, 该节点 IP</li>
	<li>canal.register.ip, 注册到 zookeeper 上的 IP</li>
	<li>canal.zkServers, zk 集群</li>
	<li>是否启用 tsdb, 开启 table meta 的时间序列版本记录功能</li>
	<li>// 5. canal.serverMode, 设置为 rabbitmq, 默认为 tcp</li>
</ol>
<p>代码如下：</p>
<pre>
<code>
canal.instance.tsdb.enable = true
canal.instance.tsdb.dir = ${canal.file.data.dir:../conf}/${canal.instance.destination:}
canal.instance.tsdb.url = jdbc:h2:${canal.instance.tsdb.dir}/h2;CACHE_SIZE=1000;MODE=MYSQL;
canal.instance.tsdb.dbUsername = canal
canal.instance.tsdb.dbPassword = canal</code></pre>
<p>MySQL-canal-rabbitmq 安装部署超详细教程</p>
<p>5.canal.destinations, 当前集群上部署的 instance 列表</p>
<p>6.canal.mq.servers, 设置 Rabbitmq 集群地址, !! 此处不可以加上端口</p>
<p class="maodian"></p>
<h3>1.5.2. instance.properties</h3>
<ol>
	<li>canal.instance.master.address, master 数据库地址</li>
	<li>canal.instance.master.journal.name, 在数据库中执行show master status的File值</li>
	<li>canal.instance.master.position, 在数据库中执行show master status的Position值</li>
	<li>canal.instance.tsdb.enable=false, 禁用 tsdb</li>
	<li>canal.instance.dbUsername, 实例数据库用户名</li>
	<li>canal.instance.dbPassword, 实例数据库密码</li>
	<li>canal.instance.filter.regex, 匹配需要同步的表</li>
	<li>canal.mq.topic, canal 注册 mq 的 topic 名称</li>
</ol>
<p class="maodian"></p>
<h3>1.5.3. properties 配置文件</h3>
<p><code>properties</code> 配置分为两部分</p>
<p>canal.properties (系统根配置文件)instance.properties (instance 级别的配置文件, 每个实例一份)</p>
<p>1.canal.properties</p>
<p>代码如下：</p>
<pre>
<code>
canal.destinations # 当前 server 上部署的 instance 列表
canal.conf.dir # conf 目录所在路径
canal.auto.scan # 开启 instance 自动扫描
# 如果配置为 true, canal.conf.dir 目录下的 instance 配置变化会自动触发
# 1. instance 目录新增: 触发 instance 配置载入, lazy 为 true 时则自动启动;
# 2. instance 目录删除: 卸载对应 instance 配置, 如已启动则进行关闭;
# 3. instance.properties 文件变化: reload instance 配置, 如已启动则自动进行重启操作;
canal.auto.scan.interval # instance 自动扫描间隔时间, 单位 s
canal.instance.global.mode # 全局配置加载方式
canal.instance.global.lazy # 全局 lazy 模式
canal.instance.global.manager.address # 全局的 manager 配置方式的链接信息
canal.instance.global.spring.xml # 全局的 spring 配置方式的组件文件
canal.instance.example.mode
canal.instance.example.lazy
canal.instance.example.spring.xml
# instance 级别的配置定义, 如有配置, 会自动覆盖全局配置定义模式

canal.instance.tsdb.enable # 是否开启 table meta 的时间序列版本记录功能
canal.instance.tsdb.dir # 时间序列版本的本地存储路径, 默认为 instance 目录
canal.instance.tsdb.url # 时间序列版本的数据库连接地址, 默认为本地嵌入式数据库
canal.instance.tsdb.dbUsername # 时间序列版本的数据库连接账号
canal.instance.tsdb.dbPassword # 时间序列版本的数据库连接密码</code></pre>
<p>MySQL-canal-rabbitmq 安装部署超详细教程</p>
<p>2.instance.properties</p>
<p>代码如下：</p>
<pre>
<code>
canal.id # 每个 canal server 实例的唯一标识
canal.ip # canal server 绑定的本地 IP 信息, 如果不配置, 默认选择一个本机 IP 进行启动服务
canal.port # canal server 提供 socket 服务的端口
canal.zkServers # canal server 连接 zookeeper 集群的连接地址, 例如: 10.20.144.22:2181,10.20.144.23:2181
canal.zookeeper.flush.period # canal 持久化数据到 zookeeper 上的更新频率, 单位 ms
canal.instance.memory.batch.mode # canal 内存 store 中数据缓存模式
# 1. ITEMSIZE: 根据 buffer.size 进行限制, 只限制记录的数量
# 2. MEMSIZE: 根据 buffer.size * buffer.memunit 的大小, 限制缓存记录的大小;
canal.instance.memory.buffer.size # canal 内存 store 中可缓存 buffer 记录数, 需要为 2 的指数
canal.instance.memory.buffer.memunit # 内存记录的单位大小, 默认为 1KB, 和 buffer.size 组合决定最终的内存使用大小
canal.instance.transactions.size # 最大事务完整解析的长度支持, 超过该长度后, 一个事务可能会被拆分成多次提交到 canal store 中, 无法保证事务的完整可见性
canal.instance.fallbackIntervalInSeconds # canal 发生 mysql 切换时, 在新的 mysql 库上查找 binlog 时需要往前查找的时间, 单位 s
# 说明: mysql 主备库可能存在解析延迟或者时钟不一致, 需要回退一段时间, 保证数据不丢
canal.instance.detecting.enable # 是否开启心跳检查
canal.instance.detecting.sql # 心跳检查 sql, insert into retl.xdual values(1,now()) on duplicate key update x=now()
canal.instance.detecting.interval.time # 心跳检查频率, 单位 s
canal.instance.detecting.retry.threshold # 心跳检查失败重试次数
canal.instance.detecting.heatbeatHaEnable # 心跳检查失败后, 是否开启 mysql 自动切换
# 说明: 比如心跳检查失败超过阈值后, 如果该配置为 true, canal 会自动连到 mysql 备库获取 binlog 数据
canal.instance.network.receiveBufferSize # 网络连接参数, SocketOptions.SO_RCVBUF
canal.instance.network.sendBufferSize # 网络连接参数, SocketOptions.SO_SNDBUF
canal.instance.network.soTimeout # 网络连接参数, SocketOptions.SO_TIMEOUT</code></pre>
<p>MySQL-canal-rabbitmq 安装部署超详细教程</p>
<p>1.5.4. canal.mq.dynamicTopic</p>
<p style="text-align: center"><!---ecms -ecms 
【图缺】
--></p>
<p>参考: https://github.com/alibaba/canal/wiki/Canal-Kafka-RocketMQ-QuickStart?tdsourcetag=s_pctim_aiomsg</p>
<p class="maodian"></p>
<h2>1.6. 问题处理</h2>
<p>1.windows 下执行 <code>startup.bat</code> 启动 canal 时, 出现如下异常</p>
<blockquote>
<p>Failed to instantiate [ch.qos.logback.classic.LoggerContext]Reported exception:ch.qos.logback.core.LogbackException: Unexpected filename extension of file [file:/D:/env/green/canal/conf/]. Should be either .groovy or .xml at ch.qos.logback.classic.util.ContextInitializer.configureByResource(ContextInitializer.java:79) at ch.qos.logback.classic.util.ContextInitializer.autoConfig(ContextInitializer.java:152) at org.slf4j.impl.StaticLoggerBinder.init(StaticLoggerBinder.java:85) at org.slf4j.impl.StaticLoggerBinder.&lt;clinit&gt;(StaticLoggerBinder.java:55) at org.slf4j.LoggerFactory.bind(LoggerFactory.java:141) at org.slf4j.LoggerFactory.performInitialization(LoggerFactory.java:120) at org.slf4j.LoggerFactory.getILoggerFactory(LoggerFactory.java:331) at org.slf4j.LoggerFactory.getLogger(LoggerFactory.java:283) at org.slf4j.LoggerFactory.getLogger(LoggerFactory.java:304) at com.alibaba.otter.canal.deployer.CanalLauncher.&lt;clinit&gt;(CanalLauncher.java:29)</p></blockquote>
<p>解决方法:将 <code>startup.bat</code> 里的一下这行代码注释打开<code>@rem set logback_configurationFile=%conf_dir%\logback.xml</code></p>
<p>注, 新版 <code>1.1.5</code> 不存在该问题, <code>1.1.5</code>这个文件中的这一行是没有注释掉的.</p>
<p><code>1.1.5</code>新版本 <code>canal-admin</code> 启动时出现如下异常:</p>
<blockquote>
<p>2020-04-10 18:55:40.406 [main] ERROR com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Exception during pool initialization.java.sql.SQLException: The server time zone value &#39;�й���׼ʱ��&#39; is unrecognized or represents more than one time zone. You must configure either the server or JDBC driver (via the serverTimezone configuration property) to use a more specifc time zone value if you want to utilize time zone support.</p></blockquote>
<p>解决方法</p>
<p><code>spring.datasource.url</code> 配置的 mysql 连接地址后面加上参数 <code>&amp;serverTimezone=UTC</code></p>
<p><code>Instance</code> 日志里出现异常 <code>errno = 1236, sqlstate = HY000 errmsg = log event entry exceeded max_allowed_packet;</code></p>
<blockquote>
<p>2020-04-13 13:06:09.507 [destination = example3 , address = /192.168.2.108:3306 , EventParser] ERROR com.alibaba.otter.canal.common.alarm.LogAlarmHandler - destination:example3[java.io.IOException: Received error packet: errno = 1236, sqlstate = HY000 errmsg = log event entry exceeded max_allowed_packet; Increase max_allowed_packet on master; the first event &#39;mysql-5.7&#39; at 671745, the last event read from &#39;D:\env\mysql-5.7&#39; at 673181, the last byte read from &#39;D:\env\mysql-5.7&#39; at 673200.at com.alibaba.otter.canal.parse.inbound.mysql.dbsync.DirectLogFetcher.fetch(DirectLogFetcher.java:102)at com.alibaba.otter.canal.parse.inbound.mysql.MysqlConnection.dump(MysqlConnection.java:235)at com.alibaba.otter.canal.parse.inbound.AbstractEventParser$3.run(AbstractEventParser.java:265)at java.lang.Thread.run(Unknown Source)]</p></blockquote>
<p>解决方法</p>
<p>删除 <code>canal/conf</code> 下对应实例里的 <code>meta.dat</code> 文件, 让 <code>canal-admin</code> 自动再生成即可;</p>
<p class="maodian"></p>
<h2>1.7. 参考资料</h2>
<p>canal(基于 mysql 数据库 binlog 的增量订阅和消费)</p>
<p>Canal Admin 搭建 Canal 集群以及体验</p>
<p>canal 整合RabbitMQ</p>
<p>canal系列&mdash;配置文件介绍</p>
<p>到此这篇关于mysql-canal-rabbitmq 安装部署超详细教程的文章就介绍到这了,更多相关mysql-canal-rabbitmq 安装部署内容请搜索512笔记以前的文章或继续浏览下面的相关文章希望大家以后多多支持512笔记！</p></div>

<p>注：关于MySQL-canal-rabbitmq 安装部署的简单示例的内容就先介绍到这里，更多相关文章的可以留意</span>                                     
		    	</div>
		    	<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>代码注释</div>
			    <div class="panel-content">
			    <span></span>                                     
		    	</div>
			</div>

			<!-- END ROW -->
			<div class="newsPage">
				<div class="newsPageTurn">
				    <span><a>上一篇</a><a href='/mysql/biji/200.html'>关闭MySQL进程的解决办法</a><a>下一篇</a><a href='/mysql/biji/202.html'>MySQL 分组查询和聚合函数的解决办法</a></span>
				</div>
			</div>
		</div>


<div id="author-box">
    <h3>作者：喵哥笔记</h3>
        <div class="author-info">
            <div class="author-avatar">
                <img src="/skin1/picture/01.jpg" alt="IDC笔记" class="avatar" width="64" height="64">
            </div>
        <div class="author-description">
            <p>学的不仅是技术，更是梦想！</p>
            <ul class="author-social follows nb">
            	<li>
                    <a target="_blank" href="/" title="IDC笔记">IDC笔记</a>
                </li>
            </ul>
        </div>
        <div class="clear"></div>
    </div>
</div>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
<!-- container-fluid -->
	</div>
<!-- content -->
	<footer class="footer">
	© 2020 IDC笔记 <i class="mdi mdi-heart text-danger"></i>. | 备案号：<a href="https://beian.miit.gov.cn/">辽ICP备18000516号</a>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?674585fbbd2294d3faf910f668ea91b4";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

	</footer>
</div>

</div>
<!-- END wrapper -->
<!-- jQuery  -->
<script src="/skin1/js/jquery.min.js"></script>
<script src="/skin1/js/bootstrap.bundle.min.js"></script>
<script src="/skin1/js/metismenu.min.js"></script>
<script src="/skin1/js/jquery.slimscroll.js"></script>
<script src="/skin1/js/waves.min.js"></script>
<!--Morris Chart-->
<script src="/skin1/js/morris.min.js"></script>
<script src="/skin1/js/raphael.min.js"></script>
<script src="/skin1/js/dashboard.init.js"></script>
<script src="/skin1/js/app.js"></script>
<script src="/foot.js"></script>
</body>
</html>