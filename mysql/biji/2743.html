<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <title>SQL Server学习基础之内存初探用法_mysql教程_IDC笔记</title>
    <meta name="keywords" content="PHP,PHP笔记,PHP教程" />
    <meta name="description" content="这篇文章主要为大家详细介绍了SQL Server学习基础之内存初探用法，具有一定的参考价值，可以用来参考一下。

对此感兴趣的朋友，看看idc笔记做的技术笔记！

一. 前言

对于sql ser" />
    <meta content="Responsive admin theme build on top of Bootstrap 4" name="description" />
    <meta content="idcnote.com" name="author" />
    <link rel="shortcut icon" href="/skin1/images/favicon.ico">
    <!--Morris Chart CSS -->
    <link rel="stylesheet" href="/skin1/css/morris.css">
    <link href="/skin1/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/metismenu.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/icons.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/style.css" rel="stylesheet" type="text/css">
<link href="/SyntaxHighlighter/shCoreDefault.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">
 SyntaxHighlighter.all();
</script>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
</head>
<body>
<!-- Begin page -->
		<div id="wrapper">
			<!-- Top Bar Start -->
			<div class="topbar">
				<!-- LOGO -->
				<div class="topbar-left">
					<a href="/" class="logo">
						<span class="logo-light">
                            <i class="mdi mdi-camera-control"></i>IDC笔记
                        </span>
						<span class="logo-sm">
                            <i class="mdi mdi-camera-control"></i>
                        </span>
					</a>
				</div>
				<nav class="navbar-custom">
					<ul class="navbar-right list-inline float-right mb-0">
						<!--<li class="dropdown notification-list list-inline-item d-none d-md-inline-block">
							<a class="nav-link waves-effect" href="#" id="btn-fullscreen">
								<i class="mdi mdi-arrow-expand-all noti-icon"></i>
							</a>
						</li>
						<li class="dropdown notification-list list-inline-item">
							<div class="dropdown notification-list nav-pro-img">
								<a class="dropdown-toggle nav-link arrow-none nav-user" data-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
									<img src="/skin1/picture/user-4.jpg" alt="user" class="rounded-circle">
								</a>
								<div class="dropdown-menu dropdown-menu-right profile-dropdown ">
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-account-circle"></i> Profile</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-wallet"></i> Wallet</a>
									<a class="dropdown-item d-block" href="#">
										<span class="badge badge-success float-right">11</span>
										<i class="mdi mdi-settings"></i> Settings</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-lock-open-outline"></i> Lock screen</a>
									<div class="dropdown-divider"></div>
									<a class="dropdown-item text-danger" href="#">
										<i class="mdi mdi-power text-danger"></i> Logout</a>
								</div>
							</div>
						</li>
						-->
					</ul>
					<ul class="list-inline menu-left mb-0">
						<li class="float-left">
							<button class="button-menu-mobile open-left waves-effect">
                            <i class="mdi mdi-menu"></i>
                        </button>
						</li>
						<li class="d-none d-md-inline-block">
							<form role="search" class="app-search">
								<div class="form-group mb-0">
									<input type="text" class="form-control" placeholder="Search..">
									<button type="submit"><i class="fa fa-search"></i></button>
								</div>
							</form>
						</li>
					</ul>
				</nav>
			</div>
<!-- ========== Left Sidebar Start ========== -->
<div class="left side-menu">
    <div class="slimscroll-menu" id="remove-scroll">
    <!--- Sidemenu -->
    <div id="sidebar-menu">
    <!-- Left Menu Start -->
    <ul class="metismenu" id="side-menu">
			<li>
	    <a href="/mysql/biji/" class="waves-effect">
		    <i class="icon-share"></i>
		    <span>数据库笔记
		       	<span class="float-right menu-arrow">
		       	<i class="mdi mdi-chevron-right"></i>
		       	</span>
		    </span>
	    </a>
	</li>
	</ul>
</div>
<!-- Sidebar -->
<div class="clearfix"></div>
</div>
<!-- Sidebar -left -->
</div>
<!-- Left Sidebar End -->
<!-- Start right Content here -->
<div class="content-page">
	<div class="content">
		<div class="container-fluid">
			<div class="page-title-box">
				<div class="row align-items-center">
					<div class="col-sm-6">
						<h1 class="page-title">SQL Server学习基础之内存初探用法</h1>
					</div>
                    <div class="panel-title">
                        2022-11-12 09:40:09                    </div>
				</div>
				<!-- end row -->
			</div>
			<!-- end page-title -->
			<!-- START ROW -->
			<div class="panel panel-forbid">
				<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>内容摘要</div>
			    <div class="panel-content">
			    <span>这篇文章主要为大家详细介绍了SQL Server学习基础之内存初探用法，具有一定的参考价值，可以用来参考一下。

对此感兴趣的朋友，看看idc笔记做的技术笔记！

一. 前言

对于sql ser</span>                                     
		    	</div>
			    <div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>文章正文</div>
			    <div class="panel-content">
			    <span><p>这篇文章主要为大家详细介绍了SQL Server学习基础之内存初探用法，具有一定的参考价值，可以用来参考一下。</p>

<p>对此感兴趣的朋友，看看idc笔记做的技术笔记！</p>
<p></p>
<h3>一. 前言</h3>
<p></p>
<p>对于sql server 这个产品来说，内存这块是最重要的一个资源， 当我们新建一个会话，相同的sql语句查询第二次查询时间往往会比第一次快，特别是在sql统计或大量查询数据输出时，会有这么感觉。除了第一次要编译生成执行计划, 在CPU,I/O 的影响外，最主要的是第二次查询是从内存缓存中读出，为什么是这样，sql server 内存里存储了什么，它与windows内存又有什么区别？ 参考了一些资料 下面来试着讲讲。</p>
<p></p>
<h3>二. 内存和硬盘</h3>
<p></p>
<p>为什么内存是宝贵的，在每个系统上都是有限的，就像你看到的1 tb的硬盘，但是你通常看到的是50-200 G的内存， 物理内存的访问速度非常快，不能超过一定的限制。在内存有限的情况下，如果所有的进程都使用了有限的内存，并且新的进程将无法为他们找到任何内存，这就出现了虚拟地址空间的概念（也称为VAS）。</p>
<p>Virtual Address Space(虚拟地址空间)</p>
<p>是指一个应用程序能够申请访问的最大地址空间。32位寻址空间最大是4G， 64位寻址空间最大是8TB。</p>
<p>VAS作为中间的抽象层的, 不是所有的请求都直接映射到物理内存,它首先映射到VAS然后映射到物理内存。因此，它可以更协调的方式管理对内存的请求，而不是让进程去做，如果不是这样，它很快就会导致内存崩溃。</p>
<p>在Windows操作系统中，VAS 的内核进程与用户进程之间的划分是相同的。对于32位系统，最大的VAS 是4 G的内核/ 2 G到应用程序的中，在这里，SQL Server是应用程序进程，当我使用word进程时，它意味SQL Server进程差不多一样，将得到2 G的VAS。因此，从理论上讲，这意味着任何应用程序进程在32位上运行的都将拥有最大限度的2 G。</p>
<p></p>
<h3>三 sql server 内存 架构</h3>
<p></p>
<p>sql server 内存管理，在sql server 2012发生了重大改变，对内存重新实现了一遍。 先看下版本之间内存管理图的区别</p>
<p style="text-align: center">【图片暂缺】【图片暂缺】</p>
<p> 　　名词术语</p>
<p>　　　3.1 BufferPool　　　　　　</p>
<p>　　　　SQL Server使用BufferPool缓冲池来有效地管理SQL Server进程的内存请求。它是SQL Server的最大内存消耗者。缓冲区是内存中的一个8 KB的页面，与数据或索引页面大小相同，您可以将缓冲区看作是一个框架，它在从磁盘到内存的时候保存数据和索引页。</p>
<p>　　　　SQL Server缓冲区管理器管理将数据页读入缓冲池的任务，并将其写入磁盘。它是SQL Server的预留内存存储，如果您不为它设置值，它将占用尽可能多的内存。因此，在spconfigure中为max server内存设置最佳值总是被推荐为一种良好的实践。缓冲池只将内存分配给需要少于8 KB页面的请求。</p>
<p>　　　　对于大于8 KB内存的所有请求，都是由windows API直接分配的。所有缓存存储计划、数据和索引页都存储在这个缓冲池中。当用户请求row/rows时，如果缓冲区池中没有，则使该页面从磁盘进入内存。这种输入/输出可能在繁忙的系统上特别昂贵，因此尽可能减少SQL服务器缓存的大小，这可能会被用户看作是内存泄漏或SQL Server占用大量内存，但实际上它提高了性能，实际上这个特性是通过设计实现的。</p>
<p>　　　　下面这些内存不是来自缓冲池：　　　　　　SQL LCR　　　　　　扩展存储过程　　　　　　链接服务器分配的内存　　　　　　内存管理器完成的大页面分配（大页面为任意页面＞8 KB）　　　　　　COM对象</p>
<p> 3.2 single-page</p>
<p> 这块内存是&lt;=8kb 的存储，适用于sql server 2008及以前， 属于buffer pool 缓冲池来分配。有存储数据页面，Consumer功能组件。</p>
<p> 3.3 multi- page</p>
<p> 这块内存是&gt;8kb的 存储，适用于sql server 2008及以前， 不属于buffer pool 缓冲池来分配, 有存储Consumer功能组件, 第三方代码, Threads线程。</p>
<p> 　 3.4 any size page</p>
<p> 这个适用于sql server 2012及以上，整合了single-page,multi-page 统称pages。</p>
<p></p>
<h3>四. sql server 2008 内存</h3>
<p></p>
<p>从内存图我们可以看到有 page reservation 需预先申请的内存， 有momory objects 从windows api申请的内存， 有clr第三方申请的内存。</p>
<p>内存的分类方式有很多，下面介绍三种方式：</p>
<p>　　1. 按用途分类</p>
<p> 1.1 Database Cache(数据页面缓冲区)</p>
<p> 当用户修改了某个页面上的数据时，sql server会在页存中将这个页修改。但不会立刻将这个页面写回硬盘，而是等后面的checkpoint 或lazy write集中处理。</p>
<p> 1.2 各类Consumer功能组件</p>
<p> Connection 连接：包括输入缓冲池和输出缓冲池, 用来存储用户指令和返回结果。</p>
<p> General ：一组大杂烩: 语句，语句编译，范式化，锁数据结构，事务上下文，表格，索引的元数据等。</p>
<p> Query paln：语句和存储过程的执行计划。</p>
<p> Optimizer：sql server在生成执行计划的过程中需要消耗的内存。</p>
<p> Utilities：像BCP, Log Manager,Parallel Queries,Backup</p>
<p> 1.3 线程内存</p>
<p> 为每个线程分配0.5MB的内存</p>
<p> 1.4 第三方代码申请的内存</p>
<p>　　　　　　　　如用户定义的CLR,Linked Server分布式查询从远程数据库取回大量数据。</p>
<p>　　2. 按申请方式分类</p>
<p>　　　 申请方式是指要先预先Reserve一块大的内存，然后再一小块一小块的commit。对Database Cache是会先Reserve，再commit。</p>
<p>　　　　其他所有内存使用，基本都是直接commit，都叫Stolen。</p>
<p>　　3. 按申请大小分类（上面的内存图就是这种分类）</p>
<p>　　　　有二种内存申请单位: 一种是小于或等于8KB的，称为Buffer Pool，一次一个页面的这种分配，被称为single page allocation.</p>
<p>　　　 一种是大于8kb的，称为Multi-page（以前叫MemToLeave）,这种分配，被称为 Multiple Page Allocation.</p>
<p>　　　　注意这里的很大一部分内存不受 sql server本身控制.因为第三方代码申请的内存都放在Multi-page里.</p>
<p>　内存分类方法之间的关系</p>
<p></p>
<table border="1" cellpadding="0" cellspacing="0">
	<tbody>
		<tr>
			<td>
			<p>类型</p></td>
			<td>
			<p>Database cache</p>
			<p>数据页面缓冲区</p></td>
			<td>
			<p>Consumer</p>
			<p>功能组件</p></td>
			<td>
			<p>3 Party code</p>
			<p>第三方代码</p></td>
			<td>
			<p>Threads</p>
			<p>线程</p></td>
		</tr>
		<tr>
			<td>
			<p>Reserved/Commit</p></td>
			<td>
			<p>是</p></td>
			<td>
			<p>一般不是</p></td>
			<td>
			<p>一般不是</p></td>
			<td>
			<p>不是</p></td>
		</tr>
		<tr>
			<td>
			<p>Stolen</p></td>
			<td>
			<p>不是</p></td>
			<td>
			<p>是</p></td>
			<td>
			<p>是</p></td>
			<td>
			<p>是</p></td>
		</tr>
		<tr>
			<td>
			<p>Buffer Pool</p>
			<p>(single- page)</p></td>
			<td>
			<p>所有</p></td>
			<td>
			<p>绝大部分</p></td>
			<td>
			<p>没有</p></td>
			<td>
			<p>没有</p></td>
		</tr>
		<tr>
			<td>
			<p>MemToLeave</p>
			<p>(Multi -page)</p></td>
			<td>
			<p>没有</p></td>
			<td>
			<p>一小部分</p></td>
			<td>
			<p>所有</p></td>
			<td>
			<p>所有</p></td>
		</tr>
	</tbody>
</table>
<p></p>
<h3>五.sql server 2012 内存</h3>
<p></p>
<p>在 sql server 2012里，single page allocator 和multi page allocator 统一起来了，叫做any size page allocator。max server memory 不再像以前的版本那样，只控制buffer pool的大小，也包括那些大于8kb 的内存请求。也就是max server memory 能够更准确地控制SQL Server 的内存使用了。</p>
<p>　　如下图所示：</p>
<p style="text-align: center">【图片暂缺】　　　　</p>
<p> 使用dmv 来查看当前实例的总内存空间，以及占用内存空间</p>
<p>　　　　--Target Server Memory (KB)最多能申请的内存量　　　　--Total Server Memory (KB) 目前使用了多少内存量</p>
<p> 从下面的空间占用也可以看出来， 给sql server有分配多少内存， 它就会占用多少内存，以达到性能的最优。</p>
<p>代码如下：</p>
<pre>
<code>
select counter_name, ltrim(cntr_value*1.0/1024.0/1024.0)+'G' 
as memoryGB from master.sys.dm_os_performance_counters 
where counter_name like '%target%server%memory%'or counter_name like '%total%memory%'</code></pre>
<p></p>
<h3>六 总结</h3>
<p></p>
<p>当您启动Microsoft SQL Server时，SQL Server内存使用量可能会继续稳步增长，而不是减少，即使服务器上的活动很低。此外，任务管理器和性能监视器可能显示，计算机上可用的物理内存会逐渐减少，直到可用内存在4 MB到10 MB之间。这种行为本身并不表示内存泄漏。这种行为是典型的，并且是SQL Server缓冲池的预期行为。</p>
<p>默认情况下，SQL Server根据操作系统报告的物理内存负载动态地增长和缩小缓冲池（缓存）的大小。只要有足够的内存（4 MB和10 MB）可以防止分页，那么SQL Server缓冲池就会继续增长。当与SQL Server在同一台计算机上分配内存时，SQL Server缓冲管理器将根据需要释放内存。SQL Server可以每秒释放数兆字节的内存。这允许SQL Server快速地适应内存分配更改。</p>
<p>您可以为SQL Server数据库引擎使用最小服务器内存和最大服务器内存配置选项使用多少内存（缓冲池）设置上限和下限</p>
<p>请注意，通过上图设置内存最大 max 只限制SQL Server缓冲池的大小。不限制SQL Server为其他组件分配的剩余未保留内存区域，如扩展存储过程、COM对象、非共享dll、EXEs和MAPI组件。由于之前的分配，SQL Server私有字节的数量超过了最大服务器内存配置。</p>
<p>后面章节在详细介绍内存的查看分析</p>
<p>好了，以上就是这篇文章的全部内容了，希望本文的内容对大家的学习或者工作具有一定的参考学习价值，如果有疑问大家可以留言交流，谢谢大家对512笔记的支持。</p>
<p></p>
<h3>参考文献：</h3>
<p></p>
<ul>
	<li>　 SQL Server Memory and Troubleshooting</li>
	<li> Microsoft SQL Server企业级平台管理实践</li>
	<li> SQL Server 2012 内存管理 (memory management) 改进</li>
</ul>

<p>注：关于SQL Server学习基础之内存初探用法的内容就先介绍到这里，更多相关文章的可以留意</span>                                     
		    	</div>
		    	<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>代码注释</div>
			    <div class="panel-content">
			    <span></span>                                     
		    	</div>
			</div>

			<!-- END ROW -->
			<div class="newsPage">
				<div class="newsPageTurn">
				    <span><a>上一篇</a><a href='/mysql/biji/2742.html'>SQL Server通用脚本实现获取一年前日期的解决办法</a><a>下一篇</a><a href='/mysql/biji/2744.html'>SQL Server表和索引存储结构的解决办法</a></span>
				</div>
			</div>
		</div>


<div id="author-box">
    <h3>作者：喵哥笔记</h3>
        <div class="author-info">
            <div class="author-avatar">
                <img src="/skin1/picture/01.jpg" alt="IDC笔记" class="avatar" width="64" height="64">
            </div>
        <div class="author-description">
            <p>学的不仅是技术，更是梦想！</p>
            <ul class="author-social follows nb">
            	<li>
                    <a target="_blank" href="/" title="IDC笔记">IDC笔记</a>
                </li>
            </ul>
        </div>
        <div class="clear"></div>
    </div>
</div>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
<!-- container-fluid -->
	</div>
<!-- content -->
	<footer class="footer">
	© 2020 IDC笔记 <i class="mdi mdi-heart text-danger"></i>. | 备案号：<a href="https://beian.miit.gov.cn/">辽ICP备18000516号</a>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?674585fbbd2294d3faf910f668ea91b4";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

	</footer>
</div>

</div>
<!-- END wrapper -->
<!-- jQuery  -->
<script src="/skin1/js/jquery.min.js"></script>
<script src="/skin1/js/bootstrap.bundle.min.js"></script>
<script src="/skin1/js/metismenu.min.js"></script>
<script src="/skin1/js/jquery.slimscroll.js"></script>
<script src="/skin1/js/waves.min.js"></script>
<!--Morris Chart-->
<script src="/skin1/js/morris.min.js"></script>
<script src="/skin1/js/raphael.min.js"></script>
<script src="/skin1/js/dashboard.init.js"></script>
<script src="/skin1/js/app.js"></script>
<script src="/foot.js"></script>
</body>
</html>