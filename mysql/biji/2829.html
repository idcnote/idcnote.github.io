<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <title>SQL Server类似正则表达式的字符处理的解决办法_mysql教程_IDC笔记</title>
    <meta name="keywords" content="PHP,PHP笔记,PHP教程" />
    <meta name="description" content="这篇文章主要为大家详细介绍了SQL Server类似正则表达式的字符处理的简单示例，具有一定的参考价值，可以用来参考一下。

对此感兴趣的朋友，看看idc笔记做的技术笔记！
SQL Serve" />
    <meta content="Responsive admin theme build on top of Bootstrap 4" name="description" />
    <meta content="idcnote.com" name="author" />
    <link rel="shortcut icon" href="/skin1/images/favicon.ico">
    <!--Morris Chart CSS -->
    <link rel="stylesheet" href="/skin1/css/morris.css">
    <link href="/skin1/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/metismenu.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/icons.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/style.css" rel="stylesheet" type="text/css">
<link href="/SyntaxHighlighter/shCoreDefault.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">
 SyntaxHighlighter.all();
</script>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
</head>
<body>
<!-- Begin page -->
		<div id="wrapper">
			<!-- Top Bar Start -->
			<div class="topbar">
				<!-- LOGO -->
				<div class="topbar-left">
					<a href="/" class="logo">
						<span class="logo-light">
                            <i class="mdi mdi-camera-control"></i>IDC笔记
                        </span>
						<span class="logo-sm">
                            <i class="mdi mdi-camera-control"></i>
                        </span>
					</a>
				</div>
				<nav class="navbar-custom">
					<ul class="navbar-right list-inline float-right mb-0">
						<!--<li class="dropdown notification-list list-inline-item d-none d-md-inline-block">
							<a class="nav-link waves-effect" href="#" id="btn-fullscreen">
								<i class="mdi mdi-arrow-expand-all noti-icon"></i>
							</a>
						</li>
						<li class="dropdown notification-list list-inline-item">
							<div class="dropdown notification-list nav-pro-img">
								<a class="dropdown-toggle nav-link arrow-none nav-user" data-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
									<img src="/skin1/picture/user-4.jpg" alt="user" class="rounded-circle">
								</a>
								<div class="dropdown-menu dropdown-menu-right profile-dropdown ">
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-account-circle"></i> Profile</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-wallet"></i> Wallet</a>
									<a class="dropdown-item d-block" href="#">
										<span class="badge badge-success float-right">11</span>
										<i class="mdi mdi-settings"></i> Settings</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-lock-open-outline"></i> Lock screen</a>
									<div class="dropdown-divider"></div>
									<a class="dropdown-item text-danger" href="#">
										<i class="mdi mdi-power text-danger"></i> Logout</a>
								</div>
							</div>
						</li>
						-->
					</ul>
					<ul class="list-inline menu-left mb-0">
						<li class="float-left">
							<button class="button-menu-mobile open-left waves-effect">
                            <i class="mdi mdi-menu"></i>
                        </button>
						</li>
						<li class="d-none d-md-inline-block">
							<form role="search" class="app-search">
								<div class="form-group mb-0">
									<input type="text" class="form-control" placeholder="Search..">
									<button type="submit"><i class="fa fa-search"></i></button>
								</div>
							</form>
						</li>
					</ul>
				</nav>
			</div>
<!-- ========== Left Sidebar Start ========== -->
<div class="left side-menu">
    <div class="slimscroll-menu" id="remove-scroll">
    <!--- Sidemenu -->
    <div id="sidebar-menu">
    <!-- Left Menu Start -->
    <ul class="metismenu" id="side-menu">
			<li>
	    <a href="/mysql/biji/" class="waves-effect">
		    <i class="icon-share"></i>
		    <span>数据库笔记
		       	<span class="float-right menu-arrow">
		       	<i class="mdi mdi-chevron-right"></i>
		       	</span>
		    </span>
	    </a>
	</li>
	</ul>
</div>
<!-- Sidebar -->
<div class="clearfix"></div>
</div>
<!-- Sidebar -left -->
</div>
<!-- Left Sidebar End -->
<!-- Start right Content here -->
<div class="content-page">
	<div class="content">
		<div class="container-fluid">
			<div class="page-title-box">
				<div class="row align-items-center">
					<div class="col-sm-6">
						<h1 class="page-title">SQL Server类似正则表达式的字符处理的解决办法</h1>
					</div>
                    <div class="panel-title">
                        2022-11-12 09:40:56                    </div>
				</div>
				<!-- end row -->
			</div>
			<!-- end page-title -->
			<!-- START ROW -->
			<div class="panel panel-forbid">
				<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>内容摘要</div>
			    <div class="panel-content">
			    <span>这篇文章主要为大家详细介绍了SQL Server类似正则表达式的字符处理的简单示例，具有一定的参考价值，可以用来参考一下。

对此感兴趣的朋友，看看idc笔记做的技术笔记！
SQL Serve</span>                                     
		    	</div>
			    <div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>文章正文</div>
			    <div class="panel-content">
			    <span><p>这篇文章主要为大家详细介绍了SQL Server类似正则表达式的字符处理的简单示例，具有一定的参考价值，可以用来参考一下。</p>

<p>对此感兴趣的朋友，看看idc笔记做的技术笔记！</p>
<p>SQL Serve提供了简单的字符模糊匹配功能，比如：like, patindex，不过对于某些字符处理场景还显得并不足够，日常碰到的几个问题有：</p>
<p></p>
<h3>1. 同一个字符/字符串，出现了多少次</h3>
<p></p>
<p></p>
<h3>2. 同一个字符，第N次出现的位置</h3>
<p></p>
<p></p>
<h3>3. 多个相同字符连续，合并为一个字符</h3>
<p></p>
<p></p>
<h3>4. 是否为有效IP/身份证号/手机号等</h3>
<p></p>
<p></p>
<h3>一. 同一个字符/字符串，出现了多少次</h3>
<p></p>
<p>同一个字符，将其替换为空串，即可计算</p>
<p>代码如下：</p>
<pre>
<code>
declare @text varchar(1000)
declare @str varchar(10)
set @text = 'ABCBDBE'
set @str = 'B'
select len(@text) - len(replace(@text,@str,''))</code></pre>
<p>同一个字符串，仍然是替换，因为是多个字符，方法1替换后需要做一次除法；方法2替换时增加一个字符，则不需要</p>
<p>代码如下：</p>
<pre>
<code>
--方法1
declare @text varchar(1000)
declare @str varchar(10)
set @text = 'ABBBCBBBDBBBE'
set @str = 'BBB'
select (len(@text) - len(replace(@text,@str,'')))/len(@str)
--方法2
declare @text varchar(1000)
declare @str varchar(10)
set @text = 'ABBBCBBBDBBBE'
set @str = 'BBB'
select len(replace(@text,@str,@str+'_')) - len(@text)</code></pre>
<p></p>
<h3>二. 同一个字符/字符串，第N次出现的位置</h3>
<p></p>
<p>SQL SERVER定位字符位置的函数为CHARINDEX：</p>
<p>代码如下：</p>
<pre>
<code>
CHARINDEX ( expressionToFind , expressionToSearch [ , start_location ] )</code></pre>
<p>可以从指定位置起开始检索，但是不能取第N次出现的位置，需要自己写SQL来补充，有以下几种思路：</p>
<p>1. 自定义函数, 循环中每次为charindex加一个计数，直到为N</p>
<p>代码如下：</p>
<pre>
<code>
if object_id('NthChar','FN') is not null
  drop function Nthchar
GO
create function NthChar
(
@source_string as nvarchar(4000), 
@sub_string  as nvarchar(1024),
@nth      as int
) 
returns int 
as 
begin 
  declare @postion int 
  declare @count  int 
  set @postion = CHARINDEX(@sub_string, @source_string) 
  set @count = 0 
  while @postion &gt; 0 
  begin 
    set @count = @count + 1 
    if @count = @nth 
    begin 
      break 
    end
    set @postion = CHARINDEX(@sub_string, @source_string, @postion + 1) 
  End 
  return @postion 
end 
GO
--select dbo.NthChar('abcabc','abc',2)
--4</code></pre>
<p>2. 通过CTE，对待处理的整个表字段操作, 递归中每次为charindex加一个计数，直到为N</p>
<p>代码如下：</p>
<pre>
<code>
if object_id('tempdb..#T') is not null
  drop table #T
create table #T
(
source_string nvarchar(4000)
)
insert into #T values (N'我们我们')
insert into #T values (N'我我哦我')
declare @sub_string nvarchar(1024)
declare @nth    int
set @sub_string = N'我们'
set @nth = 2
;with T(source_string, starts, pos, nth) 
as (
  select source_string, 1, charindex(@sub_string, source_string), 1 from #t
  union all
  select source_string, pos + 1, charindex(@sub_string, source_string, pos + 1), nth+1 from T
  where pos &gt; 0
)
select 
  source_string, pos, nth
from T
where pos &lt;&gt; 0
 and nth = @nth
order by source_string, starts
--source_string  pos  nth
--我们我们  3  2</code></pre>
<p>3. 借助数字表 (tally table)，到不同起点位置去做charindex，需要先自己构造个数字表</p>
<p>代码如下：</p>
<pre>
<code>
--numbers/tally table
IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[dbo].[Numbers]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
  DROP TABLE dbo.Numbers
--===== Create and populate the Tally table on the fly
 SELECT TOP 1000000 
    IDENTITY(int,1,1) AS number
  INTO dbo.Numbers
  FROM master.dbo.syscolumns sc1,
    master.dbo.syscolumns sc2
--===== Add a Primary Key to maximize performance
 ALTER TABLE dbo.Numbers
    ADD CONSTRAINT PK_numbers_number PRIMARY KEY CLUSTERED (number)
--===== Allow the general public to use it
 GRANT SELECT ON dbo.Numbers TO PUBLIC
--以上数字表创建一次即可，不需要每次都重复创建
DECLARE @source_string  nvarchar(4000), 
    @sub_string    nvarchar(1024), 
    @nth       int
SET @source_string = 'abcabcvvvvabc'
SET @sub_string = 'abc'
SET @nth = 2 
;WITH T 
AS
(      
SELECT ROW_NUMBER() OVER(ORDER BY number) AS nth,
    number AS [Position In String]
 FROM dbo.Numbers n 
 WHERE n.number &lt;= LEN(@source_string)  
  AND CHARINDEX(@sub_string, @source_string, n.number)-number = 0
  ----OR
  --AND SUBSTRING(@source_string,number,LEN(@sub_string)) = @sub_string
) 
SELECT * FROM T WHERE nth = @nth</code></pre>
<p>4. 通过CROSS APPLY结合charindex，适用于N值较小的时候，因为CROSS APPLY的次数要随着N的变大而增加，语句也要做相应的修改</p>
<p>代码如下：</p>
<pre>
<code>
declare @T table
(
source_string nvarchar(4000)
)

insert into @T values
('abcabc'),
('abcabcvvvvabc')
declare @sub_string nvarchar(1024)
set @sub_string = 'abc'

select source_string,
    p1.pos as no1,
    p2.pos as no2,
    p3.pos as no3
from @T
cross apply (select (charindex(@sub_string, source_string))) as P1(Pos)
cross apply (select (charindex(@sub_string, source_string, P1.Pos+1))) as P2(Pos)
cross apply (select (charindex(@sub_string, source_string, P2.Pos+1))) as P3(Pos)</code></pre>
<p>5. 在SSIS里有内置的函数，但T-SQL中并没有</p>
<p>代码如下：</p>
<pre>
<code>
--FINDSTRING in SQL Server 2005 SSIS
FINDSTRING([yourColumn], "|", 2),
--TOKEN in SQL Server 2012 SSIS
TOKEN(Col1,"|",3)</code></pre>
<p>注：不难发现，这些方法和字符串拆分的逻辑是类似的，只不过一个是定位，一个是截取，如果要获取第N个字符左右的一个/多个字符，有了N的位置，再结合substring去截取即可；</p>
<p></p>
<h3>三. 多个相同字符连续，合并为一个字符</h3>
<p></p>
<p>最常见的就是把多个连续的空格合并为一个空格，解决思路有两个：</p>
<p></p>
<h3>1. 比较容易想到的就是用多个replace</h3>
<p></p>
<p>但是究竟需要replace多少次并不确定，所以还得循环多次才行</p>
<p>代码如下：</p>
<pre>
<code>
--把两个连续空格替换成一个空格，然后循环，直到charindex检查不到两个连续空格
declare @str varchar(100)
set @str='abc    abc   kljlk   kljkl'
while(charindex(' ',@str)&gt;0)
begin
  select @str=replace(@str,' ',' ')
end
select @str</code></pre>
<p></p>
<h3>2. 按照空格把字符串拆开</h3>
<p></p>
<p>对每一段拆分开的字符串trim或者replace后，再用一个空格连接，有点繁琐，没写代码示例，如何拆分字符串可参考：&ldquo;第N次出现的位置&rdquo;；</p>
<p></p>
<h3>四. 是否为有效IP/身份证号/手机号等</h3>
<p></p>
<p>类似IP/身份证号/手机号等这些字符串，往往都有自身特定的规律，通过substring去逐位或逐段判断是可以的，但SQL语句的方式往往性能不佳，建议尝试正则函数，见下。</p>
<p></p>
<h3>五. 正则表达式函数</h3>
<p></p>
<p>1. Oracle</p>
<p>从10g开始，可以在查询中使用正则表达式，它通过一些支持正则表达式的函数来实现：</p>
<p>代码如下：</p>
<pre>
<code>
Oracle 10 g
REGEXP_LIKE
REGEXP_REPLACE
REGEXP_INSTR
REGEXP_SUBSTR
Oracle 11g (新增)
REGEXP_COUNT</code></pre>
<p>Oracle用REGEXP函数处理上面几个问题：</p>
<p>(1) 同一个字符/字符串，出现了多少次</p>
<p>代码如下：</p>
<pre>
<code>
select length(regexp_replace('123-345-566', '[^-]', '')) from dual;
select REGEXP_COUNT('123-345-566', '-') from dual; --Oracle 11g </code></pre>
<p>(2) 同一个字符/字符串，第N次出现的位置</p>
<p>不需要正则，ORACLE的instr可以直接查找位置：</p>
<p>代码如下：</p>
<pre>
<code>
instr('source_string','sub_string' [,n][,m])</code></pre>
<p>n表示从第n个字符开始搜索，缺省值为1，m表示第m次出现，缺省值为1。</p>
<p>代码如下：</p>
<pre>
<code>
select instr('abcdefghijkabc','abc', 1, 2) position from dual; </code></pre>
<p>(3) 多个相同字符连续，合并为一个字符</p>
<p>代码如下：</p>
<pre>
<code>
select regexp_replace(trim('agc f  f '),'\s+',' ') from dual; </code></pre>
<p>(4) 是否为有效IP/身份证号/手机号等</p>
<p>代码如下：</p>
<pre>
<code>
--是否为有效IP
WITH IP
AS(
SELECT '10.20.30.40' ip_address FROM dual UNION ALL
SELECT 'a.b.c.d' ip_address FROM dual UNION ALL
SELECT '256.123.0.254' ip_address FROM dual UNION ALL
SELECT '255.255.255.255' ip_address FROM dual
)
SELECT *
FROM IP
WHERE REGEXP_LIKE(ip_address, '^(([0-9]{1}|[0-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\.){3}([0-9]{1}|[0-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])$');
--是否为有效身份证/手机号，暂未举例</code></pre>
<p></p>
<h3>2. SQL Server</h3>
<p></p>
<p>目前最新版本为SQL Server 2017，还没有对REGEXP函数的支持，需要通用CLR来扩展，如下为CLR实现REG_REPLACE：</p>
<p>代码如下：</p>
<pre>
<code>
--1. 开启 CLR 
EXEC sp_configure 'show advanced options' , '1'
GO
RECONFIGURE
GO
EXEC sp_configure 'clr enabled' , '1'
GO
RECONFIGURE
GO
EXEC sp_configure 'show advanced options' , '0';
GO</code></pre>
<p></p>
<h3>2. 创建 Assembly</h3>
<p></p>
<p>代码如下：</p>
<pre>
<code>
--3. 创建 CLR 函数
CREATE FUNCTION [dbo].[regex_replace](@input [nvarchar](4000), @pattern [nvarchar](4000), @replacement [nvarchar](4000))
RETURNS [nvarchar](4000) WITH EXECUTE AS CALLER, RETURNS NULL ON NULL INPUT
AS 
EXTERNAL NAME [RegexUtility].[RegexUtility].[RegexReplaceDefault]
GO
--4. 使用regex_replace替换多个空格为一个空格
select dbo.regex_replace('agc f  f ','\s+',' ');</code></pre>
<p>注：通过CLR实现更多REGEXP函数，如果有高级语言开发能力，可以自行开发；或者直接使用一些开源贡献也行，比如：http://devnambi.com/2016/sql-server-regex/</p>
<p></p>
<h3>小结：</h3>
<p></p>
<p>1. 非正则SQL语句的思路，对不同数据库往往都适用；</p>
<p>2. 正则表达式中的规则(pattern) 在不同开发语言里，有很多语法是相通的，通常是遵守perl或者linux shell中的sed等工具的规则；</p>
<p>3. 从性能上来看，通用SQL判断 &gt; REGEXP函数 &gt; 自定义SQL函数。</p>
<p></p>
<h3>总结</h3>
<p></p>
<p>以上所述是小编给大家介绍的SqlServer类似正则表达式的字符处理问题，希望对大家有所帮助，如果大家有任何疑问请给我留言，小编会及时回复大家的。在此也非常感谢大家对512笔记网站的支持！</p>

<p>注：关于SQL Server类似正则表达式的字符处理的简单示例的内容就先介绍到这里，更多相关文章的可以留意</span>                                     
		    	</div>
		    	<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>代码注释</div>
			    <div class="panel-content">
			    <span></span>                                     
		    	</div>
			</div>

			<!-- END ROW -->
			<div class="newsPage">
				<div class="newsPageTurn">
				    <span><a>上一篇</a><a href='/mysql/biji/2828.html'>SQL Server作业报错特殊案例示例</a><a>下一篇</a><a href='/mysql/biji/2830.html'>针对distinct疑问引发的一系列思考</a></span>
				</div>
			</div>
		</div>


<div id="author-box">
    <h3>作者：喵哥笔记</h3>
        <div class="author-info">
            <div class="author-avatar">
                <img src="/skin1/picture/01.jpg" alt="IDC笔记" class="avatar" width="64" height="64">
            </div>
        <div class="author-description">
            <p>学的不仅是技术，更是梦想！</p>
            <ul class="author-social follows nb">
            	<li>
                    <a target="_blank" href="/" title="IDC笔记">IDC笔记</a>
                </li>
            </ul>
        </div>
        <div class="clear"></div>
    </div>
</div>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
<!-- container-fluid -->
	</div>
<!-- content -->
	<footer class="footer">
	© 2020 IDC笔记 <i class="mdi mdi-heart text-danger"></i>. | 备案号：<a href="https://beian.miit.gov.cn/">辽ICP备18000516号</a>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?674585fbbd2294d3faf910f668ea91b4";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

	</footer>
</div>

</div>
<!-- END wrapper -->
<!-- jQuery  -->
<script src="/skin1/js/jquery.min.js"></script>
<script src="/skin1/js/bootstrap.bundle.min.js"></script>
<script src="/skin1/js/metismenu.min.js"></script>
<script src="/skin1/js/jquery.slimscroll.js"></script>
<script src="/skin1/js/waves.min.js"></script>
<!--Morris Chart-->
<script src="/skin1/js/morris.min.js"></script>
<script src="/skin1/js/raphael.min.js"></script>
<script src="/skin1/js/dashboard.init.js"></script>
<script src="/skin1/js/app.js"></script>
<script src="/foot.js"></script>
</body>
</html>