<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <title>提高MySQL 查询效率的三个技巧第1/2页_mysql教程_IDC笔记</title>
    <meta name="keywords" content="PHP,PHP笔记,PHP教程" />
    <meta name="description" content="这篇文章主要为大家详细介绍了提高MySQL 查询效率的三个技巧第1/2页，具有一定的参考价值，可以用来参考一下。

对此感兴趣的朋友，看看idc笔记做的技术笔记！MySQL由于它本身的小" />
    <meta content="Responsive admin theme build on top of Bootstrap 4" name="description" />
    <meta content="idcnote.com" name="author" />
    <link rel="shortcut icon" href="/skin1/images/favicon.ico">
    <!--Morris Chart CSS -->
    <link rel="stylesheet" href="/skin1/css/morris.css">
    <link href="/skin1/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/metismenu.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/icons.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/style.css" rel="stylesheet" type="text/css">
<link href="/SyntaxHighlighter/shCoreDefault.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">
 SyntaxHighlighter.all();
</script>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
</head>
<body>
<!-- Begin page -->
		<div id="wrapper">
			<!-- Top Bar Start -->
			<div class="topbar">
				<!-- LOGO -->
				<div class="topbar-left">
					<a href="/" class="logo">
						<span class="logo-light">
                            <i class="mdi mdi-camera-control"></i>IDC笔记
                        </span>
						<span class="logo-sm">
                            <i class="mdi mdi-camera-control"></i>
                        </span>
					</a>
				</div>
				<nav class="navbar-custom">
					<ul class="navbar-right list-inline float-right mb-0">
						<!--<li class="dropdown notification-list list-inline-item d-none d-md-inline-block">
							<a class="nav-link waves-effect" href="#" id="btn-fullscreen">
								<i class="mdi mdi-arrow-expand-all noti-icon"></i>
							</a>
						</li>
						<li class="dropdown notification-list list-inline-item">
							<div class="dropdown notification-list nav-pro-img">
								<a class="dropdown-toggle nav-link arrow-none nav-user" data-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
									<img src="/skin1/picture/user-4.jpg" alt="user" class="rounded-circle">
								</a>
								<div class="dropdown-menu dropdown-menu-right profile-dropdown ">
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-account-circle"></i> Profile</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-wallet"></i> Wallet</a>
									<a class="dropdown-item d-block" href="#">
										<span class="badge badge-success float-right">11</span>
										<i class="mdi mdi-settings"></i> Settings</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-lock-open-outline"></i> Lock screen</a>
									<div class="dropdown-divider"></div>
									<a class="dropdown-item text-danger" href="#">
										<i class="mdi mdi-power text-danger"></i> Logout</a>
								</div>
							</div>
						</li>
						-->
					</ul>
					<ul class="list-inline menu-left mb-0">
						<li class="float-left">
							<button class="button-menu-mobile open-left waves-effect">
                            <i class="mdi mdi-menu"></i>
                        </button>
						</li>
						<li class="d-none d-md-inline-block">
							<form role="search" class="app-search">
								<div class="form-group mb-0">
									<input type="text" class="form-control" placeholder="Search..">
									<button type="submit"><i class="fa fa-search"></i></button>
								</div>
							</form>
						</li>
					</ul>
				</nav>
			</div>
<!-- ========== Left Sidebar Start ========== -->
<div class="left side-menu">
    <div class="slimscroll-menu" id="remove-scroll">
    <!--- Sidemenu -->
    <div id="sidebar-menu">
    <!-- Left Menu Start -->
    <ul class="metismenu" id="side-menu">
			<li>
	    <a href="/mysql/biji/" class="waves-effect">
		    <i class="icon-share"></i>
		    <span>数据库笔记
		       	<span class="float-right menu-arrow">
		       	<i class="mdi mdi-chevron-right"></i>
		       	</span>
		    </span>
	    </a>
	</li>
	</ul>
</div>
<!-- Sidebar -->
<div class="clearfix"></div>
</div>
<!-- Sidebar -left -->
</div>
<!-- Left Sidebar End -->
<!-- Start right Content here -->
<div class="content-page">
	<div class="content">
		<div class="container-fluid">
			<div class="page-title-box">
				<div class="row align-items-center">
					<div class="col-sm-6">
						<h1 class="page-title">提高MySQL 查询效率的三个技巧第1/2页</h1>
					</div>
                    <div class="panel-title">
                        2022-11-12 09:20:57                    </div>
				</div>
				<!-- end row -->
			</div>
			<!-- end page-title -->
			<!-- START ROW -->
			<div class="panel panel-forbid">
				<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>内容摘要</div>
			    <div class="panel-content">
			    <span>这篇文章主要为大家详细介绍了提高MySQL 查询效率的三个技巧第1/2页，具有一定的参考价值，可以用来参考一下。

对此感兴趣的朋友，看看idc笔记做的技术笔记！MySQL由于它本身的小</span>                                     
		    	</div>
			    <div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>文章正文</div>
			    <div class="panel-content">
			    <span><p>这篇文章主要为大家详细介绍了提高MySQL 查询效率的三个技巧第1/2页，具有一定的参考价值，可以用来参考一下。</p>

<p>对此感兴趣的朋友，看看idc笔记做的技术笔记！</p>MySQL由于它本身的小巧和操作的高效,在数据库应用中越来越多的被采用.我在开发一个P2P应用的时候曾经使用MySQL来保存P2P节点,由于P2P的应用中,结点数动辄上万个,而且节点变化频繁,因此一定要保持查询和插入的高效.以下是我在使用过程中做的提高效率的三个有效的尝试.l使用statement进行绑定查询使用statement可以提前构建查询语法树,在查询时不再需要构建语法树就直接查询.因此可以很好的提高查询的效率.这个方法适合于查询条件固定但查询非常频繁的场合.使用方法是:绑定,创建一个MYSQL_STMT变量,与对应的查询字符串绑定,字符串中的问号代表要传入的变量,每个问号都必须指定一个变量.查询,输入每个指定的变量,传入MYSQL_STMT变量用可用的连接句柄执行.代码如下://1.绑定boolCDBManager::BindInsertStmt(MYSQL*connecthandle){//作插入操作的绑定MYSQL_BINDinsertbind[FEILD_NUM];if(m_stInsertParam==NULL)m_stInsertParam=newCHostCacheTable;m_stInsertStmt=mysql_stmt_init(connecthandle);//构建绑定字符串charinsertSQL[SQL_LENGTH];strcpy(insertSQL,&quot;insertintoHostCache(SessionID,ChannelID,ISPType,&quot;&quot;ExternalIP,ExternalPort,InternalIP,InternalPort)&quot;&quot;values(?,?,?,?,?,?,?)&quot;);mysql_stmt_prepare(m_stInsertStmt,insertSQL,strlen(insertSQL));intparam_count=mysql_stmt_param_count(m_stInsertStmt);if(param_count!=FEILD_NUM)returnfalse;//填充bind结构数组,m_sInsertParam是这个statement关联的结构变量memset(insertbind,0,sizeof(insertbind));insertbind[0].buffer_type=MYSQL_TYPE_STRING;insertbind[0].buffer_length=ID_LENGTH/*-1*/;insertbind[0].buffer=(char*)m_stInsertParam-&gt;sessionid;insertbind[0].is_null=0;insertbind[0].length=0;insertbind[1].buffer_type=MYSQL_TYPE_STRING;insertbind[1].buffer_length=ID_LENGTH/*-1*/;insertbind[1].buffer=(char*)m_stInsertParam-&gt;channelid;insertbind[1].is_null=0;insertbind[1].length=0;insertbind[2].buffer_type=MYSQL_TYPE_TINY;insertbind[2].buffer=(char*)&amp;m_stInsertParam-&gt;ISPtype;insertbind[2].is_null=0;insertbind[2].length=0;insertbind[3].buffer_type=MYSQL_TYPE_LONG;insertbind[3].buffer=(char*)&amp;m_stInsertParam-&gt;externalIP;insertbind[3].is_null=0;insertbind[3].length=0;insertbind[4].buffer_type=MYSQL_TYPE_SHORT;insertbind[4].buffer=(char*)&amp;m_stInsertParam-&gt;externalPort;insertbind[4].is_null=0;insertbind[4].length=0;insertbind[5].buffer_type=MYSQL_TYPE_LONG;insertbind[5].buffer=(char*)&amp;m_stInsertParam-&gt;internalIP;insertbind[5].is_null=0;insertbind[5].length=0;insertbind[6].buffer_type=MYSQL_TYPE_SHORT;insertbind[6].buffer=(char*)&amp;m_stInsertParam-&gt;internalPort;insertbind[6].is_null=0;insertbind[6].is_null=0;//绑定if(mysql_stmt_bind_param(m_stInsertStmt,insertbind))returnfalse;returntrue;}//2.查询boolCDBManager::InsertHostCache2(MYSQL*connecthandle,char*sessionid,char*channelid,intISPtype,\unsignedinteIP,unsignedshorteport,unsignedintiIP,unsignedshortiport){//填充结构变量m_sInsertParamstrcpy(m_stInsertParam-&gt;sessionid,sessionid);strcpy(m_stInsertParam-&gt;channelid,channelid);m_stInsertParam-&gt;ISPtype=ISPtype;m_stInsertParam-&gt;externalIP=eIP;m_stInsertParam-&gt;externalPort=eport;m_stInsertParam-&gt;internalIP=iIP;m_stInsertParam-&gt;internalPort=iport;//执行statement,性能瓶颈处if(mysql_stmt_execute(m_stInsertStmt))returnfalse;returntrue;}l随机的获取记录在某些数据库的应用中,我们并不是要获取所有的满足条件的记录,而只是要随机挑选出满足条件的记录.这种情况常见于数据业务的统计分析,从大容量数据库中获取小量的数据的场合.有两种方法可以做到1.常规方法,首先查询出所有满足条件的记录,然后随机的挑选出部分记录.这种方法在满足条件的记录数很多时效果不理想.2.使用limit语法,先获取满足条件的记录条数,然后在sql查询语句中加入limit来限制只查询满足要求的一段记录.这种方法虽然要查询两次,但是在数据量大时反而比较高效.示例代码如下://1.常规的方法//性能瓶颈,10万条记录时,执行查询140ms,获取结果集500ms,其余可忽略intCDBManager::QueryHostCache(MYSQL*connecthandle,char*channelid,intISPtype,CDBManager::CHostCacheTable*&amp;hostcache){charselectSQL[SQL_LENGTH];memset(selectSQL,0,sizeof(selectSQL));sprintf(selectSQL,&quot;select*fromHostCachewhereChannelID=&#39;%s&#39;andISPtype=%d&quot;,channelid,ISPtype);if(mysql_real_query(connecthandle,selectSQL,strlen(selectSQL))!=0)//检索return0;//获取结果集m_pResultSet=mysql_store_result(connecthandle);if(!m_pResultSet)//获取结果集出错return0;intiAllNumRows=(int)(mysql_num_rows(m_pResultSet));///&lt;所有的搜索结果数//计算待返回的结果数intiReturnNumRows=(iAllNumRows&lt;=RETURN_QUERY_HOST_NUM)?iAllNumRows:RETURN_QUERY_HOST_NUM;if(iReturnNumRows&lt;=RETURN_QUERY_HOST_NUM){//获取逐条记录for(inti=0;i&lt;iReturnNumRows;i++){//获取逐个字段m_Row=mysql_fetch_row(m_pResultSet);if(m_Row[0]!=NULL)strcpy(hostcache[i].sessionid,m_Row[0]);if(m_Row[1]!=NULL)strcpy(hostcache[i].channelid,m_Row[1]);if(m_Row[2]!=NULL)hostcache[i].ISPtype=atoi(m_Row[2]);if(m_Row[3]!=NULL)hostcache[i].externalIP=atoi(m_Row[3]);if(m_Row[4]!=NULL)hostcache[i].externalPort=atoi(m_Row[4]);if(m_Row[5]!=NULL)hostcache[i].internalIP=atoi(m_Row[5]);if(m_Row[6]!=NULL)hostcache[i].internalPort=atoi(m_Row[6]);}}else{//随机的挑选指定条记录返回intiRemainder=iAllNumRows%iReturnNumRows;///&lt;余数intiQuotient=iAllNumRows/iReturnNumRows;///&lt;商intiStartIndex=rand()%(iRemainder+1);///&lt;开始下标//获取逐条记录for(intiSelectedIndex=0;iSelectedIndex&lt;iReturnNumRows;iSelectedIndex++){mysql_data_seek(m_pResultSet,iStartIndex+iQuotient*iSelectedIndex);m_Row=mysql_fetch_row(m_pResultSet);if(m_Row[0]!=NULL)strcpy(hostcache[iSelectedIndex].sessionid,m_Row[0]);if(m_Row[1]!=NULL)strcpy(hostcache[iSelectedIndex].channelid,m_Row[1]);if(m_Row[2]!=NULL)hostcache[iSelectedIndex].ISPtype=atoi(m_Row[2]);if(m_Row[3]!=NULL)hostcache[iSelectedIndex].externalIP=atoi(m_Row[3]);if(m_Row[4]!=NULL)hostcache[iSelectedIndex].externalPort=atoi(m_Row[4]);if(m_Row[5]!=NULL)hostcache[iSelectedIndex].internalIP=atoi(m_Row[5]);if(m_Row[6]!=NULL)hostcache[iSelectedIndex].internalPort=atoi(m_Row[6]);}}//释放结果集内容mysql_free_result(m_pResultSet);returniReturnNumRows;}
<div class="pagenum tc"><strong>12下一页阅读全文 </strong>
<p><strong>对此感兴趣的朋友，看看idc笔记做的技术笔记！</strong></p><strong>//2.使用limit版intCDBManager::QueryHostCache(MYSQL*connecthandle,char*channelid,unsignedintmyexternalip,intISPtype,CHostCacheTable*hostcache){//首先获取满足结果的记录条数,再使用limit随机选择指定条记录返回MYSQL_ROWrow;MYSQL_RES*pResultSet;charselectSQL[SQL_LENGTH];memset(selectSQL,0,sizeof(selectSQL));sprintf(selectSQL,&quot;selectcount(*)fromHostCachewhereChannelID=&#39;%s&#39;andISPtype=%d&quot;,channelid,ISPtype);if(mysql_real_query(connecthandle,selectSQL,strlen(selectSQL))!=0)//检索return0;pResultSet=mysql_store_result(connecthandle);if(!pResultSet)return0;row=mysql_fetch_row(pResultSet);intiAllNumRows=atoi(row[0]);mysql_free_result(pResultSet);//计算待取记录的上下范围intiLimitLower=(iAllNumRows&lt;=RETURN_QUERY_HOST_NUM)?0:(rand()%(iAllNumRows-RETURN_QUERY_HOST_NUM));intiLimitUpper=(iAllNumRows&lt;=RETURN_QUERY_HOST_NUM)?iAllNumRows:(iLimitLower+RETURN_QUERY_HOST_NUM);//计算待返回的结果数intiReturnNumRows=(iAllNumRows&lt;=RETURN_QUERY_HOST_NUM)?iAllNumRows:RETURN_QUERY_HOST_NUM;//使用limit作查询sprintf(selectSQL,&quot;selectSessionID,ExternalIP,ExternalPort,InternalIP,InternalPort&quot;&quot;fromHostCachewhereChannelID=&#39;%s&#39;andISPtype=%dlimit%d,%d&quot;,channelid,ISPtype,iLimitLower,iLimitUpper);if(mysql_real_query(connecthandle,selectSQL,strlen(selectSQL))!=0)//检索return0;pResultSet=mysql_store_result(connecthandle);if(!pResultSet)return0;//获取逐条记录for(inti=0;i&lt;iReturnNumRows;i++){//获取逐个字段row=mysql_fetch_row(pResultSet);if(row[0]!=NULL)strcpy(hostcache[i].sessionid,row[0]);if(row[1]!=NULL)hostcache[i].externalIP=atoi(row[1]);if(row[2]!=NULL)hostcache[i].externalPort=atoi(row[2]);if(row[3]!=NULL)hostcache[i].internalIP=atoi(row[3]);if(row[4]!=NULL)hostcache[i].internalPort=atoi(row[4]);}//释放结果集内容mysql_free_result(pResultSet);returniReturnNumRows;}l使用连接池管理连接.在有大量节点访问的数据库设计中,经常要使用到连接池来管理所有的连接.一般方法是:建立两个连接句柄队列,空闲的等待使用的队列和正在使用的队列.当要查询时先从空闲队列中获取一个句柄,插入到正在使用的队列,再用这个句柄做数据库操作,完毕后一定要从使用队列中删除,再插入到空闲队列.设计代码如下://定义句柄队列typedefstd::list&lt;MYSQL*&gt;CONNECTION_HANDLE_LIST;typedefstd::list&lt;MYSQL*&gt;::iteratorCONNECTION_HANDLE_LIST_IT;//连接数据库的参数结构classCDBParameter{public:char*host;///&lt;主机名char*user;///&lt;用户名char*password;///&lt;密码char*database;///&lt;数据库名unsignedintport;///&lt;端口，一般为0constchar*unix_socket;///&lt;套接字，一般为NULLunsignedintclient_flag;///&lt;一般为0};//创建两个队列CONNECTION_HANDLE_LISTm_lsBusyList;///&lt;正在使用的连接句柄CONNECTION_HANDLE_LISTm_lsIdleList;///&lt;未使用的连接句柄//所有的连接句柄先连上数据库,加入到空闲队列中,等待使用.boolCDBManager::Connect(char*host/*=&quot;localhost&quot;*/,char*user/*=&quot;chenmin&quot;*/,\char*password/*=&quot;chenmin&quot;*/,char*database/*=&quot;HostCache&quot;*/){CDBParameter*lpDBParam=newCDBParameter();lpDBParam-&gt;host=host;lpDBParam-&gt;user=user;lpDBParam-&gt;password=password;lpDBParam-&gt;database=database;lpDBParam-&gt;port=0;lpDBParam-&gt;unix_socket=NULL;lpDBParam-&gt;client_flag=0;try{//连接for(intindex=0;index&lt;CONNECTION_NUM;index++){MYSQL*pConnectHandle=mysql_init((MYSQL*)0);//初始化连接句柄if(!mysql_real_connect(pConnectHandle,lpDBParam-&gt;host,lpDBParam-&gt;user,lpDBParam-&gt;password,\lpDBParam-&gt;database,lpDBParam-&gt;port,lpDBParam-&gt;unix_socket,lpDBParam-&gt;client_fla))returnfalse;//加入到空闲队列中m_lsIdleList.push_back(pConnectHandle);}}catch(...){returnfalse;}returntrue;}//提取一个空闲句柄供使用MYSQL*CDBManager::GetIdleConnectHandle(){MYSQL*pConnectHandle=NULL;m_ListMutex.acquire();if(m_lsIdleList.size()){pConnectHandle=m_lsIdleList.front();m_lsIdleList.pop_front();m_lsBusyList.push_back(pConnectHandle);}else//特殊情况,闲队列中为空,返回为空{pConnectHandle=0;}m_ListMutex.release();returnpConnectHandle;}//从使用队列中释放一个使用完毕的句柄,插入到空闲队列voidCDBManager::SetIdleConnectHandle(MYSQL*connecthandle){m_ListMutex.acquire();m_lsBusyList.remove(connecthandle);m_lsIdleList.push_back(connecthandle);m_ListMutex.release();}//使用示例,首先获取空闲句柄,利用这个句柄做真正的操作,然后再插回到空闲队列boolCDBManager::DeleteHostCacheBySessionID(char*sessionid){MYSQL*pConnectHandle=GetIdleConnectHandle();if(!pConnectHandle)return0;boolbRet=DeleteHostCacheBySessionID(pConnectHandle,sessionid);SetIdleConnectHandle(pConnectHandle);returnbRet;}//传入空闲的句柄,做真正的删除操作boolCDBManager::DeleteHostCacheBySessionID(MYSQL*connecthandle,char*sessionid){chardeleteSQL[SQL_LENGTH];memset(deleteSQL,0,sizeof(deleteSQL));sprintf(deleteSQL,&quot;deletefromHostCachewhereSessionID=&#39;%s&#39;&quot;,sessionid);if(mysql_query(connecthandle,deleteSQL)!=0)//删除returnfalse;returntrue;} </strong>
<div class="pagenum tc"><strong>上一页1<strong>2阅读全文 </strong></strong></div></div>

<p>注：关于提高MySQL 查询效率的三个技巧第1/2页的内容就先介绍到这里，更多相关文章的可以留意</span>                                     
		    	</div>
		    	<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>代码注释</div>
			    <div class="panel-content">
			    <span></span>                                     
		    	</div>
			</div>

			<!-- END ROW -->
			<div class="newsPage">
				<div class="newsPageTurn">
				    <span><a>上一篇</a><a href='/mysql/biji/939.html'>弄懂MySQL查询语句的执行过程的解决办法</a><a>下一篇</a><a href='/mysql/biji/941.html'>MySQL的Seconds_Behind_Master的解决办法</a></span>
				</div>
			</div>
		</div>


<div id="author-box">
    <h3>作者：喵哥笔记</h3>
        <div class="author-info">
            <div class="author-avatar">
                <img src="/skin1/picture/01.jpg" alt="IDC笔记" class="avatar" width="64" height="64">
            </div>
        <div class="author-description">
            <p>学的不仅是技术，更是梦想！</p>
            <ul class="author-social follows nb">
            	<li>
                    <a target="_blank" href="/" title="IDC笔记">IDC笔记</a>
                </li>
            </ul>
        </div>
        <div class="clear"></div>
    </div>
</div>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
<!-- container-fluid -->
	</div>
<!-- content -->
	<footer class="footer">
	© 2020 IDC笔记 <i class="mdi mdi-heart text-danger"></i>. | 备案号：<a href="https://beian.miit.gov.cn/">辽ICP备18000516号</a>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?674585fbbd2294d3faf910f668ea91b4";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

	</footer>
</div>

</div>
<!-- END wrapper -->
<!-- jQuery  -->
<script src="/skin1/js/jquery.min.js"></script>
<script src="/skin1/js/bootstrap.bundle.min.js"></script>
<script src="/skin1/js/metismenu.min.js"></script>
<script src="/skin1/js/jquery.slimscroll.js"></script>
<script src="/skin1/js/waves.min.js"></script>
<!--Morris Chart-->
<script src="/skin1/js/morris.min.js"></script>
<script src="/skin1/js/raphael.min.js"></script>
<script src="/skin1/js/dashboard.init.js"></script>
<script src="/skin1/js/app.js"></script>
<script src="/foot.js"></script>
</body>
</html>