<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <title>SQL SERVER数据库中经常用到的操作和管理数据库的语句总结_mysql教程_IDC笔记</title>
    <meta name="keywords" content="PHP,PHP笔记,PHP教程" />
    <meta name="description" content="这篇文章主要为大家详细介绍了SQL SERVER数据库中经常用到的操作和管理数据库的语句总结，具有一定的参考价值，可以用来参考一下。

对此感兴趣的朋友，看看idc笔记做的技术笔记！" />
    <meta content="Responsive admin theme build on top of Bootstrap 4" name="description" />
    <meta content="idcnote.com" name="author" />
    <link rel="shortcut icon" href="/skin1/images/favicon.ico">
    <!--Morris Chart CSS -->
    <link rel="stylesheet" href="/skin1/css/morris.css">
    <link href="/skin1/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/metismenu.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/icons.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/style.css" rel="stylesheet" type="text/css">
<link href="/SyntaxHighlighter/shCoreDefault.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">
 SyntaxHighlighter.all();
</script>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
</head>
<body>
<!-- Begin page -->
		<div id="wrapper">
			<!-- Top Bar Start -->
			<div class="topbar">
				<!-- LOGO -->
				<div class="topbar-left">
					<a href="/" class="logo">
						<span class="logo-light">
                            <i class="mdi mdi-camera-control"></i>IDC笔记
                        </span>
						<span class="logo-sm">
                            <i class="mdi mdi-camera-control"></i>
                        </span>
					</a>
				</div>
				<nav class="navbar-custom">
					<ul class="navbar-right list-inline float-right mb-0">
						<!--<li class="dropdown notification-list list-inline-item d-none d-md-inline-block">
							<a class="nav-link waves-effect" href="#" id="btn-fullscreen">
								<i class="mdi mdi-arrow-expand-all noti-icon"></i>
							</a>
						</li>
						<li class="dropdown notification-list list-inline-item">
							<div class="dropdown notification-list nav-pro-img">
								<a class="dropdown-toggle nav-link arrow-none nav-user" data-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
									<img src="/skin1/picture/user-4.jpg" alt="user" class="rounded-circle">
								</a>
								<div class="dropdown-menu dropdown-menu-right profile-dropdown ">
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-account-circle"></i> Profile</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-wallet"></i> Wallet</a>
									<a class="dropdown-item d-block" href="#">
										<span class="badge badge-success float-right">11</span>
										<i class="mdi mdi-settings"></i> Settings</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-lock-open-outline"></i> Lock screen</a>
									<div class="dropdown-divider"></div>
									<a class="dropdown-item text-danger" href="#">
										<i class="mdi mdi-power text-danger"></i> Logout</a>
								</div>
							</div>
						</li>
						-->
					</ul>
					<ul class="list-inline menu-left mb-0">
						<li class="float-left">
							<button class="button-menu-mobile open-left waves-effect">
                            <i class="mdi mdi-menu"></i>
                        </button>
						</li>
						<li class="d-none d-md-inline-block">
							<form role="search" class="app-search">
								<div class="form-group mb-0">
									<input type="text" class="form-control" placeholder="Search..">
									<button type="submit"><i class="fa fa-search"></i></button>
								</div>
							</form>
						</li>
					</ul>
				</nav>
			</div>
<!-- ========== Left Sidebar Start ========== -->
<div class="left side-menu">
    <div class="slimscroll-menu" id="remove-scroll">
    <!--- Sidemenu -->
    <div id="sidebar-menu">
    <!-- Left Menu Start -->
    <ul class="metismenu" id="side-menu">
			<li>
	    <a href="/mysql/biji/" class="waves-effect">
		    <i class="icon-share"></i>
		    <span>数据库笔记
		       	<span class="float-right menu-arrow">
		       	<i class="mdi mdi-chevron-right"></i>
		       	</span>
		    </span>
	    </a>
	</li>
	</ul>
</div>
<!-- Sidebar -->
<div class="clearfix"></div>
</div>
<!-- Sidebar -left -->
</div>
<!-- Left Sidebar End -->
<!-- Start right Content here -->
<div class="content-page">
	<div class="content">
		<div class="container-fluid">
			<div class="page-title-box">
				<div class="row align-items-center">
					<div class="col-sm-6">
						<h1 class="page-title">SQL SERVER数据库中经常用到的操作和管理数据库的语句总结</h1>
					</div>
                    <div class="panel-title">
                        2022-11-12 09:52:12                    </div>
				</div>
				<!-- end row -->
			</div>
			<!-- end page-title -->
			<!-- START ROW -->
			<div class="panel panel-forbid">
				<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>内容摘要</div>
			    <div class="panel-content">
			    <span>这篇文章主要为大家详细介绍了SQL SERVER数据库中经常用到的操作和管理数据库的语句总结，具有一定的参考价值，可以用来参考一下。

对此感兴趣的朋友，看看idc笔记做的技术笔记！</span>                                     
		    	</div>
			    <div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>文章正文</div>
			    <div class="panel-content">
			    <span><p>这篇文章主要为大家详细介绍了SQL SERVER数据库中经常用到的操作和管理数据库的语句总结，具有一定的参考价值，可以用来参考一下。</p>

<p>对此感兴趣的朋友，看看idc笔记做的技术笔记！</p>
<p>--★★SQL2000查询出各（某）表字段的属性:★★★★★★★★★★★★★★★★★★SELECT表名 = case when a.colorder=1 then d.name else &#39;&#39; end,表说明 = case when a.colorder=1 then isnull(f.value,&#39;&#39;) else &#39;&#39; end,字段序号 = a.colorder,字段名 = a.name,标识 = case when COLUMNPROPERTY( a.id,a.name,&#39;IsIdentity&#39;)=1 then &#39;&radic;&#39;else &#39;&#39; end,主键 = case when exists(SELECT 1 FROM sysobjects where xtype=&#39;PK&#39; and parent_obj=a.id and name in (SELECT name FROM sysindexes WHERE indid in(SELECT indid FROM sysindexkeys WHERE id = a.id AND colid=a.colid))) then &#39;&radic;&#39; else &#39;&#39; end,类型 = b.name,占用字节数 = a.length,长度 = COLUMNPROPERTY(a.id,a.name,&#39;PRECISION&#39;),小数位数 = isnull(COLUMNPROPERTY(a.id,a.name,&#39;Scale&#39;),0),允许空 = case when a.isnullable=1 then &#39;&radic;&#39;else &#39;&#39; end,默认值 = isnull(e.text,&#39;&#39;),字段说明 = isnull(g.[value],&#39;&#39;)FROMsyscolumns aleft joinsystypes bona.xusertype=b.xusertypeinner joinsysobjects dona.id=d.id and d.xtype=&#39;U&#39; and d.name&lt;&gt;&#39;dtproperties&#39;left joinsyscomments eona.cdefault=e.idleft joinsysproperties gona.id=g.id and a.colid=g.smallidleft joinsysproperties fond.id=f.id and f.smallid=0whered.name=&#39;要查询的表&#39; --如果只查询指定表,加上此条件order bya.id,a.colorder--★★SQL2005查询出各（某）表字段的属性:★★★★★★★★★★★★★★★★★★-- ========================================================================-- 表结构信息查询-- 邹建 2005.08(引用请保留此信息)-- ========================================================================SELECTTableName=CASE WHEN C.column_id=1 THEN O.name ELSE N&#39;&#39; END,TableDesc=ISNULL(CASE WHEN C.column_id=1 THEN PTB.[value] END,N&#39;&#39;),Column_id=C.column_id,ColumnName=C.name,PrimaryKey=ISNULL(IDX.PrimaryKey,N&#39;&#39;),[IDENTITY]=CASE WHEN C.is_identity=1 THEN N&#39;&radic;&#39;ELSE N&#39;&#39; END,Computed=CASE WHEN C.is_computed=1 THEN N&#39;&radic;&#39;ELSE N&#39;&#39; END,Type=T.name,Length=C.max_length,Precision=C.precision,Scale=C.scale,NullAble=CASE WHEN C.is_nullable=1 THEN N&#39;&radic;&#39;ELSE N&#39;&#39; END,[Default]=ISNULL(D.definition,N&#39;&#39;),ColumnDesc=ISNULL(PFD.[value],N&#39;&#39;),IndexName=ISNULL(IDX.IndexName,N&#39;&#39;),IndexSort=ISNULL(IDX.Sort,N&#39;&#39;),Create_Date=O.Create_Date,Modify_Date=O.Modify_dateFROM sys.columns CINNER JOIN sys.objects OON C.[object_id]=O.[object_id]AND O.type=&#39;U&#39;AND O.is_ms_shipped=0INNER JOIN sys.types TON C.user_type_id=T.user_type_idLEFT JOIN sys.default_constraints DON C.[object_id]=D.parent_object_idAND C.column_id=D.parent_column_idAND C.default_object_id=D.[object_id]LEFT JOIN sys.extended_properties PFDON PFD.class=1AND C.[object_id]=PFD.major_idAND C.column_id=PFD.minor_id-- AND PFD.name=&#39;Caption&#39; -- 字段说明对应的描述名称(一个字段可以添加多个不同name的描述)LEFT JOIN sys.extended_properties PTBON PTB.class=1AND PTB.minor_id=0AND C.[object_id]=PTB.major_id-- AND PFD.name=&#39;Caption&#39; -- 表说明对应的描述名称(一个表可以添加多个不同name的描述)LEFT JOIN -- 索引及主键信息(SELECTIDXC.[object_id],IDXC.column_id,Sort=CASE INDEXKEY_PROPERTY(IDXC.[object_id],IDXC.index_id,IDXC.index_column_id,&#39;IsDescending&#39;)WHEN 1 THEN &#39;DESC&#39; WHEN 0 THEN &#39;ASC&#39; ELSE &#39;&#39; END,PrimaryKey=CASE WHEN IDX.is_primary_key=1 THEN N&#39;&radic;&#39;ELSE N&#39;&#39; END,IndexName=IDX.NameFROM sys.indexes IDXINNER JOIN sys.index_columns IDXCON IDX.[object_id]=IDXC.[object_id]AND IDX.index_id=IDXC.index_idLEFT JOIN sys.key_constraints KCON IDX.[object_id]=KC.[parent_object_id]AND IDX.index_id=KC.unique_index_idINNER JOIN -- 对于一个列包含多个索引的情况,只显示第1个索引信息(SELECT [object_id], Column_id, index_id=MIN(index_id)FROM sys.index_columnsGROUP BY [object_id], Column_id) IDXCUQON IDXC.[object_id]=IDXCUQ.[object_id]AND IDXC.Column_id=IDXCUQ.Column_idAND IDXC.index_id=IDXCUQ.index_id) IDXON C.[object_id]=IDX.[object_id]AND C.column_id=IDX.column_id-- WHERE O.name=N&#39;要查询的表&#39; -- 如果只查询指定表,加上此条件ORDER BY O.name,C.column_id--★★SQL2005索引及主键信息 :★★★★★★★★★★★★★★★★★★-- ========================================================================-- 索引及主键信息-- 邹建 2005.08(引用请保留此信息)-- ========================================================================SELECTTableId=O.[object_id],TableName=O.Name,IndexId=ISNULL(KC.[object_id],IDX.index_id),IndexName=IDX.Name,IndexType=ISNULL(KC.type_desc,&#39;Index&#39;),Index_Column_id=IDXC.index_column_id,ColumnID=C.Column_id,ColumnName=C.Name,Sort=CASE INDEXKEY_PROPERTY(IDXC.[object_id],IDXC.index_id,IDXC.index_column_id,&#39;IsDescending&#39;)WHEN 1 THEN &#39;DESC&#39; WHEN 0 THEN &#39;ASC&#39; ELSE &#39;&#39; END,PrimaryKey=CASE WHEN IDX.is_primary_key=1 THEN N&#39;&radic;&#39;ELSE N&#39;&#39; END,[UQIQUE]=CASE WHEN IDX.is_unique=1 THEN N&#39;&radic;&#39;ELSE N&#39;&#39; END,Ignore_dup_key=CASE WHEN IDX.ignore_dup_key=1 THEN N&#39;&radic;&#39;ELSE N&#39;&#39; END,Disabled=CASE WHEN IDX.is_disabled=1 THEN N&#39;&radic;&#39;ELSE N&#39;&#39; END,Fill_factor=IDX.fill_factor,Padded=CASE WHEN IDX.is_padded=1 THEN N&#39;&radic;&#39;ELSE N&#39;&#39; ENDFROM sys.indexes IDXINNER JOIN sys.index_columns IDXCON IDX.[object_id]=IDXC.[object_id]AND IDX.index_id=IDXC.index_idLEFT JOIN sys.key_constraints KCON IDX.[object_id]=KC.[parent_object_id]AND IDX.index_id=KC.unique_index_idINNER JOIN sys.objects OON O.[object_id]=IDX.[object_id]INNER JOIN sys.columns CON O.[object_id]=C.[object_id]AND O.type=&#39;U&#39;AND O.is_ms_shipped=0AND IDXC.Column_id=C.Column_id--★★SQL Server对大容量内存的支持:★★★★★★★★★★★★★★★★★★/*32位操作系统有个很大的缺陷，应用程序无法访问大于4G的进程地址空间，因为32位的指针无法保存大于4G的地址空间如果大于4G，则需要使用地址窗口化扩展插件(AWE)，具体操作如下：1，启动物理地址扩展(1)找到C:\boot.ini,并删除其只读属性.(2)编辑boot.ini，在ARC路径中添加/PAE参数.例如：在windows Server 2003 Enterprise Edition 中，编辑后的ARC路径如下：muti(0)disk(0)partition(1)windows=&quot;windows Server 2003 Enterprise,Edition&quot;/fastdetect/PAE保存后将其恢复为只读模式，然后重新启动计算机。如果计算机上的可用物理内存超过16G，应确保boot.ini文件中没有/3gb参数*/--★★如何启动AWE选项:★★★★★★★★★★★★★★★★★★sp_configure&#39;show advanced options&#39;,1reconfiguregosp_configue &#39;awe enabled&#39;,1reconfigurego--★★手动配置内存选项:★★★★★★★★★★★★★★★★★★sp_configure&#39;show advanced options&#39;,1goreconfiguregosp_configure &#39;min server memory&#39; --服务器最小内存sp_configure &#39;max server memory&#39; --服务器最大内存sp_configure &#39;index create memory&#39;--创建索引占用的内存sp_configure &#39;min memory per query&#39;--每次查询占用的最小内存--★★获取磁盘读写情况:★★★★★★★★★★★★★★★★★★select@@total_read as &#39;读取磁盘的次数&#39;,@@total_write as &#39;写入磁盘的次数&#39;,@@total_error as &#39;磁盘写入错误数&#39;,getdate() as &#39;当前时间&#39;--★★获取数据库文件的I/O统计信息:★★★★★★★★★★★★★★★★★★select * from fn_virtualfilestats(null,null)--★★获取I/O工作情况:★★★★★★★★★★★★★★★★★★select@@id_busy，--SQL自上次启动以来的用于执行输入和输出操作的时间@@timeticks, --每个时钟周期对应的微秒数@@id_busy*@@timeticks as &#39;I/O 操作毫秒数&#39;,getdate() as &#39;当前时间&#39;--★★查看SQL SEVER CPU活动,工作情况:★★★★★★★★★★★★★★★★★★select@@cpu_busy,--自上次启动以来的工作时间@@timeticks, --每个时钟周期对应的微秒数@@cpu_busy*cast(@@timeticks as float)/1000 as &#39;cpu工作时间(秒)&#39;,@@idie*cast(@@timeticks as float)/1000 as &#39;CPU空闲时间(秒)&#39;getdate() as &#39;当前时间&#39;--★★获取网络数据包统计信息:★★★★★★★★★★★★★★★★★★selectgetdate() as &#39;当前时间&#39;,@@pack_received as&#39;输入数据包数量&#39;,@@pack_sent as &#39;输出数据包数量&#39;,@@packet_error as &#39;错误包数量&#39;--★★查看服务器工作状态:★★★★★★★★★★★★★★★★★★create function fgetsstatus(@servername varchar(50) --服务器名,@userid varchar(50)=&#39;sa&#39; --用户名,如果为nt验证方式,则为空,@password varchar(50)=&#39;&#39; --密码) returns varchar(20)asbegindeclare @re varchar(20),@ire int --返回状态declare @srvid int --定义服务器、数据库集iddeclare @err int,@src varchar(255), @desc varchar(255) --错误处理变量--★★创建sqldmo对象 :★★★★★★★★★★★★★★★★★★exec @err=sp_oacreate &#39;sqldmo.sqlserver&#39;,@srvid outputif @err &lt;&gt;0 goto lberr--★★连接服务器 :★★★★★★★★★★★★★★★★★★if isnull(@userid,&#39;&#39;)=&#39;&#39; --如果是 Nt验证方式beginexec @err=sp_oasetproperty @srvid,&#39;loginsecure&#39;,1if @err &lt;&gt;0 goto lberrexec @err=sp_oamethod @srvid,&#39;connect&#39;,null,@servernameendelseexec @err=sp_oamethod @srvid,&#39;connect&#39;,null,@servername,@userid,@passwordif @err &lt;&gt;0 goto lberr--★★获取服务器状态 :★★★★★★★★★★★★★★★★★★exec @err=sp_oagetproperty @srvid,&#39;Status&#39;,@ire outputif @err &lt;&gt;0 goto lberrset @re=case @ire when 0 then &#39;未知&#39;when 1 then &#39;运行...&#39;when 2 then &#39;暂停&#39;when 3 then &#39;停止...&#39;when 4 then &#39;正在启动...&#39;when 5 then &#39;正在启动停止...&#39;when 6 then &#39;连接...&#39;when 7 then &#39;正在暂停...&#39; endreturn(@re)lberr:exec sp_oageterrorinfo NULL, @src out, @desc outdeclare @errb varbinary(4)set @errb=cast(@err as varbinary(4))exec master..xp_varbintohexstr @errb,@re outset @re=&#39;错误号: &#39;+@re+char(13)+&#39;错误源: &#39;+@src+char(13)+&#39;错误描述: &#39;+@descreturn(@re)endgoselect dbo.fgetsstatus(&#39;192.168.102.208&#39;,&#39;sa&#39;,&#39;sa&#39;)----------------------运行...--★★获取服务器状态 :★★★★★★★★★★★★★★★★★★if object_id(&#39;tb&#39;)is not null drop table tbgocreate table tb(表名 sysname,记录数 int,保留空间 nvarchar(10),使用空间 varchar(10),索引使用空间 varchar(10),未用空间 varchar(10))exec sp_MSForEachTable @command1=N&#39;insert tb exec sp_spaceused &#39;&#39;?&#39;&#39;&#39;select * from tb--★★查看服务器版本 :★★★★★★★★★★★★★★★★★★SELECTSERVERPROPERTY(&#39;productversion&#39;),SERVERPROPERTY (&#39;productlevel&#39;),SERVERPROPERTY (&#39;edition&#39;)--★★查看数据库脱机时间 :★★★★★★★★★★★★★★★★★★EXEC sp_configure &#39;show advanced options&#39;, 1RECONFIGUREgoEXEC sp_configure &#39;xp_cmdshell&#39;, 1RECONFIGUREGOselect a.name,a.database_id,a.create_date,b.physical_name into #afrom sys.databases a left join sys.master_files b ona.database_id=b.database_id where has_dbaccess(a.name)&lt;&gt;1 and b.type=1create table #b(info varchar(500))declare @string varchar(max)set @string=&#39;&#39;select @string=@string+&#39;insert into #b exec xp_cmdshell&#39;&#39;dir &#39;+ physical_name +&#39;&#39;&#39;&#39;+char(13)+char(10) from #aexecute(@string)select a.name,substring(b.info,0,20) as 脱机时间,a.database_id,a.create_date,a.physical_namefrom #a a left join #b b onREVERSE(substring(REVERSE(physical_name),0,charindex(&#39;\&#39;,REVERSE(physical_name))))=REVERSE(substring(REVERSE(info),0,charindex(&#39; &#39;,REVERSE(info))))drop table #a,#bgoEXEC sp_configure &#39;xp_cmdshell&#39;, 0RECONFIGUREgoEXEC sp_configure &#39;show advanced options&#39;, 0RECONFIGUREgo/*1. 查看数据库的版本select @@version2.查看数据库所在机器操作系统参数 .exec master..xp_msver ..3. 查看数据库启动的参数 !sp_configure4.查看数据库启动时间 .select convert(varchar(30),login_time,120) from master..sysprocesses where spid=1查看数据库服务器名和实例名 .print &#39;&#39;Server Name...............: &#39;&#39; + convert(varchar(30),@@SERVERNAME) .print &#39;&#39;Instance..................: &#39;&#39; + convert(varchar(30),@@SERVICENAME) ...5. 查看所有数据库名称及大小sp_helpdb 。重命名数据库用的SQLsp_renamedb &#39;&#39;old_dbname&#39;&#39;, &#39;&#39;new_dbname&#39;&#39;6. 查看所有数据库用户登录信息 ..sp_helplogins查看所有数据库用户所属的角色信息sp_helpsrvrolemember !修复迁移服务器时孤立用户时,可以用的fix_orphan_user脚本或者LoneUser过程 .更改某个数据对象的用户属主sp_changeobjectowner [@objectname =] &#39;&#39;object&#39;&#39;, [@newowner =] &#39;&#39;owner&#39;&#39; .注意: 更改对象名的任一部分都可能破坏脚本和存储过程。把一台服务器上的数据库用户登录信息备份出来可以用add_login_to_aserver脚本7. 查看链接服务器 ...sp_helplinkedsrvlogin查看远端数据库用户登录信息 。sp_helpremotelogin ..8.查看某数据库下某个数据对象的大小 !sp_spaceused @objname还可以用sp_toptables过程看最大的N(默认为50)*/--★★查看作业执行情况 :★★★★★★★★★★★★★★★★★★select category = jc.name,category_id = jc.category_id,job_name = j.name,job_enabled = j.enabled,last_run_time = cast(js.last_run_date as varchar(10)) + &#39;-&#39; + cast(js.last_run_time as varchar(10)),last_run_duration = js.last_run_duration,last_run_status = js.last_run_outcome,last_run_msg = js.last_outcome_message + cast(nullif(js.last_run_outcome,1) as varchar(2)),job_created = j.date_created,job_modified = j.date_modifiedfrom msdb.dbo.sysjobs jinner join msdb.dbo.sysjobservers json j.job_id = js.job_idinner join msdb.dbo.syscategories jcon j.category_id = jc.category_idwhere j.enabled = 1and js.last_run_outcome in (0,1,3,5) -- 0:Fail 1:Succ 3:Cancel 5:First runand jc.category_id not between 10 and 20 -- repl--★★查询数据库db中表tb的所有索引的随片情况 :★★★★★★★★★★★★★★★★★★use dbgoselecta.index_id,---索引编号b.name,---索引名称avg_fragmentation_in_percent---索引的逻辑碎片fromsys.dm_db_indx_physical_stats(db_id(),object_id(N&#39;create.consume&#39;),null,null,null) as ajoinsys.indexes as bona.object_id=b.object_idanda.index_id=b.index_idgo--★★用户成员权限:★★★★★★★★★★★★★★★★★★USE pubs--创建角色 r_testEXEC sp_addrole &#39;r_test&#39;--授予 r_test 对 jobs 表的所有权限GRANT ALL ON jobs TO r_test--授予角色 r_test 对 titles 表的 SELECT 权限GRANT SELECT ON titles TO r_test--添加登录 l_test,设置密码为pwd,默认数据库为pubsEXEC sp_addlogin &#39;l_test&#39;,&#39;pwd&#39;,&#39;pubs&#39;--为登录 l_test 在数据库 pubs 中添加安全账户 u_testEXEC sp_grantdbaccess &#39;l_test&#39;,&#39;u_test&#39;--添加 u_test 为角色 r_test 的成员EXEC sp_addrolemember &#39;r_test&#39;,&#39;u_test&#39;--拒绝安全账户 u_test 对 titles 表的 SELECT 权限DENY SELECT ON titles TO u_test/*--完成上述步骤后,用 l_test 登录,可以对jobs表进行所有操作,但无法对titles表查询,虽然角色 r_test 有titles表的select权限,但已经在安全账户中明确拒绝了对titles的select权限,所以l_test无titles表的select权限--*/--从数据库 pubs 中删除安全账户EXEC sp_revokedbaccess &#39;u_test&#39;--删除登录 l_testEXEC sp_droplogin &#39;l_test&#39;--删除角色 r_testEXEC sp_droprole &#39;r_test&#39;</p>
<div class="pagenum tc"><strong>12下一页阅读全文 </strong>
<p><strong>对此感兴趣的朋友，看看idc笔记做的技术笔记！</strong></p><strong>--★★SQL Server 2005及以上版本数据库批量备份存储过程(判断盘符、路径，错误盘符返回，不存在--路径自动创建)★★★★★★★★★★★★★USE masterGO--1.周期性备份数据库代码(保留原来备份的):--备份文件名为：原数据库名称+&#39;_&#39;+备份日期.bakIF OBJECT_ID(&#39;sp_backupdatabase&#39;) IS NOT NULLDROP PROC sp_backupdatabaseGOCREATE PROC sp_backupdatabase@path NVARCHAR(100)--路径AS--路径名格式标准化IF RIGHT(@path,1)&lt;&gt;&#39;\&#39; SET @path=@path+&#39;\&#39;--获取文件夹信息DECLARE @t TABLE(id INT IDENTITY,a INT,b INT,c INT)DECLARE @fpath NVARCHAR(3)SET @fpath=LEFT(@path,3)INSERT @t EXEC master..xp_fileexist @fpathINSERT @t EXEC master..xp_fileexist @path--如果指定盘符有误不存在，则返回错误提示：IF EXISTS(SELECT 1 FROM @t WHERE id=1 AND c=0)BEGINRAISERROR(N&#39;输入的盘符不存在，请重新输入!&#39;,16,1)RETURNEND--如果不存在指定的文件夹，则创建:ELSE IF EXISTS(SELECT 1 FROM @t WHERE b=0 AND id=2)BEGINDECLARE @mddir NVARCHAR(100)SET @mddir=&#39;md &#39;+@pathEXEC master..xp_cmdshell @mddirEND--开始备份数据库到指定的目录DECLARE @s nvarchar(4000)SELECT @s=ISNULL(@s+&#39;;&#39;,&#39;&#39;)+N&#39;BACKUP database [&#39;+name+&#39;] TO DISK = &#39;&#39;&#39;+@path+name+&#39;_&#39;+CONVERT(NVARCHAR(8),getdate(),112)+N&#39;.bak&#39;&#39;&#39;FROM master..sysdatabasesWHERE name NOT IN(&#39;master&#39;,&#39;tempdb&#39;,&#39;model&#39;,&#39;msdb&#39;,&#39;pubs&#39;)--这里筛选不参加备份的数据库EXEC(@S)GO--调用方法：EXEC sp_backupdatabase &#39;f:\Backup\tony&#39;/*--返回信息：已为数据库 &#39;mydb&#39;，文件 &#39;mydb&#39; (位于文件 1 上)处理了 312 页。已为数据库 &#39;mydb&#39;，文件 &#39;mydb_log&#39; (位于文件 1 上)处理了 1 页。BACKUP DATABASE 成功处理了 313 页，花费 0.733 秒(3.336 MB/秒)。已为数据库 &#39;test&#39;，文件 &#39;test&#39; (位于文件 1 上)处理了 208 页。已为数据库 &#39;test&#39;，文件 &#39;test_log&#39; (位于文件 1 上)处理了 1 页。BACKUP DATABASE 成功处理了 209 页，花费 0.413 秒(3.951 MB/秒)。--备份后的文件列表：mydb_20100418.baktest_20100418.bak*/--2.周期性备份数据库代码(自动删除原备份文件):--备份文件名为：原数据库名称.bakIF OBJECT_ID(&#39;sp_backupdatabase&#39;) IS NOT NULLDROP PROC sp_backupdatabaseGOCREATE PROC sp_backupdatabase@path NVARCHAR(100)--路径AS--路径名格式标准化IF RIGHT(@path,1)&lt;&gt;&#39;\&#39; SET @path=@path+&#39;\&#39;--获取文件夹信息DECLARE @t TABLE(id INT IDENTITY,a INT,b INT,c INT)DECLARE @fpath NVARCHAR(3)SET @fpath=LEFT(@path,3)INSERT @t EXEC master..xp_fileexist @fpathINSERT @t EXEC master..xp_fileexist @path--如果指定盘符有误不存在，则返回错误提示：IF EXISTS(SELECT 1 FROM @t WHERE id=1 AND c=0)BEGINRAISERROR(N&#39;输入的盘符不存在，请重新输入!&#39;,16,1)RETURNEND--如果不存在指定的文件夹，则创建:ELSE IF EXISTS(SELECT 1 FROM @t WHERE b=0 AND id=2)BEGINDECLARE @mddir NVARCHAR(100)SET @mddir=&#39;md &#39;+@pathEXEC master..xp_cmdshell @mddirEND--开始备份数据库到指定的目录DECLARE @s nvarchar(4000)SELECT @s=ISNULL(@s+&#39;;&#39;,&#39;&#39;)+N&#39;BACKUP database [&#39;+name+&#39;] TO DISK = &#39;&#39;&#39;+@path+name+N&#39;.bak&#39;&#39; WITH INIT&#39;FROM master..sysdatabasesWHERE name NOT IN(&#39;master&#39;,&#39;tempdb&#39;,&#39;model&#39;,&#39;msdb&#39;,&#39;pubs&#39;)--这里筛选不参加备份的数据库EXEC(@S)GO--调用方法：EXEC sp_backupdatabase &#39;f:\Backup\tony2&#39;/*--返回信息：已为数据库 &#39;mydb&#39;，文件 &#39;mydb&#39; (位于文件 1 上)处理了 312 页。已为数据库 &#39;mydb&#39;，文件 &#39;mydb_log&#39; (位于文件 1 上)处理了 1 页。BACKUP DATABASE 成功处理了 313 页，花费 0.599 秒(4.082 MB/秒)。已为数据库 &#39;test&#39;，文件 &#39;test&#39; (位于文件 1 上)处理了 208 页。已为数据库 &#39;test&#39;，文件 &#39;test_log&#39; (位于文件 1 上)处理了 1 页。BACKUP DATABASE 成功处理了 209 页，花费 0.351 秒(4.651 MB/秒)。--备份后的文件列表：mydb.baktest.bak*/--★★DBCC是SQL Server提供的一组控制台命令，功能很强大，掌握一些必要的语句，对操作数据库有不---少帮助，归类如下：--一、DBCC 帮助类命令* DBCC HELP(&#39;?&#39;)--查询所有的DBCC命令* DBCC HELP(&#39;命令&#39;)--查询指定的DBCC命令的语法说明* DBCC USEROPTIONS--返回当前连接的活动(设置)的SET选项--二、DBCC 检查验证类命令* DBCC CHECKALLOG (&#39;数据库名称&#39;)--检查指定数据库的磁盘空间分配结构的一致性* DBCC CHECKCATALOG (&#39;数据库名称&#39;)--检查指定数据库的系统表内和系统表间的一致性* DBCC CHECKCONSTAINTS (&#39;tablename&#39;)--检查指定表上的指定约束或所有约束的完整性* DBCC CHECKDB--检查数据库中的所有对象的分配和结构完整性* DBCC CHECKFILEGROUP--检查指定文件组中所有表在当前数据库中的分配和结构完整性* DBCC CHECKTABLE--检查指定表或索引视图的数据、索引及test、ntest和image页的完整性* DBCC CHECKIDENT--检查指定的当前标识值* DBCC SQLPERF(UMSSTATS) undocumented in BOL--可以用来检查是否CPU使用达到瓶颈--最关键的一个参考数据num runnable,表明当前有多少个线程再等待运行--如果大于等于2,考虑CPU达到瓶颈--三、DBCC 维护类命令* DBCC CLEANTABLE (&#39;db_name&#39;,&#39;table_name&#39;)--回收Alter table drop column语句删除可变长度列或text* DBCC DBREINDEX--重建指定数据库的一个或多个索引* DBCC INDEXDEFRAG--对表或视图上的索引和非聚集索引进行碎片整理* DBCC PINTABLE (db_id,object_id)--将表数据驻留在内存中--查看哪些表驻留在内存的方法是：select objectproperty(object_id(&#39;tablename&#39;）,&#39;tableispinned&#39;)* DBCC UNPINTABLE (db_id,object_id)--撤消驻留在内存中的表* DBCC SHRINKDATABASE(db_id,int)--收缩指定数据库的数据文件和日志文件大小* DBCC SHRINKFILE(file_name,int)--收缩相关数据库的指定数据文件和日志文件大小--四、DBCC 性能调节命令* DBCC dllname(FREE)sp_helpextendedproc 查看加载的扩展PROC--在内存中卸载指定的扩展过程动态链接库（dll)* DBCC DROPCLEANBUFFERS--从缓冲池中删除所有缓冲区* DBCC FREEPROCCACHE--从过程缓冲区删除所有元素* DBCC INPUTBUFFER--显示从客户机发送到服务器的最后一个语句* DBCC OPENTRAN (db_name)--查询某个数据库执行时间最久的事务，由哪个程序拥有* DBCC SHOW_STATISTICS--显示指定表上的指定目标的当前分布统计信息* DBCC SHOWCONTIG--显示指定表的数据和索引的碎片信息* DBCC SQLPERF(logspace) --查看各个DB的日志情况(iostats) --查看IO情况(threads) --查看线程消耗情况--返回多种有用的统计信息* DBCC CACHESTATS--显示SQL Server 2000内存的统计信息* DBCC CURSORSTATS--显示SQL Server 2000游标的统计信息* DBCC MEMORYSTATS--显示SQL Server 2000内存是如何细分的* DBCC SQLMGRSTATS--显示缓冲中先读和预读准备的SQL语句--五、DBCC 未公开的命令* DBCC ERRLOG--初始化SQL Server 2000的错误日志文件* DBCC FLUSHPROCINDB (db_id)--清除SQL Server 2000服务器内存中的某个数据库的存储过程缓存内容* DBCC BUFFER (db_name,object_name,int(缓冲区个数))--显示缓冲区的头部信息和页面信息* DBCC DBINFO (db_name)--显示数据库的结构信息* DBCC DBTABLE--显示管理数据的表(数据字典)信息* DBCC IND (db_name,table_name,index_id)--查看某个索引使用的页面信息* DBCC REBUILDLOG--重建SQL Server 2000事务日志文件* DBCC LOG (db_name,3) (-1--4)--查看某个数据库使用的事物日志信息* DBCC PAGE--查看某个数据库数据页面信息* DBCC PROCBUF--显示过程缓冲池中的缓冲区头和存储过程头* DBCC PRTIPAGE--查看某个索引页面的每行指向的页面号* DBCC PSS (user,spid,1)--显示当前连接到SQL Server 2000服务器的进程信息* DBCC RESOURCE--显示服务器当前使用的资源情况* DBCC TAB (db_id,object_id)--显示数据页面的结构六、DBCC跟踪标记--跟踪标记用于临时设置服务器的特定特征或关闭特定行为，常用于诊断性能问题或调试存储过程或复杂的---计算机系统* DBCC TRACEON (3604)--打开跟踪标记* DBCC TRACEOFF--关闭跟踪标记* DBCC TRACESTATS--查看跟踪标记状态--七、使用 DBCC 结果集输出　　--许多 DBCC 命令可以产生表格格式的输出（使用 WITH TABLERESULTS 选项）。该信息可装载到--中以便将来使用。以下显示一个示例脚本：　　　　CREATE TABLE DBCCResult (　　DBCCFlag INT,　　Result INT　　)　　INSERT INTO DBCCResult　　EXEC (&#39;DBCC TRACESTATUS (-1) WITH NO_INFOMSGS&#39;)　　SELECT *　　FROM DBCCResult--八、官方使用DBCC的建议--1、在系统使用率较低时运行 CHECKDB。--2、请确保未同时执行其它磁盘 I/O 操作，例如磁盘备份。--3、将 tempdb 放到单独的磁盘系统或快速磁盘子系统中。--4、允许 tempdb 在驱动器上有足够的扩展空间。 使用带有 ESTIMATE ONLY 的 DBCC--估计 tempdb 将需要多少空间。--5、避免运行占用大量 CPU 的查询或批处理作业。--6、在 DBCC 命令运行时，减少活动事务。--7、使用 NO_INFOMSGS 选项显著减少处理和 tempdb 的使用。--8、考虑使用带有 PHYSICAL_ONLY 选项的 DBCC CHECKDB 来检查页和记录首部--的物理结构。当硬件导致的错误被置疑时，这个操作将执行快速检查。--在发布,订阅复制时要用服务器实名时可以这样:select * from sysservers (可以找到原来服务器的名称)exec sp_dropserver &#39;jmsql9&#39; (删除原来的服务器名)exec sp_addserver &#39;jmSQL9&#39; ,LOCAL (改为新的服务器名)ALTER DATABASE [jm] SET SINGLE_USER (改为单用户模式)DBCC CHECKDB(&quot;databasename&quot;,REPAIR_REBUILD) WITH TABLOCK (修复数据库)DBCC CHECKTABLE(&quot;tablename&quot;,repair_rebuild) with tablock (修复表)DBCC DBREINDEX (&#39;t_icitem&#39; , &#39; &#39;) 修复此表所有的索引。ALTER DATABASE [jm] SET MULTI_USER (改为多用户模式)REPAIR_ALLOW_DATA_LOSS：执行由REPAIR_REBUILD 完成的所有修复，包括对行和页进行分配和取消分配以改正分配错误、结构行或页的错误，以及删除已损坏的文本对象。这些修复可能会导致一些数据丢失。修复操作可以在用户事务下完成以允许用户回滚所做的更改。如果回滚修复，则数据库仍会含有错误，应该从备份进行恢复。如果由于所提供修复等级的缘故遗漏某个错误的修复，则将遗漏任何取决于该修复的修复。修复完成后，备份数据库。REPAIR_FAST 进行小的、不耗时的修复操作，如修复非聚集索引中的附加键。这些修复可以很快完成，并且不会有丢失数据的危险。REPAIR_REBUILD 执行由REPAIR_FAST 完成的所有修复，包括需要较长时间的修复（如重建索引），执行这些修复时不会有丢失数据的危险。dbcc shrinkdatabase (jm) 压缩数据库本文来自CSDN博客，转载请标明出处：http://blog.csdn.net/fredrickhu/archive/2009/10/14/4669452.aspx--★★获得job执行的步骤内容★★★★★★★★★★★★★★★★select j.name,s.step_id,s.step_name,s.commandfrom msdb.dbo.sysjobs_view j join msdb.dbo.sysjobsteps son j.job_id=s.job_id;--★★查看死锁和阻塞并杀死它们★★★★★★★★★★★★★★★★if exists (select * from dbo.sysobjects where id = object_id(N&#39;[dbo].[p_lockinfo]&#39;) and OBJECTPROPERTY(id, N&#39;IsProcedure&#39;) = 1)drop procedure [dbo].[p_lockinfo]GOSET QUOTED_IDENTIFIER ONGOSET ANSI_NULLS ONGO/*--处理死锁查看当前进程,或死锁进程,并能自动杀掉死进程因为是针对死的,所以如果有死锁进程,只能查看死锁进程当然,你可以通过参数控制,不管有没有死锁,都只查看死锁进程感谢: caiyunxia,jiangopen 两位提供的参考信息--邹建 2004.4--*//*--调用示例exec p_lockinfo--*/create proc p_lockinfo@kill_lock_spid bit=1, --是否杀掉死锁的进程,1 杀掉, 0 仅显示@show_spid_if_nolock bit=1 --如果没有死锁的进程,是否显示正常进程信息,1 显示,0 不显示asdeclare @count int,@s nvarchar(1000),@i intselect id=identity(int,1,1),标志,进程ID=spid,线程ID=kpid,块进程ID=blocked,数据库ID=dbid,数据库名=db_name(dbid),用户ID=uid,用户名=loginame,累计CPU时间=cpu,登陆时间=login_time,打开事务数=open_tran, 进程状态=status,工作站名=hostname,应用程序名=program_name,工作站进程ID=hostprocess,域名=nt_domain,网卡地址=net_addressinto #t from(select 标志=&#39;死锁的进程&#39;,spid,kpid,a.blocked,dbid,uid,loginame,cpu,login_time,open_tran,status,hostname,program_name,hostprocess,nt_domain,net_address,s1=a.spid,s2=0from master..sysprocesses a join (select blocked from master..sysprocesses group by blocked)b on a.spid=b.blocked where a.blocked=0union allselect &#39;|_牺牲品_&gt;&#39;,spid,kpid,blocked,dbid,uid,loginame,cpu,login_time,open_tran,status,hostname,program_name,hostprocess,nt_domain,net_address,s1=blocked,s2=1from master..sysprocesses a where blocked&lt;&gt;0)a order by s1,s2select @count=@@rowcount,@i=1if @count=0 and @show_spid_if_nolock=1begininsert #tselect 标志=&#39;正常的进程&#39;,spid,kpid,blocked,dbid,db_name(dbid),uid,loginame,cpu,login_time,open_tran,status,hostname,program_name,hostprocess,nt_domain,net_addressfrom master..sysprocessesset @count=@@rowcountendif @count&gt;0begincreate table #t1(id int identity(1,1),a nvarchar(30),b Int,EventInfo nvarchar(255))if @kill_lock_spid=1begindeclare @spid varchar(10),@标志 varchar(10)while @i&lt;=@countbeginselect @spid=进程ID,@标志=标志 from #t where id=@iinsert #t1 exec(&#39;dbcc inputbuffer(&#39;+@spid+&#39;)&#39;)if @标志=&#39;死锁的进程&#39; exec(&#39;kill &#39;+@spid)set @i=@i+1endendelsewhile @i&lt;=@countbeginselect @s=&#39;dbcc inputbuffer(&#39;+cast(进程ID as varchar)+&#39;)&#39; from #t where id=@iinsert #t1 exec(@s)set @i=@i+1endselect a.*,进程的SQL语句=b.EventInfofrom #t a join #t1 b on a.id=b.idendGOSET QUOTED_IDENTIFIER OFFGOSET ANSI_NULLS ONGO----------版本2： 我在邹建的基础上改写的(KILL 死锁时间超过15秒的死锁进程 ---------------/*exec p_lockinfo 0,1;*/alter proc p_lockinfo@kill_lock_spid bit=1, --是否杀掉死锁的进程,1 杀掉, 0 仅显示@show_spid_if_nolock bit=1 --如果没有死锁的进程,是否显示正常进程信息,1 显示,0 不显示asdeclare @count int,@s nvarchar(1000),@i intselect id=identity(int,1,1),标志,进程ID=spid,线程ID=kpid,块进程ID=blocked,数据库ID=dbid,数据库名=db_name(dbid),用户ID=uid,用户名=loginame,累计CPU时间=cpu,等待时间=waittime,登陆时间=login_time,打开事务数=open_tran, 进程状态=status,工作站名=hostname,应用程序名=program_name,工作站进程ID=hostprocess,域名=nt_domain,网卡地址=net_addressinto #t from(select 标志=&#39;死锁的进程&#39;,spid,kpid,a.blocked,dbid,uid,loginame,cpu,waittime,login_time,open_tran,status,hostname,program_name,hostprocess,nt_domain,net_address,s1=a.spid,s2=0from master..sysprocesses a join (select blocked from master..sysprocesses group by blocked)b on a.spid=b.blocked where a.blocked=0union allselect &#39;|_牺牲品_&gt;&#39;,spid,kpid,blocked,dbid,uid,loginame,cpu,waittime,login_time,open_tran,status,hostname,program_name,hostprocess,nt_domain,net_address,s1=blocked,s2=1from master..sysprocesses a where blocked&lt;&gt;0)a order by s1,s2select @count=@@rowcount,@i=1if @count=0 and @show_spid_if_nolock=1begininsert #tselect 标志=&#39;正常的进程&#39;,spid,kpid,blocked,dbid,db_name(dbid),uid,loginame,cpu,waittime,login_time,open_tran,status,hostname,program_name,hostprocess,nt_domain,net_addressfrom master..sysprocessesset @count=@@rowcountendif @count&gt;0begincreate table #t1(id int identity(1,1),a nvarchar(30),b Int,EventInfo nvarchar(4000))if @kill_lock_spid=1begindeclare @spid varchar(10),@标志 varchar(10), @等待时间 intwhile @i&lt;=@countbeginselect @spid=进程ID,@标志=标志, @等待时间=等待时间 from #t where id=@iinsert #t1 exec(&#39;dbcc inputbuffer(&#39;+@spid+&#39;)&#39;)if @标志=&#39;死锁的进程&#39; and @等待时间 &gt;=15000 exec(&#39;kill &#39;+@spid)set @i=@i+1endendelsewhile @i&lt;=@countbeginselect @s=&#39;dbcc inputbuffer(&#39;+cast(进程ID as varchar)+&#39;)&#39; from #t where id=@iinsert #t1 exec(@s)set @i=@i+1endselect a.*,进程的SQL语句=b.EventInfofrom #t a join #t1 b on a.id=b.idendGOSET QUOTED_IDENTIFIER OFFGOSET ANSI_NULLS ONGO </strong>
<p></p><strong> </strong>
<div class="pagenum tc"><strong>上一页1<strong>2阅读全文 </strong></strong></div></div>

<p>注：关于SQL SERVER数据库中经常用到的操作和管理数据库的语句总结的内容就先介绍到这里，更多相关文章的可以留意</span>                                     
		    	</div>
		    	<div class="panel-title"><i class="fa fa fa-file-text fa-fw"></i>代码注释</div>
			    <div class="panel-content">
			    <span></span>                                     
		    	</div>
			</div>

			<!-- END ROW -->
			<div class="newsPage">
				<div class="newsPageTurn">
				    <span><a>上一篇</a><a href='/mysql/biji/3988.html'>SQL Server 数据结构简明备忘录 线性表</a><a>下一篇</a><a href='/mysql/biji/3990.html'>SQL Server 删除Table表中的重复行的方法</a></span>
				</div>
			</div>
		</div>


<div id="author-box">
    <h3>作者：喵哥笔记</h3>
        <div class="author-info">
            <div class="author-avatar">
                <img src="/skin1/picture/01.jpg" alt="IDC笔记" class="avatar" width="64" height="64">
            </div>
        <div class="author-description">
            <p>学的不仅是技术，更是梦想！</p>
            <ul class="author-social follows nb">
            	<li>
                    <a target="_blank" href="/" title="IDC笔记">IDC笔记</a>
                </li>
            </ul>
        </div>
        <div class="clear"></div>
    </div>
</div>
<script>
var paras = document.getElementsByTagName("pre");
for ( var i=0;i<paras.length;i++ ) {
    paras[i].setAttribute("class","brush:php;toolbar:false");     
}
</script>
<!-- container-fluid -->
	</div>
<!-- content -->
	<footer class="footer">
	© 2020 IDC笔记 <i class="mdi mdi-heart text-danger"></i>. | 备案号：<a href="https://beian.miit.gov.cn/">辽ICP备18000516号</a>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?674585fbbd2294d3faf910f668ea91b4";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

	</footer>
</div>

</div>
<!-- END wrapper -->
<!-- jQuery  -->
<script src="/skin1/js/jquery.min.js"></script>
<script src="/skin1/js/bootstrap.bundle.min.js"></script>
<script src="/skin1/js/metismenu.min.js"></script>
<script src="/skin1/js/jquery.slimscroll.js"></script>
<script src="/skin1/js/waves.min.js"></script>
<!--Morris Chart-->
<script src="/skin1/js/morris.min.js"></script>
<script src="/skin1/js/raphael.min.js"></script>
<script src="/skin1/js/dashboard.init.js"></script>
<script src="/skin1/js/app.js"></script>
<script src="/foot.js"></script>
</body>
</html>