<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <title>宝塔面板phpMyAdmin未授权访问安全漏洞是个低级错误吗_IDC笔记</title>
    <meta name="keywords" content="javascript,javascript教程" />
    <meta name="description" content="周日晚，某群里突然发布了一则消息，宝塔面板的phpmyadmin存在未授权访问漏洞的紧急漏洞预警，并给出了一大批存在漏洞的URL：随便点开其中一个，赫然就是一个大大的phpmyadmin后台管" />
    <meta content="Responsive admin theme build on top of Bootstrap 4" name="description" />
    <meta content="idcnote.com" name="author" />
    <link rel="shortcut icon" href="/skin1/images/favicon.ico">
    <link rel="stylesheet" href="/skin1/css/morris.css">
    <link href="/skin1/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/metismenu.min.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/icons.css" rel="stylesheet" type="text/css">
    <link href="/skin1/css/style.css" rel="stylesheet" type="text/css">
	<link href="/SyntaxHighlighter/shCoreDefault.css" rel="stylesheet" type="text/css" />
	<script type="text/javascript" src="/SyntaxHighlighter/shCore.js"></script>
	<script type="text/javascript">
	 SyntaxHighlighter.all();
	</script>
	<script>
	var paras = document.getElementsByTagName("pre");
	for ( var i=0;i<paras.length;i++ ) {
		paras[i].setAttribute("class","brush:php;toolbar:false");     
	}
	</script>
</head>
<body>
	<!-- Begin page -->
		<div id="wrapper">
			<!-- Top Bar Start -->
			<div class="topbar">
				<!-- LOGO -->
				<div class="topbar-left">
					<a href="/" class="logo">
						<span class="logo-light">
                            <i class="mdi mdi-camera-control"></i>IDC笔记
                        </span>
						<span class="logo-sm">
                            <i class="mdi mdi-camera-control"></i>
                        </span>
					</a>
				</div>
				<nav class="navbar-custom">
					<ul class="navbar-right list-inline float-right mb-0">
						<!--<li class="dropdown notification-list list-inline-item d-none d-md-inline-block">
							<a class="nav-link waves-effect" href="#" id="btn-fullscreen">
								<i class="mdi mdi-arrow-expand-all noti-icon"></i>
							</a>
						</li>
						<li class="dropdown notification-list list-inline-item">
							<div class="dropdown notification-list nav-pro-img">
								<a class="dropdown-toggle nav-link arrow-none nav-user" data-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
									<img src="/skin1/picture/user-4.jpg" alt="user" class="rounded-circle">
								</a>
								<div class="dropdown-menu dropdown-menu-right profile-dropdown ">
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-account-circle"></i> Profile</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-wallet"></i> Wallet</a>
									<a class="dropdown-item d-block" href="#">
										<span class="badge badge-success float-right">11</span>
										<i class="mdi mdi-settings"></i> Settings</a>
									<a class="dropdown-item" href="#">
										<i class="mdi mdi-lock-open-outline"></i> Lock screen</a>
									<div class="dropdown-divider"></div>
									<a class="dropdown-item text-danger" href="#">
										<i class="mdi mdi-power text-danger"></i> Logout</a>
								</div>
							</div>
						</li>
						-->
					</ul>
					<ul class="list-inline menu-left mb-0">
						<li class="float-left">
							<button class="button-menu-mobile open-left waves-effect">
                            <i class="mdi mdi-menu"></i>
                        </button>
						</li>
						<li class="d-none d-md-inline-block">
							<form role="search" class="app-search">
								<div class="form-group mb-0">
									<input type="text" class="form-control" placeholder="Search..">
									<button type="submit"><i class="fa fa-search"></i></button>
								</div>
							</form>
						</li>
					</ul>
				</nav>
			</div>
	<div class="left side-menu">
		<div class="slimscroll-menu" id="remove-scroll">
			<div id="sidebar-menu">
				<ul class="metismenu" id="side-menu">
					<li>
						<a href="/js/" class="waves-effect">
							<i class="icon-share"></i>
							<span>宝塔面板教程
								<span class="float-right menu-arrow">
								<i class="mdi mdi-chevron-right"></i>
								</span>
							</span>
						</a>
					</li>
															<li>
						<a href="javascript:void(0);" class="waves-effect">
							<i class="icon-share"></i>
							<span> 系统简介							<span class="float-right menu-arrow">
							<i class="mdi mdi-chevron-right"></i>
							</span> 
							</span>
						</a>
						<ul class="submenu">
							 <li><a href="/bt/1.html">宝塔面板简介</a></li><li><a href="/bt/35.html">宝塔目录结构</a></li>						</ul>
					</li>
										<li>
						<a href="javascript:void(0);" class="waves-effect">
							<i class="icon-share"></i>
							<span> 系统版本							<span class="float-right menu-arrow">
							<i class="mdi mdi-chevron-right"></i>
							</span> 
							</span>
						</a>
						<ul class="submenu">
							 <li><a href="/bt/2.html">windows面板介绍</a></li><li><a href="/bt/3.html">Linux面板介绍</a></li>						</ul>
					</li>
										<li>
						<a href="javascript:void(0);" class="waves-effect">
							<i class="icon-share"></i>
							<span> 系统安装							<span class="float-right menu-arrow">
							<i class="mdi mdi-chevron-right"></i>
							</span> 
							</span>
						</a>
						<ul class="submenu">
							 <li><a href="/bt/4.html">1. SSH远程登录Linux系统</a></li><li><a href="/bt/5.html">2.1 放行阿里云服务器端口</a></li><li><a href="/bt/6.html">2.2 放行腾讯云服务器端口</a></li><li><a href="/bt/7.html">2.3 放行华为云服务器端口</a></li><li><a href="/bt/8.html">2.4 放行百度云服务器端口</a></li><li><a href="/bt/9.html">3. 安装Windows面板</a></li><li><a href="/bt/10.html">4. 安装Linux面板</a></li><li><a href="/bt/11.html">4.1 安装初始化环境</a></li><li><a href="/bt/12.html">5. 创建一个网站</a></li>						</ul>
					</li>
										<li>
						<a href="javascript:void(0);" class="waves-effect">
							<i class="icon-share"></i>
							<span> 使用教程							<span class="float-right menu-arrow">
							<i class="mdi mdi-chevron-right"></i>
							</span> 
							</span>
						</a>
						<ul class="submenu">
							 <li><a href="/bt/13.html">1. 网站基本配置操作</a></li><li><a href="/bt/14.html">2. 宝塔面板FTP端口设置</a></li><li><a href="/bt/15.html">3. 宝塔面板数据库设置</a></li><li><a href="/bt/16.html">4. 监控设置功能</a></li><li><a href="/bt/17.html">5. 安全管理</a></li><li><a href="/bt/18.html">6. 文件管理</a></li><li><a href="/bt/19.html">6.1. 计划任务之Shell脚本</a></li><li><a href="/bt/20.html">6.2. 计划任务之备份网站</a></li><li><a href="/bt/21.html">6.3. 计划任务之面板设置</a></li>						</ul>
					</li>
										<li>
						<a href="javascript:void(0);" class="waves-effect">
							<i class="icon-share"></i>
							<span> 提升性能							<span class="float-right menu-arrow">
							<i class="mdi mdi-chevron-right"></i>
							</span> 
							</span>
						</a>
						<ul class="submenu">
							 <li><a href="/bt/22.html">1. Swap交换分区</a></li><li><a href="/bt/23.html">2. PHP参数调整</a></li><li><a href="/bt/24.html">3. Mysql性能调整</a></li><li><a href="/bt/25.html">4. 定期释放缓存</a></li><li><a href="/bt/26.html">5. 启用禁ping</a></li>						</ul>
					</li>
										<li>
						<a href="javascript:void(0);" class="waves-effect">
							<i class="icon-share"></i>
							<span> 系统安全							<span class="float-right menu-arrow">
							<i class="mdi mdi-chevron-right"></i>
							</span> 
							</span>
						</a>
						<ul class="submenu">
							 <li><a href="/bt/27.html">服务器数据安全</a></li><li><a href="/bt/28.html">安全组及漏洞修补</a></li><li><a href="/bt/29.html">文件夹权限</a></li><li><a href="/bt/30.html">宝塔面板安全设置</a></li><li><a href="/bt/31.html">运行环境安全设置</a></li>						</ul>
					</li>
										<li>
						<a href="javascript:void(0);" class="waves-effect">
							<i class="icon-share"></i>
							<span> 实用收藏							<span class="float-right menu-arrow">
							<i class="mdi mdi-chevron-right"></i>
							</span> 
							</span>
						</a>
						<ul class="submenu">
							 <li><a href="/bt/32.html">常用Linux命令</a></li><li><a href="/bt/33.html">安装/升级/操作命令</a></li><li><a href="/bt/34.html">Linux常用命令大全</a></li><li><a href="/bt/36.html">忘记账户密码</a></li><li><a href="/bt/37.html">宝塔面板中网站页面出现403</a></li>						</ul>
					</li>
										<li>
						<a href="/bt/biji/" class="waves-effect">
							<i class="icon-share"></i>
							<span>宝塔笔记
								<span class="float-right menu-arrow">
								<i class="mdi mdi-chevron-right"></i>
								</span>
							</span>
						</a>
					</li>
				</ul>
			</div>
			<div class="clearfix"></div>
		</div>
	</div>
	<div class="content-page">
		<div class="content">
			<div class="container-fluid">
				<div class="page-title-box">
					<div class="row align-items-center">
						<div class="col-sm-6">
							<h1 class="page-title">宝塔面板phpMyAdmin未授权访问安全漏洞是个低级错误吗</h1>
						</div>
					</div>
				</div>
				<div class="panel panel-forbid">
					<div class="panel-title">
						<i class="fa fa fa-file-text fa-fw"></i>内容摘要
					</div>
					<div class="panel-content">
						<span>周日晚，某群里突然发布了一则消息，宝塔面板的phpmyadmin存在未授权访问漏洞的紧急漏洞预警，并给出了一大批存在漏洞的URL：随便点开其中一个，赫然就是一个大大的phpmyadmin后台管</span>                                     
					</div>
					<div class="panel-title">
						<i class="fa fa fa-file-text fa-fw"></i>文章正文
					</div>
					<div class="panel-content">
					<span><p>周日晚，某群里突然发布了一则消息，宝塔面板的phpmyadmin存在未授权访问漏洞的紧急漏洞预警，并给出了一大批存在漏洞的URL：</p>
<p><img alt="8ab94b0361e4ccb558061222e3e6cf6.png" src="/d/file/p/20230325/1598248782544619.png" title="1598248782544619.png" /></p>
<p>随便点开其中一个，赫然就是一个大大的phpmyadmin后台管理页面，无需任何认证与登录。当然，随后各种神图神事也都刷爆了社交网络，作为一个冷静安全研究者，我对此当然是一笑置之，但是这个漏洞的原因我还是颇感兴趣的，所以本文我们就来考证一下整件事情的缘由。</p>
<p><strong>一、我们的问题究竟是什么？</strong></p>
<p>首先，我先给出一个结论：这件事情绝对不是简简单单地有一个pma目录忘记删除了，或者宝塔面板疏忽大意进行了错误地配置，更不是像某些人阴谋论中说到的官方刻意留的后门。</p>
<p>我为什么这么说？首先，根据官方的说法，这个漏洞只影响如下版本：</p>
<ul style="list-style-type: disc;">
	<li>
	<p>Linux正式版7.4.2</p></li>
	<li>
	<p>Linux测试版7.5.13</p></li>
	<li>
	<p>Windows正式版6.8</p></li>
</ul>
<p>这个版本就是最新版（漏洞修复版）的前一个版本。也就是说，这个确定的小版本之前的版本面板是不受影响的。我们试想一下，如果是&ldquo;后门&rdquo;或者官方忘记删除的目录，为什么只影响这一个版本呢？况且宝塔面板发展了这么久，积累了400万用户，体系安全性也相对比较成熟，如果存在这么低劣的错误或&ldquo;后门&rdquo;，也应该早就被发现了。</p>
<p>经过实际查看互联网上的案例和询问使用了宝塔面板的朋友，我发现在7.4.2以前的版本中没有pma这个目录，并且phpmyadmin默认情况下认证方法是需要输入账号密码的。所以，宝塔出现这个漏洞，一定是做过了下面这两件事：</p>
<ul style="list-style-type: disc;">
	<li>
	<p>新增了一个pma目录，内容phpmyadmin</p></li>
	<li>
	<p>phpmyadmin的配置文件被修改了认证方式</p></li>
</ul>
<p>那么，我们的问题就变成了，官方为什么要做这两处修改，目的究竟是什么？</p>
<p>为了研究这个问题，我们需要先安装一个宝塔7.4.2版本。但是，宝塔的安装是一个傻瓜化的一键化脚本：</p>
<pre class="brush:php;toolbar:false">
<code style="position:relative; padding:0px; margin:0px;">yum install -y wget &amp;&amp; wget -O install.sh /d/file/p/20230325/install_6.0.sh &amp;&amp; sh install.sh</code></pre>
<div class="contentsignin"><code style="position:relative; padding:0px; margin:0px;">登录后复制</code></div>
<p>并没有给到用户一个可以选择版本号的选项，官方的Git也许久没更新了，我们如何才能安装到一个合适的版本（7.4.2）呢？</p>
<p><strong>二、安装一个合适的版本</strong></p>
<p>这当然难不倒我。首先，我安装了最新版的宝塔面板，用的就是上述一键化脚本。</p>
<p>安装的过程自然没什么问题，安装完成后，系统显示的版本号是最新版7.4.3，因为在爆出这个漏洞以后，官方迅速进行了修复升级。不过没关系，我们仍然可以找到离线升级包：</p>
<pre class="brush:php;toolbar:false">
<code style="position:relative; padding:0px; margin:0px;">http://download.bt.cn/install/update/LinuxPanel-7.4.0.zip
http://download.bt.cn/install/update/LinuxPanel-7.4.2.zip
http://download.bt.cn/install/update/LinuxPanel-7.4.3.zip</code></pre>
<div class="contentsignin"><code style="position:relative; padding:0px; margin:0px;">登录后复制</code></div>
<p>分别是7.4.0/7.4.2/7.4.3的版本，我们分别下载并解压，并尝试将自己的服务器版本恢复成漏洞版本7.4.2。</p>
<p>在恢复代码之前，我们先将服务器断网，或者将宝塔设置成离线模式：</p>
<p><img alt="3cd084c23abeaaf41f95b9cb6cb799a.png" src="/d/file/p/20230325/1598248814482550.png" title="1598248814482550.png" /></p>
<p>这么做的目的是防止宝塔进行自动版本更新，避免好不容易恢复的代码又自动升级了。</p>
<p>宝塔系统代码默认安装完是在<code>/www/server/panel</code>，接着我们直接将将压缩包内的panel目录上传到这里来，覆盖掉已有的文件。重启下宝塔，即可发现系统版本号已经恢复成7.4.2了：</p>
<p><img alt="83a03bae942e6f71c3617b9ba707c68.png" src="/d/file/p/20230325/1598248825258548.png" title="1598248825258548.png" /></p>
<p>还没完，我们使用beyond compare打开7.4.2和7.4.3的压缩包代码，先看看官方是怎么修复的漏洞：</p>
<p><img alt="04828949f5f39eefbfba453db13b738.png" src="/d/file/p/20230325/1598248841349251.png" title="1598248841349251.png" /></p>
<p>比较粗暴，直接判断目录<code>/www/server/phpmyadmin/pma</code>是否存在，如果存在就直接删掉。所以，我们虽然恢复了系统版本代码，但删掉的pma已经不在了，我们还需要恢复一下这个目录。</p>
<p>方法也很简单，<code>/www/server/phpmyadmin</code>下本身存在一个phpmyadmin目录，我们直接复制一下这个目录即可：</p>
<p><img alt="d7ea051444f1b50c20197487b52fb0e.png" src="/d/file/p/20230325/1598248852659020.png" title="1598248852659020.png" /></p>
<p><strong>三、漏洞究竟是怎么回事</strong></p>
<p>有了环境，我们仍需看看代码。</p>
<p>首先，由于7.4.2是引入漏洞的版本，我们看看官方对7.4.2的更新日志：</p>
<p><img alt="617af739919d57fd7d13e9cf12f6297.png" src="/d/file/p/20230325/1598248866152983.png" title="1598248866152983.png" /></p>
<p>用beyond compare打开7.4.0和7.4.2的压缩包代码，看看具体增加了哪些代码：</p>
<p><img alt="c9a67dd190c79960118bf7cc1a4d5e0.png" src="/d/file/p/20230325/1598248872608491.png" title="1598248872608491.png" /></p>
<p>可见，在7.4.2版本中增加了两个视图，分别对应着phpmyadmin和adminer。视图中用到了<code>panelPHP#start</code>方法，这个方法其实也是新加的：</p>
<pre class="brush:php;toolbar:false">
<code style="position:relative; padding:0px; margin:0px;">    def start(self,puri,document_root,last_path = &#39;&#39;):
        &#39;&#39;&#39;
            @name 开始处理PHP请求
            @author hwliang&lt;2020-07-11&gt;
            @param puri string(URI地址)
            @return socket or Response
        &#39;&#39;&#39;
        ...
        #如果是PHP文件
        if puri[-4:] == &#39;.php&#39;:
            if  request.path.find(&#39;/phpmyadmin/&#39;) != -1:
                ...
                if request.method == &#39;POST&#39;:
                    #登录phpmyadmin
                    if puri in [&#39;index.php&#39;,&#39;/index.php&#39;]:
                        content = public.url_encode(request.form.to_dict())
                        if not isinstance(content,bytes):
                            content = content.encode()
                        self.re_io = StringIO(content)
                        username = request.form.get(&#39;pma_username&#39;)
                        if username:
                            password = request.form.get(&#39;pma_password&#39;)
                            if not self.write_pma_passwd(username,password):
                                return Resp(&#39;未安装phpmyadmin&#39;)
                if puri in [&#39;logout.php&#39;,&#39;/logout.php&#39;]:
                    self.write_pma_passwd(None,None)
            else:
                ...
      #如果是静态文件
        return send_file(filename)</code></pre>
<div class="contentsignin"><code style="position:relative; padding:0px; margin:0px;">登录后复制</code></div>
<p>&nbsp;</p>
<p>代码太长，我们不展开分析，只我写出来的部分。在请求的路径是<code>/phpmyadmin/index.php</code>且存在<code>pma_username</code>、<code>pma_password</code>时，则执行<code>self.write_pma_passwd(username,password)</code>。</p>
<p>跟进self.write_pma_passwd：</p>
<pre class="brush:php;toolbar:false">
<code style="position:relative; padding:0px; margin:0px;">    def write_pma_passwd(self,username,password):
        &#39;&#39;&#39;
            @name 写入mysql帐号密码到配置文件
            @author hwliang&lt;2020-07-13&gt;
            @param username string(用户名)
            @param password string(密码)
            @return bool
        &#39;&#39;&#39;
        self.check_phpmyadmin_phpversion()
        pconfig = &#39;cookie&#39;
        if username:
            pconfig = &#39;config&#39;
        pma_path = &#39;/www/server/phpmyadmin/&#39;
        pma_config_file = os.path.join(pma_path,&#39;pma/config.inc.php&#39;)
        conf = public.readFile(pma_config_file)
        if not conf: return False
        rep = r&quot;/\* Authentication type \*/(.|\n)+/\* Server parameters \*/&quot;
        rstr = &#39;&#39;&#39;/* Authentication type */
$cfg[&#39;Servers&#39;][$i][&#39;auth_type&#39;] = &#39;{}&#39;;
$cfg[&#39;Servers&#39;][$i][&#39;host&#39;] = &#39;localhost&#39;; 
$cfg[&#39;Servers&#39;][$i][&#39;port&#39;] = &#39;{}&#39;;
$cfg[&#39;Servers&#39;][$i][&#39;user&#39;] = &#39;{}&#39;; 
$cfg[&#39;Servers&#39;][$i][&#39;password&#39;] = &#39;{}&#39;; 
/* Server parameters */&#39;&#39;&#39;.format(pconfig,self.get_mysql_port(),username,password)
        conf = re.sub(rep,rstr,conf)
        public.writeFile(pma_config_file,conf)
        return True</code></pre>
<div class="contentsignin"><code style="position:relative; padding:0px; margin:0px;">登录后复制</code></div>
<p>这个代码也很好理解了，如果传入了username和password的情况下，宝塔会改写phpmyadmin的配置文件config.inc.php，将认证方式改成<code>config</code>，并写死账号密码。</p>
<p>这就是为什么7.4.2版本中pma可以直接访问的原因。</p>
<blockquote>
<p>补个课：</p>
<p>phpmyadmin支持数种认证方法，默认情况下是Cookie认证，此时需要输入账号密码；用户也可以将认证方式修改成Config认证，此时phpmyadmin会使用配置文件中的账号密码来连接mysql数据库，即不用再输入账号密码。</p></blockquote>
<p><strong>四、官方做这些动作的原因</strong></p>
<p>其实各位看官看到这里肯定脑子里还是一团浆糊，这些代码究竟意味着什么呢？为什么官方要将认证模式改成config模式？</p>
<p>是很多漏洞分析文章的通病，这些文章在出现漏洞后跟一遍漏洞代码，找到漏洞发生点和利用方法就结束了，并没有深入研究开发为什么会这么写，那么下次你还是挖不出漏洞。</p>
<p>所以，这里思考一下，我们现在起码还有下列疑问：</p>
<ul style="list-style-type: disc;">
	<li>
	<p>在7.4.2版本以前，用户是如何使用phpmyadmin的？</p></li>
	<li>
	<p>宝塔为什么要在7.4.2版本增加phpmyadmin有关的视图？</p></li>
	<li>
	<p>宝塔为什么要将phpmyadmin认证模式改成config？</p></li>
</ul>
<p>我们如何复现这个漏洞？</p>
<p>第一个问题，我们其实可以简单找到答案。在正常安装宝塔最新版7.4.3时，我们点击宝塔后台的phpmyadmin链接，会访问到这样一个路径：</p>
<p><img alt="b678601f9e10d03b18ed8edf71b63a0.png" src="/d/file/p/20230325/1598248897682934.png" title="1598248897682934.png" /></p>
<p>7.4.3版本为了修复这个漏洞，回滚了部分代码，所以这种方式其实就是7.4.2以前版本的phpmyadmin的访问方式：通过888端口下的一个以<code>phpmyadmin_</code>开头的文件夹直接访问phpmyadmin。</p>
<p>这种老的访问方法中，888端口是一个单独的Nginx或Apache服务器，整个东西是安全的，访问也需要输入账号密码。</p>
<p>但是这种访问方法有些麻烦，需要额外开放888端口，而且每次登陆都要重新输入密码。所以，官方开发人员提出了一种新的做法，在宝塔后端的python层面转发用户对phpmyadmin的请求给php-fpm。这样有三个好处：</p>
<ul style="list-style-type: disc;">
	<li>
	<p>直接在python层面做用户认证，和宝塔的用户认证进行统一，不需要多次输入mysql密码</p></li>
	<li>
	<p>也不需要再对外开放888端口了</p></li>
	<li>
	<p>使用phpmyadmin也不再依赖于Nginx/Apache等服务器中间件了</p></li>
</ul>
<p>这就是为什么宝塔要在7.4.2增加phpmyadmin有关的视图的原因，这个视图就是一个phpmyadmin的代理，做的事情就是转发用户的请求给php-fpm。</p>
<p>用户在第一次使用这种方式登录时，系统会自动发送包含了Mysql账号密码的数据包，宝塔后端会捕捉到此时的账号密码，填入phpmyadmin的配置文件，并将认证方式改成<code>config</code>。对于用户来说，感受到的体验就是，不再需要输入任何Mysql密码即可使用phpmyadmin了。</p>
<p>这的确给用户的使用带来了更好的体验。</p>
<p><strong>五、漏洞复现</strong></p>
<p>此时我们应该还有个疑问：既然官方目的是&ldquo;直接在python层面做用户认证，和宝塔的用户认证进行统一&rdquo;，那么仍然是有认证的呀？为什么会出现未授权访问漏洞呢？</p>
<p>我们可以来复现一下这个漏洞。首先，我们以系统管理员的身份登录宝塔后台，来到数据库页面，点击&ldquo;phpMyAdmin&rdquo;按钮，会弹出如下模态框：</p>
<p><img alt="7fa30bdf20eab63dd56755d61cee440.png" src="/d/file/p/20230325/1598248917841064.png" title="1598248917841064.png" /></p>
<p>这个里面有两种访问模式，&ldquo;通过Nginx/Apache/OIs访问&rdquo;是老版本的访问方式，&ldquo;通过面板安全访问&rdquo;就是7.4.2新增加的代理模式。</p>
<p>我们点击&ldquo;通过面板安全访问&rdquo;，并抓包，会抓到这样一个数据包：</p>
<p><img alt="6914eecff6f59abcea46f1c3a8522f0.png" src="/d/file/p/20230325/1598248928806493.png" title="1598248928806493.png" /></p>
<p>宝塔前端将我们的Mysql账号密码填好了直接发给phpmyadmin。又因为我们前面分析过的那段代码，后台将账号密码直接写入了phpmyadmin配置文件，来做到免认证的逻辑。</p>
<p>如果一个未认证的用户，直接访问<code>http://ip:8888/phpmyadmin/index.php</code>呢？会被直接重定向到登录页面：</p>
<p><img alt="4598a34ea51d0c500b02406b886a589.png" src="/d/file/p/20230325/1598248947402233.png" title="1598248947402233.png" /></p>
<p>如果仅仅是这样，这个过程是不存在漏洞的。但是，官方开发人员犯了一个错误，他将pma应用放在了<code>/www/server/phpmyadmin</code>目录下，而这个目录原本是老的phpmyadmin访问方式所使用的Web根目录。</p>
<p>这意味着，我通过老的888端口+pma目录，可以访问到新的phpmyadmin，而新的phpmyadmin又被官方修改了配置文件，最终导致了未授权访问漏洞：</p>
<p><img alt="0a30c32ee0fbdf5336685701172e2ac.png" src="/d/file/p/20230325/1598248959115948.png" title="1598248959115948.png" /></p>
<p>所以，如何解决这个问题呢？也很简单，只需要将pma移到其他目录去即可。</p>
<p><strong>六、总结</strong></p>
<p>我们来做个总结。</p>
<p>首先，宝塔面板绝对不是弱智，这个漏洞不是简简单单的放了一个未授权的pma在外面忘记删。这其实会打很多人脸，因为大部分人认为这只是个简单的phpmyadmin未授权访问漏洞，并对宝塔进行了一顿diss，没有想到这后面其实是一个复杂的逻辑错误。</p>
<p>其次，用户体验和安全绝对是不冲突的，我十分不喜欢为了保障安全而阉割用户体验的做法。所以希望宝塔官方不会因为这次的漏洞事件而彻底将代码回滚（据说7.4.3的更新只是临时解决方案），该改进的地方还是要改进。</p>
<p>我有数年不再使用Linux面板了，这次也算重新体验了一下2020年的Linux面板，个人感觉宝塔看外在其实是一个比较注重安全的系统，比如自动生成的用户密码、用户名和密码的策略、默认的Php安全配置、自动的版本更新等等，相比于很多国内其他的商业系统，绝对属于有过之而无不及了。但是看代码其实需要改进的地方还有很多，这个以后有机会再细说吧。</p>
<p>本文来自公众号：/d/file/p/20230325/p</p></span>                                     
					</div>
					<div class="panel-title">
						<i class="fa fa fa-file-text fa-fw"></i>代码注释
					</div>
					<div class="panel-content">
					<span>[!--zhushi--]</span>                                     
					</div>
				</div>
				<div class="newsPage">
					<div class="newsPageTurn">
						<span><a>上一篇</a><a href='/bt/biji/232.html'>宝塔面板干什么用的？_宝塔面板</a><a>下一篇</a><a href='/bt/biji/234.html'>宝塔linux面板​如何强制修改MySQL管理密码_宝塔面板</a></span>
					</div>
				</div>
			</div>
			<div id="author-box">
				<h3>作者：喵哥笔记</h3>
				<div class="author-info">
					<div class="author-avatar">
						<img src="/skin1/picture/01.jpg" alt="IDC笔记" class="avatar" width="64" height="64">
					</div>
					<div class="author-description">
						<p>学的不仅是技术，更是梦想！</p>
						<ul class="author-social follows nb">
							<li>
								<a target="_blank" href="/" title="IDC笔记">IDC笔记</a>
							</li>
						</ul>
					</div>
					<div class="clear"></div>
				</div>
			</div>
		</div>
		<footer class="footer">
			© 2020 IDC笔记 <i class="mdi mdi-heart text-danger"></i>. | 备案号：<a href="https://beian.miit.gov.cn/">辽ICP备18000516号</a>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?674585fbbd2294d3faf910f668ea91b4";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

		</footer>
	</div>
	</div>
	<script src="/skin1/js/jquery.min.js"></script>
	<script src="/skin1/js/bootstrap.bundle.min.js"></script>
	<script src="/skin1/js/metismenu.min.js"></script>
	<script src="/skin1/js/jquery.slimscroll.js"></script>
	<script src="/skin1/js/waves.min.js"></script>
	<script src="/skin1/js/morris.min.js"></script>
	<script src="/skin1/js/raphael.min.js"></script>
	<script src="/skin1/js/dashboard.init.js"></script>
	<script src="/skin1/js/app.js"></script>
<script src="/foot.js"></script>
</body>
</html>